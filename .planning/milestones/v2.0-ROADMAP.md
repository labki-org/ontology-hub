# Milestone v2.0: Platform Rebuild

**Status:** SHIPPED 2026-01-25
**Phases:** 8-15
**Total Plans:** 41

## Overview

Full database/API/frontend rebuild with versioned canonical data, normalized relationship tables, draft-as-deltas with auto-rebase, and graph visualization with module hull overlays.

**Target features delivered:**
- Latest-only canonical storage (Ontology Hub retains only current version; labki-schemas repo is the version archive)
- Webhook-triggered ingest from labki-schemas on push
- Precomputed relationship tables (inheritance, property membership, where-used)
- Draft model storing deltas (JSON Patch for updates, full replacement for creates)
- Auto-rebase for in-progress drafts when new canonical is ingested
- Graph-based navigation with module grouping hulls
- Template entity support (new entity type)
- Unified browse/draft UI with same underlying query logic

## Phases

### Phase 8: Database Foundation

**Goal**: Establish v2.0 schema with canonical tables, normalized relationship storage, and materialized inheritance views (only latest version retained)
**Depends on**: Nothing (first phase of v2.0)
**Plans**: 3 plans

Plans:
- [x] 08-01-PLAN.md — Core entity models (ontology_version + 6 entity tables)
- [x] 08-02-PLAN.md — Relationship tables + materialized view SQL
- [x] 08-03-PLAN.md — Draft tables + Alembic migration

**Requirements:** DB-01, DB-02, DB-03, DB-04, DB-05, DB-06, DB-07, DB-08, DB-09

### Phase 9: Ingest Pipeline

**Goal**: Populate v2.0 schema from labki-schemas repo via webhook, replacing previous data with latest
**Depends on**: Phase 8
**Plans**: 4 plans

Plans:
- [x] 09-01-PLAN.md — Schema validation service (jsonschema library)
- [x] 09-02-PLAN.md — Entity parser service (all 6 types + relationship extraction)
- [x] 09-03-PLAN.md — Ingest service core (atomic replacement, OntologyVersion, mat view)
- [x] 09-04-PLAN.md — Webhook integration (v2.0 trigger, draft staleness)

**Requirements:** ING-01, ING-02, ING-03, ING-04, ING-05, ING-06, ING-07

### Phase 10: Query Layer

**Goal**: Provide entity queries and graph endpoints supporting canonical and draft contexts
**Depends on**: Phase 9
**Plans**: 3 plans

Plans:
- [x] 10-01-PLAN.md — Response schemas + DraftOverlayService (jsonpatch, change_status)
- [x] 10-02-PLAN.md — Entity query endpoints (categories, properties, modules, bundles)
- [x] 10-03-PLAN.md — Graph endpoints (neighborhood, module-scoped with CTEs)

**Requirements:** QRY-01, QRY-02, QRY-03, QRY-04, QRY-05, QRY-06, QRY-07, GRP-01, GRP-02, GRP-03, GRP-04

### Phase 11: Draft System

**Goal**: Store draft changes as JSON Patch deltas with server-side effective view computation and auto-rebase on canonical updates
**Depends on**: Phase 10
**Plans**: 5 plans

Plans:
- [x] 11-01-PLAN.md — Draft CRUD endpoints (v2 router, capability URLs)
- [x] 11-02-PLAN.md — Draft change management (add/update/delete with JSON Patch validation)
- [x] 11-03-PLAN.md — Auto-rebase service (conflict detection, webhook integration)
- [x] 11-04-PLAN.md — MediaWiki import endpoint (explicit action signals)
- [x] 11-05-PLAN.md — Draft-aware inheritance (gap closure for DRF-04)

**Requirements:** DRF-01, DRF-02, DRF-03, DRF-04, DRF-05, DRF-06, DRF-07

### Phase 12: Frontend + Graph Visualization

**Goal**: Build unified browse/draft frontend with graph panel featuring module hull overlays
**Depends on**: Phase 11
**Plans**: 6 plans

Plans:
- [x] 12-01-PLAN.md — Core layout + dependencies (SplitLayout, v2 API hooks)
- [x] 12-02-PLAN.md — Graph stores + API client (graphStore, hullStore, graph hooks)
- [x] 12-03-PLAN.md — Sidebar with draft badges (SidebarV2, search, DraftBanner)
- [x] 12-04-PLAN.md — Force-directed graph canvas (GraphCanvas, useForceLayout)
- [x] 12-05-PLAN.md — Module hull overlays (ModuleHull, HullLayer, controls)
- [x] 12-06-PLAN.md — Integration + routing (BrowsePage, MainLayoutV2)

**Requirements:** FE-01, FE-02, FE-03, FE-04, FE-05, FE-06, GV-01, GV-02, GV-03, GV-04, GV-05, GV-06, GV-07

### Phase 13: Entity Detail Pages

**Goal**: Implement detail pages for all six entity types with view and edit modes
**Depends on**: Phase 12
**Plans**: 9 plans

Plans:
- [x] 13-01-PLAN.md — Infrastructure (shadcn/ui components, TypeScript types, useAutoSave hook)
- [x] 13-02-PLAN.md — Form components (EditableField, VisualChangeMarker, EditableList, EntityHeader)
- [x] 13-03-PLAN.md — Modal + sections (EntityDetailModal, detailStore, MembershipSection, WhereUsedSection)
- [x] 13-04-PLAN.md — CategoryDetail (parents, direct/inherited properties with provenance)
- [x] 13-05-PLAN.md — PropertyDetail + SubobjectDetail (datatype, cardinality, where-used)
- [x] 13-06-PLAN.md — ModuleDetail + BundleDetail (members, closure, version increment)
- [x] 13-07-PLAN.md — TemplateDetail (wikitext display and editor)
- [x] 13-08-PLAN.md — Integration (BrowsePage modal integration, double-click handling)
- [x] 13-09-PLAN.md — Gap closure: ModuleDetail + BundleDetail edit mode

**Requirements:** CAT-01, CAT-02, CAT-03, CAT-04, CAT-05, CAT-06, PRP-01, PRP-02, PRP-03, PRP-04, SUB-01, SUB-02, SUB-03, SUB-04, MOD-01, MOD-02, MOD-03, MOD-04, MOD-05, MOD-06, BND-01, BND-02, BND-03, BND-04, BND-05, TPL-01, TPL-02, TPL-03, TPL-04

### Phase 14: Validation + Workflow + PR

**Goal**: Complete validation engine, draft workflow UI, and GitHub PR submission
**Depends on**: Phase 13
**Plans**: 10 plans

Plans:
- [x] 14-01-PLAN.md — Validation service v2 (adapt validators for DraftChange model)
- [x] 14-02-PLAN.md — Auto-revert + status management (draft workflow transitions)
- [x] 14-03-PLAN.md — Validate endpoint (POST /drafts/{token}/validate)
- [x] 14-04-PLAN.md — PR builder v2 (file generation from DraftChange records)
- [x] 14-05-PLAN.md — Submit endpoint (POST /drafts/{token}/submit with OAuth)
- [x] 14-06-PLAN.md — Frontend API hooks + workflow state (draftApiV2, draftStoreV2)
- [x] 14-07-PLAN.md — DraftBannerV2 + FloatingActionBar + ValidationSummaryV2
- [x] 14-08-PLAN.md — DraftDiffViewerV2 (per-entity change viewer)
- [x] 14-09-PLAN.md — PR wizard (multi-step submission dialog)
- [x] 14-10-PLAN.md — Integration (BrowsePage wiring + DraftSelector update)

**Requirements:** VAL-01, VAL-02, VAL-03, VAL-04, VAL-05, VAL-06, DWF-01, DWF-02, DWF-03, DWF-04, DWF-05, PR-01, PR-02, PR-03, PR-04, PR-05

### Phase 15: V2 Frontend Wiring Fixes

**Goal**: Fix 3 integration gaps from milestone audit: draft overlay propagation, v1/v2 component conflicts, and OAuth redirect URL
**Depends on**: Phase 14
**Plans**: 1 plan

Plans:
- [x] 15-01-PLAN.md — Fix draft_id derivation, remove v1 draft components from layout, fix OAuth URL

**Gap Closure**: Closes all 3 integration gaps and 2 broken flows from v2.0-MILESTONE-AUDIT.md

---

## Milestone Summary

**Key Decisions:**
- Full rebuild approach — replace v1.0 implementation completely, reuse working code where appropriate
- Hybrid patch format — JSON Patch for updates, full replacement for creates
- Materialized inheritance tables — precompute category_property_effective at ingest
- Latest-only versioning — Ontology Hub retains only current version; labki-schemas repo is the version archive
- Webhook-triggered ingest — repo push triggers ingest, no manual refresh
- Draft auto-rebase — when new canonical is ingested, in-progress drafts rebase automatically
- Draft ID derivation — derive draftId from async fetch instead of URL to support draft_token workflow

**Issues Resolved:**
- Draft overlay propagation — entity/graph queries now receive correct draft context from fetched draft data
- V1/V2 component conflicts — MainLayoutV2 no longer renders conflicting v1 draft components
- OAuth redirect URL — ConfirmSubmit.tsx uses correct /api/v1/oauth/github/login path

**Issues Deferred:**
- Performance optimization for large ontologies (500+ nodes) — deferred to v2.1+
- Concave hull option for module overlays — convex hulls sufficient for v2.0

**Technical Debt Incurred:**
- None — all v2.0 requirements shipped clean

---

*For current project status, see .planning/MILESTONES.md*
