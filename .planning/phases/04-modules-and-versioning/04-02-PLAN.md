---
phase: 04-modules-and-versioning
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - backend/app/routers/modules.py
  - backend/tests/test_modules_api.py
  - frontend/src/components/graph/DependencyGraph.tsx
  - frontend/src/components/graph/ModuleNode.tsx
  - frontend/src/components/module/OverlapIndicator.tsx
  - frontend/src/components/module/ModuleEntityList.tsx
  - frontend/src/pages/ModulePage.tsx
  - frontend/src/pages/ProfilePage.tsx
  - frontend/src/api/modules.ts
  - frontend/src/api/types.ts
autonomous: true

must_haves:
  truths:
    - "User can view module dependency graph on profile detail page"
    - "Module detail page shows which entities also appear in other modules"
    - "Overlap indicators use neutral info style (not warning)"
    - "Dependency graph shows arrows from dependency to dependent module"
  artifacts:
    - path: "backend/app/routers/modules.py"
      provides: "Module overlaps endpoint"
      contains: "get_module_overlaps"
    - path: "frontend/src/components/graph/DependencyGraph.tsx"
      provides: "Module dependency visualization"
      exports: ["DependencyGraph"]
    - path: "frontend/src/components/module/OverlapIndicator.tsx"
      provides: "Neutral overlap info display"
      exports: ["OverlapIndicator"]
  key_links:
    - from: "frontend/src/pages/ProfilePage.tsx"
      to: "DependencyGraph"
      via: "component import and render"
      pattern: "<DependencyGraph"
    - from: "frontend/src/components/module/ModuleEntityList.tsx"
      to: "/api/modules/{id}/overlaps"
      via: "useModuleOverlaps hook"
      pattern: "useModuleOverlaps\\("
---

<objective>
Add module dependency visualization and entity overlap detection.

Purpose: Satisfy MODL-03 and MODL-04 requirements - users can view module dependency graphs and see when entities appear in multiple modules.
Output: DependencyGraph component using React Flow, overlap endpoint, OverlapIndicator component with neutral styling.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-modules-and-versioning/04-CONTEXT.md
@.planning/phases/04-modules-and-versioning/04-RESEARCH.md
@.planning/phases/04-modules-and-versioning/04-01-SUMMARY.md

# Existing graph patterns to follow
@frontend/src/components/graph/InheritanceGraph.tsx
@frontend/src/components/graph/CategoryNode.tsx
@frontend/src/components/graph/useGraphLayout.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add module overlaps endpoint</name>
  <files>
    backend/app/routers/modules.py
    backend/tests/test_modules_api.py
  </files>
  <action>
Add new endpoint to `backend/app/routers/modules.py`:

**GET /modules/{module_id}/overlaps**:
- Returns entities that appear in multiple modules
- Response: `dict[str, list[str]]` mapping entity_id to list of other module_ids
- Only includes entities that appear in MORE than one module
- Example response: `{"Person": ["core", "research"], "Agent": ["core"]}`

Implementation approach:
1. Get the target module and its category_ids
2. Query all other modules (not soft-deleted)
3. For each category in target module, check if it appears in any other module
4. Return map of overlapping entities

```python
@router.get("/{module_id}/overlaps")
@limiter.limit(RATE_LIMITS["entity_read"])
async def get_module_overlaps(
    request: Request,
    module_id: str,
    session: SessionDep,
) -> dict[str, list[str]]:
    """Get entities that appear in multiple modules.

    Returns: { "entity_id": ["other_module1", "other_module2"], ... }
    Only includes entities that appear in more than one module.
    """
    # Verify module exists
    query = select(Module).where(
        Module.module_id == module_id,
        Module.deleted_at.is_(None),
    )
    result = await session.execute(query)
    module = result.scalar_one_or_none()
    if not module:
        raise HTTPException(status_code=404, detail="Module not found")

    # Get all other modules
    other_query = select(Module).where(
        Module.module_id != module_id,
        Module.deleted_at.is_(None),
    )
    result = await session.execute(other_query)
    other_modules = result.scalars().all()

    # Find overlaps
    overlaps: dict[str, list[str]] = {}
    for cat_id in module.category_ids or []:
        other_module_ids = [
            m.module_id for m in other_modules
            if cat_id in (m.category_ids or [])
        ]
        if other_module_ids:
            overlaps[cat_id] = other_module_ids

    return overlaps
```

Add tests:
- Test overlaps endpoint returns correct format
- Test with module that has overlaps
- Test with module that has no overlaps (returns empty dict)
- Test 404 for non-existent module
  </action>
  <verify>
Run `cd /home/daharoni/dev/ontology-hub && docker compose exec backend pytest tests/test_modules_api.py -v -k overlap` and tests pass.
Manually verify: `curl http://localhost:8080/api/modules/{module_id}/overlaps | jq .` returns overlap map.
  </verify>
  <done>
GET /modules/{id}/overlaps returns map of entity_id to other_module_ids.
Returns empty dict for modules with no overlapping entities.
Returns 404 for non-existent module.
All overlap tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create dependency graph and overlap indicator components</name>
  <files>
    frontend/src/components/graph/DependencyGraph.tsx
    frontend/src/components/graph/ModuleNode.tsx
    frontend/src/components/module/OverlapIndicator.tsx
    frontend/src/components/module/ModuleEntityList.tsx
    frontend/src/pages/ModulePage.tsx
    frontend/src/pages/ProfilePage.tsx
    frontend/src/api/modules.ts
    frontend/src/api/types.ts
  </files>
  <action>
1. **Add to `frontend/src/api/types.ts`**:
   - No new types needed (overlaps is `Record<string, string[]>`)

2. **Add to `frontend/src/api/modules.ts`**:
   - `fetchModuleOverlaps(moduleId: string)` -> `Record<string, string[]>`
   - `useModuleOverlaps(moduleId: string)` hook with query key `['module-overlaps', moduleId]`

3. **Create `frontend/src/components/graph/ModuleNode.tsx`**:
   - Custom React Flow node for modules (similar to CategoryNode.tsx)
   - Shows module label and entity count
   - Clickable, navigates to /module/{module_id}
   - Highlight style for "current" module in context
   - Use Package icon

   ```typescript
   interface ModuleNodeData {
     label: string
     moduleId: string
     entityCount: number
     isCurrent?: boolean
   }

   export const moduleNodeTypes = {
     module: ModuleNodeComponent,
   }
   ```

4. **Create `frontend/src/components/graph/DependencyGraph.tsx`**:
   - Props: `moduleIds: string[]` (modules to show in graph)
   - Reuse `getLayoutedElements` from useGraphLayout.ts
   - Use same React Flow pattern as InheritanceGraph
   - Edges: from dependency TO dependent (arrow shows direction of dependency)
   - Define `moduleNodeTypes` OUTSIDE component to prevent re-renders
   - Detect and display cycle warning badge (similar to has_circular in inheritance)

   ```typescript
   interface DependencyGraphProps {
     moduleIds: string[]
     currentModuleId?: string  // Optional: highlight this module
   }
   ```

5. **Create `frontend/src/components/module/OverlapIndicator.tsx`**:
   - Neutral info style (blue/gray, NOT warning yellow/red)
   - Shows "also in: Module X, Module Y" as inline text
   - Use Info icon (lucide-react)
   - Module names are links to their detail pages

   ```typescript
   interface OverlapIndicatorProps {
     otherModuleIds: string[]
   }
   ```

6. **Update `frontend/src/components/module/ModuleEntityList.tsx`**:
   - Accept `overlaps` prop: `Record<string, string[]>`
   - For each entity, check if it has overlaps
   - If yes, render OverlapIndicator inline with entity row
   - Layout: entity label on left, overlap indicator on right

7. **Update `frontend/src/pages/ModulePage.tsx`**:
   - Fetch overlaps using `useModuleOverlaps(moduleId)`
   - Pass overlaps to ModuleEntityList component
   - Add dependency graph section if module has dependencies
   - Graph shows: this module + all modules it depends on

8. **Update `frontend/src/pages/ProfilePage.tsx`**:
   - Add DependencyGraph section showing module dependencies
   - Pass all module_ids from profile to DependencyGraph
   - Section header: "Module Dependencies"
   - Graph container: h-64 (same as inheritance graph)
  </action>
  <verify>
Run `cd /home/daharoni/dev/ontology-hub/frontend && npm run build` succeeds.
Visit /module/:moduleId - see overlap indicators next to entities that appear in multiple modules.
Visit /profile/:profileId - see dependency graph visualization.
Overlap indicators show neutral blue/gray style (not warning colors).
Graph edges point from dependency to dependent.
  </verify>
  <done>
Module detail page shows overlap indicators ("also in: X, Y") for shared entities.
Overlap indicators use neutral info styling (blue/gray).
Profile detail page shows dependency graph with module nodes.
Graph arrows show dependency direction correctly.
Module nodes are clickable and link to detail pages.
DependencyGraph detects and warns about circular dependencies.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:
1. `docker compose exec backend pytest tests/test_modules_api.py -v` - all tests pass
2. `cd frontend && npm run build` - builds without errors
3. Navigate to /module/:moduleId with overlapping entities - see neutral "also in:" indicators
4. Navigate to /profile/:profileId - see dependency graph
5. Click module nodes in graph - navigate to module detail
6. Verify overlap styling is informational (blue/gray), not warning (yellow/red)
</verification>

<success_criteria>
- MODL-03 satisfied: User can view module dependency visualization showing which modules depend on which
- MODL-04 satisfied: Module pages show overlap info when entities appear in multiple modules
- Overlap detection uses neutral info style per CONTEXT.md decision
- Dependency graph reuses React Flow pattern from Phase 3
- Graph shows correct dependency direction
</success_criteria>

<output>
After completion, create `.planning/phases/04-modules-and-versioning/04-02-SUMMARY.md`
</output>
