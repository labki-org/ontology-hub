---
phase: 04-modules-and-versioning
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/routers/modules.py
  - backend/tests/test_modules_api.py
  - frontend/src/api/modules.ts
  - frontend/src/api/types.ts
  - frontend/src/pages/ModulesPage.tsx
  - frontend/src/pages/ModulePage.tsx
  - frontend/src/pages/ProfilesPage.tsx
  - frontend/src/pages/ProfilePage.tsx
  - frontend/src/components/module/ModuleCard.tsx
  - frontend/src/components/module/ModuleEntityList.tsx
  - frontend/src/components/profile/ProfileCard.tsx
  - frontend/src/components/layout/Sidebar.tsx
  - frontend/src/App.tsx
  - backend/app/main.py
autonomous: true

must_haves:
  truths:
    - "User can browse list of modules seeing name, entity count, and preview entities"
    - "User can click a module card to see its detail page with entities grouped by type"
    - "User can browse list of profiles seeing module composition"
    - "User can click a profile card to see its detail page with module cards"
    - "Sidebar navigation includes Modules and Profiles sections"
  artifacts:
    - path: "backend/app/routers/modules.py"
      provides: "Module and Profile API endpoints"
      exports: ["router"]
    - path: "frontend/src/pages/ModulesPage.tsx"
      provides: "Module list page with cards"
      exports: ["ModulesPage"]
    - path: "frontend/src/pages/ModulePage.tsx"
      provides: "Module detail page with grouped entities"
      exports: ["ModulePage"]
    - path: "frontend/src/pages/ProfilesPage.tsx"
      provides: "Profile list page with cards"
      exports: ["ProfilesPage"]
    - path: "frontend/src/pages/ProfilePage.tsx"
      provides: "Profile detail page with module cards"
      exports: ["ProfilePage"]
  key_links:
    - from: "frontend/src/pages/ModulesPage.tsx"
      to: "/api/modules"
      via: "useModules hook"
      pattern: "useModules\\(\\)"
    - from: "frontend/src/pages/ModulePage.tsx"
      to: "/api/modules/{id}"
      via: "useModule hook"
      pattern: "useModule\\("
    - from: "frontend/src/App.tsx"
      to: "ModulesPage, ProfilesPage"
      via: "React Router routes"
      pattern: "path.*modules"
---

<objective>
Create module and profile browsing functionality with list and detail pages.

Purpose: Satisfy MODL-01 and MODL-02 requirements - users can browse modules with included entities/dependencies, and profiles with module composition.
Output: Backend API for modules/profiles, frontend pages with card-based lists and detail views, sidebar navigation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-modules-and-versioning/04-CONTEXT.md
@.planning/phases/04-modules-and-versioning/04-RESEARCH.md

# Existing patterns to follow
@backend/app/routers/entities.py
@frontend/src/api/entities.ts
@frontend/src/pages/CategoryPage.tsx
@frontend/src/components/layout/Sidebar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create module and profile API endpoints</name>
  <files>
    backend/app/routers/modules.py
    backend/app/main.py
    backend/tests/test_modules_api.py
  </files>
  <action>
Create new router at `backend/app/routers/modules.py` following the entities.py pattern:

1. **List modules endpoint** `GET /modules`:
   - Optional `search` query param (min 2 chars) for ILIKE on label
   - Returns `list[ModulePublic]` ordered by label
   - Filter out soft-deleted (deleted_at is None)
   - Apply rate limit: `RATE_LIMITS["entity_list"]`

2. **Get module endpoint** `GET /modules/{module_id}`:
   - Returns single `ModulePublic`
   - 404 if not found or soft-deleted
   - Apply rate limit: `RATE_LIMITS["entity_read"]`

3. **Get module entities endpoint** `GET /modules/{module_id}/entities`:
   - Returns all entities included in module grouped by type
   - Response schema: `{"categories": [...], "properties": [...], "subobjects": [...]}`
   - Categories: direct from module.category_ids
   - Properties/Subobjects: transitively included (find entities used by the categories)
   - Each entity is `EntityPublic`

4. **List profiles endpoint** `GET /profiles`:
   - Same pattern as modules list
   - Optional `search` query param
   - Returns `list[ProfilePublic]`

5. **Get profile endpoint** `GET /profiles/{profile_id}`:
   - Returns single `ProfilePublic`
   - 404 if not found

6. **Get profile modules endpoint** `GET /profiles/{profile_id}/modules`:
   - Returns `list[ModulePublic]` for modules in this profile
   - Resolves module_ids to full module objects

Register router in main.py: `app.include_router(modules.router)`

Create response schema in routers/modules.py:
```python
class ModuleEntitiesResponse(BaseModel):
    categories: list[EntityPublic]
    properties: list[EntityPublic]
    subobjects: list[EntityPublic]
```

Write tests in `backend/tests/test_modules_api.py`:
- Test list modules returns expected format
- Test get module by ID
- Test module entities endpoint returns grouped entities
- Test list profiles
- Test get profile and profile modules
- Test 404 for non-existent module/profile
- Test search filtering
  </action>
  <verify>
Run `cd /home/daharoni/dev/ontology-hub && docker compose exec backend pytest tests/test_modules_api.py -v` and all tests pass.
Manually verify with curl: `curl http://localhost:8080/api/modules | jq .` returns modules list.
  </verify>
  <done>
GET /modules returns module list with labels and category counts.
GET /modules/{id} returns single module with all fields.
GET /modules/{id}/entities returns entities grouped by type.
GET /profiles, GET /profiles/{id}, GET /profiles/{id}/modules work correctly.
All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create module and profile frontend pages</name>
  <files>
    frontend/src/api/modules.ts
    frontend/src/api/types.ts
    frontend/src/pages/ModulesPage.tsx
    frontend/src/pages/ModulePage.tsx
    frontend/src/pages/ProfilesPage.tsx
    frontend/src/pages/ProfilePage.tsx
    frontend/src/components/module/ModuleCard.tsx
    frontend/src/components/module/ModuleEntityList.tsx
    frontend/src/components/profile/ProfileCard.tsx
    frontend/src/components/layout/Sidebar.tsx
    frontend/src/App.tsx
  </files>
  <action>
1. **Add types to `frontend/src/api/types.ts`**:
   - Add `ProfilePublic` interface (id, profile_id, label, description, module_ids[], commit_sha, created_at, updated_at)
   - Add `ModuleEntitiesResponse` interface (categories, properties, subobjects arrays of EntityPublic)

2. **Create `frontend/src/api/modules.ts`** following entities.ts pattern:
   - `fetchModules(search?: string)` -> list of ModulePublic
   - `fetchModule(moduleId: string)` -> ModulePublic
   - `fetchModuleEntities(moduleId: string)` -> ModuleEntitiesResponse
   - `fetchProfiles(search?: string)` -> list of ProfilePublic
   - `fetchProfile(profileId: string)` -> ProfilePublic
   - `fetchProfileModules(profileId: string)` -> list of ModulePublic
   - Hooks: `useModules`, `useModule`, `useModuleEntities`, `useProfiles`, `useProfile`, `useProfileModules`
   - Query keys: `['modules']`, `['module', moduleId]`, `['module-entities', moduleId]`, etc.

3. **Create `frontend/src/components/module/ModuleCard.tsx`**:
   - Card component for module list
   - Shows: label, entity count, 3-5 preview entity badges, dependency badges
   - Uses shadcn Card, CardHeader, CardTitle, CardDescription, CardContent, Badge
   - Links to `/module/{module_id}`
   - Use Package icon from lucide-react

4. **Create `frontend/src/components/module/ModuleEntityList.tsx`**:
   - Groups entities by type (Categories, Properties, Subobjects sections)
   - Each entity links to its detail page (`/{type}/{entity_id}`)
   - Use collapsible sections if list is long (>10 items)

5. **Create `frontend/src/pages/ModulesPage.tsx`**:
   - Header: "Modules" title with description
   - Search input (text search by name)
   - Grid of ModuleCard components (3 cols on lg, 2 on md, 1 on mobile)
   - Loading skeleton states
   - Empty state if no modules

6. **Create `frontend/src/pages/ModulePage.tsx`**:
   - Header with module label and description
   - Dependency badges section (clickable, link to other modules)
   - ModuleEntityList showing grouped entities
   - Error state for 404

7. **Create `frontend/src/components/profile/ProfileCard.tsx`**:
   - Similar to ModuleCard
   - Shows: label, module count, entity summary (X categories, Y properties, Z subobjects)
   - Links to `/profile/{profile_id}`
   - Use Layers icon from lucide-react

8. **Create `frontend/src/pages/ProfilesPage.tsx`**:
   - Same layout as ModulesPage
   - Grid of ProfileCard components

9. **Create `frontend/src/pages/ProfilePage.tsx`**:
   - Header with profile label and description
   - Grid of small ModuleCard components for included modules
   - Entity summary section (total count breakdown)

10. **Update `frontend/src/components/layout/Sidebar.tsx`**:
    - Add "Modules" and "Profiles" navigation sections ABOVE the entity type sections
    - Use Package icon for Modules, Layers icon for Profiles
    - Link to /modules and /profiles pages
    - Show counts in badges

11. **Update `frontend/src/App.tsx`**:
    - Add routes: `/modules`, `/module/:moduleId`, `/profiles`, `/profile/:profileId`
    - Import new page components
  </action>
  <verify>
Run `cd /home/daharoni/dev/ontology-hub/frontend && npm run build` succeeds without errors.
Visit http://localhost:5173/modules and see module list with cards.
Click a module card and see detail page with grouped entities.
Visit http://localhost:5173/profiles and see profile list.
Sidebar shows Modules and Profiles sections with counts.
  </verify>
  <done>
/modules page displays grid of module cards with name, entity preview, and dependencies.
/module/:moduleId page shows module detail with entities grouped by Categories/Properties/Subobjects.
/profiles page displays grid of profile cards with module composition.
/profile/:profileId page shows profile detail with module cards.
Sidebar has Modules and Profiles navigation sections.
All routes work and link correctly.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:
1. `docker compose exec backend pytest tests/test_modules_api.py -v` - all tests pass
2. `cd frontend && npm run build` - builds without errors
3. Navigate to /modules - see module list with cards
4. Click any module - see detail page with grouped entities
5. Navigate to /profiles - see profile list with cards
6. Click any profile - see detail page with module cards
7. Sidebar shows Modules and Profiles sections
</verification>

<success_criteria>
- MODL-01 satisfied: User can browse list of modules seeing included entities and dependencies
- MODL-02 satisfied: User can browse list of profiles seeing which modules compose each profile
- All API endpoints return correct data
- Frontend pages render correctly with loading and error states
- Navigation between list and detail pages works
- Sidebar provides quick access to modules/profiles
</success_criteria>

<output>
After completion, create `.planning/phases/04-modules-and-versioning/04-01-SUMMARY.md`
</output>
