---
phase: 04-modules-and-versioning
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - backend/app/routers/versions.py
  - backend/app/services/versions.py
  - backend/app/services/github.py
  - backend/tests/test_versions_api.py
  - backend/app/main.py
  - frontend/package.json
  - frontend/src/api/versions.ts
  - frontend/src/api/types.ts
  - frontend/src/lib/diff.ts
  - frontend/src/pages/VersionsPage.tsx
  - frontend/src/components/version/VersionList.tsx
  - frontend/src/components/version/DiffViewer.tsx
  - frontend/src/components/version/ChangeGroup.tsx
  - frontend/src/components/layout/Sidebar.tsx
  - frontend/src/App.tsx
autonomous: true

must_haves:
  truths:
    - "User can view list of releases with dates and version labels"
    - "User can view field-level diff between any two versions"
    - "Diffs are grouped by entity type (Categories, Properties, Subobjects)"
    - "Changes are categorized by type (added, modified, deleted)"
    - "Default comparison is latest vs previous version"
  artifacts:
    - path: "backend/app/routers/versions.py"
      provides: "Version/release API endpoints"
      exports: ["router"]
    - path: "backend/app/services/versions.py"
      provides: "Version diff computation service"
      exports: ["compute_version_diff"]
    - path: "frontend/src/lib/diff.ts"
      provides: "jsondiffpatch wrapper"
      exports: ["computeDiff", "classifyChange"]
    - path: "frontend/src/pages/VersionsPage.tsx"
      provides: "Version history page with diff view"
      exports: ["VersionsPage"]
    - path: "frontend/src/components/version/DiffViewer.tsx"
      provides: "Field-level diff display grouped by entity type"
      exports: ["DiffViewer"]
  key_links:
    - from: "frontend/src/pages/VersionsPage.tsx"
      to: "/api/versions"
      via: "useReleases hook"
      pattern: "useReleases\\(\\)"
    - from: "frontend/src/pages/VersionsPage.tsx"
      to: "/api/versions/diff"
      via: "useVersionDiff hook"
      pattern: "useVersionDiff\\("
    - from: "backend/app/routers/versions.py"
      to: "GitHub API"
      via: "GitHubClient.get_releases"
      pattern: "github_client\\.get_releases"
---

<objective>
Create version listing and diff viewing functionality.

Purpose: Satisfy VERS-01, VERS-02, VERS-03 requirements - users can view releases with dates, field-level diffs between versions, and changes categorized by entity type and change type.
Output: Backend version API with GitHub release fetching, frontend version page with diff viewer, jsondiffpatch integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-modules-and-versioning/04-CONTEXT.md
@.planning/phases/04-modules-and-versioning/04-RESEARCH.md
@.planning/phases/04-modules-and-versioning/04-01-SUMMARY.md

# Existing patterns
@backend/app/services/github.py
@frontend/src/api/entities.ts
@frontend/src/components/entity/SchemaTable.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create version API with GitHub release fetching</name>
  <files>
    backend/app/routers/versions.py
    backend/app/services/versions.py
    backend/app/services/github.py
    backend/tests/test_versions_api.py
    backend/app/main.py
  </files>
  <action>
1. **Add to `backend/app/services/github.py`**:
   Add method to fetch releases from GitHub API.

   ```python
   async def get_releases(
       self, owner: str, repo: str, per_page: int = 30
   ) -> list[dict[str, Any]]:
       """Fetch releases from GitHub repository.

       Args:
           owner: Repository owner
           repo: Repository name
           per_page: Number of releases to fetch (max 100)

       Returns:
           List of release objects with tag_name, name, created_at, published_at, body
       """
       url = f"/repos/{owner}/{repo}/releases"
       return await self._request("GET", url, params={"per_page": per_page})

   async def get_file_at_ref(
       self, owner: str, repo: str, path: str, ref: str
   ) -> dict[str, Any]:
       """Fetch and decode a JSON file at a specific git ref (tag/sha).

       Same as get_file_content but with explicit ref parameter.
       """
       return await self.get_file_content(owner, repo, path, ref=ref)
   ```

2. **Create `backend/app/services/versions.py`**:
   Service for computing diffs between versions.

   ```python
   from typing import Any
   from app.services.github import GitHubClient, ENTITY_DIRECTORIES
   from app.config import settings

   async def get_entities_at_version(
       github_client: GitHubClient,
       ref: str,
   ) -> dict[str, dict[str, Any]]:
       """Fetch all entities at a specific git ref.

       Returns: dict mapping "type/entity_id" to entity data
       """
       owner, repo = settings.github_repo.split("/")

       # Get tree at this ref
       tree = await github_client.get_repository_tree(owner, repo, sha=ref)

       entities = {}
       for entry in tree:
           path = entry["path"]
           parts = path.split("/")
           if len(parts) != 2:
               continue
           entity_type, filename = parts
           if entity_type not in ENTITY_DIRECTORIES:
               continue
           if not filename.endswith(".json"):
               continue

           entity_id = filename[:-5]  # Remove .json
           content = await github_client.get_file_at_ref(owner, repo, path, ref)
           entities[f"{entity_type}/{entity_id}"] = content

       return entities

   def compute_entity_diff(
       old_entities: dict[str, dict[str, Any]],
       new_entities: dict[str, dict[str, Any]],
   ) -> dict[str, list[dict[str, Any]]]:
       """Compute diff between two entity snapshots.

       Returns: {
           "added": [{"key": "...", "entity_type": "...", "entity_id": "...", "new": {...}}],
           "modified": [{"key": "...", "entity_type": "...", "entity_id": "...", "old": {...}, "new": {...}}],
           "deleted": [{"key": "...", "entity_type": "...", "entity_id": "...", "old": {...}}],
       }
       """
       all_keys = set(old_entities.keys()) | set(new_entities.keys())

       added, modified, deleted = [], [], []

       for key in all_keys:
           entity_type, entity_id = key.split("/", 1)
           old = old_entities.get(key)
           new = new_entities.get(key)

           if old is None and new is not None:
               added.append({"key": key, "entity_type": entity_type, "entity_id": entity_id, "new": new})
           elif old is not None and new is None:
               deleted.append({"key": key, "entity_type": entity_type, "entity_id": entity_id, "old": old})
           elif old != new:
               modified.append({"key": key, "entity_type": entity_type, "entity_id": entity_id, "old": old, "new": new})

       return {"added": added, "modified": modified, "deleted": deleted}
   ```

3. **Create `backend/app/routers/versions.py`**:

   ```python
   from fastapi import APIRouter, HTTPException, Query, Request
   from pydantic import BaseModel
   from typing import Any

   from app.dependencies.rate_limit import RATE_LIMITS, limiter
   from app.services.versions import get_entities_at_version, compute_entity_diff
   from app.config import settings

   router = APIRouter(prefix="/versions", tags=["versions"])

   class ReleasePublic(BaseModel):
       tag_name: str
       name: str | None
       created_at: str
       published_at: str | None
       body: str | None

   class VersionDiffResponse(BaseModel):
       old_version: str
       new_version: str
       categories: dict[str, list[dict[str, Any]]]  # added, modified, deleted
       properties: dict[str, list[dict[str, Any]]]
       subobjects: dict[str, list[dict[str, Any]]]
       modules: dict[str, list[dict[str, Any]]]
       profiles: dict[str, list[dict[str, Any]]]

   @router.get("/", response_model=list[ReleasePublic])
   @limiter.limit(RATE_LIMITS["entity_list"])
   async def list_releases(request: Request) -> list[ReleasePublic]:
       """List all releases from GitHub repository."""
       github_client = request.app.state.github_client
       if not github_client:
           raise HTTPException(status_code=503, detail="GitHub client not configured")

       owner, repo = settings.github_repo.split("/")
       releases = await github_client.get_releases(owner, repo)

       return [
           ReleasePublic(
               tag_name=r["tag_name"],
               name=r.get("name"),
               created_at=r["created_at"],
               published_at=r.get("published_at"),
               body=r.get("body"),
           )
           for r in releases
       ]

   @router.get("/diff", response_model=VersionDiffResponse)
   @limiter.limit(RATE_LIMITS["entity_read"])
   async def get_version_diff(
       request: Request,
       old: str = Query(..., description="Old version tag"),
       new: str = Query(..., description="New version tag"),
   ) -> VersionDiffResponse:
       """Get field-level diff between two versions."""
       github_client = request.app.state.github_client
       if not github_client:
           raise HTTPException(status_code=503, detail="GitHub client not configured")

       # Fetch entities at both versions
       old_entities = await get_entities_at_version(github_client, old)
       new_entities = await get_entities_at_version(github_client, new)

       # Compute diff
       diff = compute_entity_diff(old_entities, new_entities)

       # Group by entity type
       def group_by_type(changes: list[dict], change_type: str) -> dict[str, list]:
           groups: dict[str, list] = {
               "categories": [], "properties": [], "subobjects": [],
               "modules": [], "profiles": []
           }
           for change in changes:
               et = change["entity_type"]
               if et in groups:
                   groups[et].append(change)
           return groups

       categories = {"added": [], "modified": [], "deleted": []}
       properties = {"added": [], "modified": [], "deleted": []}
       subobjects = {"added": [], "modified": [], "deleted": []}
       modules = {"added": [], "modified": [], "deleted": []}
       profiles = {"added": [], "modified": [], "deleted": []}

       for change_type in ["added", "modified", "deleted"]:
           for change in diff[change_type]:
               et = change["entity_type"]
               if et == "categories":
                   categories[change_type].append(change)
               elif et == "properties":
                   properties[change_type].append(change)
               elif et == "subobjects":
                   subobjects[change_type].append(change)
               elif et == "modules":
                   modules[change_type].append(change)
               elif et == "profiles":
                   profiles[change_type].append(change)

       return VersionDiffResponse(
           old_version=old,
           new_version=new,
           categories=categories,
           properties=properties,
           subobjects=subobjects,
           modules=modules,
           profiles=profiles,
       )
   ```

4. **Register in `backend/app/main.py`**:
   ```python
   from app.routers import versions
   app.include_router(versions.router)
   ```

5. **Create tests in `backend/tests/test_versions_api.py`**:
   - Test list releases returns expected format (mock GitHub client)
   - Test diff endpoint returns grouped changes
   - Test 503 when GitHub client not configured
  </action>
  <verify>
Run `cd /home/daharoni/dev/ontology-hub && docker compose exec backend pytest tests/test_versions_api.py -v` and tests pass.
If GITHUB_TOKEN is set, verify: `curl "http://localhost:8080/api/versions" | jq .` returns release list.
  </verify>
  <done>
GET /versions returns list of releases with tag_name, name, created_at, published_at, body.
GET /versions/diff?old=v1.0.0&new=v1.1.0 returns changes grouped by entity type.
Changes are categorized as added, modified, deleted.
503 returned when GitHub client not configured.
All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create version frontend with diff viewer</name>
  <files>
    frontend/package.json
    frontend/src/api/versions.ts
    frontend/src/api/types.ts
    frontend/src/lib/diff.ts
    frontend/src/pages/VersionsPage.tsx
    frontend/src/components/version/VersionList.tsx
    frontend/src/components/version/DiffViewer.tsx
    frontend/src/components/version/ChangeGroup.tsx
    frontend/src/components/layout/Sidebar.tsx
    frontend/src/App.tsx
  </files>
  <action>
1. **Install jsondiffpatch**:
   Run in frontend directory: `npm install jsondiffpatch`

2. **Add types to `frontend/src/api/types.ts`**:
   ```typescript
   export interface ReleasePublic {
     tag_name: string
     name: string | null
     created_at: string
     published_at: string | null
     body: string | null
   }

   export interface EntityChange {
     key: string
     entity_type: string
     entity_id: string
     old?: Record<string, unknown>
     new?: Record<string, unknown>
   }

   export interface ChangesByType {
     added: EntityChange[]
     modified: EntityChange[]
     deleted: EntityChange[]
   }

   export interface VersionDiffResponse {
     old_version: string
     new_version: string
     categories: ChangesByType
     properties: ChangesByType
     subobjects: ChangesByType
     modules: ChangesByType
     profiles: ChangesByType
   }
   ```

3. **Create `frontend/src/api/versions.ts`**:
   ```typescript
   import { useQuery } from '@tanstack/react-query'
   import { apiFetch } from './client'
   import type { ReleasePublic, VersionDiffResponse } from './types'

   async function fetchReleases(): Promise<ReleasePublic[]> {
     return apiFetch('/versions/')
   }

   async function fetchVersionDiff(oldVersion: string, newVersion: string): Promise<VersionDiffResponse> {
     const params = new URLSearchParams({ old: oldVersion, new: newVersion })
     return apiFetch(`/versions/diff?${params.toString()}`)
   }

   export function useReleases() {
     return useQuery({
       queryKey: ['releases'],
       queryFn: fetchReleases,
     })
   }

   export function useVersionDiff(oldVersion: string | null, newVersion: string | null) {
     return useQuery({
       queryKey: ['version-diff', oldVersion, newVersion],
       queryFn: () => fetchVersionDiff(oldVersion!, newVersion!),
       enabled: !!oldVersion && !!newVersion,
     })
   }
   ```

4. **Create `frontend/src/lib/diff.ts`**:
   jsondiffpatch wrapper for field-level diff computation.
   ```typescript
   import * as jsondiffpatch from 'jsondiffpatch'

   const diffpatcher = jsondiffpatch.create({
     objectHash: (obj: Record<string, unknown>) =>
       (obj as { id?: string }).id ||
       (obj as { entity_id?: string }).entity_id ||
       JSON.stringify(obj),
     arrays: {
       detectMove: true,
     },
   })

   export type DiffDelta = jsondiffpatch.Delta

   export function computeDiff(oldValue: unknown, newValue: unknown): DiffDelta | undefined {
     return diffpatcher.diff(oldValue, newValue)
   }

   export function classifyChange(delta: unknown): 'added' | 'modified' | 'deleted' | 'unchanged' {
     if (delta === undefined) return 'unchanged'
     if (Array.isArray(delta)) {
       if (delta.length === 1) return 'added'      // [newValue]
       if (delta.length === 2) return 'modified'   // [oldValue, newValue]
       if (delta.length === 3 && delta[2] === 0) return 'deleted'  // [oldValue, 0, 0]
     }
     return 'modified' // Nested object changes
   }

   export function formatPath(path: string): string {
     // Convert JSON path to human-readable format
     return path
       .replace(/\./g, ' > ')
       .replace(/\[(\d+)\]/g, ' [$1]')
   }
   ```

5. **Create `frontend/src/components/version/ChangeGroup.tsx`**:
   Component for displaying a group of changes (added/modified/deleted).
   ```typescript
   interface ChangeGroupProps {
     title: string
     changes: EntityChange[]
     variant: 'success' | 'warning' | 'destructive'
   }
   ```
   - Collapsible section for each change group
   - Count badge in header
   - Each entity shows entity_id and links to detail page
   - For modified: show jsondiffpatch diff of old vs new

6. **Create `frontend/src/components/version/DiffViewer.tsx`**:
   Main diff display component.
   ```typescript
   interface DiffViewerProps {
     diff: VersionDiffResponse
   }
   ```
   - Sections for each entity type: Categories, Properties, Subobjects, Modules, Profiles
   - Each section shows ChangeGroup for added, modified, deleted
   - Skip sections with no changes
   - Use Card/CardHeader/CardContent for structure

7. **Create `frontend/src/components/version/VersionList.tsx`**:
   List of releases for selection.
   ```typescript
   interface VersionListProps {
     releases: ReleasePublic[]
     selected?: string
     onSelect: (tagName: string) => void
   }
   ```
   - Table or timeline layout showing version, date, optional release notes preview
   - Highlight selected version
   - Click to select for comparison

8. **Create `frontend/src/pages/VersionsPage.tsx`**:
   Main version history page.
   - Header: "Version History"
   - Two version selectors (dropdowns): "Compare [old] with [new]"
   - Default: compare latest (index 0) with previous (index 1)
   - DiffViewer component showing the diff
   - VersionList showing all releases below
   - Loading states with Skeleton
   - Handle case where repo has no releases

9. **Update `frontend/src/components/layout/Sidebar.tsx`**:
   - Add "Versions" link above entity sections
   - Use History icon from lucide-react
   - Link to /versions

10. **Update `frontend/src/App.tsx`**:
    - Add route: `/versions` -> VersionsPage
  </action>
  <verify>
Run `cd /home/daharoni/dev/ontology-hub/frontend && npm run build` succeeds.
Visit http://localhost:5173/versions and see version list.
Select two versions and see diff viewer with changes grouped by entity type.
Changes show added (green), modified (yellow), deleted (red) styling.
Sidebar shows Versions link.
  </verify>
  <done>
/versions page displays list of releases with dates and names.
Version selector allows comparing any two versions.
Default comparison is latest vs previous.
DiffViewer groups changes by entity type (Categories, Properties, etc.).
Each group shows added/modified/deleted changes.
Modified entities show field-level diff details.
Sidebar has Versions navigation link.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:
1. `docker compose exec backend pytest tests/test_versions_api.py -v` - all tests pass
2. `cd frontend && npm run build` - builds without errors
3. Navigate to /versions - see release list
4. Select two versions - see diff grouped by entity type
5. Added entities show green styling
6. Modified entities show yellow styling with field-level diff
7. Deleted entities show red styling
8. Sidebar shows Versions link
</verification>

<success_criteria>
- VERS-01 satisfied: User can view list of releases with dates and version labels
- VERS-02 satisfied: User can view field-level diff between any two versions
- VERS-03 satisfied: Diffs categorize changes by entity type and change type
- Default comparison is latest vs previous per CONTEXT.md decision
- jsondiffpatch used for diff computation per RESEARCH.md recommendation
- Changes grouped by entity type (Categories, Properties, Subobjects, Modules, Profiles)
</success_criteria>

<output>
After completion, create `.planning/phases/04-modules-and-versioning/04-03-SUMMARY.md`
</output>
