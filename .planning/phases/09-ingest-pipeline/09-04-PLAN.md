---
phase: 09-ingest-pipeline
plan: 04
type: execute
wave: 3
depends_on: ["09-03"]
files_modified:
  - backend/app/routers/webhooks.py
  - backend/app/services/github.py
autonomous: true

must_haves:
  truths:
    - "Webhook endpoint triggers v2.0 ingest on push events"
    - "Active drafts are marked stale when new canonical is ingested"
    - "ENTITY_DIRECTORIES includes all 6 entity types plus bundles and templates"
  artifacts:
    - path: "backend/app/routers/webhooks.py"
      provides: "Extended webhook handler with v2.0 ingest and draft staleness"
      contains: "trigger_sync_background_v2"
    - path: "backend/app/services/github.py"
      provides: "Updated ENTITY_DIRECTORIES constant"
      contains: "bundles"
  key_links:
    - from: "webhooks.py"
      to: "app.services.ingest_v2.sync_repository_v2"
      via: "import and call in background task"
      pattern: "from app.services.ingest_v2 import sync_repository_v2"
    - from: "webhooks.py"
      to: "app.models.v2.Draft"
      via: "Update query for stale marking"
      pattern: "update.*Draft"
---

<objective>
Wire up the v2.0 ingest service to the webhook endpoint and implement draft staleness marking when canonical data changes.

Purpose: ING-01 requires webhook-triggered ingest. CONTEXT.md requires marking drafts as stale when canonical updates.
Output: Complete end-to-end ingest pipeline triggered by GitHub push events.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-ingest-pipeline/09-RESEARCH.md
@.planning/phases/09-ingest-pipeline/09-03-SUMMARY.md

# Files to modify
@backend/app/routers/webhooks.py
@backend/app/services/github.py

# Draft model for staleness
@backend/app/models/v2/draft.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update ENTITY_DIRECTORIES in github.py</name>
  <files>backend/app/services/github.py</files>
  <action>
Update the ENTITY_DIRECTORIES constant to include all 6 v2.0 entity types:

Change from:
```python
ENTITY_DIRECTORIES = frozenset(
    {"categories", "properties", "subobjects", "modules", "profiles"}
)
```

To:
```python
# Directories containing entity JSON files (v2.0)
ENTITY_DIRECTORIES = frozenset(
    {"categories", "properties", "subobjects", "modules", "bundles", "templates"}
)
```

This ensures get_repository_tree() returns files from all 6 entity directories, including templates (which may be nested like `templates/Property/Page.json`).
  </action>
  <verify>
Run Python test:
```bash
cd /home/daharoni/dev/ontology-hub/backend
python -c "from app.services.github import ENTITY_DIRECTORIES; print(sorted(ENTITY_DIRECTORIES))"
```
Expected output: `['bundles', 'categories', 'modules', 'properties', 'subobjects', 'templates']`
  </verify>
  <done>ENTITY_DIRECTORIES includes all 6 v2.0 entity types</done>
</task>

<task type="auto">
  <name>Task 2: Add v2.0 background task and draft staleness</name>
  <files>backend/app/routers/webhooks.py</files>
  <action>
Extend webhooks.py to add v2.0 ingest and draft staleness:

1. Add imports at top:
```python
from sqlalchemy import select, update
from app.services.ingest_v2 import sync_repository_v2
from app.models.v2 import Draft, DraftStatus, OntologyVersion
```

2. Add helper function to mark drafts stale:
```python
async def mark_drafts_stale(
    session: AsyncSession,
    old_commit_sha: str | None,
    new_commit_sha: str,
) -> int:
    """Mark active drafts as stale when canonical changes.

    Args:
        session: Database session
        old_commit_sha: Previous canonical commit (None if first ingest)
        new_commit_sha: New canonical commit

    Returns:
        Number of drafts marked stale
    """
    if not old_commit_sha:
        return 0

    result = await session.execute(
        update(Draft)
        .where(Draft.base_commit_sha == old_commit_sha)
        .where(Draft.status.in_([DraftStatus.DRAFT, DraftStatus.VALIDATED]))
        .values(rebase_status="stale")
    )
    await session.commit()
    return result.rowcount
```

3. Add v2.0 background task function:
```python
async def trigger_sync_background_v2(httpx_client: Any) -> None:
    """Background task to sync repository using v2.0 ingest.

    Creates its own database session since FastAPI BackgroundTasks
    run after the request context is closed.

    Args:
        httpx_client: Pre-configured httpx.AsyncClient from app.state
    """
    async with async_session_maker() as session:
        github_client = GitHubClient(httpx_client)
        try:
            # Get previous commit SHA for draft staleness detection
            prev_version = (
                await session.execute(
                    select(OntologyVersion).order_by(OntologyVersion.created_at.desc())
                )
            ).scalars().first()
            old_commit_sha = prev_version.commit_sha if prev_version else None

            # Run v2.0 ingest
            result = await sync_repository_v2(
                github_client=github_client,
                session=session,
                owner=settings.GITHUB_REPO_OWNER,
                repo=settings.GITHUB_REPO_NAME,
            )
            logger.info("v2.0 sync complete: %s", result)

            # Mark drafts as stale if canonical changed
            if result.get("status") == "completed" and old_commit_sha:
                stale_count = await mark_drafts_stale(
                    session, old_commit_sha, result["commit_sha"]
                )
                if stale_count > 0:
                    logger.info("Marked %d drafts as stale", stale_count)

        except Exception as e:
            logger.error("v2.0 sync failed: %s", e, exc_info=True)
```

4. Update the github_webhook endpoint to call v2.0:
In the `if event_type != "push"` block, after the check, change:
```python
# Trigger background sync (v2.0)
background_tasks.add_task(trigger_sync_background_v2, httpx_client)
```

Replace the old v1.0 call `trigger_sync_background` with `trigger_sync_background_v2`.

Keep the old v1.0 function for backward compatibility but it won't be called.
  </action>
  <verify>
Run Python import test:
```bash
cd /home/daharoni/dev/ontology-hub/backend
python -c "
from app.routers.webhooks import trigger_sync_background_v2, mark_drafts_stale
print('OK')
"
```
  </verify>
  <done>Webhook endpoint triggers v2.0 ingest and marks drafts stale</done>
</task>

<task type="auto">
  <name>Task 3: Verify end-to-end import chain</name>
  <files>backend/app/routers/webhooks.py</files>
  <action>
Verify the complete import chain works by running a dry import test.

This is a verification task - no code changes needed, just run the test to ensure all pieces connect.

Test script:
```python
# Test complete import chain
from app.routers.webhooks import github_webhook, trigger_sync_background_v2
from app.services.ingest_v2 import sync_repository_v2, IngestService
from app.services.validators import SchemaValidator
from app.services.parsers import EntityParser, ParsedEntities
from app.models.v2 import (
    OntologyVersion, Category, Property, Subobject, Module, Bundle, Template,
    CategoryParent, CategoryProperty, ModuleEntity, BundleModule,
    refresh_category_property_effective,
)
print("All imports successful - ingest pipeline wired correctly")
```
  </action>
  <verify>
Run the verification script:
```bash
cd /home/daharoni/dev/ontology-hub/backend
python -c "
from app.routers.webhooks import github_webhook, trigger_sync_background_v2
from app.services.ingest_v2 import sync_repository_v2, IngestService
from app.services.validators import SchemaValidator
from app.services.parsers import EntityParser, ParsedEntities
from app.models.v2 import (
    OntologyVersion, Category, Property, Subobject, Module, Bundle, Template,
    CategoryParent, CategoryProperty, ModuleEntity, BundleModule,
    refresh_category_property_effective,
)
print('All imports successful - ingest pipeline wired correctly')
"
```
  </verify>
  <done>Complete import chain verified - webhook -> ingest -> validators -> parsers -> models</done>
</task>

</tasks>

<verification>
1. ENTITY_DIRECTORIES includes bundles and templates (replacing profiles)
2. `trigger_sync_background_v2` function exists and calls `sync_repository_v2`
3. `mark_drafts_stale` function updates Draft.rebase_status
4. `github_webhook` endpoint calls `trigger_sync_background_v2` (not v1.0)
5. Complete import chain from webhooks.py -> ingest_v2.py -> validators -> parsers -> models works
</verification>

<success_criteria>
- ENTITY_DIRECTORIES updated to v2.0 entity types (no more profiles)
- Webhook push handler triggers v2.0 ingest via trigger_sync_background_v2
- Draft staleness: active drafts marked stale when canonical commit changes
- End-to-end import chain verified working
</success_criteria>

<output>
After completion, create `.planning/phases/09-ingest-pipeline/09-04-SUMMARY.md`
</output>
