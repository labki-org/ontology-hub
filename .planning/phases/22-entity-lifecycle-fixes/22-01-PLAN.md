---
phase: 22-entity-lifecycle-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/api/draftApiV2.ts
  - backend/app/services/graph_query.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User creates new entity and sees it appear in graph view immediately"
    - "Graph shows isolated draft-created entities (no parents) as single node"
    - "Draft-created entities display 'added' badge in graph"
  artifacts:
    - path: "frontend/src/api/draftApiV2.ts"
      provides: "Graph cache invalidation on entity creation/deletion"
      contains: "invalidateQueries.*graph"
    - path: "backend/app/services/graph_query.py"
      provides: "Isolated draft node handling"
      contains: "isolated draft"
  key_links:
    - from: "useCreateEntityChange.onSuccess"
      to: "graph queries"
      via: "queryClient.invalidateQueries"
      pattern: "invalidateQueries.*queryKey.*graph"
    - from: "get_neighborhood_graph"
      to: "draft_creates"
      via: "isolated node check"
      pattern: "not rows.*draft_creates"
---

<objective>
Fix graph cache invalidation so newly created entities appear in graph view immediately, including isolated entities with no relationships.

Purpose: Closes BUG-001 from v2.1 audit - graph doesn't update when new entities are created
Output: Graph refreshes automatically after entity creation, isolated draft entities render as single nodes
</objective>

<execution_context>
@/home/daharoni/.claude/get-shit-done/workflows/execute-plan.md
@/home/daharoni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/22-entity-lifecycle-fixes/22-RESEARCH.md

# Key source files
@frontend/src/api/draftApiV2.ts
@backend/app/services/graph_query.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add graph cache invalidation to entity mutations</name>
  <files>frontend/src/api/draftApiV2.ts</files>
  <action>
In `useCreateEntityChange` (around line 206), add graph cache invalidation after the existing entity list invalidations:

```typescript
// Invalidate graph queries to refresh graph view
queryClient.invalidateQueries({ queryKey: ['graph'] })
```

Also add the same invalidation to `useDeleteEntityChange` (around line 256) for consistency - deleted entities should also trigger graph refresh.

And add to `useUndoDeleteChange` (around line 290) since undoing a delete restores an entity.

This broad invalidation pattern (`['graph']`) catches all graph query variants (neighborhood, module, etc.) without needing to know specific entity keys.
  </action>
  <verify>
1. Read the modified file and confirm invalidateQueries with ['graph'] appears in all three mutation hooks
2. Run `npm run build` in frontend to verify TypeScript compiles
  </verify>
  <done>
- useCreateEntityChange invalidates graph queries on success
- useDeleteEntityChange invalidates graph queries on success
- useUndoDeleteChange invalidates graph queries on success
  </done>
</task>

<task type="auto">
  <name>Task 2: Handle isolated draft-created entities in graph query</name>
  <files>backend/app/services/graph_query.py</files>
  <action>
In `get_neighborhood_graph`, after the CTE query executes and before processing rows (around line 145), add handling for isolated draft-created entities.

The current flow:
1. CTE query runs for entity_key
2. If entity doesn't exist in DB, CTE returns empty rows
3. Draft-created entities with parents get added later, but isolated ones (no parents) don't

Fix: After line 142 (`rows = result.fetchall()`), add:

```python
# Handle isolated draft-created entities (GRAPH-05)
# If CTE returned no rows but entity exists in draft creates, it's an isolated node
if not rows:
    draft_creates = await self.draft_overlay.get_draft_creates("category")
    draft_match = next(
        (c for c in draft_creates if c.get("entity_key") == entity_key),
        None,
    )
    if draft_match:
        # Return isolated draft node as single-node graph
        return GraphResponse(
            nodes=[
                GraphNode(
                    id=entity_key,
                    label=draft_match.get("label", entity_key),
                    entity_type=entity_type,
                    depth=0,
                    modules=[],
                    change_status="added",
                )
            ],
            edges=[],
            has_cycles=False,
        )
```

This must come AFTER line 142 and BEFORE line 145 (`entity_keys = [row.entity_key for row in rows]`).

Note: The existing draft_match check at lines 77-85 already validates the entity exists. This new block handles the empty CTE result case by returning early with the isolated node.
  </action>
  <verify>
1. Read the modified file and confirm the isolated draft handling block exists
2. Run `cd backend && python -m pytest tests/ -v -k "graph"` to verify no regressions
3. Manually test: Start draft, create new category with no parents, click on it in sidebar, verify graph shows single node
  </verify>
  <done>
- Isolated draft-created entities render as single-node graphs
- Graph shows entity with "added" badge and depth=0
- No regression in existing graph functionality
  </done>
</task>

</tasks>

<verification>
1. Create a new draft
2. Create a new category with NO parent categories
3. Click on the new category in sidebar
4. Verify graph view shows the category as a single node (not "No graph data")
5. Verify node has "added" badge/styling
6. Create another category WITH a parent (existing or new)
7. Verify graph shows both nodes connected
</verification>

<success_criteria>
- Graph refreshes automatically when entities are created (no manual refresh needed)
- Isolated draft-created entities appear as single nodes in graph view
- Draft-created entities with parents appear connected to their parents
- All draft-created entities show "added" change_status badge
</success_criteria>

<output>
After completion, create `.planning/phases/22-entity-lifecycle-fixes/22-01-SUMMARY.md`
</output>
