---
phase: 22-entity-lifecycle-fixes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/routers/draft_changes.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User can delete a newly created entity from the current draft session"
    - "Deleting draft-created entity removes the CREATE change entirely"
    - "Draft changes list no longer shows the CREATE after deletion"
  artifacts:
    - path: "backend/app/routers/draft_changes.py"
      provides: "CREATE->DELETE special case handling"
      contains: "existing_change.change_type == ChangeType.CREATE"
  key_links:
    - from: "add_draft_change"
      to: "session.delete"
      via: "CREATE->DELETE detection"
      pattern: "DELETE.*existing.*CREATE.*session.delete"
---

<objective>
Fix backend logic to properly handle deletion of draft-created entities by removing the CREATE change instead of replacing it with DELETE.

Purpose: Closes BUG-002 from v2.1 audit - delete functionality fails for newly created entities
Output: Deleting a draft-created entity removes the CREATE change record entirely
</objective>

<execution_context>
@/home/daharoni/.claude/get-shit-done/workflows/execute-plan.md
@/home/daharoni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/22-entity-lifecycle-fixes/22-RESEARCH.md

# Key source file
@backend/app/routers/draft_changes.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix CREATE->DELETE handling in add_draft_change</name>
  <files>backend/app/routers/draft_changes.py</files>
  <action>
In `add_draft_change` function, modify the handling at lines 263-268 to detect when a DELETE is requested for a draft-created entity and remove the CREATE change instead of replacing it.

Current problematic code (lines 263-268):
```python
elif existing_change:
    # For CREATE/DELETE, replace the existing change entirely
    existing_change.change_type = change_in.change_type
    existing_change.patch = change_in.patch
    existing_change.replacement_json = change_in.replacement_json
    change = existing_change
```

Replace with:
```python
elif existing_change:
    # Special case: DELETE of a draft-created entity
    # Instead of replacing CREATE with DELETE, remove the CREATE entirely
    # (the entity never existed in canonical, so there's nothing to delete)
    if change_in.change_type == ChangeType.DELETE and existing_change.change_type == ChangeType.CREATE:
        await session.delete(existing_change)
        # Update draft modified_at
        draft.modified_at = datetime.utcnow()
        session.add(draft)
        await session.commit()
        # Return a special response indicating the change was removed
        # Use the existing change data for the response (it no longer exists but we need something to return)
        return DraftChangeResponse(
            id=existing_change.id,
            change_type=ChangeType.DELETE,
            entity_type=existing_change.entity_type,
            entity_key=existing_change.entity_key,
            patch=None,
            replacement_json=None,
            created_at=existing_change.created_at,
        )

    # For other cases (CREATE->CREATE, DELETE->DELETE), replace the existing change entirely
    existing_change.change_type = change_in.change_type
    existing_change.patch = change_in.patch
    existing_change.replacement_json = change_in.replacement_json
    change = existing_change
```

This ensures:
1. When DELETE is requested for a draft-created entity (existing CREATE), the CREATE record is deleted
2. The draft's modified_at is updated
3. A response is returned indicating success (using DELETE type to signal the deletion happened)
4. Other replacement cases (CREATE->CREATE for re-creation) continue to work
  </action>
  <verify>
1. Read the modified file and confirm the CREATE->DELETE special case handling exists
2. Run `cd backend && python -m pytest tests/ -v -k "draft"` to verify no regressions
3. Test manually:
   - Start a draft
   - Create a new entity
   - Verify GET /api/v2/drafts/{token}/changes shows the CREATE
   - Delete the entity via sidebar
   - Verify GET /api/v2/drafts/{token}/changes no longer shows any change for that entity
  </verify>
  <done>
- DELETE of draft-created entity removes the CREATE change
- Draft changes list is empty after creating then deleting an entity
- No errors in API responses
- Existing draft change handling continues to work for UPDATE and canonical DELETE
  </done>
</task>

<task type="auto">
  <name>Task 2: Add graph invalidation to frontend delete mutation</name>
  <files>frontend/src/api/draftApiV2.ts</files>
  <action>
This was already addressed in Plan 01 Task 1, but verify it's in place.

If Plan 01 runs first, this is a no-op verification.
If Plan 02 runs first, add the graph invalidation to `useDeleteEntityChange.onSuccess`:

```typescript
// Invalidate graph queries to refresh graph view
queryClient.invalidateQueries({ queryKey: ['graph'] })
```

The deleted entity should disappear from the graph view immediately after deletion.
  </action>
  <verify>
1. Confirm `useDeleteEntityChange.onSuccess` includes graph query invalidation
2. Run `npm run build` in frontend to verify TypeScript compiles
  </verify>
  <done>
- useDeleteEntityChange invalidates graph queries on success
- Graph view updates after entity deletion
  </done>
</task>

</tasks>

<verification>
1. Start a new draft
2. Create a new category via "+ New Category" button
3. Verify it appears in sidebar with "added" styling
4. Click delete (trash icon) on the newly created category
5. Verify:
   - Category is removed from sidebar
   - No errors in browser console
   - No errors in backend logs
6. Check draft changes via API: `GET /api/v2/drafts/{token}/changes`
7. Verify the response shows NO changes (the CREATE was removed, not converted to DELETE)
</verification>

<success_criteria>
- Deleting a draft-created entity removes it from the sidebar
- The CREATE change is removed entirely (not replaced with DELETE)
- Draft changes list is empty after create+delete cycle
- Graph updates to reflect the deletion (if entity was visible in graph)
- No API errors or console errors during the flow
</success_criteria>

<output>
After completion, create `.planning/phases/22-entity-lifecycle-fixes/22-02-SUMMARY.md`
</output>
