---
phase: 03-entity-browsing
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - backend/app/routers/entities.py
  - backend/app/schemas/entity.py
  - backend/app/services/inheritance.py
  - backend/tests/test_entities_api.py
  - frontend/package.json
  - frontend/src/api/entities.ts
  - frontend/src/api/types.ts
  - frontend/src/components/graph/InheritanceGraph.tsx
  - frontend/src/components/graph/CategoryNode.tsx
  - frontend/src/components/graph/useGraphLayout.ts
  - frontend/src/components/entity/UsedByList.tsx
  - frontend/src/components/entity/PropertyList.tsx
  - frontend/src/pages/CategoryPage.tsx
  - frontend/src/pages/PropertyPage.tsx
  - frontend/src/pages/SubobjectPage.tsx
  - frontend/src/pages/GraphExplorerPage.tsx
  - frontend/src/App.tsx
autonomous: true

must_haves:
  truths:
    - "User can see inheritance graph showing parent/child category relationships"
    - "User can see which categories use a given property or subobject"
    - "Category pages show properties with inheritance chain indicators"
    - "Graph is interactive - nodes are clickable to navigate"
  artifacts:
    - path: "backend/app/routers/entities.py"
      provides: "Inheritance and used-by endpoints"
      contains: "inheritance"
    - path: "backend/app/services/inheritance.py"
      provides: "Inheritance resolution logic"
      min_lines: 30
    - path: "frontend/src/components/graph/InheritanceGraph.tsx"
      provides: "React Flow graph visualization"
      min_lines: 50
    - path: "frontend/src/components/entity/UsedByList.tsx"
      provides: "Used-by reference list"
      min_lines: 20
  key_links:
    - from: "frontend/src/components/graph/InheritanceGraph.tsx"
      to: "/api/v1/entities/category/{id}/inheritance"
      via: "TanStack Query"
      pattern: "useInheritance"
    - from: "frontend/src/components/entity/UsedByList.tsx"
      to: "/api/v1/entities/{type}/{id}/used-by"
      via: "TanStack Query"
      pattern: "useUsedBy"
---

<objective>
Add inheritance graph visualization for categories and used-by references for properties/subobjects.

Purpose: Users need to understand entity relationships - which categories inherit from which parents, and which categories use specific properties or subobjects. This completes the browsing experience by revealing the ontology structure.

Output: Interactive inheritance graph on category pages, used-by lists on property/subobject pages, full graph explorer page
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-entity-browsing/03-CONTEXT.md
@.planning/phases/03-entity-browsing/03-RESEARCH.md
@.planning/phases/03-entity-browsing/03-01-SUMMARY.md

# Existing entity router to extend
@backend/app/routers/entities.py
@backend/app/models/entity.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Backend Inheritance and Used-By Endpoints</name>
  <files>
    backend/app/routers/entities.py
    backend/app/schemas/entity.py
    backend/app/services/inheritance.py
    backend/app/services/__init__.py
    backend/tests/test_entities_api.py
  </files>
  <action>
    Add inheritance resolution service and API endpoints:

    1. Create backend/app/services/inheritance.py:
       ```python
       async def get_inheritance_chain(
           session: AsyncSession,
           entity_id: str
       ) -> InheritanceResponse:
           """Resolve full inheritance chain for a category.

           Returns nodes (categories) and edges (parent relationships)
           for React Flow graph visualization.
           """
       ```

       Logic:
       - Start with target category
       - Recursively resolve parent categories (schema_definition["parent"])
       - Find child categories (categories where parent == entity_id)
       - Build nodes list with: id, label, entity_id, is_current (bool)
       - Build edges list with: source (child), target (parent)
       - Handle circular references gracefully (break cycle, mark as circular)
       - Return InheritanceResponse with nodes, edges, has_circular flag

    2. Add schemas to backend/app/schemas/entity.py:
       ```python
       class InheritanceNode(BaseModel):
           id: str          # entity_id for React Flow
           label: str
           entity_id: str
           is_current: bool

       class InheritanceEdge(BaseModel):
           source: str      # child entity_id
           target: str      # parent entity_id

       class InheritanceResponse(BaseModel):
           nodes: list[InheritanceNode]
           edges: list[InheritanceEdge]
           has_circular: bool = False
       ```

    3. Add GET /entities/category/{entity_id}/inheritance endpoint:
       - Returns InheritanceResponse
       - Rate limited to entity_read limit
       - 404 if category not found

    4. Add GET /entities/{entity_type}/{entity_id}/used-by endpoint:
       - Only valid for property and subobject types (return 400 for category)
       - Search categories where schema_definition["properties"] or ["subobjects"] contains entity_id
       - Use JSONB contains operator: `Entity.schema_definition["properties"].contains([entity_id])`
       - Return list[EntityPublic] of using categories
       - Rate limited

    5. Add tests:
       - test_inheritance_single_category: category with no parent returns self as node
       - test_inheritance_with_parent: category with parent returns both nodes and edge
       - test_inheritance_chain: multi-level inheritance (grandparent)
       - test_used_by_property: property used by multiple categories
       - test_used_by_subobject: subobject used by categories
       - test_used_by_invalid_type: category returns 400

    Export inheritance service from __init__.py
  </action>
  <verify>
    ```bash
    cd /home/daharoni/dev/ontology-hub/backend && python -m pytest tests/test_entities_api.py -v -k "inheritance or used_by"
    ```
    All new tests pass.
  </verify>
  <done>
    - Inheritance endpoint returns nodes and edges for graph
    - Used-by endpoint returns categories using a property/subobject
    - Circular inheritance detected and flagged
    - Tests cover all scenarios
  </done>
</task>

<task type="auto">
  <name>Task 2: Frontend Graph Visualization with React Flow</name>
  <files>
    frontend/package.json
    frontend/src/api/entities.ts
    frontend/src/api/types.ts
    frontend/src/components/graph/InheritanceGraph.tsx
    frontend/src/components/graph/CategoryNode.tsx
    frontend/src/components/graph/useGraphLayout.ts
    frontend/src/pages/CategoryPage.tsx
    frontend/src/pages/GraphExplorerPage.tsx
    frontend/src/App.tsx
  </files>
  <action>
    Add React Flow graph visualization:

    1. Install React Flow and dagre:
       ```bash
       cd frontend && npm install @xyflow/react @dagrejs/dagre
       ```

    2. Add types to frontend/src/api/types.ts:
       ```typescript
       export interface InheritanceNode {
         id: string;
         label: string;
         entity_id: string;
         is_current: boolean;
       }

       export interface InheritanceEdge {
         source: string;
         target: string;
       }

       export interface InheritanceResponse {
         nodes: InheritanceNode[];
         edges: InheritanceEdge[];
         has_circular: boolean;
       }
       ```

    3. Add hooks to frontend/src/api/entities.ts:
       - useInheritance(entityId) - GET /entities/category/{id}/inheritance

    4. Create frontend/src/components/graph/useGraphLayout.ts:
       - Use dagre for automatic hierarchical layout
       - Direction: TB (top to bottom) - parents above children
       - Node dimensions: 172x36
       - Return layouted nodes with calculated positions

    5. Create frontend/src/components/graph/CategoryNode.tsx:
       - Custom React Flow node component
       - Display label and entity_id
       - Highlight current category (is_current) with different border color
       - onClick navigates to category page using react-router navigate
       - Handles at top (target) and bottom (source)

    6. Create frontend/src/components/graph/InheritanceGraph.tsx:
       - Accept entityId and compact (boolean) props
       - Fetch inheritance data with useInheritance
       - Convert API response to React Flow nodes/edges
       - Apply dagre layout via useGraphLayout
       - Render ReactFlow with:
         - nodeTypes = { category: CategoryNode }
         - fitView on initial render
         - Background with dots pattern
         - Controls (zoom, fit view)
       - IMPORTANT: Import React Flow CSS: `import '@xyflow/react/dist/style.css'`
       - IMPORTANT: Parent container must have explicit height
       - Show warning badge if has_circular is true

    7. Update CategoryPage.tsx:
       - Add InheritanceGraph component in "Inheritance" section
       - Container with explicit height (h-64 for mini graph)
       - Link to full graph explorer page

    8. Create GraphExplorerPage.tsx:
       - Full-page graph view
       - Accept entityId from route params
       - Larger container (h-[calc(100vh-200px)])
       - More controls, better pan/zoom

    9. Update App.tsx:
       - Add route: /graph/:entityId -> GraphExplorerPage

    CRITICAL from RESEARCH.md:
    - Define nodeTypes OUTSIDE component to prevent re-render performance issues
    - Import '@xyflow/react/dist/style.css' for proper rendering
    - Container must have explicit dimensions
  </action>
  <verify>
    ```bash
    cd /home/daharoni/dev/ontology-hub/frontend && npm run build
    ```
    Build succeeds with React Flow components.
  </verify>
  <done>
    - React Flow renders inheritance graph
    - Nodes show category labels, current highlighted
    - Clicking node navigates to category page
    - Dagre layout positions nodes hierarchically
    - Graph explorer page for full view
  </done>
</task>

<task type="auto">
  <name>Task 3: Used-By References and Enhanced Property List</name>
  <files>
    frontend/src/api/entities.ts
    frontend/src/components/entity/UsedByList.tsx
    frontend/src/components/entity/PropertyList.tsx
    frontend/src/pages/PropertyPage.tsx
    frontend/src/pages/SubobjectPage.tsx
  </files>
  <action>
    Add used-by functionality and enhance property display:

    1. Add hook to frontend/src/api/entities.ts:
       - useUsedBy(entityType, entityId) - GET /entities/{type}/{id}/used-by
       - Returns list of EntityPublic (categories using this entity)

    2. Create frontend/src/components/entity/UsedByList.tsx:
       - Accept entityType and entityId props
       - Fetch using useUsedBy hook
       - Display list of categories with links
       - Each item shows category label and entity_id
       - Empty state: "Not used by any categories"
       - Loading skeleton

    3. Update PropertyPage.tsx:
       - Add UsedByList component in "Used By" section
       - Show which categories use this property

    4. Update SubobjectPage.tsx:
       - Add UsedByList component in "Used By" section
       - Show which categories use this subobject

    5. Enhance PropertyList.tsx on category pages:
       - Add "declared" badge to properties/subobjects
       - Prepare structure for "inherited" badges (actual inheritance resolution in future enhancement)
       - Show property type (property vs subobject) with different styling
       - Each item links to the property/subobject detail page

    From CONTEXT.md decisions:
    - "Simple clickable list of categories that use a property/subobject"
    - "Links navigate to the using category's page"
    - "Visual indicators (badges/icons) distinguish declared vs inherited"
  </action>
  <verify>
    ```bash
    cd /home/daharoni/dev/ontology-hub/frontend && npm run build
    ```
    Build succeeds.
  </verify>
  <done>
    - Property pages show list of categories using the property
    - Subobject pages show list of categories using the subobject
    - Category pages show declared badge on properties
    - Used-by items link to category pages
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Backend tests pass: `cd backend && pytest tests/test_entities_api.py -v`
2. Frontend builds: `cd frontend && npm run build`
3. Manual test:
   - Start services: `docker compose up -d`
   - Trigger sync: `curl -X POST http://localhost:8080/api/v1/sync`
   - Navigate to http://localhost:5173/category/Person
   - See inheritance graph (mini version)
   - Click "View full graph" - navigate to graph explorer
   - Navigate to http://localhost:5173/property/has_name
   - See "Used By" section listing categories (Person, Organization)
   - Click category in used-by list - navigate to category page
</verification>

<success_criteria>
- User can see inheritance graph showing parent/child category relationships
- User can see which categories use a given property or subobject
- Category pages show properties with declared badges
- Graph is interactive - clicking nodes navigates to category pages
- Graph uses dagre layout for clean hierarchical display
- Used-by lists are clickable links to category pages
</success_criteria>

<output>
After completion, create `.planning/phases/03-entity-browsing/03-03-SUMMARY.md`
</output>
