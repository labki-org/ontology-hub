---
phase: 03-entity-browsing
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - backend/app/routers/entities.py
  - backend/app/schemas/entity.py
  - backend/tests/test_entities_api.py
  - frontend/src/api/entities.ts
  - frontend/src/api/types.ts
  - frontend/src/hooks/useDebounce.ts
  - frontend/src/components/search/SearchInput.tsx
  - frontend/src/components/search/SearchResults.tsx
  - frontend/src/components/layout/Sidebar.tsx
  - frontend/src/pages/SearchPage.tsx
  - frontend/src/App.tsx
autonomous: true

must_haves:
  truths:
    - "User can search entities by name and find matching results instantly"
    - "Search matches against entity_id, label, and description"
    - "Search results link to entity detail pages"
    - "Search is accessible from sidebar"
  artifacts:
    - path: "backend/app/routers/entities.py"
      provides: "Search endpoint"
      contains: "search"
    - path: "frontend/src/components/search/SearchInput.tsx"
      provides: "Search input with debounce"
      min_lines: 20
    - path: "frontend/src/pages/SearchPage.tsx"
      provides: "Search results page"
      min_lines: 30
  key_links:
    - from: "frontend/src/components/search/SearchInput.tsx"
      to: "/api/v1/entities/search"
      via: "TanStack Query with debounced query"
      pattern: "useSearch.*debouncedQuery"
    - from: "backend/app/routers/entities.py"
      to: "Entity model"
      via: "ILIKE query on label, entity_id, description"
      pattern: "ilike"
---

<objective>
Add search functionality allowing users to find entities by name, description, or ID with instant results.

Purpose: Search is essential for finding entities in a large ontology. Users need to quickly locate specific categories, properties, or subobjects without navigating the entire tree.

Output: Search endpoint on backend, search input in sidebar, search results page showing matching entities
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-entity-browsing/03-CONTEXT.md
@.planning/phases/03-entity-browsing/03-RESEARCH.md
@.planning/phases/03-entity-browsing/03-01-SUMMARY.md

# Existing entity router to extend
@backend/app/routers/entities.py
@backend/app/schemas/entity.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Backend Search Endpoint</name>
  <files>
    backend/app/routers/entities.py
    backend/app/schemas/entity.py
    backend/tests/test_entities_api.py
  </files>
  <action>
    Add search endpoint to entity router:

    1. Add SearchRequest schema to backend/app/schemas/entity.py (or inline Query params):
       - q: str (min 2 chars, max 100)
       - entity_type: Optional[EntityType] (filter to single type)
       - limit: int (default 20, max 100)

    2. Add GET /entities/search endpoint to backend/app/routers/entities.py:
       ```python
       @router.get("/search", response_model=EntityListResponse)
       @limiter.limit(RATE_LIMITS["entity_list"])
       async def search_entities(
           request: Request,
           session: SessionDep,
           q: str = Query(..., min_length=2, max_length=100),
           entity_type: Optional[EntityType] = None,
           limit: int = Query(20, ge=1, le=100),
       ) -> EntityListResponse:
       ```

    3. Search logic using ILIKE:
       - Match against entity_id, label, and description
       - Use OR for multi-field search: `or_(Entity.entity_id.ilike(f"%{q}%"), ...)`
       - Filter by entity_type if provided
       - Filter out soft-deleted (deleted_at is None)
       - Order by label for readability
       - Return EntityListResponse (reuse existing schema)
       - Set next_cursor to None (search doesn't use cursor pagination)

    4. Add tests in backend/tests/test_entities_api.py:
       - test_search_by_label: search "Person" finds Person category
       - test_search_by_entity_id: search "has_name" finds property
       - test_search_partial_match: search "date" finds multiple date properties
       - test_search_filter_by_type: search with entity_type filter
       - test_search_min_length: query too short returns 422
       - test_search_empty_results: nonsense query returns empty list
       - test_search_excludes_deleted: soft-deleted entities not in results

    IMPORTANT: Place /search route BEFORE /{entity_type} in router to avoid path conflict
  </action>
  <verify>
    ```bash
    cd /home/daharoni/dev/ontology-hub/backend && python -m pytest tests/test_entities_api.py -v -k search
    ```
    All search tests pass.
  </verify>
  <done>
    - GET /entities/search endpoint accepts q, entity_type, limit params
    - Search matches entity_id, label, description using ILIKE
    - Results exclude soft-deleted entities
    - Tests cover all search scenarios
  </done>
</task>

<task type="auto">
  <name>Task 2: Frontend Search Components</name>
  <files>
    frontend/src/api/entities.ts
    frontend/src/api/types.ts
    frontend/src/hooks/useDebounce.ts
    frontend/src/components/search/SearchInput.tsx
    frontend/src/components/search/SearchResults.tsx
    frontend/src/components/layout/Sidebar.tsx
    frontend/src/pages/SearchPage.tsx
    frontend/src/App.tsx
  </files>
  <action>
    Add search functionality to frontend:

    1. frontend/src/hooks/useDebounce.ts:
       ```typescript
       export function useDebounce<T>(value: T, delay = 300): T {
         const [debouncedValue, setDebouncedValue] = useState(value);
         useEffect(() => {
           const timer = setTimeout(() => setDebouncedValue(value), delay);
           return () => clearTimeout(timer);
         }, [value, delay]);
         return debouncedValue;
       }
       ```

    2. frontend/src/api/entities.ts - Add useSearch hook:
       ```typescript
       export function useSearch(query: string, entityType?: EntityType) {
         return useQuery({
           queryKey: ['search', query, entityType],
           queryFn: () => searchEntities(query, entityType),
           enabled: query.length >= 2,
         });
       }
       ```

    3. frontend/src/components/search/SearchInput.tsx:
       - Text input with search icon (lucide-react Search icon)
       - Controlled input with local state
       - Use useDebounce hook (300ms delay)
       - On submit or debounce, navigate to /search?q={query}
       - Minimum 2 characters before searching
       - Clear button when input has value

    4. frontend/src/components/search/SearchResults.tsx:
       - Accept items: EntityPublic[] prop
       - Display as list with entity type badge
       - Each result links to entity detail page
       - Show label, entity_id, description snippet
       - Empty state: "No results found for '{query}'"

    5. frontend/src/pages/SearchPage.tsx:
       - Read q and type from URL search params
       - Use useSearch hook with debounced query
       - Show SearchResults component
       - Loading skeleton while fetching
       - Filter dropdown for entity_type (optional)

    6. Update Sidebar.tsx:
       - Add SearchInput at top of sidebar
       - Style to fit within sidebar width

    7. Update App.tsx:
       - Add route: /search -> SearchPage
  </action>
  <verify>
    ```bash
    cd /home/daharoni/dev/ontology-hub/frontend && npm run build
    ```
    Build succeeds with new search components.
  </verify>
  <done>
    - Search input in sidebar with debounce
    - Search page shows results with links to entity pages
    - Results show entity type badge
    - Empty state for no results
    - Filter by entity type works
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Backend tests pass: `cd backend && pytest tests/test_entities_api.py -v -k search`
2. Frontend builds: `cd frontend && npm run build`
3. Manual test:
   - Start services: `docker compose up -d`
   - Trigger sync: `curl -X POST http://localhost:8080/api/v1/sync`
   - Navigate to http://localhost:5173/
   - Type "Person" in search box
   - See Person category in results
   - Click result, navigate to category page
   - Search "date" - see multiple date-related properties
</verification>

<success_criteria>
- User can search entities by name and find matching results
- Search matches against entity_id, label, and description
- Search results link to entity detail pages
- Search input accessible from sidebar on all pages
- Debounce prevents excessive API calls while typing
- Backend returns results in <200ms for typical queries
</success_criteria>

<output>
After completion, create `.planning/phases/03-entity-browsing/03-02-SUMMARY.md`
</output>
