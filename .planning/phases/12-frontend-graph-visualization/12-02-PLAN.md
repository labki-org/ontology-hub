---
phase: 12-frontend-graph-visualization
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/stores/graphStore.ts
  - frontend/src/stores/hullStore.ts
  - frontend/src/api/graph.ts
  - frontend/src/api/types.ts
autonomous: true

must_haves:
  truths:
    - "Graph store tracks selected entity and expanded nodes"
    - "Hull store tracks which modules have visible hulls"
    - "Graph API hooks fetch neighborhood data with draft support"
  artifacts:
    - path: "frontend/src/stores/graphStore.ts"
      provides: "Graph interaction state"
      exports: ["useGraphStore"]
    - path: "frontend/src/stores/hullStore.ts"
      provides: "Module hull visibility state"
      exports: ["useHullStore"]
    - path: "frontend/src/api/graph.ts"
      provides: "Graph API client"
      exports: ["useNeighborhoodGraph", "useModuleGraph"]
  key_links:
    - from: "frontend/src/api/graph.ts"
      to: "/api/v2/graph/neighborhood"
      via: "apiFetch"
      pattern: "apiFetch.*api/v2/graph"
---

<objective>
Create graph-related state stores and API hooks for the visualization layer.

Purpose: Establish client state management for graph interactions (node selection, expansion, depth control) and module hull visibility, plus API hooks for graph data fetching.
Output: graphStore, hullStore, and graph API hooks ready for GraphCanvas component.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/intel/summary.md
@.planning/phases/12-frontend-graph-visualization/12-CONTEXT.md
@.planning/phases/12-frontend-graph-visualization/12-RESEARCH.md
@frontend/src/stores/draftStore.ts
@frontend/src/api/client.ts
@backend/app/schemas/graph.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create graph state store</name>
  <files>frontend/src/stores/graphStore.ts</files>
  <action>
Create a zustand store for graph interaction state following the existing draftStore.ts pattern.

State fields:
- selectedEntityKey: string | null (currently focused entity shown in detail panel)
- expandedNodes: Set<string> (nodes that have been expanded in the graph)
- depth: number (current traversal depth, 1-3, default 2)
- showProperties: boolean (toggle for property nodes, default false)
- showSubobjects: boolean (toggle for subobject nodes, default false)
- showTemplates: boolean (toggle for template nodes, default false)
- edgeTypeFilter: Set<string> (visible edge types: 'parent', 'property', 'subobject')

Actions:
- setSelectedEntity(key: string | null): void
- toggleNodeExpanded(key: string): void
- setDepth(depth: number): void
- toggleEntityType(type: 'property' | 'subobject' | 'template'): void
- setEdgeTypeFilter(types: string[]): void
- resetGraph(): void (clears expanded nodes, resets to defaults)

Use zustand with immer middleware and enableMapSet() for Set support.
Do NOT use persist middleware - graph state should reset on page refresh.

Export useGraphStore as named export.
  </action>
  <verify>`import { useGraphStore } from '@/stores/graphStore'` works; store actions update state correctly</verify>
  <done>graphStore created with selection, expansion, depth, and filter state</done>
</task>

<task type="auto">
  <name>Task 2: Create hull visibility store</name>
  <files>frontend/src/stores/hullStore.ts</files>
  <action>
Create a zustand store for module hull visibility with localStorage persistence.

Based on RESEARCH.md code example for module hull toggle state, create:

State fields:
- visibleModules: Set<string> (module IDs with visible hulls)

Actions:
- toggleModule(moduleId: string): void - toggle hull visibility
- showModule(moduleId: string): void - ensure module hull is visible
- hideModule(moduleId: string): void - ensure module hull is hidden
- showAll(moduleIds: string[]): void - show all provided modules
- hideAll(): void - hide all hulls
- isVisible(moduleId: string): boolean - check if module hull is visible

Use zustand with persist middleware for localStorage persistence.
Custom storage adapter needed for Set serialization (convert to/from array).

Key name: 'hull-visibility'

Export useHullStore as named export.
  </action>
  <verify>Toggle module, refresh page, hull visibility state persists</verify>
  <done>hullStore created with toggle, show/hide, and localStorage persistence</done>
</task>

<task type="auto">
  <name>Task 3: Create graph API hooks</name>
  <files>frontend/src/api/graph.ts, frontend/src/api/types.ts</files>
  <action>
Create API hooks for graph endpoints matching backend schemas.

First, add graph types to types.ts:
```typescript
// Graph types (from backend app/schemas/graph.py)
export interface GraphNode {
  id: string
  label: string
  entity_type: string
  depth?: number
  modules: string[]
  change_status?: 'added' | 'modified' | 'deleted' | 'unchanged'
}

export interface GraphEdge {
  source: string
  target: string
  edge_type: string
}

export interface GraphResponse {
  nodes: GraphNode[]
  edges: GraphEdge[]
  has_cycles: boolean
}
```

Then create graph.ts with hooks:

1. useNeighborhoodGraph(entityKey, entityType?, depth?, draftId?)
   - GET /api/v2/graph/neighborhood
   - Query params: entity_key, entity_type (default 'category'), depth (default 2)
   - Optional draft_id for draft context
   - queryKey: ['graph', 'neighborhood', entityKey, entityType, depth, draftId]

2. useModuleGraph(moduleKey, draftId?)
   - GET /api/v2/graph/module/{moduleKey}
   - Optional draft_id for draft context
   - queryKey: ['graph', 'module', moduleKey, draftId]

Both hooks should:
- Use apiFetch from ./client
- Include draft_id in params when provided
- Be enabled only when entityKey/moduleKey is truthy

Export both hooks as named exports.
  </action>
  <verify>`tsc --noEmit` passes; useNeighborhoodGraph hook returns typed GraphResponse</verify>
  <done>Graph API hooks created with proper typing and draft support</done>
</task>

</tasks>

<verification>
1. `cd frontend && npx tsc --noEmit` passes without errors
2. Import graphStore and verify setSelectedEntity updates state
3. Import hullStore, toggle module, verify persistence after simulated refresh
4. Graph types properly match backend schema
</verification>

<success_criteria>
- graphStore manages selection, expansion, depth, and entity type toggles
- hullStore manages hull visibility with localStorage persistence
- Graph API hooks fetch from /api/v2/graph/* with draft_id support
- All types match backend schemas/graph.py
</success_criteria>

<output>
After completion, create `.planning/phases/12-frontend-graph-visualization/12-02-SUMMARY.md`
</output>
