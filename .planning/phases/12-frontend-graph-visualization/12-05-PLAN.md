---
phase: 12-frontend-graph-visualization
plan: 05
type: execute
wave: 3
depends_on: ["12-02", "12-04"]
files_modified:
  - frontend/src/components/graph/ModuleHull.tsx
  - frontend/src/components/graph/HullLayer.tsx
  - frontend/src/components/graph/ModuleHullControls.tsx
  - frontend/src/components/graph/GraphCanvas.tsx
autonomous: true

must_haves:
  truths:
    - "Module hulls render as convex polygons around nodes"
    - "Multiple hulls can display simultaneously with transparency"
    - "Hulls use distinct colors from a predefined palette"
    - "Hull visibility toggles via checkbox controls"
  artifacts:
    - path: "frontend/src/components/graph/ModuleHull.tsx"
      provides: "SVG convex hull for a single module"
      min_lines: 30
    - path: "frontend/src/components/graph/HullLayer.tsx"
      provides: "React Flow layer rendering all visible hulls"
      min_lines: 40
    - path: "frontend/src/components/graph/ModuleHullControls.tsx"
      provides: "Module hull toggle panel"
      min_lines: 30
  key_links:
    - from: "frontend/src/components/graph/ModuleHull.tsx"
      to: "d3-polygon"
      via: "polygonHull"
      pattern: "polygonHull"
    - from: "frontend/src/components/graph/HullLayer.tsx"
      to: "hullStore"
      via: "useHullStore"
      pattern: "useHullStore.*visibleModules"
---

<objective>
Implement module hull overlays using d3-polygon convex hulls.

Purpose: Implement GV-04 (module hull overlays with d3-polygon), GV-05 (multi-hull display), GV-06 (module selection panel).
Output: Module boundaries rendered as semi-transparent convex hull polygons with toggle controls.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/intel/summary.md
@.planning/phases/12-frontend-graph-visualization/12-CONTEXT.md
@.planning/phases/12-frontend-graph-visualization/12-RESEARCH.md
@frontend/src/stores/hullStore.ts
@frontend/src/components/graph/GraphCanvas.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ModuleHull component</name>
  <files>frontend/src/components/graph/ModuleHull.tsx</files>
  <action>
Create a component that renders a convex hull polygon for a module.

Based on RESEARCH.md pattern:
```typescript
import { polygonHull } from 'd3-polygon'
```

Props:
- moduleId: string
- nodes: Array<{ id: string, position: { x: number, y: number }, data: { modules?: string[] } }>
- color: string (hex or Tailwind color)
- padding?: number (expand hull by this amount, default 40)

Implementation:
1. Filter nodes where node.data.modules includes moduleId
2. Extract positions: points = [[x, y], [x, y], ...]
3. Add padding by expanding points outward from centroid
4. Call polygonHull(points) - returns null if < 3 points
5. If null or < 3 nodes, return null (no hull to render)
6. Convert hull to SVG path: `M${hull.map(p => p.join(',')).join('L')}Z`
7. Render path with:
   - fill={color}
   - fillOpacity={0.15}
   - stroke={color}
   - strokeWidth={2}
   - strokeOpacity={0.4}
   - pointerEvents="none" (critical: don't block node clicks)

Based on CONTEXT.md:
- Semi-transparent colored fill with subtle border
- Layered transparency for overlapping modules (blended colors)

Export ModuleHull.
  </action>
  <verify>Hull renders around nodes belonging to module; clicking through hull to nodes works</verify>
  <done>ModuleHull renders convex polygon with d3-polygon</done>
</task>

<task type="auto">
  <name>Task 2: Create HullLayer and integrate with GraphCanvas</name>
  <files>frontend/src/components/graph/HullLayer.tsx, frontend/src/components/graph/GraphCanvas.tsx</files>
  <action>
Create a layer component that renders all visible module hulls and integrate with GraphCanvas.

HullLayer.tsx:
Props:
- nodes: React Flow nodes array (with positions and data.modules)

Implementation:
1. Extract unique module IDs from all nodes' data.modules arrays
2. Get visibleModules from hullStore
3. For each visible module, render ModuleHull
4. Use color palette to assign deterministic colors

Color palette (12 distinct colors, Tailwind-inspired):
```typescript
const HULL_COLORS = [
  '#3b82f6', // blue-500
  '#10b981', // emerald-500
  '#f59e0b', // amber-500
  '#8b5cf6', // violet-500
  '#ec4899', // pink-500
  '#06b6d4', // cyan-500
  '#f97316', // orange-500
  '#84cc16', // lime-500
  '#6366f1', // indigo-500
  '#14b8a6', // teal-500
  '#ef4444', // red-500
  '#a855f7', // purple-500
]

function getModuleColor(moduleId: string): string {
  // Hash moduleId to get deterministic color index
  let hash = 0
  for (const char of moduleId) {
    hash = ((hash << 5) - hash) + char.charCodeAt(0)
    hash |= 0 // Convert to 32-bit integer
  }
  return HULL_COLORS[Math.abs(hash) % HULL_COLORS.length]
}
```

Render all ModuleHulls in an SVG group.

Update GraphCanvas.tsx:
1. React Flow supports custom layers. Use the background slot or a custom SVG layer.
2. Add HullLayer BELOW the nodes layer (z-index matters)
3. Pass current nodes with positions to HullLayer
4. Hulls update when nodes move (force layout updates)

Based on RESEARCH.md pitfall: "Render hulls in separate SVG layer below nodes"
  </action>
  <verify>Multiple hulls render simultaneously; overlapping hulls show blended colors</verify>
  <done>HullLayer renders all visible hulls below nodes in GraphCanvas</done>
</task>

<task type="auto">
  <name>Task 3: Create ModuleHullControls panel</name>
  <files>frontend/src/components/graph/ModuleHullControls.tsx</files>
  <action>
Create a control panel for toggling module hull visibility.

Based on CONTEXT.md: "Toggle list in sidebar: checkboxes to show/hide each module's hull"

Props:
- modules: string[] (list of all module IDs in current graph)

Implementation:
1. Get visibleModules and toggleModule from hullStore
2. Render scrollable list of modules with checkboxes
3. Each row shows:
   - Checkbox (checked if module in visibleModules)
   - Color swatch (using same getModuleColor function)
   - Module label/ID
4. On checkbox change, call toggleModule(moduleId)
5. "Show All" / "Hide All" buttons at top

Style:
- Positioned in sidebar or as panel next to GraphControls
- Semi-transparent background
- Max height with scroll for many modules
- Color swatch as small square before label

Export ModuleHullControls.

This can be positioned either:
- In the graph controls area (preferred for graph-focused UI)
- In sidebar (if sidebar handles all toggles)

For now, place in graph controls area alongside depth controls.
  </action>
  <verify>Checkboxes toggle hull visibility; color swatches match hull colors</verify>
  <done>ModuleHullControls allows toggling individual module hull visibility</done>
</task>

</tasks>

<verification>
1. `cd frontend && npx tsc --noEmit` passes
2. Single hull renders around module's nodes
3. Multiple hulls display with distinct colors
4. Overlapping hulls show blended transparency
5. Toggling module in controls shows/hides hull
6. Clicking nodes through hulls still works (pointerEvents="none")
7. Hull colors are deterministic (same module = same color on refresh)
</verification>

<success_criteria>
- Module hulls render as convex polygons using d3-polygon (GV-04)
- Multiple hulls can display simultaneously with transparency (GV-05)
- Module selection panel allows toggling hull visibility (GV-06)
- Hull colors from predefined palette, deterministic by moduleId
- Hulls don't block node interaction
</success_criteria>

<output>
After completion, create `.planning/phases/12-frontend-graph-visualization/12-05-SUMMARY.md`
</output>
