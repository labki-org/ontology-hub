---
phase: 12-frontend-graph-visualization
plan: 04
type: execute
wave: 2
depends_on: ["12-01", "12-02"]
files_modified:
  - frontend/src/components/graph/GraphCanvas.tsx
  - frontend/src/components/graph/useForceLayout.ts
  - frontend/src/components/graph/GraphNode.tsx
  - frontend/src/components/graph/GraphControls.tsx
autonomous: true

must_haves:
  truths:
    - "Graph displays category nodes with inheritance edges"
    - "Force-directed layout positions nodes interactively"
    - "Clicking a node selects it in graphStore"
    - "Depth control adjusts neighborhood traversal (1-3)"
    - "Edge type filters show/hide edge categories"
  artifacts:
    - path: "frontend/src/components/graph/GraphCanvas.tsx"
      provides: "Main graph container with React Flow"
      min_lines: 80
    - path: "frontend/src/components/graph/useForceLayout.ts"
      provides: "d3-force integration hook"
      min_lines: 40
    - path: "frontend/src/components/graph/GraphControls.tsx"
      provides: "Depth and filter controls"
      min_lines: 30
  key_links:
    - from: "frontend/src/components/graph/GraphCanvas.tsx"
      to: "useNeighborhoodGraph"
      via: "import from api/graph"
      pattern: "useNeighborhoodGraph"
    - from: "frontend/src/components/graph/useForceLayout.ts"
      to: "d3-force"
      via: "forceSimulation"
      pattern: "forceSimulation|forceManyBody|forceLink"
---

<objective>
Build the force-directed graph visualization with React Flow and d3-force.

Purpose: Implement GV-01 (graph panel), GV-02 (depth control), GV-03 (edge type filter), GV-07 (click-to-focus, pan/zoom).
Output: Interactive category graph with force layout, controls, and node selection.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/intel/summary.md
@.planning/phases/12-frontend-graph-visualization/12-CONTEXT.md
@.planning/phases/12-frontend-graph-visualization/12-RESEARCH.md
@frontend/src/components/graph/InheritanceGraph.tsx
@frontend/src/components/graph/CategoryNode.tsx
@frontend/src/components/graph/useGraphLayout.ts
@frontend/src/stores/graphStore.ts
@frontend/src/api/graph.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useForceLayout hook</name>
  <files>frontend/src/components/graph/useForceLayout.ts</files>
  <action>
Create a hook that integrates d3-force simulation with React Flow nodes.

Based on RESEARCH.md pitfalls:
- Clone nodes before passing to simulation (avoid React state mutation)
- Auto-stop when alpha < 0.01 (performance)
- Use useCallback for safe position updates

Implementation:
```typescript
import { useEffect, useRef, useCallback, useState } from 'react'
import { forceSimulation, forceLink, forceManyBody, forceCenter, forceCollide } from 'd3-force'
import type { Node, Edge } from '@xyflow/react'

interface ForceLayoutOptions {
  chargeStrength?: number  // default -800
  linkDistance?: number    // default 120
  collisionRadius?: number // default 80
  alphaDecay?: number      // default 0.02
}

export function useForceLayout(
  initialNodes: Node[],
  edges: Edge[],
  options?: ForceLayoutOptions
) {
  const [nodes, setNodes] = useState<Node[]>(initialNodes)
  const simulationRef = useRef<any>(null)
  const [isRunning, setIsRunning] = useState(false)

  // ... simulation setup
  // On tick: update positions via setNodes
  // On end (alpha < 0.01): setIsRunning(false)

  const restartSimulation = useCallback(() => {
    if (simulationRef.current) {
      simulationRef.current.alpha(0.5).restart()
      setIsRunning(true)
    }
  }, [])

  const stopSimulation = useCallback(() => {
    simulationRef.current?.stop()
    setIsRunning(false)
  }, [])

  return { nodes, isRunning, restartSimulation, stopSimulation }
}
```

Key considerations:
- Clone nodes array before simulation to avoid mutation warnings
- Update node positions via setNodes on each tick
- Use d3.forceLink().id(d => d.id) to match edges by node id
- Add forceCollide to prevent node overlap
- Clean up simulation on unmount
  </action>
  <verify>Hook compiles; simulation runs and stops correctly</verify>
  <done>useForceLayout hook integrates d3-force with React state</done>
</task>

<task type="auto">
  <name>Task 2: Create GraphNode and GraphControls components</name>
  <files>frontend/src/components/graph/GraphNode.tsx, frontend/src/components/graph/GraphControls.tsx</files>
  <action>
Create custom node component and controls panel.

GraphNode.tsx (custom React Flow node):
- Based on existing CategoryNode.tsx pattern
- Props from node.data: label, entity_type, modules, change_status
- Display: rounded rectangle with label
- Visual indicators for change_status:
  - added: green border/glow
  - modified: yellow border
  - deleted: red border, strikethrough label
- Click handler: call graphStore.setSelectedEntity(node.id)
- Use Handle components for edges (top target, bottom source)

Register as nodeTypes = { entity: GraphNode }

GraphControls.tsx (control panel overlay):
- Depth slider/buttons (1-3) with current value display
- Edge type filter checkboxes:
  - [ ] Inheritance (parent edges)
  - [ ] Properties
  - [ ] Subobjects
- "Reset Layout" button to restart force simulation
- Position: top-right of graph canvas (absolute positioning)

Read state from graphStore, call actions on change:
- useGraphStore(s => s.depth), setDepth
- useGraphStore(s => s.edgeTypeFilter), setEdgeTypeFilter

Style: semi-transparent background, rounded corners, shadow.
  </action>
  <verify>GraphNode renders with change status styling; controls update graphStore</verify>
  <done>GraphNode shows entities with status; GraphControls manage depth/filters</done>
</task>

<task type="auto">
  <name>Task 3: Create GraphCanvas container</name>
  <files>frontend/src/components/graph/GraphCanvas.tsx</files>
  <action>
Create the main graph canvas component that brings everything together.

GraphCanvas props:
- entityKey?: string (starting entity, uses graphStore.selectedEntityKey if not provided)
- draftId?: string (for draft context)

Implementation:
1. Get selectedEntityKey from graphStore if entityKey not provided
2. Get depth from graphStore
3. Call useNeighborhoodGraph(entityKey, 'category', depth, draftId)
4. Convert GraphResponse to React Flow nodes/edges format
5. Pass to useForceLayout for positioning
6. Render ReactFlow with:
   - nodes from useForceLayout
   - edges converted from GraphResponse
   - nodeTypes = { entity: GraphNode }
   - fitView on initial load (but NOT on every update)
   - pan/zoom enabled (default React Flow behavior)
   - Background and Controls from @xyflow/react
7. Overlay GraphControls component
8. Handle empty state (no data or loading)

Edge conversion:
- GraphEdge { source, target, edge_type } -> React Flow Edge
- Filter edges based on graphStore.edgeTypeFilter
- Style edges by type (parent: solid, property: dashed, subobject: dotted)

Loading state: Skeleton or spinner
Error state: Error message with retry button
Empty state: "Select an entity to visualize"

Include has_cycles warning badge if graph has circular inheritance.
  </action>
  <verify>Graph renders nodes, force layout positions them, clicking selects nodes</verify>
  <done>GraphCanvas displays interactive force-directed graph with controls</done>
</task>

</tasks>

<verification>
1. `cd frontend && npx tsc --noEmit` passes
2. GraphCanvas renders when given an entityKey
3. Force layout runs and stabilizes (nodes stop moving)
4. Depth control changes neighborhood size
5. Edge type filters show/hide edges
6. Clicking node updates graphStore.selectedEntityKey
7. Pan and zoom work (React Flow default)
</verification>

<success_criteria>
- Graph displays category nodes with inheritance edges
- Force-directed layout positions nodes automatically
- Clicking node selects it (GV-07)
- Depth control adjusts traversal depth 1-3 (GV-02)
- Edge type filters show/hide edge categories (GV-03)
- Pan and zoom work for navigation (GV-07)
</success_criteria>

<output>
After completion, create `.planning/phases/12-frontend-graph-visualization/12-04-SUMMARY.md`
</output>
