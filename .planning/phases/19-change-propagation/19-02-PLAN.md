---
phase: 19-change-propagation
plan: 02
type: execute
wave: 2
depends_on: ["19-01"]
files_modified:
  - frontend/src/components/layout/SidebarV2.tsx
autonomous: true

must_haves:
  truths:
    - "User sees directly edited entities with blue background highlight in sidebar"
    - "User sees transitively affected entities with light blue background tint in sidebar"
    - "User sees affected entity count badge in draft header section"
    - "Direct edit styling takes precedence over transitive styling"
  artifacts:
    - path: "frontend/src/components/layout/SidebarV2.tsx"
      provides: "Sidebar with change propagation highlighting"
      contains: "directlyEditedEntities"
  key_links:
    - from: "frontend/src/components/layout/SidebarV2.tsx"
      to: "frontend/src/stores/draftStoreV2.ts"
      via: "useDraftStoreV2 hook"
      pattern: "useDraftStoreV2.*directlyEditedEntities"
---

<objective>
Add change propagation highlighting to sidebar entities and display affected count.

Purpose: Users editing a draft can immediately see which entities they've directly edited (strong blue highlight) and which entities are transitively affected through dependencies (subtle blue tint). A badge in the draft header shows the total affected count.

Output: Updated SidebarV2.tsx with conditional background styling based on draftStoreV2 change tracking state.
</objective>

<execution_context>
@/home/daharoni/.claude/get-shit-done/workflows/execute-plan.md
@/home/daharoni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/19-change-propagation/19-CONTEXT.md
@.planning/phases/19-change-propagation/19-RESEARCH.md
@.planning/phases/19-change-propagation/19-01-SUMMARY.md

@frontend/src/components/layout/SidebarV2.tsx
@frontend/src/stores/draftStoreV2.ts
@frontend/src/lib/utils.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add change tracking state consumption to EntitySection</name>
  <files>frontend/src/components/layout/SidebarV2.tsx</files>
  <action>
Update EntitySection component to highlight edited and affected entities:

1. Import useDraftStoreV2 from '@/stores/draftStoreV2'
2. Import getAffectedEntityCount from '@/lib/dependencyGraph'
3. Import cn from '@/lib/utils' (if not already imported)

4. In EntitySection component, add store subscriptions:
   ```typescript
   const directEdits = useDraftStoreV2((s) => s.directlyEditedEntities)
   const transitiveAffects = useDraftStoreV2((s) => s.transitivelyAffectedEntities)
   ```

5. In the entity mapping loop, calculate highlight state:
   ```typescript
   const isDirectEdit = directEdits.has(entity.entity_key)
   const isTransitiveEffect = transitiveAffects.has(entity.entity_key)
   ```

6. Update the button className to include conditional backgrounds:
   ```typescript
   className={cn(
     'flex items-center gap-2 w-full px-2 py-1 text-sm rounded hover:bg-sidebar-accent truncate text-left',
     isDirectEdit && 'bg-blue-100 dark:bg-blue-900/30',
     // Only show transitive if NOT direct edit (direct wins)
     !isDirectEdit && isTransitiveEffect && 'bg-blue-50 dark:bg-blue-900/10',
     isDeleted && 'line-through text-muted-foreground'
   )}
   ```

Note: Use complete Tailwind class names (not dynamic interpolation) to ensure proper CSS generation.
  </action>
  <verify>
1. TypeScript compiles: `cd frontend && npx tsc --noEmit`
2. Dev server runs without errors: `cd frontend && npm run dev`
  </verify>
  <done>
EntitySection applies blue background to directly edited entities and light blue tint to transitively affected entities, with direct edits taking precedence.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add affected entity count badge to draft header</name>
  <files>frontend/src/components/layout/SidebarV2.tsx</files>
  <action>
Add an "affected entities" count badge near the draft indicator in SidebarV2:

1. In the main SidebarV2 component, add store subscriptions:
   ```typescript
   const directEdits = useDraftStoreV2((s) => s.directlyEditedEntities)
   const transitiveAffects = useDraftStoreV2((s) => s.transitivelyAffectedEntities)
   ```

2. Calculate affected count:
   ```typescript
   const affectedCount = getAffectedEntityCount(directEdits, transitiveAffects)
   ```

3. Add a conditional badge below the version info or near it when in draft mode:
   ```tsx
   {draftToken && affectedCount > 0 && (
     <div className="text-xs text-muted-foreground mt-1">
       <Badge variant="secondary" className="bg-blue-100 dark:bg-blue-900/30">
         {affectedCount} {affectedCount === 1 ? 'entity' : 'entities'} affected
       </Badge>
     </div>
   )}
   ```

4. Also show a "Draft Mode" indicator if draftToken is present:
   ```tsx
   {draftToken && (
     <Badge variant="outline" className="text-xs mt-1">
       Draft Mode
     </Badge>
   )}
   ```

Place these in the header section (div with "p-4 border-b") after the version info.
  </action>
  <verify>
1. TypeScript compiles: `cd frontend && npx tsc --noEmit`
2. Visual check: Start dev server, load with draft_token, verify badge appears when entities are tracked
  </verify>
  <done>
SidebarV2 shows "X entities affected" badge when in draft mode with tracked changes, and shows "Draft Mode" indicator.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `cd frontend && npx tsc --noEmit`
2. Dev server runs: `cd frontend && npm run dev`
3. Visual verification:
   - Load browse page with draft_token
   - Verify entities with direct edits show blue-100 background
   - Verify entities with transitive effects show blue-50 background
   - Verify affected count badge appears in header
</verification>

<success_criteria>
1. Directly edited entities have bg-blue-100 (dark: bg-blue-900/30) background
2. Transitively affected entities have bg-blue-50 (dark: bg-blue-900/10) background
3. Direct edit styling takes precedence over transitive
4. Badge shows "{N} entities affected" when affectedCount > 0
5. Badge only appears in draft mode (when draftToken present)
6. TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/19-change-propagation/19-02-SUMMARY.md`
</output>
