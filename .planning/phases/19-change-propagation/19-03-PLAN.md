---
phase: 19-change-propagation
plan: 03
type: execute
wave: 2
depends_on: ["19-01"]
files_modified:
  - frontend/src/components/graph/GraphNode.tsx
autonomous: true

must_haves:
  truths:
    - "User sees directly edited nodes with distinct fill color in graph view"
    - "User sees transitively affected nodes with light fill color in graph view"
  artifacts:
    - path: "frontend/src/components/graph/GraphNode.tsx"
      provides: "Node rendering with change propagation highlighting"
      contains: "directlyEditedEntities"
  key_links:
    - from: "frontend/src/components/graph/GraphNode.tsx"
      to: "frontend/src/stores/draftStoreV2.ts"
      via: "useDraftStoreV2 hook"
      pattern: "useDraftStoreV2"
---

<objective>
Add change propagation visualization to graph nodes.

Purpose: Users can visually identify directly edited entities and transitively affected entities in the graph view, matching the sidebar highlighting. This provides immediate visual feedback about the impact of their edits.

Output: Updated GraphNode.tsx with fill color overrides for affected nodes.

Note: Edge change status visualization (new/deleted edges in green/dashed) is deferred to a future phase. The backend GraphEdge schema does not currently include change_status, and adding it requires backend work to compute edge diffs in draft context. For now, this plan focuses on node highlighting which is fully supported.
</objective>

<execution_context>
@/home/daharoni/.claude/get-shit-done/workflows/execute-plan.md
@/home/daharoni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/19-change-propagation/19-CONTEXT.md
@.planning/phases/19-change-propagation/19-RESEARCH.md
@.planning/phases/19-change-propagation/19-01-SUMMARY.md

@frontend/src/components/graph/GraphNode.tsx
@frontend/src/stores/draftStoreV2.ts
@frontend/src/api/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add change propagation fill colors to GraphNode</name>
  <files>frontend/src/components/graph/GraphNode.tsx</files>
  <action>
Update GraphNodeComponent to show change propagation via fill color:

1. Import useDraftStoreV2 from '@/stores/draftStoreV2'

2. Add store subscriptions inside the component:
   ```typescript
   const directEdits = useDraftStoreV2((s) => s.directlyEditedEntities)
   const transitiveAffects = useDraftStoreV2((s) => s.transitivelyAffectedEntities)
   ```

3. Calculate highlight state:
   ```typescript
   const isDirectEdit = directEdits.has(data.entity_key)
   const isTransitiveEffect = transitiveAffects.has(data.entity_key)
   ```

4. Modify the fillColor calculation to override for change propagation:
   ```typescript
   // Base fill color by entity type
   let fillColor = ENTITY_COLORS[entityType] ?? '#94a3b8'

   // Override for change propagation (direct edit wins)
   if (isDirectEdit) {
     fillColor = '#93c5fd' // blue-300 - strong highlight
   } else if (isTransitiveEffect) {
     fillColor = '#dbeafe' // blue-100 - subtle highlight
   }
   ```

Note: The change_status glow effect (for added/modified/deleted) remains separate - it shows WHETHER something changed. The propagation highlighting shows IMPACT (what else is affected by that change).
  </action>
  <verify>
TypeScript compiles: `cd frontend && npx tsc --noEmit`
  </verify>
  <done>
GraphNode renders with blue fill for directly edited entities and light blue fill for transitively affected entities.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `cd frontend && npx tsc --noEmit`
2. Dev server runs: `cd frontend && npm run dev`
3. Visual verification:
   - Load graph view with draft containing changes
   - Verify edited nodes have blue fill
   - Verify affected nodes have light blue fill
</verification>

<success_criteria>
1. Directly edited nodes show #93c5fd (blue-300) fill
2. Transitively affected nodes show #dbeafe (blue-100) fill
3. Direct edit fill takes precedence over transitive
4. TypeScript compiles without errors
</success_criteria>

<future_enhancement>
Edge change status visualization (new edges in green, deleted edges dashed/faded) requires:
1. Add change_status field to GraphEdge schema in backend/app/schemas/graph.py
2. Compute edge diffs in graph_query.py (compare base vs draft edges)
3. Update frontend GraphEdge type in frontend/src/api/types.ts
4. Add edge styling logic in GraphCanvas.tsx

This is tracked as a separate enhancement after the core change propagation work is complete.
</future_enhancement>

<output>
After completion, create `.planning/phases/19-change-propagation/19-03-SUMMARY.md`
</output>
