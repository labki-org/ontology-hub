---
phase: 19-change-propagation
plan: 03
type: execute
wave: 2
depends_on: ["19-01"]
files_modified:
  - frontend/src/components/graph/GraphNode.tsx
  - frontend/src/components/graph/GraphCanvas.tsx
autonomous: true

must_haves:
  truths:
    - "User sees directly edited nodes with distinct fill color in graph view"
    - "User sees transitively affected nodes with light fill color in graph view"
    - "User sees newly added edges in green color"
    - "User sees deleted edges as faded/dashed lines"
  artifacts:
    - path: "frontend/src/components/graph/GraphNode.tsx"
      provides: "Node rendering with change propagation highlighting"
      contains: "directlyEditedEntities"
    - path: "frontend/src/components/graph/GraphCanvas.tsx"
      provides: "Edge rendering with change status styling"
      contains: "change_status"
  key_links:
    - from: "frontend/src/components/graph/GraphNode.tsx"
      to: "frontend/src/stores/draftStoreV2.ts"
      via: "useDraftStoreV2 hook"
      pattern: "useDraftStoreV2"
---

<objective>
Add change propagation visualization to graph nodes and edge change indicators.

Purpose: Users can visually identify directly edited entities and transitively affected entities in the graph view, matching the sidebar highlighting. Additionally, structural changes (new/deleted edges) are visually distinct to help users understand relationship changes.

Output: Updated GraphNode.tsx with fill color overrides for affected nodes, and updated GraphCanvas.tsx with edge styling for added/deleted relationships.
</objective>

<execution_context>
@/home/daharoni/.claude/get-shit-done/workflows/execute-plan.md
@/home/daharoni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/19-change-propagation/19-CONTEXT.md
@.planning/phases/19-change-propagation/19-RESEARCH.md
@.planning/phases/19-change-propagation/19-01-SUMMARY.md

@frontend/src/components/graph/GraphNode.tsx
@frontend/src/components/graph/GraphCanvas.tsx
@frontend/src/stores/draftStoreV2.ts
@frontend/src/api/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add change propagation fill colors to GraphNode</name>
  <files>frontend/src/components/graph/GraphNode.tsx</files>
  <action>
Update GraphNodeComponent to show change propagation via fill color:

1. Import useDraftStoreV2 from '@/stores/draftStoreV2'

2. Add store subscriptions inside the component:
   ```typescript
   const directEdits = useDraftStoreV2((s) => s.directlyEditedEntities)
   const transitiveAffects = useDraftStoreV2((s) => s.transitivelyAffectedEntities)
   ```

3. Calculate highlight state:
   ```typescript
   const isDirectEdit = directEdits.has(data.entity_key)
   const isTransitiveEffect = transitiveAffects.has(data.entity_key)
   ```

4. Modify the fillColor calculation to override for change propagation:
   ```typescript
   // Base fill color by entity type
   let fillColor = ENTITY_COLORS[entityType] ?? '#94a3b8'

   // Override for change propagation (direct edit wins)
   if (isDirectEdit) {
     fillColor = '#93c5fd' // blue-300 - strong highlight
   } else if (isTransitiveEffect) {
     fillColor = '#dbeafe' // blue-100 - subtle highlight
   }
   ```

Note: The change_status glow effect (for added/modified/deleted) remains separate - it shows WHETHER something changed. The propagation highlighting shows IMPACT (what else is affected by that change).
  </action>
  <verify>
TypeScript compiles: `cd frontend && npx tsc --noEmit`
  </verify>
  <done>
GraphNode renders with blue fill for directly edited entities and light blue fill for transitively affected entities.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add edge change status styling to GraphCanvas</name>
  <files>frontend/src/components/graph/GraphCanvas.tsx</files>
  <action>
Update edge styling in GraphCanvas to visually distinguish new and deleted edges:

1. Update the GraphEdge type import or extend the local type to include change_status:
   The API already returns `change_status` on edges in draft mode.

2. Modify the edge mapping to include change_status styling:
   ```typescript
   .map((edge: ApiGraphEdge, index: number) => {
     const isNewEdge = edge.change_status === 'added'
     const isDeletedEdge = edge.change_status === 'deleted'

     // Base color from edge type
     let strokeColor = getEdgeColor(edge.edge_type)
     let markerColor = strokeColor

     // Override for structural changes
     if (isNewEdge) {
       strokeColor = '#22c55e' // green-500
       markerColor = '#22c55e'
     } else if (isDeletedEdge) {
       // Keep original color but faded
       // (color stays same for type recognition)
     }

     return {
       id: `e${index}-${edge.source}-${edge.target}`,
       source: edge.source,
       target: edge.target,
       type: 'default',
       markerEnd: {
         type: MarkerType.ArrowClosed,
         width: 15,
         height: 15,
         color: markerColor,
       },
       style: {
         stroke: strokeColor,
         strokeWidth: isNewEdge ? 2 : 1.5,
         strokeDasharray: isDeletedEdge
           ? '5,5'
           : getEdgeStrokeDasharray(edge.edge_type),
         opacity: isDeletedEdge ? 0.4 : 1,
       },
       data: {
         edge_type: edge.edge_type,
         change_status: edge.change_status,
       },
     }
   })
   ```

3. Update the ApiGraphEdge type annotation if needed. The type already exists in types.ts but verify it includes change_status (or use type assertion).

This gives:
- New edges: Green color, slightly thicker
- Deleted edges: Original color but dashed and faded (opacity 0.4)
- Unchanged edges: Normal styling based on edge_type
  </action>
  <verify>
TypeScript compiles: `cd frontend && npx tsc --noEmit`
  </verify>
  <done>
GraphCanvas renders new edges in green, deleted edges as faded dashed lines, matching the CONTEXT.md decisions.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `cd frontend && npx tsc --noEmit`
2. Dev server runs: `cd frontend && npm run dev`
3. Visual verification:
   - Load graph view with draft containing changes
   - Verify edited nodes have blue fill
   - Verify affected nodes have light blue fill
   - Verify new edges appear green
   - Verify deleted edges appear faded/dashed
</verification>

<success_criteria>
1. Directly edited nodes show #93c5fd (blue-300) fill
2. Transitively affected nodes show #dbeafe (blue-100) fill
3. Direct edit fill takes precedence over transitive
4. New edges (change_status='added') show green (#22c55e) stroke
5. Deleted edges (change_status='deleted') show faded (0.4 opacity) dashed stroke
6. TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/19-change-propagation/19-03-SUMMARY.md`
</output>
