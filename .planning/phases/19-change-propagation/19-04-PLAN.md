---
phase: 19-change-propagation
plan: 04
type: execute
wave: 2
depends_on: ["19-01"]
files_modified:
  - frontend/src/components/entity/detail/CategoryDetail.tsx
autonomous: true

must_haves:
  truths:
    - "User sees inheritance chain section in category detail modal"
    - "User sees edited ancestors highlighted in the inheritance chain"
    - "User can click ancestor in chain to navigate to that entity's detail"
  artifacts:
    - path: "frontend/src/components/entity/detail/CategoryDetail.tsx"
      provides: "Category detail with inheritance chain display"
      contains: "Inheritance Chain"
  key_links:
    - from: "frontend/src/components/entity/detail/CategoryDetail.tsx"
      to: "frontend/src/stores/draftStoreV2.ts"
      via: "useDraftStoreV2 for edited ancestor highlighting"
      pattern: "directlyEditedEntities"
    - from: "frontend/src/components/entity/detail/CategoryDetail.tsx"
      to: "frontend/src/stores/detailStore.ts"
      via: "openDetail for navigation"
      pattern: "openDetail"
---

<objective>
Add inheritance chain section to CategoryDetail modal showing clickable ancestry with edited ancestors highlighted.

Purpose: Users can discover inheritance relationships and understand which parent categories affect the current entity. When a parent is edited, it's highlighted so users understand the propagation chain. Clicking any ancestor navigates to that entity's detail.

Output: New AccordionSection in CategoryDetail.tsx showing the inheritance chain with visual indicators and navigation.

Note on labels: For MVP, the inheritance chain displays entity_keys (e.g., "Person", "Organization") which are human-readable identifiers in this ontology. Fetching full label data for each parent would require additional API calls. Entity_keys are acceptable for initial implementation as they match what users see elsewhere in the UI.
</objective>

<execution_context>
@/home/daharoni/.claude/get-shit-done/workflows/execute-plan.md
@/home/daharoni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/19-change-propagation/19-CONTEXT.md
@.planning/phases/19-change-propagation/19-RESEARCH.md
@.planning/phases/19-change-propagation/19-01-SUMMARY.md

@frontend/src/components/entity/detail/CategoryDetail.tsx
@frontend/src/stores/draftStoreV2.ts
@frontend/src/stores/detailStore.ts
@frontend/src/api/entitiesV2.ts
@frontend/src/lib/utils.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add inheritance chain section to CategoryDetail</name>
  <files>frontend/src/components/entity/detail/CategoryDetail.tsx</files>
  <action>
Add a new AccordionSection showing the category's inheritance chain with clickable navigation and edited ancestor highlighting:

1. Import useDraftStoreV2 from '@/stores/draftStoreV2'
2. Import cn from '@/lib/utils'

3. Add store subscription for direct edits:
   ```typescript
   const directEdits = useDraftStoreV2((s) => s.directlyEditedEntities)
   ```

4. The `category.parents` field already contains parent entity_keys. These entity_keys (e.g., "Person", "Organization") are human-readable and match the display elsewhere in the UI.

5. Add new AccordionSection after the "Parent Categories" section:
   ```tsx
   {/* Inheritance Chain section - shows parents with edit status */}
   {category.parents && category.parents.length > 0 && (
     <AccordionSection
       id="inheritance-chain"
       title="Inheritance Chain"
       count={category.parents.length}
       defaultOpen={false}
     >
       <div className="space-y-1">
         {category.parents.map((parentKey) => {
           const isParentEdited = directEdits.has(parentKey)
           return (
             <button
               key={parentKey}
               onClick={() => openDetail(parentKey, 'category')}
               className={cn(
                 'w-full text-left px-2 py-1.5 text-sm rounded flex items-center gap-2',
                 'hover:bg-sidebar-accent transition-colors',
                 isParentEdited && 'bg-blue-100 dark:bg-blue-900/30 font-medium'
               )}
             >
               <span className="flex-1 truncate">{parentKey}</span>
               {isParentEdited && (
                 <Badge variant="secondary" className="text-xs bg-blue-200 dark:bg-blue-800">
                   edited
                 </Badge>
               )}
             </button>
           )
         })}
       </div>
       {category.parents.some((p) => directEdits.has(p)) && (
         <p className="text-xs text-muted-foreground mt-2 px-2">
           Edited ancestors may affect this category's inherited properties.
         </p>
       )}
     </AccordionSection>
   )}
   ```

6. Note: The existing "Parent Categories" section uses EditableList with add/remove. The new "Inheritance Chain" section is read-only and focused on showing edit propagation status. Consider consolidating these in a future phase if the UX feels redundant.

For MVP, keep them separate:
- "Parent Categories" = editable list (add/remove parents)
- "Inheritance Chain" = read-only view showing edit impact
  </action>
  <verify>
TypeScript compiles: `cd frontend && npx tsc --noEmit`
  </verify>
  <done>
CategoryDetail shows Inheritance Chain section with clickable parent links, edited parents highlighted with blue background and "edited" badge. Parents display as entity_keys which are human-readable.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add transitive effect indicator for current entity</name>
  <files>frontend/src/components/entity/detail/CategoryDetail.tsx</files>
  <action>
Show an indicator in the header area if the current category is transitively affected by an edited parent:

1. Import transitivelyAffectedEntities from draftStoreV2:
   ```typescript
   const transitiveAffects = useDraftStoreV2((s) => s.transitivelyAffectedEntities)
   ```

2. Check if current entity is transitively affected:
   ```typescript
   const isTransitivelyAffected = transitiveAffects.has(entityKey)
   ```

3. Add a subtle indicator near the EntityHeader if affected:
   ```tsx
   {/* Transitive effect indicator */}
   {isTransitivelyAffected && (
     <div className="mb-4 p-2 rounded bg-blue-50 dark:bg-blue-900/10 border border-blue-200 dark:border-blue-800">
       <p className="text-sm text-blue-700 dark:text-blue-300">
         This category may be affected by changes to a parent category.
       </p>
     </div>
   )}
   ```

Place this just before the EntityHeader component inside the main return div.

This helps users understand why this entity is highlighted in the sidebar even though they didn't directly edit it.
  </action>
  <verify>
TypeScript compiles: `cd frontend && npx tsc --noEmit`
  </verify>
  <done>
CategoryDetail shows "affected by parent changes" indicator when the entity is in the transitivelyAffectedEntities set.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `cd frontend && npx tsc --noEmit`
2. Dev server runs: `cd frontend && npm run dev`
3. Visual verification:
   - Open a category detail that has parents
   - Verify Inheritance Chain section appears
   - Verify clicking a parent navigates to that category
   - Verify edited parents show blue highlight and "edited" badge
   - Verify transitively affected categories show info banner
</verification>

<success_criteria>
1. CategoryDetail has new "Inheritance Chain" AccordionSection when parents exist
2. Each parent in chain is clickable (navigates via openDetail)
3. Edited parents show bg-blue-100 highlight and "edited" badge
4. Transitively affected entities show info banner about parent changes
5. TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/19-change-propagation/19-04-SUMMARY.md`
</output>
