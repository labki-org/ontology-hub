---
phase: 31-frontend-create-edit-forms
plan: 02
type: execute
wave: 2
depends_on: ["31-01"]
files_modified:
  - frontend/src/components/entity/forms/schemas.ts
  - frontend/src/components/entity/forms/ResourceForm.tsx
  - frontend/src/components/layout/Sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "ResourceForm shows category dropdown at top"
    - "ResourceForm renders dynamic fields when category selected"
    - "Category change resets dynamic fields with warning behavior"
    - "+ New Dashboard button opens DashboardForm"
    - "+ New Resource button opens ResourceForm"
    - "Form submission creates draft change"
  artifacts:
    - path: "frontend/src/components/entity/forms/schemas.ts"
      provides: "resourceSchema, ResourceFormData type"
      contains: "resourceSchema"
    - path: "frontend/src/components/entity/forms/ResourceForm.tsx"
      provides: "ResourceForm component"
      exports: ["ResourceForm"]
      min_lines: 100
    - path: "frontend/src/components/layout/Sidebar.tsx"
      provides: "Dashboard and Resource form integration"
      contains: "DashboardForm"
  key_links:
    - from: "frontend/src/components/entity/forms/ResourceForm.tsx"
      to: "frontend/src/api/entities.ts"
      via: "useCategory hook for dynamic fields"
      pattern: "useCategory\\("
    - from: "frontend/src/components/layout/Sidebar.tsx"
      to: "frontend/src/components/entity/forms/DashboardForm.tsx"
      via: "import and render in modal"
      pattern: "import.*DashboardForm"
    - from: "frontend/src/components/layout/Sidebar.tsx"
      to: "frontend/src/components/entity/forms/ResourceForm.tsx"
      via: "import and render in modal"
      pattern: "import.*ResourceForm"
---

<objective>
Add ResourceForm with category-driven dynamic fields and integrate both Dashboard and Resource forms into Sidebar modal.

Purpose: Complete the form layer for Dashboard and Resource entities, enabling creation through the existing "+ New" buttons.
Output: ResourceForm.tsx with dynamic field population, Sidebar.tsx with form integration.
</objective>

<execution_context>
@/home/daharoni/.claude/get-shit-done/workflows/execute-plan.md
@/home/daharoni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-frontend-create-edit-forms/31-CONTEXT.md
@.planning/phases/31-frontend-create-edit-forms/31-RESEARCH.md

# Reference patterns
@frontend/src/components/entity/forms/schemas.ts
@frontend/src/components/entity/forms/CategoryForm.tsx
@frontend/src/components/entity/detail/ResourceDetail.tsx
@frontend/src/components/layout/Sidebar.tsx
@frontend/src/api/entities.ts
@frontend/src/api/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Resource schema and create ResourceForm</name>
  <files>
frontend/src/components/entity/forms/schemas.ts
frontend/src/components/entity/forms/ResourceForm.tsx
  </files>
  <action>
**Part A: Add resource schema to schemas.ts**

Add resourceSchema after dashboardSchema:
```typescript
export const resourceSchema = z.object({
  id: genericIdValidation,
  label: z.string().min(1, 'Label is required'),
  description: z.string().optional(),
  category_key: z.string().min(1, 'Category is required'),
  dynamic_fields: z.record(z.unknown()).default({}),
})

export type ResourceFormData = z.infer<typeof resourceSchema>
```

**Part B: Create ResourceForm.tsx**

Following CategoryForm.tsx structure:

1. Interface:
   ```typescript
   interface ResourceFormProps {
     onSubmit: (data: ResourceFormData) => void
     onCancel: () => void
     isSubmitting?: boolean
     draftId?: string
     initialData?: Partial<ResourceFormData>
   }
   ```

2. Form setup:
   - Use zodResolver(resourceSchema)
   - mode: 'onBlur'
   - Default values: id='', label='', description='', category_key='', dynamic_fields={}

3. Category selection (at top of form):
   - Use useCategories hook to fetch available categories
   - Use EntityCombobox with single-select behavior:
     ```typescript
     <EntityCombobox
       entityType="category"
       availableEntities={availableCategories}
       selectedKeys={form.watch('category_key') ? [form.watch('category_key')] : []}
       onChange={(keys) => {
         const newCategory = keys[0] || ''
         if (newCategory !== form.getValues('category_key')) {
           form.setValue('category_key', newCategory)
           form.setValue('dynamic_fields', {}) // Reset fields on category change
         }
       }}
       placeholder="Select category..."
     />
     ```
   - Show selected category with RelationshipChips (single chip)

4. Dynamic fields section (appears after category selected):
   - Use useCategory(selectedCategory, draftId) to fetch category detail
   - Cast to CategoryDetailV2 for type safety
   - Render Input for each property in categoryDetail.properties:
     ```typescript
     {categoryDetail?.properties.map((prop) => (
       <div key={prop.entity_key} className="space-y-2">
         <Label className="flex items-center gap-1">
           {prop.label}
           {prop.is_required && <span className="text-red-600">*</span>}
         </Label>
         <Input
           value={String(form.watch(`dynamic_fields.${prop.entity_key}`) ?? '')}
           onChange={(e) => {
             const current = form.getValues('dynamic_fields') || {}
             form.setValue('dynamic_fields', { ...current, [prop.entity_key]: e.target.value })
           }}
           placeholder={`Enter ${prop.label}...`}
         />
       </div>
     ))}
     ```
   - Show "Select a category to see fields" message when no category selected

5. Standard fields using FormField:
   - ID field (required, after category selection)
   - Label field (required)
   - Description field (optional, Textarea)

6. Submit/Cancel buttons

IMPORTANT: Always pass draftId to useCategory and useCategories hooks for draft overlay support.
  </action>
  <verify>TypeScript compiles without errors: `cd frontend && npx tsc --noEmit`</verify>
  <done>ResourceForm component with category dropdown, dynamic field population based on category properties</done>
</task>

<task type="auto">
  <name>Task 2: Integrate forms into Sidebar modal</name>
  <files>frontend/src/components/layout/Sidebar.tsx</files>
  <action>
Add DashboardForm and ResourceForm to the CreateEntityModal in Sidebar.tsx:

1. Add imports at top of file:
   ```typescript
   import { DashboardForm } from '@/components/entity/forms/DashboardForm'
   import { ResourceForm } from '@/components/entity/forms/ResourceForm'
   ```

2. Add form cases in CreateEntityModal (after BundleForm case, before closing tag):
   ```typescript
   {createModalEntityType === 'dashboard' && (
     <DashboardForm
       onSubmit={handleCreateSubmit}
       onCancel={closeCreateModal}
       isSubmitting={createEntity.isPending}
       draftId={draftId}
     />
   )}
   {createModalEntityType === 'resource' && (
     <ResourceForm
       onSubmit={handleCreateSubmit}
       onCancel={closeCreateModal}
       isSubmitting={createEntity.isPending}
       draftId={draftId}
     />
   )}
   ```

Note: The "+ New Dashboard" and "+ New Resource" buttons already exist in Sidebar (lines 549, 562) and call openCreateModal('dashboard') and openCreateModal('resource'). The CreateModalEntityType already includes 'dashboard' | 'resource'. We just need to add the form rendering.
  </action>
  <verify>
1. TypeScript compiles: `cd frontend && npx tsc --noEmit`
2. Run dev server: `cd frontend && npm run dev` - should start without errors
  </verify>
  <done>Sidebar renders DashboardForm when "+ New Dashboard" clicked, ResourceForm when "+ New Resource" clicked</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. schemas.ts exports resourceSchema and ResourceFormData
3. ResourceForm.tsx exports ResourceForm component
4. Sidebar.tsx imports and renders both DashboardForm and ResourceForm
5. Dev server starts without errors
6. No eslint errors blocking build
</verification>

<success_criteria>
- resourceSchema validates: id, label, description (optional), category_key (required), dynamic_fields
- ResourceFormData type is exported and usable
- ResourceForm shows category dropdown at top
- ResourceForm populates dynamic fields when category selected
- ResourceForm resets dynamic fields when category changes
- Sidebar renders DashboardForm in modal when createModalEntityType === 'dashboard'
- Sidebar renders ResourceForm in modal when createModalEntityType === 'resource'
- Form submission calls handleCreateSubmit (existing flow creates draft change)
</success_criteria>

<output>
After completion, create `.planning/phases/31-frontend-create-edit-forms/31-02-SUMMARY.md`
</output>
