---
phase: 08-database-foundation
plan: 03
type: execute
wave: 3
depends_on: ["08-01", "08-02"]
files_modified:
  - backend/app/models/v2/draft.py
  - backend/app/models/v2/__init__.py
  - backend/alembic/versions/005_v2_schema.py
autonomous: true

must_haves:
  truths:
    - "Draft table stores base_commit_sha for auto-rebase detection"
    - "Draft status workflow: draft -> validated -> submitted -> merged/rejected"
    - "Draft changes stored as JSON Patch for updates, full replacement for creates"
    - "Alembic migration creates all v2 tables and materialized view"
    - "Migration is reversible (downgrade drops v2 schema)"
  artifacts:
    - path: "backend/app/models/v2/draft.py"
      provides: "Draft and DraftChange models for v2.0 delta storage"
      exports: ["Draft", "DraftChange", "DraftStatus", "ChangeType", "DraftSource"]
    - path: "backend/alembic/versions/005_v2_schema.py"
      provides: "Complete v2.0 schema migration"
      contains: "def upgrade"
  key_links:
    - from: "backend/alembic/versions/005_v2_schema.py"
      to: "backend/app/models/v2/*.py"
      via: "Creates tables matching model definitions"
      pattern: "op\\.create_table"
    - from: "backend/app/models/v2/draft.py"
      to: "DraftChange table"
      via: "Foreign key from draft_change to draft"
      pattern: "foreign_key=\"draft\\.id\""
---

<objective>
Create draft tables (draft, draft_change) and the Alembic migration for the complete v2.0 schema.

Purpose: Enable storing draft changes as granular JSON Patch operations (v2.0 pattern) instead of a single payload blob (v1.0 pattern). The migration creates all tables and the materialized view.

Output: Draft models and runnable Alembic migration that creates the full v2.0 schema.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/08-database-foundation/08-CONTEXT.md
@.planning/phases/08-database-foundation/08-RESEARCH.md
@.planning/phases/08-database-foundation/08-01-SUMMARY.md
@.planning/phases/08-database-foundation/08-02-SUMMARY.md
@backend/alembic/versions/001_initial_schema.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create draft and draft_change models</name>
  <files>backend/app/models/v2/draft.py</files>
  <action>
Create the v2.0 draft models with JSON Patch storage:

**1. Enums:**
```python
class DraftStatus(str, Enum):
    DRAFT = "draft"
    VALIDATED = "validated"
    SUBMITTED = "submitted"
    MERGED = "merged"
    REJECTED = "rejected"

class ChangeType(str, Enum):
    CREATE = "create"
    UPDATE = "update"
    DELETE = "delete"

class DraftSource(str, Enum):
    HUB_UI = "hub_ui"
    MEDIAWIKI_PUSH = "mediawiki_push"
```

**2. Draft table:**
```python
class Draft(SQLModel, table=True):
    __tablename__ = "draft"

    id: uuid.UUID = Field(default_factory=uuid.uuid4, primary_key=True)
    capability_hash: str = Field(unique=True, index=True)  # SHA-256 of token
    base_commit_sha: str  # For auto-rebase detection
    status: DraftStatus = Field(
        default=DraftStatus.DRAFT,
        sa_column=Column(Enum(DraftStatus))
    )
    source: DraftSource = Field(sa_column=Column(Enum(DraftSource)))
    title: str | None = None  # Auto-generated or user-provided
    description: str | None = None  # Auto-generated summary
    user_comment: str | None = None  # User-editable notes

    # Timestamps for workflow tracking
    created_at: datetime = Field(default_factory=datetime.utcnow)
    modified_at: datetime = Field(default_factory=datetime.utcnow)
    validated_at: datetime | None = None
    submitted_at: datetime | None = None
    expires_at: datetime  # TTL expiration

    # Rebase tracking
    rebase_status: str | None = None  # "clean", "conflict", "pending"
    rebase_commit_sha: str | None = None  # New canonical after rebase

    # Legacy fields for compatibility during transition
    pr_url: str | None = None
```

**3. DraftChange table:**
```python
class DraftChange(SQLModel, table=True):
    __tablename__ = "draft_change"

    id: uuid.UUID = Field(default_factory=uuid.uuid4, primary_key=True)
    draft_id: uuid.UUID = Field(foreign_key="draft.id", index=True)
    change_type: ChangeType = Field(sa_column=Column(Enum(ChangeType)))
    entity_type: str  # "category", "property", etc. (string, not enum FK)
    entity_key: str = Field(index=True)  # The entity being changed
    patch: dict | None = Field(default=None, sa_column=Column(JSON))  # JSON Patch for updates
    replacement_json: dict | None = Field(default=None, sa_column=Column(JSON))  # Full JSON for creates
    created_at: datetime = Field(default_factory=datetime.utcnow)
```

**4. Response schemas:**
```python
class DraftPublic(SQLModel):
    """Public schema for Draft responses."""
    id: uuid.UUID
    status: DraftStatus
    source: DraftSource
    title: str | None
    description: str | None
    user_comment: str | None
    created_at: datetime
    modified_at: datetime
    expires_at: datetime
    rebase_status: str | None

class DraftChangePublic(SQLModel):
    """Public schema for DraftChange responses."""
    id: uuid.UUID
    change_type: ChangeType
    entity_type: str
    entity_key: str
    patch: dict | None
    replacement_json: dict | None
    created_at: datetime
```

Add proper imports (uuid, datetime, Enum, JSON, Column, Field, SQLModel).
  </action>
  <verify>
```bash
cd /home/daharoni/dev/ontology-hub && python -c "
from backend.app.models.v2.draft import (
    Draft, DraftChange, DraftStatus, ChangeType, DraftSource,
    DraftPublic, DraftChangePublic
)
print('Draft models OK')
print(f'Draft table: {Draft.__tablename__}')
print(f'DraftChange table: {DraftChange.__tablename__}')
print(f'DraftStatus values: {[s.value for s in DraftStatus]}')
"
```
  </verify>
  <done>Draft and DraftChange models with JSON Patch support, status workflow, and rebase tracking</done>
</task>

<task type="auto">
  <name>Task 2: Update v2 __init__.py with draft exports</name>
  <files>backend/app/models/v2/__init__.py</files>
  <action>
Update the v2 models __init__.py to include draft model exports:

Add imports and re-exports for:
- Draft, DraftChange, DraftStatus, ChangeType, DraftSource (from draft.py)
- DraftPublic, DraftChangePublic (from draft.py)

Ensure all exports are in __all__ list.

The final __init__.py should export:
- Enums: EntityType, IngestStatus, DraftStatus, ChangeType, DraftSource
- Version: OntologyVersion
- Entities: Category, Property, Subobject, Module, Bundle, Template (+ Base, Public variants)
- Relationships: CategoryParent, CategoryProperty, ModuleEntity, BundleModule
- View: CategoryPropertyEffective, CATEGORY_PROPERTY_EFFECTIVE_SQL, refresh_category_property_effective
- Drafts: Draft, DraftChange, DraftPublic, DraftChangePublic
  </action>
  <verify>
```bash
cd /home/daharoni/dev/ontology-hub && python -c "
from backend.app.models.v2 import (
    # All previous exports
    Category, Property, Subobject, Module, Bundle, Template,
    OntologyVersion, EntityType, IngestStatus,
    CategoryParent, CategoryProperty, ModuleEntity, BundleModule,
    CategoryPropertyEffective,
    # New draft exports
    Draft, DraftChange, DraftStatus, ChangeType, DraftSource
)
print('All v2 models importable including drafts')
"
```
  </verify>
  <done>Complete v2 model exports including all draft-related models and enums</done>
</task>

<task type="auto">
  <name>Task 3: Create Alembic migration for v2 schema</name>
  <files>backend/alembic/versions/005_v2_schema.py</files>
  <action>
Create the complete v2.0 schema migration:

**Header:**
```python
"""v2.0 schema: separate entity tables, relationship tables, and materialized view.

Revision ID: 005
Revises: 004
Create Date: 2026-01-23

Creates:
- ontology_version: Current canonical state tracking
- Entity tables: category, property, subobject, module, bundle, template
- Relationship tables: category_parent, category_property, module_entity, bundle_module
- Materialized view: category_property_effective
- Draft tables: draft, draft_change (replaces v1.0 drafts table)
"""
```

**upgrade() function:**
1. Create new enums: ingeststatus, draftstatus_v2, changetype, draftsource
2. Create ontology_version table
3. Create 6 entity tables (category, property, subobject, module, bundle, template)
   - Each with id (UUID PK), entity_key (unique, indexed), source_path, label (indexed), description, canonical_json (JSON), created_at, updated_at
   - module and bundle also have version column
   - template also has wikitext column
4. Create relationship tables:
   - category_parent (category_id, parent_id - composite PK, both FK to category.id)
   - category_property (category_id, property_id - composite PK, is_required bool)
   - module_entity (id UUID PK, module_id FK, entity_type varchar, entity_key varchar indexed)
   - bundle_module (bundle_id, module_id - composite PK)
5. Create materialized view using raw SQL (from CATEGORY_PROPERTY_EFFECTIVE_SQL)
6. Create unique index on materialized view (for REFRESH CONCURRENTLY)
7. Create draft table (v2 schema with base_commit_sha, rebase fields)
8. Create draft_change table (with patch and replacement_json JSON columns)

**downgrade() function:**
- Drop all v2 tables in reverse order
- Drop materialized view
- Drop new enums
- Note: Does NOT restore v1.0 tables (one-way migration for v2.0 rebuild)

Use sa.Enum() for PostgreSQL enum types. Follow pattern from 001_initial_schema.py.
  </action>
  <verify>
```bash
cd /home/daharoni/dev/ontology-hub && python -c "
# Syntax check the migration file
import importlib.util
spec = importlib.util.spec_from_file_location(
    'migration',
    'backend/alembic/versions/005_v2_schema.py'
)
module = importlib.util.module_from_spec(spec)
spec.loader.exec_module(module)
print(f'Migration revision: {module.revision}')
print(f'Revises: {module.down_revision}')
assert hasattr(module, 'upgrade')
assert hasattr(module, 'downgrade')
print('Migration file valid')
"
```
  </verify>
  <done>Complete v2.0 migration with all tables, relationships, materialized view, and draft storage</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Full import check:**
```bash
cd /home/daharoni/dev/ontology-hub && python -c "
from backend.app.models.v2 import (
    # Enums
    EntityType, IngestStatus, DraftStatus, ChangeType, DraftSource,
    # Version
    OntologyVersion,
    # Entities
    Category, Property, Subobject, Module, Bundle, Template,
    # Relationships
    CategoryParent, CategoryProperty, ModuleEntity, BundleModule,
    # View
    CategoryPropertyEffective, CATEGORY_PROPERTY_EFFECTIVE_SQL,
    # Drafts
    Draft, DraftChange
)
print('Complete v2 model suite importable')
"
```

2. **Migration syntax check:**
```bash
cd /home/daharoni/dev/ontology-hub/backend && python -c "
from alembic.config import Config
from alembic.script import ScriptDirectory
config = Config('alembic.ini')
script = ScriptDirectory.from_config(config)
revisions = list(script.walk_revisions())
print(f'Total migrations: {len(revisions)}')
for rev in revisions:
    print(f'  {rev.revision}: {rev.doc.split(chr(10))[0] if rev.doc else \"No doc\"}')
"
```

3. **Draft model field check:**
```bash
cd /home/daharoni/dev/ontology-hub && python -c "
from backend.app.models.v2 import Draft, DraftChange
# Check Draft has rebase fields
assert hasattr(Draft, 'base_commit_sha')
assert hasattr(Draft, 'rebase_status')
assert hasattr(Draft, 'rebase_commit_sha')
# Check DraftChange has patch fields
assert hasattr(DraftChange, 'patch')
assert hasattr(DraftChange, 'replacement_json')
print('Draft models have required fields')
"
```
</verification>

<success_criteria>
- Draft model with capability_hash, base_commit_sha, status, source, rebase fields
- DraftChange model with change_type, entity_type, entity_key, patch, replacement_json
- DraftStatus enum with 5 states: draft, validated, submitted, merged, rejected
- ChangeType enum with 3 states: create, update, delete
- Alembic migration 005 creates all v2 tables
- Alembic migration creates materialized view with unique index
- Migration is syntactically valid and references correct down_revision (004)
- All models re-exported from backend.app.models.v2
</success_criteria>

<output>
After completion, create `.planning/phases/08-database-foundation/08-03-SUMMARY.md`
</output>
