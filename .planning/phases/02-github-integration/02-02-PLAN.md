---
phase: 02-github-integration
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - backend/app/routers/__init__.py
  - backend/app/routers/entities.py
  - backend/app/schemas/entity.py
  - backend/app/schemas/__init__.py
  - backend/app/main.py
  - backend/tests/test_entities_api.py
autonomous: true

must_haves:
  truths:
    - "User can retrieve entity by type and ID via API"
    - "User can list entities by type with pagination"
    - "Pagination cursor correctly returns next page"
  artifacts:
    - path: "backend/app/routers/entities.py"
      provides: "Entity API endpoints"
      exports: ["router"]
    - path: "backend/app/schemas/entity.py"
      provides: "Entity response schemas with pagination"
      exports: ["EntityListResponse"]
    - path: "backend/tests/test_entities_api.py"
      provides: "Entity API test coverage"
      contains: "test_get_entity"
  key_links:
    - from: "backend/app/routers/entities.py"
      to: "backend/app/models/entity.py"
      via: "SQLModel query"
      pattern: "select.*Entity.*where"
    - from: "backend/app/main.py"
      to: "backend/app/routers/entities.py"
      via: "router include"
      pattern: "include_router.*entities"
---

<objective>
Create Entity API endpoints for retrieving indexed data with cursor-based pagination.

Purpose: Expose indexed entity data via REST API so consumers can browse and search the schema repository.
Output: GET /entities/{type}/{id} endpoint, GET /entities/{type} with pagination, and comprehensive test coverage.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 1 patterns
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/phases/01-foundation/01-02-SUMMARY.md

# Research for this phase
@.planning/phases/02-github-integration/02-RESEARCH.md

# Plan 02-01 output (will exist after 02-01 completes)
@.planning/phases/02-github-integration/02-01-SUMMARY.md

# Existing codebase
@backend/app/main.py
@backend/app/database.py
@backend/app/models/entity.py
@backend/app/routers/drafts.py
@backend/tests/test_drafts_api.py
@backend/tests/conftest.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Entity API Endpoints with Pagination</name>
  <files>
    backend/app/routers/entities.py
    backend/app/routers/__init__.py
    backend/app/schemas/entity.py
    backend/app/schemas/__init__.py
    backend/app/main.py
  </files>
  <action>
**Create backend/app/schemas/entity.py:**

1. Define pagination response schema:
   ```python
   from typing import Optional
   from pydantic import BaseModel
   from app.models.entity import EntityPublic

   class EntityListResponse(BaseModel):
       items: list[EntityPublic]
       next_cursor: Optional[str] = None
       has_next: bool
   ```

**Update backend/app/schemas/__init__.py:**
- Export EntityListResponse

**Create backend/app/routers/entities.py:**

1. Create router with prefix `/entities` and tag `entities`

2. Implement `GET /{entity_type}/{entity_id}`:
   - Path parameter entity_type: EntityType enum
   - Path parameter entity_id: str
   - Query database for matching entity where deleted_at is None
   - Return EntityPublic
   - Return 404 if not found
   - Rate limit: 100/minute (use existing RATE_LIMITS pattern)

3. Implement `GET /{entity_type}`:
   - Path parameter entity_type: EntityType enum
   - Query params: cursor (Optional[str]), limit (int, default 20, max 100)
   - Use cursor-based pagination on entity_id (from research Pattern 6)
   - Return EntityListResponse with items, next_cursor, has_next
   - Filter where deleted_at is None
   - Order by entity_id for consistent pagination
   - Rate limit: 100/minute

4. Implement `GET /` (list all entity types):
   - Returns summary: count per entity_type
   - Useful for dashboard/overview

**Update backend/app/routers/__init__.py:**
- Import and export entities_router

**Update backend/app/main.py:**
- Import entities_router from routers
- Add: `app.include_router(entities_router, prefix="/api/v1")`
  </action>
  <verify>
- OpenAPI docs at http://localhost:8080/docs show new endpoints
- `curl http://localhost:8080/api/v1/entities/category` returns valid JSON (empty list if no data)
- `curl http://localhost:8080/api/v1/entities/category/NonExistent` returns 404
  </verify>
  <done>
Entity API endpoints exist with cursor-based pagination. Users can retrieve entities by type and ID, and list entities with pagination.
  </done>
</task>

<task type="auto">
  <name>Task 2: Tests for Entity API</name>
  <files>
    backend/tests/test_entities_api.py
  </files>
  <action>
**Create backend/tests/test_entities_api.py:**

1. Test entity retrieval:
   - Create entity in database via test_session
   - GET /api/v1/entities/{type}/{id} returns entity
   - GET for non-existent entity returns 404

2. Test entity listing:
   - Create multiple entities
   - GET /api/v1/entities/{type} returns list
   - Test pagination: create >20 entities, verify cursor and has_next

3. Test entity type filtering:
   - Create entities of different types
   - Each type endpoint only returns that type

4. Test soft delete filtering:
   - Create entity with deleted_at set
   - Verify it does not appear in list or get endpoints

Follow existing test patterns from backend/tests/conftest.py and test_drafts_api.py.
  </action>
  <verify>
- `docker compose exec backend pytest backend/tests/test_entities_api.py -v` passes
- All tests pass: `docker compose exec backend pytest -v`
  </verify>
  <done>
Test coverage exists for entity API endpoints (retrieval, listing, pagination, soft delete filtering).
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Entity API works:**
   - GET /api/v1/entities/category/{id} returns entity or 404
   - GET /api/v1/entities/category returns paginated list
   - Pagination cursor works correctly

2. **Tests pass:**
   - `pytest backend/tests/test_entities_api.py -v` all green
</verification>

<success_criteria>
- GET /api/v1/entities/{type}/{id} returns entity by type and ID
- GET /api/v1/entities/{type} returns paginated entity list
- Cursor-based pagination works correctly with has_next indicator
- Soft-deleted entities are excluded from results
- Tests cover all endpoints
</success_criteria>

<output>
After completion, create `.planning/phases/02-github-integration/02-02-SUMMARY.md`
</output>
