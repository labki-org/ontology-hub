---
phase: 02-github-integration
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - backend/app/routers/webhooks.py
  - backend/app/routers/__init__.py
  - backend/app/main.py
  - backend/tests/test_webhook.py
autonomous: true

must_haves:
  truths:
    - "Webhook handler verifies GitHub signature"
    - "Push events trigger re-indexing of repository"
    - "Non-push events are acknowledged but not processed"
    - "Invalid signatures return 403 Forbidden"
  artifacts:
    - path: "backend/app/routers/webhooks.py"
      provides: "GitHub webhook handler"
      exports: ["router"]
    - path: "backend/tests/test_webhook.py"
      provides: "Webhook test coverage"
      contains: "test_webhook_signature"
  key_links:
    - from: "backend/app/routers/webhooks.py"
      to: "backend/app/services/indexer.py"
      via: "sync_repository call in background task"
      pattern: "from app.services.indexer import sync_repository"
    - from: "backend/app/routers/webhooks.py"
      to: "HMAC verification"
      via: "hmac.compare_digest"
      pattern: "hmac\\.compare_digest"
    - from: "backend/app/routers/webhooks.py"
      to: "backend/app/main.py"
      via: "request.app.state.github_client for dependency injection"
      pattern: "request\\.app\\.state\\.github_client"
---

<objective>
Create GitHub webhook handler for processing push events with HMAC signature verification.

Purpose: Enable real-time re-indexing when the canonical repository changes, triggered by GitHub webhooks.
Output: POST /webhooks/github endpoint with signature verification, background sync trigger, and comprehensive test coverage.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 1 patterns
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/phases/01-foundation/01-02-SUMMARY.md

# Research for this phase
@.planning/phases/02-github-integration/02-RESEARCH.md

# Plan 02-01 output (will exist after 02-01 completes)
@.planning/phases/02-github-integration/02-01-SUMMARY.md

# Existing codebase
@backend/app/main.py
@backend/app/database.py
@backend/app/config.py
@backend/app/services/github.py
@backend/app/services/indexer.py
@backend/tests/conftest.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: GitHub Webhook Handler with HMAC Verification</name>
  <files>
    backend/app/routers/webhooks.py
    backend/app/routers/__init__.py
    backend/app/main.py
  </files>
  <action>
**Create backend/app/routers/webhooks.py:**

1. Create router with prefix `/webhooks` and tag `webhooks`

2. Implement HMAC signature verification function (from research Pattern 4):
   ```python
   import hmac
   import hashlib
   from fastapi import Request, HTTPException

   async def verify_github_signature(request: Request) -> bytes:
       """Verify GitHub webhook signature and return raw body."""
       from app.config import settings

       # If no webhook secret configured, skip verification (dev mode)
       if not settings.GITHUB_WEBHOOK_SECRET:
           return await request.body()

       signature_header = request.headers.get("x-hub-signature-256")
       if not signature_header:
           raise HTTPException(status_code=403, detail="Missing signature header")

       body = await request.body()

       expected_signature = "sha256=" + hmac.new(
           settings.GITHUB_WEBHOOK_SECRET.encode("utf-8"),
           body,
           hashlib.sha256
       ).hexdigest()

       if not hmac.compare_digest(expected_signature, signature_header):
           raise HTTPException(status_code=403, detail="Invalid signature")

       return body
   ```

3. Create background task function with proper dependency injection:
   ```python
   import asyncio
   from app.services.github import GitHubClient
   from app.services.indexer import sync_repository
   from app.database import async_engine
   from sqlalchemy.ext.asyncio import AsyncSession
   from app.config import settings

   async def trigger_sync_background(httpx_client):
       """Background task to sync repository.

       Creates its own database session since FastAPI BackgroundTasks
       run after the request context is closed.
       """
       async with AsyncSession(async_engine) as session:
           github_client = GitHubClient(httpx_client)
           try:
               result = await sync_repository(
                   github_client=github_client,
                   session=session,
                   owner=settings.GITHUB_REPO_OWNER,
                   repo=settings.GITHUB_REPO_NAME
               )
               logger.info(f"Background sync complete: {result}")
           except Exception as e:
               logger.error(f"Background sync failed: {e}")
   ```

4. Implement `POST /github`:
   ```python
   from fastapi import BackgroundTasks, Request
   import json

   @router.post("/github")
   async def github_webhook(
       request: Request,
       background_tasks: BackgroundTasks,
   ):
       # Verify signature and get raw body
       body = await verify_github_signature(request)
       payload = json.loads(body)

       # Check event type
       event_type = request.headers.get("x-github-event", "unknown")

       if event_type != "push":
           return {"status": "ignored", "event": event_type}

       # Extract changed files for logging
       changed_files = set()
       for commit in payload.get("commits", []):
           changed_files.update(commit.get("added", []))
           changed_files.update(commit.get("modified", []))
           changed_files.update(commit.get("removed", []))

       # Check for force push
       is_forced = payload.get("forced", False)

       # Get the httpx client from app state for the background task
       # IMPORTANT: Pass the raw httpx client, not wrapped GitHubClient
       # The background task will wrap it since session context differs
       httpx_client = request.app.state.github_client

       # Trigger background sync
       background_tasks.add_task(trigger_sync_background, httpx_client)

       return {
           "status": "accepted",
           "event": event_type,
           "files_changed": len(changed_files),
           "forced": is_forced,
           "message": "Sync triggered in background"
       }
   ```

**Update backend/app/routers/__init__.py:**
- Import and export webhooks_router

**Update backend/app/main.py:**
- Import webhooks_router from routers
- Add: `app.include_router(webhooks_router, prefix="/api/v1")`
  </action>
  <verify>
- OpenAPI docs show POST /api/v1/webhooks/github endpoint
- Without GITHUB_WEBHOOK_SECRET set, webhook accepts any payload (dev mode)
- With secret set, invalid signature returns 403
- Valid push event returns {"status": "accepted", ...}
  </verify>
  <done>
Webhook handler processes GitHub push events with HMAC-SHA256 signature verification. Push events trigger background re-indexing using proper dependency injection (httpx client from app.state, fresh AsyncSession created in background task).
  </done>
</task>

<task type="auto">
  <name>Task 2: Tests for Webhook Handler</name>
  <files>
    backend/tests/test_webhook.py
  </files>
  <action>
**Create backend/tests/test_webhook.py:**

1. Test signature verification:
   ```python
   import hmac
   import hashlib
   import json
   from unittest.mock import patch

   def create_signature(body: bytes, secret: str) -> str:
       """Create valid GitHub webhook signature."""
       return "sha256=" + hmac.new(
           secret.encode("utf-8"),
           body,
           hashlib.sha256
       ).hexdigest()
   ```

2. Test valid signature passes:
   - Mock GITHUB_WEBHOOK_SECRET in settings
   - POST with valid signature header
   - Returns 200 with accepted status

3. Test invalid signature returns 403:
   - Mock GITHUB_WEBHOOK_SECRET in settings
   - POST with wrong signature header
   - Returns 403 with "Invalid signature" detail

4. Test missing signature header returns 403:
   - Mock GITHUB_WEBHOOK_SECRET in settings
   - POST without x-hub-signature-256 header
   - Returns 403 with "Missing signature header" detail

5. Test push event handling:
   - POST with valid push payload
   - Returns {"status": "accepted", "files_changed": N}

6. Test non-push event ignored:
   - POST with x-github-event: "ping"
   - Returns {"status": "ignored", "event": "ping"}

7. Test no secret (dev mode):
   - Without GITHUB_WEBHOOK_SECRET, signature check is skipped
   - Any payload is accepted

8. Mock the background sync task to avoid actual GitHub API calls:
   ```python
   @pytest.fixture
   def mock_sync():
       with patch("app.routers.webhooks.trigger_sync_background"):
           yield
   ```

Follow existing test patterns from backend/tests/conftest.py and test_drafts_api.py.
  </action>
  <verify>
- `docker compose exec backend pytest backend/tests/test_webhook.py -v` passes
- All tests pass: `docker compose exec backend pytest -v`
  </verify>
  <done>
Test coverage exists for webhook handler (signature verification, event handling, dev mode skip).
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Webhook handler works:**
   - POST /api/v1/webhooks/github with valid signature triggers sync
   - Invalid signature returns 403
   - Non-push events are ignored gracefully

2. **Background sync is properly wired:**
   - Uses httpx client from app.state (connection pooling preserved)
   - Creates fresh AsyncSession in background task (avoids closed session)
   - Logs success/failure

3. **Tests pass:**
   - `pytest backend/tests/test_webhook.py -v` all green
</verification>

<success_criteria>
- POST /api/v1/webhooks/github verifies HMAC signature
- Push events trigger background re-indexing
- Non-push events return ignored status
- Invalid signatures return 403 Forbidden
- Missing signature header returns 403 Forbidden
- Dev mode (no secret) skips verification
- Tests cover all scenarios
</success_criteria>

<output>
After completion, create `.planning/phases/02-github-integration/02-03-SUMMARY.md`
</output>
