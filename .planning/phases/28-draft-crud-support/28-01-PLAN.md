---
phase: 28-draft-crud-support
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/schemas/draft_change.py
  - backend/app/routers/draft_changes.py
autonomous: true

must_haves:
  truths:
    - "POST /drafts/{token}/changes accepts entity_type 'dashboard'"
    - "POST /drafts/{token}/changes accepts entity_type 'resource'"
    - "Dashboard CREATE without pages array returns 400"
    - "Dashboard CREATE without root page returns 400"
  artifacts:
    - path: "backend/app/schemas/draft_change.py"
      provides: "Entity type validation including dashboard and resource"
      contains: '"dashboard", "resource"'
    - path: "backend/app/routers/draft_changes.py"
      provides: "Dashboard and resource models in ENTITY_MODEL_MAP"
      contains: "Dashboard"
  key_links:
    - from: "backend/app/routers/draft_changes.py"
      to: "backend/app/models/v2"
      via: "import Dashboard, Resource"
      pattern: "from app\\.models\\.v2 import.*Dashboard.*Resource"
---

<objective>
Register dashboard and resource entity types for draft CRUD and add dashboard creation validation.

Purpose: Enable draft changes for new entity types with schema-compliant dashboard validation.
Output: Working entity type registration and dashboard pages validation.
</objective>

<execution_context>
@/home/daharoni/.claude/get-shit-done/workflows/execute-plan.md
@/home/daharoni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@backend/app/schemas/draft_change.py
@backend/app/routers/draft_changes.py
@backend/app/models/v2/dashboard.py
@backend/app/models/v2/resource.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add dashboard and resource to entity type validation</name>
  <files>backend/app/schemas/draft_change.py</files>
  <action>
Update VALID_ENTITY_TYPES frozenset to include "dashboard" and "resource":

```python
VALID_ENTITY_TYPES = frozenset(
    {"category", "property", "subobject", "module", "bundle", "template", "dashboard", "resource"}
)
```

This enables the schema validator to accept these entity types in DraftChangeCreate requests.
  </action>
  <verify>
Run: `grep -A2 "VALID_ENTITY_TYPES" backend/app/schemas/draft_change.py`
Should show both "dashboard" and "resource" in the set.
  </verify>
  <done>VALID_ENTITY_TYPES includes "dashboard" and "resource"</done>
</task>

<task type="auto">
  <name>Task 2: Add Dashboard and Resource to ENTITY_MODEL_MAP and implement dashboard validation</name>
  <files>backend/app/routers/draft_changes.py</files>
  <action>
1. Update imports to include Dashboard and Resource from app.models.v2:

```python
from app.models.v2 import (
    Bundle,
    Category,
    ChangeType,
    Dashboard,  # ADD
    Draft,
    DraftChange,
    DraftStatus,
    Module,
    Property,
    Resource,  # ADD
    Subobject,
    Template,
)
```

2. Update ENTITY_MODEL_MAP to include the new entity types:

```python
ENTITY_MODEL_MAP = {
    "category": Category,
    "property": Property,
    "subobject": Subobject,
    "module": Module,
    "bundle": Bundle,
    "template": Template,
    "dashboard": Dashboard,
    "resource": Resource,
}
```

3. Add a dashboard validation helper function before add_draft_change:

```python
def validate_dashboard_create(replacement_json: dict | None) -> str | None:
    """Validate dashboard creation JSON per CONTEXT.md decisions.

    Requirements:
    - Dashboard must have at least one page (cannot create empty)
    - Dashboard must have a root page (name: "")

    Args:
        replacement_json: The dashboard JSON to validate

    Returns:
        Error message if invalid, None if valid
    """
    if not replacement_json:
        return "Dashboard creation requires replacement_json"

    pages = replacement_json.get("pages", [])
    if not pages:
        return "Dashboard must have at least one page"

    # Check for root page (name: "")
    has_root = any(
        isinstance(page, dict) and page.get("name") == ""
        for page in pages
    )
    if not has_root:
        return "Dashboard must have a root page (name: '')"

    return None
```

4. In add_draft_change(), after the existing entity validation but BEFORE creating the DraftChange, add dashboard validation:

```python
# After: "elif change_in.change_type == ChangeType.CREATE:" block
# Before: "if existing_change and change_in.change_type == ChangeType.UPDATE:"

# Dashboard creation validation
if change_in.entity_type == "dashboard" and change_in.change_type == ChangeType.CREATE:
    error = validate_dashboard_create(change_in.replacement_json)
    if error:
        raise HTTPException(status_code=400, detail=error)
```

Insert this validation after line ~329 (after the CREATE entity existence check) and before the existing_change handling block.
  </action>
  <verify>
1. Check imports: `grep -E "Dashboard|Resource" backend/app/routers/draft_changes.py`
2. Check ENTITY_MODEL_MAP: `grep -A10 "ENTITY_MODEL_MAP" backend/app/routers/draft_changes.py`
3. Check validation function exists: `grep -A15 "def validate_dashboard_create" backend/app/routers/draft_changes.py`
4. Run backend tests: `cd /home/daharoni/dev/ontology-hub && python -m pytest backend/tests/test_draft_changes.py -v --tb=short`
  </verify>
  <done>
- Dashboard and Resource in ENTITY_MODEL_MAP
- validate_dashboard_create function validates pages array and root page
- Dashboard CREATE calls validation and returns 400 on failure
  </done>
</task>

</tasks>

<verification>
1. Entity registration: Both "dashboard" and "resource" accepted by schema validation
2. Dashboard validation: CREATE without pages returns 400 with clear message
3. Dashboard validation: CREATE without root page returns 400 with clear message
4. Existing tests still pass (no regressions in other entity types)
</verification>

<success_criteria>
- VALID_ENTITY_TYPES includes "dashboard" and "resource"
- ENTITY_MODEL_MAP includes Dashboard and Resource models
- validate_dashboard_create function rejects empty dashboards
- validate_dashboard_create function rejects dashboards without root page
- Existing draft change tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/28-draft-crud-support/28-01-SUMMARY.md`
</output>
