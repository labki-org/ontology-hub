---
phase: 28-draft-crud-support
plan: 03
type: execute
wave: 2
depends_on: ["28-01", "28-02"]
files_modified:
  - backend/tests/test_draft_crud_dashboard_resource.py
autonomous: true

must_haves:
  truths:
    - "Dashboard CREATE/UPDATE/DELETE operations work via draft changes API"
    - "Resource CREATE/UPDATE/DELETE operations work via draft changes API"
    - "Validation rejects invalid dashboards and resources with clear errors"
  artifacts:
    - path: "backend/tests/test_draft_crud_dashboard_resource.py"
      provides: "Integration tests for dashboard and resource draft CRUD"
      min_lines: 100
  key_links:
    - from: "backend/tests/test_draft_crud_dashboard_resource.py"
      to: "/api/v2/drafts/{token}/changes"
      via: "HTTP POST/DELETE requests"
      pattern: "client\\.post.*drafts.*changes"
---

<objective>
Create comprehensive integration tests for dashboard and resource CRUD operations in drafts.

Purpose: Verify that CREATE/UPDATE/DELETE work correctly for new entity types with proper validation.
Output: Test file covering happy paths and error cases for both dashboard and resource draft changes.
</objective>

<execution_context>
@/home/daharoni/.claude/get-shit-done/workflows/execute-plan.md
@/home/daharoni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-draft-crud-support/28-01-SUMMARY.md
@.planning/phases/28-draft-crud-support/28-02-SUMMARY.md
@backend/tests/test_draft_changes.py
@backend/tests/conftest.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create integration tests for dashboard and resource draft CRUD</name>
  <files>backend/tests/test_draft_crud_dashboard_resource.py</files>
  <action>
Create a new test file with comprehensive tests for dashboard and resource CRUD operations.

The tests should cover:

**Dashboard Tests:**
1. CREATE dashboard with valid pages - success (201)
2. CREATE dashboard without pages - failure (400)
3. CREATE dashboard without root page - failure (400)
4. UPDATE dashboard (patch pages) - success
5. DELETE dashboard - success
6. DELETE draft-created dashboard removes it entirely

**Resource Tests:**
1. CREATE resource with valid category and fields - success (201)
2. CREATE resource without category - failure (400)
3. CREATE resource with nonexistent category - failure (400)
4. CREATE resource with invalid property field - failure (400)
5. UPDATE resource (patch fields) - success
6. UPDATE resource with invalid field after patch - failure (400)
7. DELETE resource - success
8. Resource with draft-created category - validates against draft category

Use existing test patterns from test_draft_changes.py for fixtures and client setup.

```python
"""Integration tests for dashboard and resource draft CRUD operations.

Tests the POST /drafts/{token}/changes endpoint for:
- Dashboard CREATE/UPDATE/DELETE with pages validation
- Resource CREATE/UPDATE/DELETE with category property validation
"""

import pytest
from httpx import AsyncClient

from app.models.v2 import ChangeType


class TestDashboardDraftCRUD:
    """Tests for dashboard draft change operations."""

    @pytest.mark.asyncio
    async def test_create_dashboard_success(
        self,
        client: AsyncClient,
        test_draft_token: str,
    ):
        """Dashboard CREATE with valid pages returns 201."""
        response = await client.post(
            f"/api/v2/drafts/{test_draft_token}/changes",
            json={
                "change_type": "CREATE",
                "entity_type": "dashboard",
                "entity_key": "Test_Dashboard",
                "replacement_json": {
                    "id": "Test_Dashboard",
                    "label": "Test Dashboard",
                    "description": "A test dashboard",
                    "pages": [
                        {"name": "", "wikitext": "Root page content"},
                        {"name": "Details", "wikitext": "Details page content"},
                    ],
                },
            },
        )
        assert response.status_code == 201
        data = response.json()
        assert data["entity_type"] == "dashboard"
        assert data["entity_key"] == "Test_Dashboard"
        assert data["change_type"] == "CREATE"

    @pytest.mark.asyncio
    async def test_create_dashboard_no_pages_fails(
        self,
        client: AsyncClient,
        test_draft_token: str,
    ):
        """Dashboard CREATE without pages returns 400."""
        response = await client.post(
            f"/api/v2/drafts/{test_draft_token}/changes",
            json={
                "change_type": "CREATE",
                "entity_type": "dashboard",
                "entity_key": "Empty_Dashboard",
                "replacement_json": {
                    "id": "Empty_Dashboard",
                    "label": "Empty Dashboard",
                    "description": "No pages",
                    "pages": [],
                },
            },
        )
        assert response.status_code == 400
        assert "at least one page" in response.json()["detail"].lower()

    @pytest.mark.asyncio
    async def test_create_dashboard_no_root_page_fails(
        self,
        client: AsyncClient,
        test_draft_token: str,
    ):
        """Dashboard CREATE without root page returns 400."""
        response = await client.post(
            f"/api/v2/drafts/{test_draft_token}/changes",
            json={
                "change_type": "CREATE",
                "entity_type": "dashboard",
                "entity_key": "No_Root_Dashboard",
                "replacement_json": {
                    "id": "No_Root_Dashboard",
                    "label": "No Root Dashboard",
                    "description": "Missing root page",
                    "pages": [
                        {"name": "Details", "wikitext": "Not a root page"},
                    ],
                },
            },
        )
        assert response.status_code == 400
        assert "root page" in response.json()["detail"].lower()

    @pytest.mark.asyncio
    async def test_delete_draft_created_dashboard(
        self,
        client: AsyncClient,
        test_draft_token: str,
    ):
        """DELETE of draft-created dashboard removes the CREATE entirely."""
        # First create the dashboard
        create_response = await client.post(
            f"/api/v2/drafts/{test_draft_token}/changes",
            json={
                "change_type": "CREATE",
                "entity_type": "dashboard",
                "entity_key": "Temp_Dashboard",
                "replacement_json": {
                    "id": "Temp_Dashboard",
                    "label": "Temporary",
                    "description": "Will be deleted",
                    "pages": [{"name": "", "wikitext": "Root"}],
                },
            },
        )
        assert create_response.status_code == 201

        # Delete the draft-created dashboard
        delete_response = await client.post(
            f"/api/v2/drafts/{test_draft_token}/changes",
            json={
                "change_type": "DELETE",
                "entity_type": "dashboard",
                "entity_key": "Temp_Dashboard",
            },
        )
        # Should succeed and return DELETE change type
        assert delete_response.status_code == 201
        assert delete_response.json()["change_type"] == "DELETE"

        # Verify it's no longer in changes list
        list_response = await client.get(
            f"/api/v2/drafts/{test_draft_token}/changes"
        )
        changes = list_response.json()["changes"]
        dashboard_changes = [
            c for c in changes
            if c["entity_type"] == "dashboard" and c["entity_key"] == "Temp_Dashboard"
        ]
        assert len(dashboard_changes) == 0


class TestResourceDraftCRUD:
    """Tests for resource draft change operations."""

    @pytest.mark.asyncio
    async def test_create_resource_success(
        self,
        client: AsyncClient,
        test_draft_token: str,
        seeded_category_key: str,
    ):
        """Resource CREATE with valid category and fields returns 201."""
        response = await client.post(
            f"/api/v2/drafts/{test_draft_token}/changes",
            json={
                "change_type": "CREATE",
                "entity_type": "resource",
                "entity_key": "Test_Resource",
                "replacement_json": {
                    "id": "Test_Resource",
                    "label": "Test Resource",
                    "description": "A test resource",
                    "category": seeded_category_key,
                    # Note: Only include fields that are valid properties for the category
                },
            },
        )
        assert response.status_code == 201
        data = response.json()
        assert data["entity_type"] == "resource"
        assert data["entity_key"] == "Test_Resource"

    @pytest.mark.asyncio
    async def test_create_resource_no_category_fails(
        self,
        client: AsyncClient,
        test_draft_token: str,
    ):
        """Resource CREATE without category returns 400."""
        response = await client.post(
            f"/api/v2/drafts/{test_draft_token}/changes",
            json={
                "change_type": "CREATE",
                "entity_type": "resource",
                "entity_key": "No_Category_Resource",
                "replacement_json": {
                    "id": "No_Category_Resource",
                    "label": "No Category",
                    "description": "Missing category field",
                },
            },
        )
        assert response.status_code == 400
        assert "category" in response.json()["detail"].lower()

    @pytest.mark.asyncio
    async def test_create_resource_nonexistent_category_fails(
        self,
        client: AsyncClient,
        test_draft_token: str,
    ):
        """Resource CREATE with nonexistent category returns 400."""
        response = await client.post(
            f"/api/v2/drafts/{test_draft_token}/changes",
            json={
                "change_type": "CREATE",
                "entity_type": "resource",
                "entity_key": "Bad_Category_Resource",
                "replacement_json": {
                    "id": "Bad_Category_Resource",
                    "label": "Bad Category",
                    "description": "Nonexistent category",
                    "category": "Nonexistent_Category",
                },
            },
        )
        assert response.status_code == 400
        assert "does not exist" in response.json()["detail"].lower()

    @pytest.mark.asyncio
    async def test_create_resource_invalid_field_fails(
        self,
        client: AsyncClient,
        test_draft_token: str,
        seeded_category_key: str,
    ):
        """Resource CREATE with unknown property field returns 400."""
        response = await client.post(
            f"/api/v2/drafts/{test_draft_token}/changes",
            json={
                "change_type": "CREATE",
                "entity_type": "resource",
                "entity_key": "Invalid_Field_Resource",
                "replacement_json": {
                    "id": "Invalid_Field_Resource",
                    "label": "Invalid Field",
                    "description": "Has unknown property",
                    "category": seeded_category_key,
                    "Not_A_Real_Property": "should fail",
                },
            },
        )
        assert response.status_code == 400
        assert "unknown property" in response.json()["detail"].lower()

    @pytest.mark.asyncio
    async def test_create_resource_with_draft_category(
        self,
        client: AsyncClient,
        test_draft_token: str,
    ):
        """Resource CREATE validates against draft-created category."""
        # First create a category in the draft
        cat_response = await client.post(
            f"/api/v2/drafts/{test_draft_token}/changes",
            json={
                "change_type": "CREATE",
                "entity_type": "category",
                "entity_key": "Draft_Category",
                "replacement_json": {
                    "id": "Draft_Category",
                    "label": "Draft Category",
                    "description": "Created in draft",
                    "required_properties": ["Draft_Property"],
                    "optional_properties": [],
                },
            },
        )
        assert cat_response.status_code == 201

        # Now create a resource for that draft category
        resource_response = await client.post(
            f"/api/v2/drafts/{test_draft_token}/changes",
            json={
                "change_type": "CREATE",
                "entity_type": "resource",
                "entity_key": "Draft_Category_Resource",
                "replacement_json": {
                    "id": "Draft_Category_Resource",
                    "label": "Draft Category Resource",
                    "description": "Uses draft category",
                    "category": "Draft_Category",
                    "Draft_Property": "valid field from draft category",
                },
            },
        )
        assert resource_response.status_code == 201

    @pytest.mark.asyncio
    async def test_delete_draft_created_resource(
        self,
        client: AsyncClient,
        test_draft_token: str,
        seeded_category_key: str,
    ):
        """DELETE of draft-created resource removes the CREATE entirely."""
        # First create the resource
        create_response = await client.post(
            f"/api/v2/drafts/{test_draft_token}/changes",
            json={
                "change_type": "CREATE",
                "entity_type": "resource",
                "entity_key": "Temp_Resource",
                "replacement_json": {
                    "id": "Temp_Resource",
                    "label": "Temporary",
                    "description": "Will be deleted",
                    "category": seeded_category_key,
                },
            },
        )
        assert create_response.status_code == 201

        # Delete the draft-created resource
        delete_response = await client.post(
            f"/api/v2/drafts/{test_draft_token}/changes",
            json={
                "change_type": "DELETE",
                "entity_type": "resource",
                "entity_key": "Temp_Resource",
            },
        )
        assert delete_response.status_code == 201
        assert delete_response.json()["change_type"] == "DELETE"

        # Verify it's no longer in changes list
        list_response = await client.get(
            f"/api/v2/drafts/{test_draft_token}/changes"
        )
        changes = list_response.json()["changes"]
        resource_changes = [
            c for c in changes
            if c["entity_type"] == "resource" and c["entity_key"] == "Temp_Resource"
        ]
        assert len(resource_changes) == 0
```

Note: This test file requires fixtures from conftest.py. You may need to add:
- `seeded_category_key` fixture that returns a category key with known properties
- Ensure `test_draft_token` fixture exists for creating drafts

If the fixtures don't exist, add them to conftest.py or create them inline.
  </action>
  <verify>
Run the tests:
```bash
cd /home/daharoni/dev/ontology-hub && python -m pytest backend/tests/test_draft_crud_dashboard_resource.py -v --tb=short
```
All tests should pass.
  </verify>
  <done>
- Test file created with comprehensive coverage
- Dashboard CREATE/UPDATE/DELETE tests pass
- Resource CREATE/UPDATE/DELETE tests pass
- Validation error cases properly tested
- Draft-created category/resource interaction tested
  </done>
</task>

<task type="auto">
  <name>Task 2: Add required test fixtures if missing</name>
  <files>backend/tests/conftest.py</files>
  <action>
Check if `seeded_category_key` fixture exists in conftest.py. If not, add it.

The fixture should:
1. Create a test category in the database with known properties
2. Return the category's entity_key
3. Clean up after test (or use existing database seeding)

If existing fixtures already provide a category (check for `sample_category` or similar), use that instead and update the test file to use the correct fixture name.

Example fixture to add if needed:
```python
@pytest.fixture
async def seeded_category_key(db_session: AsyncSession) -> str:
    """Create a test category with properties and return its key."""
    from app.models.v2 import Category, Property, CategoryProperty

    # Create a test property
    prop = Property(
        entity_key="Test_Property",
        source_path="properties/Test_Property.json",
        label="Test Property",
        canonical_json={"id": "Test_Property", "label": "Test Property"},
    )
    db_session.add(prop)

    # Create a test category
    cat = Category(
        entity_key="Test_Category",
        source_path="categories/Test_Category.json",
        label="Test Category",
        canonical_json={
            "id": "Test_Category",
            "label": "Test Category",
            "required_properties": ["Test_Property"],
            "optional_properties": [],
        },
    )
    db_session.add(cat)
    await db_session.commit()

    # Create category-property relationship
    cat_prop = CategoryProperty(
        category_id=cat.id,
        property_id=prop.id,
        is_required=True,
    )
    db_session.add(cat_prop)
    await db_session.commit()

    # Refresh materialized view
    from app.models.v2 import refresh_category_property_effective
    await refresh_category_property_effective(db_session)

    return cat.entity_key
```

Alternatively, if the test database is already seeded with categories, just identify which category key to use and update the test file.
  </action>
  <verify>
1. Fixture exists or test uses existing seeded data
2. All tests in test_draft_crud_dashboard_resource.py pass
3. Run: `python -m pytest backend/tests/test_draft_crud_dashboard_resource.py -v`
  </verify>
  <done>
- Required fixtures available
- Tests can access seeded category with known properties
- All integration tests pass
  </done>
</task>

</tasks>

<verification>
1. All dashboard CRUD tests pass
2. All resource CRUD tests pass
3. Validation error tests correctly return 400 with descriptive messages
4. Draft-created entity interaction works correctly
5. No regressions in existing test suite
</verification>

<success_criteria>
- test_draft_crud_dashboard_resource.py created with 10+ test cases
- Dashboard validation tests cover: no pages, no root page, valid dashboard
- Resource validation tests cover: no category, bad category, invalid field
- Draft-created category/resource interaction tested
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/28-draft-crud-support/28-03-SUMMARY.md`
</output>
