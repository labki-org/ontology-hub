---
phase: 07-pr-integration
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - backend/app/services/github.py
  - backend/app/services/pr_builder.py
  - backend/app/routers/oauth.py
  - frontend/src/components/draft/OpenPRButton.tsx
  - frontend/src/pages/DraftPage.tsx
autonomous: true

must_haves:
  truths:
    - "User can click Open PR button to initiate OAuth and PR creation"
    - "PR is created with branch, commit, and structured body"
    - "PR body shows changes categorized by type"
    - "PR body shows validation status and semver suggestion"
    - "PR body references wiki URL and base version"
  artifacts:
    - path: "backend/app/services/pr_builder.py"
      provides: "PR body generation and file serialization"
      exports: ["build_files_from_draft", "generate_pr_body"]
    - path: "backend/app/services/github.py"
      provides: "Git Data API methods for PR creation"
      contains: "create_pull_request"
    - path: "frontend/src/components/draft/OpenPRButton.tsx"
      provides: "Button to trigger PR creation"
      min_lines: 30
  key_links:
    - from: "backend/app/routers/oauth.py"
      to: "backend/app/services/pr_builder.py"
      via: "create_pr_from_draft function"
      pattern: "build_files_from_draft"
    - from: "backend/app/routers/oauth.py"
      to: "backend/app/services/github.py"
      via: "GitHub API calls"
      pattern: "create_pull_request"
    - from: "frontend/src/pages/DraftPage.tsx"
      to: "frontend/src/components/draft/OpenPRButton.tsx"
      via: "component import"
      pattern: "OpenPRButton"
---

<objective>
Complete PR creation flow: serialize draft to repo files, create branch/commit via Git Data API, generate structured PR body, and add frontend button.

Purpose: Transform validated drafts into GitHub PRs with full context about changes, validation status, and semver recommendations.

Output: GitHubClient extended with PR creation methods, pr_builder service, OpenPRButton component, complete OAuth callback that creates PR.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-pr-integration/07-RESEARCH.md
@.planning/phases/07-pr-integration/07-01-SUMMARY.md

# Existing files to extend
@backend/app/services/github.py
@backend/app/routers/oauth.py
@backend/app/models/draft.py
@frontend/src/pages/DraftPage.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend GitHubClient with Git Data API methods for PR creation</name>
  <files>backend/app/services/github.py</files>
  <action>
Add methods to GitHubClient class for creating branches, trees, commits, and PRs:

1. get_branch_sha(owner, repo, branch="main") -> str:
   - GET /repos/{owner}/{repo}/git/refs/heads/{branch}
   - Return object.sha

2. get_commit_tree_sha(owner, repo, commit_sha) -> str:
   - GET /repos/{owner}/{repo}/git/commits/{commit_sha}
   - Return tree.sha

3. create_tree(owner, repo, files: list[dict], base_tree: str) -> str:
   - POST /repos/{owner}/{repo}/git/trees
   - files: [{"path": "...", "content": "..."}]
   - Build tree items with mode="100644", type="blob"
   - Return new tree sha

4. create_commit(owner, repo, message: str, tree_sha: str, parent_sha: str) -> str:
   - POST /repos/{owner}/{repo}/git/commits
   - Return new commit sha

5. create_branch(owner, repo, branch_name: str, sha: str) -> dict:
   - POST /repos/{owner}/{repo}/git/refs
   - json: {"ref": f"refs/heads/{branch_name}", "sha": sha}
   - Return ref object

6. create_pull_request(owner, repo, title, body, head, base="main") -> dict:
   - POST /repos/{owner}/{repo}/pulls
   - Return full PR object with html_url

All methods should use self._request() for retry logic and rate limit handling.
All methods need user's access_token, so add optional token parameter that creates temporary httpx client when provided.

Add helper method:
create_pr_with_token(token: str, owner, repo, branch_name, files, commit_message, pr_title, pr_body) -> str:
- Creates temporary httpx client with user's token
- Calls get_branch_sha, get_commit_tree_sha, create_tree, create_commit, create_branch, create_pull_request in sequence
- Returns PR html_url
  </action>
  <verify>
    - `python -c "from app.services.github import GitHubClient; print('OK')"` from backend/
    - GitHubClient has create_pull_request, create_tree, create_commit, create_branch methods
  </verify>
  <done>GitHubClient extended with all Git Data API methods needed for atomic multi-file PR creation.</done>
</task>

<task type="auto">
  <name>Task 2: Create pr_builder service for file serialization and PR body generation</name>
  <files>backend/app/services/pr_builder.py</files>
  <action>
Create backend/app/services/pr_builder.py with:

1. serialize_entity_for_repo(entity: EntityDefinition, entity_type: str) -> dict:
   - Convert draft entity format to repo file format
   - Repo uses "id" not "entity_id"
   - Categories: {id, label, description, parent, properties, subobjects}
   - Properties: {id, label, description, datatype, cardinality}
   - Subobjects: {id, label, description, properties}

2. serialize_module_for_repo(module: ModuleDefinition) -> dict:
   - {id (from module_id), label, description, categories (from category_ids), dependencies}

3. serialize_profile_for_repo(profile: ProfileDefinition) -> dict:
   - {id (from profile_id), label, description, modules (from module_ids)}

4. build_files_from_draft(payload: DraftPayload) -> list[dict]:
   - Returns [{"path": "categories/Person.json", "content": "..."}]
   - JSON with indent=2, trailing newline
   - Process all entities, modules, profiles from payload

5. generate_pr_body(diff: DraftDiffResponse, validation: dict, wiki_url: str, base_version: str) -> str:
   Generate markdown PR body with sections:

   ```markdown
   ## Summary

   Changes proposed from [{wiki_url}]({wiki_url})
   Based on version: `{base_version}`

   ## Changes

   ### Categories
   - **Added:** Entity1, Entity2
   - **Modified:** Entity3
   - **Deleted:** Entity4

   ### Properties
   ...

   ### Modules
   ...

   ### Profiles
   ...

   ## Validation

   **Status:** {Passed/Failed}
   **Suggested version bump:** `{major/minor/patch}`

   {If has errors:}
   ### Errors ({count})
   - `entity_id`: message

   {If has warnings:}
   ### Warnings ({count})
   - `entity_id`: message

   {If has semver_reasons:}
   ### Version bump reasons
   - Reason 1
   - Reason 2

   ---
   *Created via [Ontology Hub](https://ontology.labki.org)*
   ```

6. generate_branch_name(draft_id: str) -> str:
   - Return f"draft-{draft_id[:8]}-{timestamp}"
   - timestamp as compact ISO: YYYYMMDD-HHMMSS

7. generate_commit_message(diff: DraftDiffResponse) -> str:
   - "feat(schema): update from wiki export"
   - Include summary of changes in body
  </action>
  <verify>
    - `python -c "from app.services.pr_builder import build_files_from_draft, generate_pr_body; print('OK')"` from backend/
  </verify>
  <done>pr_builder service provides file serialization and PR body generation per repo format.</done>
</task>

<task type="auto">
  <name>Task 3: Wire PR creation into OAuth callback and add frontend button</name>
  <files>backend/app/routers/oauth.py, frontend/src/components/draft/OpenPRButton.tsx, frontend/src/pages/DraftPage.tsx</files>
  <action>
**Backend - Update oauth.py callback:**

1. Import required modules:
   ```python
   from app.services.pr_builder import build_files_from_draft, generate_pr_body, generate_branch_name, generate_commit_message
   from app.services.github import GitHubClient
   from app.dependencies.capability import validate_capability_token
   from app.models.draft import DraftPayload, DraftDiffResponse, DraftStatus
   ```

2. Create create_pr_from_draft async function:
   - Takes draft_token, github_token, session
   - Validate draft via capability token
   - Check draft.status is pending (else 400)
   - Build files from draft.payload
   - Generate PR body from draft.diff_preview, draft.validation_results, source_wiki, base_commit_sha
   - Generate branch name using str(draft.id)
   - Call GitHubClient.create_pr_with_token()
   - Update draft.status to SUBMITTED
   - Store pr_url in draft (add pr_url field to Draft model if needed)
   - Return pr_url

3. Update github_callback to call create_pr_from_draft:
   - After getting access_token
   - On success: redirect to frontend with ?pr_url=encoded_url
   - On error: redirect with ?pr_error=encoded_message

**Frontend - Create OpenPRButton.tsx:**

```typescript
interface OpenPRButtonProps {
  draftToken: string
  isValid: boolean
  hasUnsavedChanges: boolean
}

export function OpenPRButton({ draftToken, isValid, hasUnsavedChanges }: OpenPRButtonProps)
```

- Button with GitPullRequest icon and "Open Pull Request" text
- Disabled if: !isValid OR hasUnsavedChanges
- Show tooltip explaining why disabled
- onClick: window.location.href = `/api/v1/oauth/github/login?draft_token=${draftToken}`
- Show loading state while redirecting

**Frontend - Update DraftPage.tsx:**

1. Import OpenPRButton
2. Add to page header area (after DraftHeader, before ValidationSummary)
3. Pass draftToken, validation status (draft.validation_results?.is_valid), hasUnsavedChanges
4. Parse ?pr_url and ?pr_error from URL params on mount
5. Show success banner with link to PR if pr_url present
6. Show error banner if pr_error present
7. Clear URL params after displaying
  </action>
  <verify>
    - Backend: `curl localhost:8080/api/v1/oauth/github/login?draft_token=test` initiates OAuth
    - Frontend: OpenPRButton renders on draft page
    - TypeScript compiles without errors
  </verify>
  <done>Complete PR creation flow: OAuth callback creates PR via Git Data API, frontend has Open PR button with proper state handling.</done>
</task>

</tasks>

<verification>
1. Backend builds and starts: `docker compose up`
2. OAuth flow initiates from frontend button click
3. PR body includes all required sections (changes, validation, semver, wiki reference)
4. Draft status updates to SUBMITTED after PR creation
5. Frontend shows PR link after successful creation
</verification>

<success_criteria>
- GHUB-01: GitHub OAuth triggered only when user clicks "Open PR" button
- GHUB-02: Platform creates branch, commits changes, and opens PR via GitHub API
- GHUB-03: PR body includes structured summary of changes categorized by type
- GHUB-04: PR body includes validation report and suggested semver bump
- GHUB-05: PR body references originating wiki and base schema version
</success_criteria>

<output>
After completion, create `.planning/phases/07-pr-integration/07-02-SUMMARY.md`
</output>
