---
phase: 07-pr-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/config.py
  - backend/app/routers/oauth.py
  - backend/app/main.py
  - backend/requirements.txt
autonomous: true

must_haves:
  truths:
    - "OAuth flow starts when /oauth/github/login is called with draft_token"
    - "OAuth callback exchanges code for access token"
    - "Draft token survives OAuth redirect round-trip"
    - "Session middleware preserves state across redirect"
  artifacts:
    - path: "backend/app/routers/oauth.py"
      provides: "OAuth endpoints for GitHub login flow"
      exports: ["router"]
    - path: "backend/app/config.py"
      provides: "OAuth configuration settings"
      contains: "GITHUB_CLIENT_ID"
  key_links:
    - from: "backend/app/main.py"
      to: "SessionMiddleware"
      via: "app.add_middleware"
      pattern: "SessionMiddleware"
    - from: "backend/app/main.py"
      to: "backend/app/routers/oauth.py"
      via: "app.include_router"
      pattern: "oauth_router"
---

<objective>
Implement GitHub OAuth flow for PR creation using Authlib with stateless token handling.

Purpose: Enable users to authenticate with GitHub when they click "Open PR" on the draft page. OAuth tokens are held only in memory during PR creation, never persisted.

Output: OAuth router with /oauth/github/login and /oauth/callback endpoints, SessionMiddleware for OAuth state, config settings for client credentials.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-pr-integration/07-RESEARCH.md

# Existing files to extend
@backend/app/config.py
@backend/app/main.py
@backend/app/routers/__init__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add OAuth configuration and Authlib dependency</name>
  <files>backend/app/config.py, backend/requirements.txt</files>
  <action>
1. Add authlib to requirements.txt (version 1.6+)

2. Extend Settings class in config.py with:
   - GITHUB_CLIENT_ID: Optional[str] = None
   - GITHUB_CLIENT_SECRET: Optional[str] = None
   - SESSION_SECRET: str with default (generate random 32-byte hex for production)
   - FRONTEND_URL: str = "http://localhost:5173" (for redirect after OAuth)

Note: Keep existing settings. Add new OAuth settings alongside.
  </action>
  <verify>
    - `grep -q "GITHUB_CLIENT_ID" backend/app/config.py`
    - `grep -q "authlib" backend/requirements.txt`
  </verify>
  <done>Config has GITHUB_CLIENT_ID, GITHUB_CLIENT_SECRET, SESSION_SECRET, FRONTEND_URL settings. authlib in requirements.</done>
</task>

<task type="auto">
  <name>Task 2: Create OAuth router with login and callback endpoints</name>
  <files>backend/app/routers/oauth.py, backend/app/routers/__init__.py</files>
  <action>
Create backend/app/routers/oauth.py with:

1. Import and configure Authlib OAuth client:
   ```python
   from authlib.integrations.starlette_client import OAuth

   oauth = OAuth()
   # Register happens on startup when settings available
   ```

2. Create register_oauth_client(settings) function:
   - Called from main.py lifespan after settings loaded
   - Registers github provider with:
     - client_id from settings
     - client_secret from settings
     - access_token_url: 'https://github.com/login/oauth/access_token'
     - authorize_url: 'https://github.com/login/oauth/authorize'
     - api_base_url: 'https://api.github.com/'
     - client_kwargs: {'scope': 'public_repo'}

3. Create router = APIRouter(prefix="/oauth", tags=["oauth"])

4. GET /github/login endpoint:
   - Query param: draft_token (required)
   - Store draft_token in request.session['pending_draft_token']
   - Store initiated_at timestamp
   - Build redirect_uri using request.url_for('github_callback')
   - Return oauth.github.authorize_redirect(request, redirect_uri)
   - Skip if GITHUB_CLIENT_ID not configured (return 503)

5. GET /github/callback endpoint (name="github_callback"):
   - Try authorize_access_token, catch OAuthError -> 400
   - Pop pending_draft_token from session
   - If missing -> 400 "No pending draft found"
   - For now: store access_token in session temporarily (next plan will use it)
   - Redirect to {FRONTEND_URL}/draft/{draft_token}?oauth=success

6. Export router and register_oauth_client from __init__.py

Use proper error handling: OAuthError for OAuth failures, HTTPException for missing state.
  </action>
  <verify>
    - `python -c "from app.routers.oauth import router, register_oauth_client"` from backend/
    - File has github_login and github_callback endpoints
  </verify>
  <done>OAuth router with /github/login and /github/callback endpoints. Properly handles OAuth state via session.</done>
</task>

<task type="auto">
  <name>Task 3: Wire OAuth into FastAPI app with SessionMiddleware</name>
  <files>backend/app/main.py</files>
  <action>
Modify main.py to add SessionMiddleware and OAuth router:

1. Import SessionMiddleware:
   ```python
   from starlette.middleware.sessions import SessionMiddleware
   ```

2. Import OAuth router and register function:
   ```python
   from app.routers.oauth import router as oauth_router, register_oauth_client
   ```

3. Add SessionMiddleware BEFORE other middleware (important for OAuth):
   ```python
   # SessionMiddleware must come before other middleware for OAuth
   app.add_middleware(
       SessionMiddleware,
       secret_key=settings.SESSION_SECRET,
       max_age=1800,  # 30 min - enough for OAuth flow
       same_site="lax",  # Required for OAuth redirects
   )
   ```

4. In lifespan(), after GITHUB_TOKEN check, add OAuth registration:
   ```python
   if settings.GITHUB_CLIENT_ID and settings.GITHUB_CLIENT_SECRET:
       register_oauth_client(settings)
   ```

5. Include OAuth router with other routers:
   ```python
   app.include_router(oauth_router, prefix="/api/v1")
   ```

Ensure middleware order: SessionMiddleware -> SecurityHeadersMiddleware -> CORSMiddleware
  </action>
  <verify>
    - `grep -q "SessionMiddleware" backend/app/main.py`
    - `grep -q "oauth_router" backend/app/main.py`
    - Docker compose up starts without errors
  </verify>
  <done>SessionMiddleware configured, OAuth router included, OAuth client registered on startup when credentials available.</done>
</task>

</tasks>

<verification>
1. Backend starts without errors: `docker compose up backend`
2. OAuth login endpoint exists: `curl -s localhost:8080/api/v1/oauth/github/login?draft_token=test` returns redirect or 503 (if not configured)
3. Config accepts new env vars
</verification>

<success_criteria>
- SessionMiddleware added to FastAPI app
- OAuth router mounted at /api/v1/oauth
- /github/login accepts draft_token and initiates OAuth
- /github/callback handles OAuth response and redirects to frontend
- OAuth client registered on startup when credentials configured
</success_criteria>

<output>
After completion, create `.planning/phases/07-pr-integration/07-01-SUMMARY.md`
</output>
