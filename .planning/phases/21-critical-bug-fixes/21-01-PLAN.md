---
phase: 21-critical-bug-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/pages/BrowsePage.tsx
  - frontend/src/components/draft/DraftBannerV2.tsx
  - frontend/src/components/draft/FloatingActionBar.tsx
autonomous: false

must_haves:
  truths:
    - "User can click Validate button in draft mode when changes exist"
    - "User can click Submit PR button after validation passes"
    - "Validation results appear after clicking Validate"
    - "PR wizard opens after clicking Submit PR"
  artifacts:
    - path: "frontend/src/pages/BrowsePage.tsx"
      provides: "Draft data flow to child components"
      contains: "draftV2.data"
    - path: "frontend/src/components/draft/DraftBannerV2.tsx"
      provides: "Validate and Submit PR buttons with correct disabled logic"
      contains: "isDraft"
    - path: "frontend/src/components/draft/FloatingActionBar.tsx"
      provides: "Floating Validate and Submit PR buttons with correct disabled logic"
      contains: "isDraft"
  key_links:
    - from: "BrowsePage.tsx"
      to: "DraftBannerV2.tsx"
      via: "draft prop from useDraftV2"
      pattern: "draft={draftV2\\.data}"
    - from: "DraftBannerV2.tsx"
      to: "Button disabled"
      via: "isDraft check"
      pattern: "draft\\.status === 'DRAFT'"
---

<objective>
Debug and fix BUG-003: Validate and Submit PR buttons always disabled.

Purpose: Restore core draft workflow - users must be able to validate changes and submit PRs. This bug blocks E2E flows 6 (validation) and 7 (PR submission).

Output: Working Validate and Submit PR buttons that respond correctly to draft status.
</objective>

<execution_context>
@/home/daharoni/.claude/get-shit-done/workflows/execute-plan.md
@/home/daharoni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-critical-bug-fixes/21-RESEARCH.md

# Key source files
@frontend/src/pages/BrowsePage.tsx
@frontend/src/components/draft/DraftBannerV2.tsx
@frontend/src/components/draft/FloatingActionBar.tsx
@frontend/src/api/draftApiV2.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Diagnose the root cause with console logging</name>
  <files>
    frontend/src/pages/BrowsePage.tsx
    frontend/src/components/draft/DraftBannerV2.tsx
    frontend/src/components/draft/FloatingActionBar.tsx
  </files>
  <action>
Add diagnostic console.log statements to trace the data flow and identify where the bug occurs:

1. In BrowsePage.tsx (before the return statement, around line 155):
   ```typescript
   // DEBUG: Trace draft data flow
   console.log('[BrowsePage] draftToken:', draftToken)
   console.log('[BrowsePage] draftV2.data:', draftV2.data)
   console.log('[BrowsePage] draftV2.status:', draftV2.data?.status)
   console.log('[BrowsePage] draftV2.isLoading:', draftV2.isLoading)
   console.log('[BrowsePage] draftV2.error:', draftV2.error)
   ```

2. In DraftBannerV2.tsx (at the start of the component, after line 30):
   ```typescript
   // DEBUG: Trace received props
   console.log('[DraftBannerV2] draft:', draft)
   console.log('[DraftBannerV2] draft.status:', draft?.status)
   console.log('[DraftBannerV2] isDraft:', draft?.status === 'DRAFT')
   console.log('[DraftBannerV2] isValidated:', draft?.status === 'VALIDATED')
   ```

3. In FloatingActionBar.tsx (at the start of the component, after line 24):
   ```typescript
   // DEBUG: Trace received props
   console.log('[FloatingActionBar] draft:', draft)
   console.log('[FloatingActionBar] draft.status:', draft?.status)
   console.log('[FloatingActionBar] isDraft:', draft?.status === 'DRAFT')
   ```

Start the development server and open a draft in the browser. Check the console for the debug output. Document what you find:
- Is draftToken populated?
- Is draftV2.data populated?
- What is the actual value of draft.status?
- Are the components receiving the draft prop?
  </action>
  <verify>
Run `cd /home/daharoni/dev/ontology-hub/frontend && npm run dev` and navigate to a draft URL (e.g., /browse?draft_token=xxx). Open browser DevTools console. Verify console.log statements appear and document the values.
  </verify>
  <done>
Console logs reveal the actual data flow state - either:
- draft.status shows 'DRAFT' (logic bug in disabled prop)
- draft.status is undefined/null (data not flowing correctly)
- draft.status is wrong value (backend issue)
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix the identified root cause</name>
  <files>
    frontend/src/pages/BrowsePage.tsx
    frontend/src/components/draft/DraftBannerV2.tsx
    frontend/src/components/draft/FloatingActionBar.tsx
  </files>
  <action>
Based on the diagnosis from Task 1, apply the appropriate fix:

**If draft.status is undefined/null (most likely based on research):**

The issue is likely that `draftV2.data` is undefined during initial render, or the status field is not being included. Check:

1. Verify the TanStack Query `enabled` condition in `useDraftV2`:
   ```typescript
   // In draftApiV2.ts - ensure enabled when token exists
   enabled: !!token,
   ```

2. Add defensive null checks in components:

   In DraftBannerV2.tsx (lines 70-71):
   ```typescript
   // Before:
   const isDraft = draft.status === 'DRAFT'
   const isValidated = draft.status === 'VALIDATED'

   // After (add optional chaining):
   const isDraft = draft?.status === 'DRAFT'
   const isValidated = draft?.status === 'VALIDATED'
   ```

   In FloatingActionBar.tsx (lines 63-64):
   ```typescript
   // Before:
   const isDraft = draft.status === 'DRAFT'
   const isValidated = draft.status === 'VALIDATED'

   // After (add optional chaining):
   const isDraft = draft?.status === 'DRAFT'
   const isValidated = draft?.status === 'VALIDATED'
   ```

3. Check that BrowsePage only renders components when data is ready:
   - `draftV2.data` condition at lines 159 and 213 already guard the components
   - If this is the guard, the components should always receive valid draft

**If draft.status is wrong value:**
- Check backend response in Network tab
- Verify DraftResponse schema includes status field
- Ensure Draft model default is DraftStatus.DRAFT

**If draft.status is 'DRAFT' but button still disabled:**
- Check if `isValidating` is stuck at true
- Check for any useMemo/useCallback blocking re-renders
- Verify the disabled prop logic matches the isDraft check
  </action>
  <verify>
After applying fix, verify in browser:
1. Navigate to draft URL
2. Check console logs show draft.status === 'DRAFT'
3. Check Validate button is NOT disabled
4. Click Validate button - confirm it triggers (console shows '[BrowsePage] handleValidate called' or similar)
  </verify>
  <done>
Validate button is enabled and clickable when draft status is 'DRAFT'.
  </done>
</task>

<task type="auto">
  <name>Task 3: Remove debug logging and verify complete flow</name>
  <files>
    frontend/src/pages/BrowsePage.tsx
    frontend/src/components/draft/DraftBannerV2.tsx
    frontend/src/components/draft/FloatingActionBar.tsx
  </files>
  <action>
1. Remove all DEBUG console.log statements added in Task 1:
   - Remove from BrowsePage.tsx
   - Remove from DraftBannerV2.tsx
   - Remove from FloatingActionBar.tsx

2. Verify the fix is clean:
   - No console.log statements remain (except error handling)
   - TypeScript compiles without errors
   - ESLint passes

3. Run TypeScript check:
   ```bash
   cd /home/daharoni/dev/ontology-hub/frontend && npm run typecheck
   ```

4. Run ESLint:
   ```bash
   cd /home/daharoni/dev/ontology-hub/frontend && npm run lint
   ```
  </action>
  <verify>
`npm run typecheck` passes. `npm run lint` passes (or only has pre-existing warnings unrelated to this fix).
  </verify>
  <done>
Code is clean with no debug statements. TypeScript and ESLint pass.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 4: Human verification of complete draft workflow</name>
  <what-built>
Fixed Validate and Submit PR buttons - now enabled based on draft status.
  </what-built>
  <how-to-verify>
1. Start servers if not running:
   ```bash
   cd /home/daharoni/dev/ontology-hub && docker compose up -d
   cd /home/daharoni/dev/ontology-hub/frontend && npm run dev
   ```

2. Create a new draft:
   - Go to http://localhost:5173/browse
   - Click "Start New Draft" or similar
   - Note the URL now has ?draft_token=xxx

3. Verify Validate button is ENABLED:
   - Look at the top banner (DraftBannerV2)
   - Look at the bottom floating bar (FloatingActionBar)
   - Validate button should be clickable (not grayed out)

4. Make a change to trigger validation need:
   - Click any entity in sidebar
   - Make an edit (e.g., change description)
   - Save the change

5. Click Validate button:
   - Button should be clickable
   - Should see "Validating..." loading state
   - Should see validation results appear

6. After validation passes:
   - Verify status changes to VALIDATED
   - Verify Submit PR button becomes ENABLED
   - Click Submit PR button
   - Verify PR wizard modal opens

Expected results:
- [x] Validate button enabled in DRAFT status
- [x] Validate button triggers validation
- [x] Validation results appear
- [x] Submit PR button enabled in VALIDATED status
- [x] Submit PR button opens PR wizard
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Button State Verification:**
   - Validate button enabled when draft.status === 'DRAFT'
   - Submit PR button enabled when draft.status === 'VALIDATED'
   - Both buttons in banner and floating bar work correctly

2. **Workflow Verification:**
   - Complete flow: Create draft -> Make change -> Validate -> Submit PR
   - Each step transitions correctly

3. **Code Quality:**
   - No debug console.log statements
   - TypeScript compiles
   - ESLint passes
</verification>

<success_criteria>
1. User can click Validate button in draft mode when draft exists
2. User can click Submit PR button in draft mode when validated
3. Validation results appear after clicking Validate
4. PR wizard opens after clicking Submit PR
5. BUG-003 from v2.1 audit is CLOSED
</success_criteria>

<output>
After completion, create `.planning/phases/21-critical-bug-fixes/21-01-SUMMARY.md`
</output>
