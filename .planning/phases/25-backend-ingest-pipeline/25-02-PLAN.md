---
phase: 25-backend-ingest-pipeline
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/services/github.py
  - backend/app/services/ingest.py
autonomous: true

must_haves:
  truths:
    - "Webhook triggers load dashboard and resource files from repo"
    - "Ingest service deletes and inserts dashboard and resource entities"
    - "Ingest service resolves module_dashboard and bundle_dashboard relationships"
    - "Resources with nested paths (like templates) are loaded correctly"
  artifacts:
    - path: "backend/app/services/github.py"
      provides: "ENTITY_DIRECTORIES includes dashboards and resources"
      contains: "dashboards"
    - path: "backend/app/services/ingest.py"
      provides: "Dashboard, Resource imports and relationship handling"
      contains: "ModuleDashboard"
  key_links:
    - from: "backend/app/services/ingest.py"
      to: "backend/app/models/v2/dashboard.py"
      via: "import statement"
      pattern: "Dashboard"
    - from: "backend/app/services/ingest.py"
      to: "backend/app/models/v2/relationships.py"
      via: "import statement"
      pattern: "ModuleDashboard"
---

<objective>
Update ingest pipeline (github.py and ingest.py) to handle Dashboard and Resource entities.

Purpose: Complete the ingest pipeline so webhook triggers load, delete, insert, and wire relationships for the new entity types. This includes ENTITY_DIRECTORIES updates, nested path handling for resources, and junction table resolution.

Output: Updated github.py and ingest.py with full Dashboard and Resource ingest support.
</objective>

<execution_context>
@/home/daharoni/.claude/get-shit-done/workflows/execute-plan.md
@/home/daharoni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-backend-ingest-pipeline/25-CONTEXT.md

# Existing ingest patterns to follow
@backend/app/services/github.py
@backend/app/services/ingest.py
@backend/app/models/v2/relationships.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update ENTITY_DIRECTORIES in github.py</name>
  <files>backend/app/services/github.py</files>
  <action>
Update the ENTITY_DIRECTORIES frozenset to include dashboards and resources:

```python
# Directories containing entity JSON files (v2.0)
ENTITY_DIRECTORIES = frozenset(
    {"categories", "properties", "subobjects", "modules", "bundles", "templates", "dashboards", "resources"}
)
```
  </action>
  <verify>
cd /home/daharoni/dev/ontology-hub/backend && python -c "
from app.services.github import ENTITY_DIRECTORIES
assert 'dashboards' in ENTITY_DIRECTORIES
assert 'resources' in ENTITY_DIRECTORIES
print('github.py ENTITY_DIRECTORIES OK')
"
  </verify>
  <done>ENTITY_DIRECTORIES in github.py includes dashboards and resources</done>
</task>

<task type="auto">
  <name>Task 2: Update ENTITY_DIRECTORIES in ingest.py</name>
  <files>backend/app/services/ingest.py</files>
  <action>
Update the ENTITY_DIRECTORIES dict to include dashboards and resources with their schema paths:

```python
# Entity directories and their schema file paths
ENTITY_DIRECTORIES = {
    "categories": "categories/_schema.json",
    "properties": "properties/_schema.json",
    "subobjects": "subobjects/_schema.json",
    "modules": "modules/_schema.json",
    "bundles": "bundles/_schema.json",
    "templates": "templates/_schema.json",
    "dashboards": "dashboards/_schema.json",
    "resources": "resources/_schema.json",
}
```
  </action>
  <verify>
cd /home/daharoni/dev/ontology-hub/backend && python -c "
from app.services.ingest import ENTITY_DIRECTORIES
assert 'dashboards' in ENTITY_DIRECTORIES
assert 'resources' in ENTITY_DIRECTORIES
print('ingest.py ENTITY_DIRECTORIES OK')
"
  </verify>
  <done>ENTITY_DIRECTORIES in ingest.py includes dashboards and resources with schema paths</done>
</task>

<task type="auto">
  <name>Task 3: Update load_entity_files to allow nested paths for resources</name>
  <files>backend/app/services/ingest.py</files>
  <action>
Update the nested path check in load_entity_files() to allow resources (like templates):

Change:
```python
# Only process files directly in entity directories (e.g., "bundles/Default.json")
# Skip nested files like "bundles/Default/versions/1.0.0.json"
# Exception: templates allow nested paths (e.g., templates/Property/Page.json)
if len(parts) != 2 and directory != "templates":
    continue
```

To:
```python
# Only process files directly in entity directories (e.g., "bundles/Default.json")
# Skip nested files like "bundles/Default/versions/1.0.0.json"
# Exception: templates and resources allow nested paths
# (e.g., templates/Property/Page.json, resources/Person/John_doe.json)
if len(parts) != 2 and directory not in ("templates", "resources"):
    continue
```
  </action>
  <verify>
cd /home/daharoni/dev/ontology-hub/backend && python -c "
# Verify the code change by checking the source
import inspect
from app.services.ingest import IngestService
source = inspect.getsource(IngestService.load_entity_files)
assert 'resources' in source
assert 'templates' in source
print('load_entity_files handles nested resources OK')
"
  </verify>
  <done>load_entity_files allows nested paths for resources directory (like templates)</done>
</task>

<task type="auto">
  <name>Task 4: Add Dashboard, Resource, and junction table imports to ingest.py</name>
  <files>backend/app/services/ingest.py</files>
  <action>
Update the imports from app.models.v2 to include Dashboard, Resource, and their junction tables:

```python
from app.models.v2 import (
    # Entities
    Bundle,
    BundleDashboard,    # ADD
    # Relationships
    BundleModule,
    Category,
    CategoryParent,
    CategoryProperty,
    CategorySubobject,
    Dashboard,          # ADD
    IngestStatus,
    Module,
    ModuleDashboard,    # ADD
    ModuleDependency,
    ModuleEntity,
    # Version tracking
    OntologyVersion,
    Property,
    Resource,           # ADD
    Subobject,
    SubobjectProperty,
    Template,
    # Mat view refresh
    refresh_category_property_effective,
)
```

Maintain alphabetical order within each comment section.
  </action>
  <verify>
cd /home/daharoni/dev/ontology-hub/backend && python -c "
from app.services.ingest import IngestService
# If imports are wrong, this will fail
print('ingest.py imports OK')
"
  </verify>
  <done>Dashboard, Resource, ModuleDashboard, BundleDashboard imported in ingest.py</done>
</task>

<task type="auto">
  <name>Task 5: Update delete_all_canonical for new entities and relationships</name>
  <files>backend/app/services/ingest.py</files>
  <action>
Update delete_all_canonical() to delete dashboard/resource relationships and entities.

In the relationships deletion section (step 1), add after existing relationship deletes:
```python
await self._session.execute(delete(ModuleDashboard))
await self._session.execute(delete(BundleDashboard))
```

In the entities deletion section (step 2), add after Template delete:
```python
await self._session.execute(delete(Resource))
await self._session.execute(delete(Dashboard))
```

Order matters for FK constraints:
1. All relationship tables (including new ModuleDashboard, BundleDashboard)
2. All entity tables (including new Resource, Dashboard)
3. OntologyVersion
  </action>
  <verify>
cd /home/daharoni/dev/ontology-hub/backend && python -c "
import inspect
from app.services.ingest import IngestService
source = inspect.getsource(IngestService.delete_all_canonical)
assert 'ModuleDashboard' in source
assert 'BundleDashboard' in source
assert 'Dashboard' in source
assert 'Resource' in source
print('delete_all_canonical handles new entities OK')
"
  </verify>
  <done>delete_all_canonical deletes ModuleDashboard, BundleDashboard, Resource, and Dashboard</done>
</task>

<task type="auto">
  <name>Task 6: Update insert_entities for dashboards and resources</name>
  <files>backend/app/services/ingest.py</files>
  <action>
Update insert_entities() to add dashboard and resource entities. After templates add:

```python
self._session.add_all(parsed.dashboards)
self._session.add_all(parsed.resources)
```

The full method should look like:
```python
async def insert_entities(self, parsed: ParsedEntities) -> None:
    """Insert all parsed entities into database."""
    self._session.add_all(parsed.categories)
    self._session.add_all(parsed.properties)
    self._session.add_all(parsed.subobjects)
    self._session.add_all(parsed.modules)
    self._session.add_all(parsed.bundles)
    self._session.add_all(parsed.templates)
    self._session.add_all(parsed.dashboards)
    self._session.add_all(parsed.resources)

    # Flush to generate UUIDs
    await self._session.flush()
```
  </action>
  <verify>
cd /home/daharoni/dev/ontology-hub/backend && python -c "
import inspect
from app.services.ingest import IngestService
source = inspect.getsource(IngestService.insert_entities)
assert 'parsed.dashboards' in source
assert 'parsed.resources' in source
print('insert_entities handles dashboards and resources OK')
"
  </verify>
  <done>insert_entities adds dashboards and resources to session</done>
</task>

<task type="auto">
  <name>Task 7: Update resolve_and_insert_relationships for dashboard relationships</name>
  <files>backend/app/services/ingest.py</files>
  <action>
Update resolve_and_insert_relationships() to handle module_dashboard and bundle_dashboard relationships.

1. Add dashboard lookup table after bundles lookup:
```python
dashboards = {
    d.entity_key: d.id
    for d in (await self._session.execute(select(Dashboard))).scalars().all()
}
```

2. Add relationship resolution cases at the end of the for loop (after existing elif blocks):
```python
elif rel.type == "module_dashboard":
    module_id = modules.get(rel.source_key)
    dashboard_id = dashboards.get(rel.target_key)
    if module_id and dashboard_id:
        self._session.add(
            ModuleDashboard(
                module_id=module_id,
                dashboard_id=dashboard_id,
            )
        )
    else:
        self._warnings.append(
            f"Unresolved module_dashboard: {rel.source_key} -> {rel.target_key}"
        )

elif rel.type == "bundle_dashboard":
    bundle_id = bundles.get(rel.source_key)
    dashboard_id = dashboards.get(rel.target_key)
    if bundle_id and dashboard_id:
        self._session.add(
            BundleDashboard(
                bundle_id=bundle_id,
                dashboard_id=dashboard_id,
            )
        )
    else:
        self._warnings.append(
            f"Unresolved bundle_dashboard: {rel.source_key} -> {rel.target_key}"
        )
```
  </action>
  <verify>
cd /home/daharoni/dev/ontology-hub/backend && python -c "
import inspect
from app.services.ingest import IngestService
source = inspect.getsource(IngestService.resolve_and_insert_relationships)
assert 'module_dashboard' in source
assert 'bundle_dashboard' in source
assert 'ModuleDashboard' in source
assert 'BundleDashboard' in source
print('resolve_and_insert_relationships handles dashboard relationships OK')
"
  </verify>
  <done>resolve_and_insert_relationships resolves module_dashboard and bundle_dashboard relationships</done>
</task>

</tasks>

<verification>
Run from backend directory:

```bash
cd /home/daharoni/dev/ontology-hub/backend

# Type check
uv run mypy app/services/github.py app/services/ingest.py --ignore-missing-imports

# Unit tests
uv run pytest tests/ -v -k "ingest" --tb=short

# Full test suite
uv run pytest tests/ -v --tb=short

# Integration verification
python -c "
from app.services.github import ENTITY_DIRECTORIES as GH_DIRS
from app.services.ingest import ENTITY_DIRECTORIES as INGEST_DIRS

# Check github.py
assert 'dashboards' in GH_DIRS
assert 'resources' in GH_DIRS

# Check ingest.py
assert 'dashboards' in INGEST_DIRS
assert 'resources' in INGEST_DIRS

print('ENTITY_DIRECTORIES updated in both files')
"
```
</verification>

<success_criteria>
1. github.py ENTITY_DIRECTORIES includes dashboards and resources
2. ingest.py ENTITY_DIRECTORIES includes dashboards and resources with schema paths
3. load_entity_files allows nested paths for resources (like templates)
4. Dashboard, Resource, ModuleDashboard, BundleDashboard imported in ingest.py
5. delete_all_canonical deletes new relationship and entity tables
6. insert_entities adds dashboards and resources
7. resolve_and_insert_relationships handles module_dashboard and bundle_dashboard
</success_criteria>

<output>
After completion, create `.planning/phases/25-backend-ingest-pipeline/25-02-SUMMARY.md`
</output>
