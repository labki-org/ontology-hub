---
phase: 11-draft-system
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/services/draft_overlay.py
  - backend/app/routers/entities_v2.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Category detail endpoint returns draft-aware inherited properties when draft modifies parents"
    - "Inherited properties from draft-added parents appear in response"
    - "Properties from draft-removed parents are excluded from inheritance"
  artifacts:
    - path: "backend/app/services/draft_overlay.py"
      provides: "Draft-aware inheritance computation method"
      exports: ["DraftOverlayService.get_draft_aware_inherited_properties"]
    - path: "backend/app/routers/entities_v2.py"
      provides: "Integration of draft-aware inheritance in category detail"
      contains: "get_draft_aware_inherited_properties"
  key_links:
    - from: "backend/app/routers/entities_v2.py"
      to: "backend/app/services/draft_overlay.py"
      via: "draft_ctx.get_draft_aware_inherited_properties call"
      pattern: "draft_ctx\\.get_draft_aware_inherited_properties"
---

<objective>
Implement draft-aware inheritance computation for category properties.

Purpose: Close DRF-04 gap - when a draft modifies a category's parent relationships, the inherited properties should reflect the draft's modified inheritance chain, not just canonical data.

Output: The category detail endpoint returns correct inherited properties when viewing in draft context, including properties from draft-added parents and excluding properties from draft-removed parents.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-draft-system/11-VERIFICATION.md

# Existing code to modify
@backend/app/services/draft_overlay.py
@backend/app/routers/entities_v2.py

# Reference for inheritance data model
@backend/app/models/v2/category_property_effective.py
@backend/app/models/v2/relationships.py
@backend/app/schemas/entity_v2.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add draft-aware inheritance method to DraftOverlayService</name>
  <files>backend/app/services/draft_overlay.py</files>
  <action>
Add a new method `get_draft_aware_inherited_properties()` to DraftOverlayService that computes effective inherited properties accounting for draft parent modifications.

**Method signature:**
```python
async def get_draft_aware_inherited_properties(
    self,
    session: AsyncSession,
    category_entity_key: str,
    canonical_category_id: uuid.UUID | None,
) -> list[dict]:
    """Compute inherited properties with draft parent changes applied.

    When a draft modifies a category's parents (via JSON Patch on the
    "parents" field), this method:
    1. Gets canonical inherited properties from category_property_effective
    2. Detects draft changes to this category's parents
    3. Walks the draft-modified inheritance graph to compute additional
       inherited properties from draft-added parents
    4. Excludes properties that would be inherited from draft-removed parents

    Returns list of PropertyProvenance-compatible dicts with:
    - entity_key: property entity_key
    - label: property label
    - is_direct: False (all inherited)
    - is_inherited: True
    - is_required: bool
    - source_category: entity_key of source
    - inheritance_depth: int
    """
```

**Implementation approach:**

1. If no draft context (self.draft_id is None), return empty list (caller will use canonical query)

2. Check if this category has an UPDATE change that modifies parents:
   - Look up `category:{category_entity_key}` in draft changes
   - If UPDATE, apply patch to get effective parents array
   - Compare effective parents vs canonical parents

3. If parents unchanged, return empty list (caller can use canonical)

4. If parents changed, compute inheritance manually:
   a. Get all ancestors by walking parent chain (draft-modified)
   b. For each ancestor, query their direct properties from category_property table
   c. Track depth and source for provenance
   d. Handle cycles with visited set
   e. Return PropertyProvenance-compatible dicts

**Key queries needed:**
- Get category by entity_key: `SELECT id, canonical_json FROM categories WHERE entity_key = :key`
- Get direct properties: `SELECT p.entity_key, p.label, cp.is_required FROM category_property cp JOIN properties p ON p.id = cp.property_id WHERE cp.category_id = :cat_id`
- Get parent category ids: `SELECT parent_id FROM category_parent WHERE category_id = :cat_id`

**Handle draft-created parents:** If a draft adds a parent that is itself draft-created (not in canonical), skip it for now (property inheritance from draft-created categories is out of scope for this gap closure).

Import uuid at top of file if not already imported.
  </action>
  <verify>cd /home/daharoni/dev/ontology-hub/backend && python -c "from app.services.draft_overlay import DraftOverlayService; print('has method:', hasattr(DraftOverlayService, 'get_draft_aware_inherited_properties'))"</verify>
  <done>DraftOverlayService has get_draft_aware_inherited_properties method that computes draft-aware inheritance</done>
</task>

<task type="auto">
  <name>Task 2: Integrate draft-aware inheritance in category detail endpoint</name>
  <files>backend/app/routers/entities_v2.py</files>
  <action>
Modify the `get_category()` endpoint (lines 119-203) to use draft-aware inheritance when a draft_id is provided.

**Current behavior (lines 158-192):**
- Always queries `category_property_effective` materialized view
- Returns canonical inherited properties regardless of draft context

**New behavior:**
1. If draft_ctx.draft_id is not None:
   a. Call `draft_ctx.get_draft_aware_inherited_properties(session, entity_key, category.id if category else None)`
   b. If result is not empty, use it instead of canonical query
   c. If result is empty (no parent changes in draft), fall back to canonical query

2. If draft_ctx.draft_id is None:
   - Use canonical query as before (no change)

**Code change location:** After line 156 (parents extraction), before line 158 (properties query).

**Approximate structure:**
```python
# Get properties with provenance
properties: list[PropertyProvenance] = []

# Check for draft-aware inheritance first
draft_properties = await draft_ctx.get_draft_aware_inherited_properties(
    session, entity_key, category.id if category else None
)

if draft_properties:
    # Draft modifies parents - use computed inheritance
    for prop in draft_properties:
        properties.append(PropertyProvenance(**prop))
elif category:
    # No draft parent changes or no draft context - use canonical materialized view
    # (existing query code from lines 163-192)
    props_query = text("""...""")
    # ... rest of existing query
```

Also add direct properties for the category itself (depth=0) when using draft-aware inheritance - query category_property for the target category and add with depth=0.
  </action>
  <verify>cd /home/daharoni/dev/ontology-hub/backend && python -c "from app.routers.entities_v2 import get_category; import inspect; src = inspect.getsource(get_category); print('has draft-aware:', 'get_draft_aware_inherited_properties' in src)"</verify>
  <done>Category detail endpoint uses draft-aware inheritance when draft modifies parent relationships</done>
</task>

</tasks>

<verification>
1. Method exists and returns correct type:
   ```bash
   cd /home/daharoni/dev/ontology-hub/backend && python -c "
   from app.services.draft_overlay import DraftOverlayService
   import inspect
   sig = inspect.signature(DraftOverlayService.get_draft_aware_inherited_properties)
   print(f'Method signature: {sig}')
   "
   ```

2. Endpoint uses draft-aware inheritance:
   ```bash
   cd /home/daharoni/dev/ontology-hub/backend && python -c "
   from app.routers.entities_v2 import get_category
   import inspect
   src = inspect.getsource(get_category)
   assert 'get_draft_aware_inherited_properties' in src, 'Missing draft-aware call'
   print('Integration verified')
   "
   ```

3. No syntax errors:
   ```bash
   cd /home/daharoni/dev/ontology-hub/backend && python -c "
   from app.services.draft_overlay import DraftOverlayService
   from app.routers.entities_v2 import router
   print(f'Router routes: {len(router.routes)}')
   "
   ```
</verification>

<success_criteria>
- DraftOverlayService has get_draft_aware_inherited_properties method
- Method accepts session, entity_key, and optional canonical_category_id
- Method returns list of PropertyProvenance-compatible dicts
- get_category endpoint calls the method when draft_id is provided
- Endpoint falls back to canonical query when no parent changes in draft
- No import errors or syntax errors in modified files
</success_criteria>

<output>
After completion, create `.planning/phases/11-draft-system/11-05-SUMMARY.md`
</output>
