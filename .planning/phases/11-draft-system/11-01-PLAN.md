---
phase: 11-draft-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/routers/drafts_v2.py
  - backend/app/routers/__init__.py
  - backend/app/schemas/draft_v2.py
autonomous: true

must_haves:
  truths:
    - "Draft creation generates capability URL with token shown once"
    - "Draft creation binds to current ontology version commit_sha"
    - "Draft retrieval works via capability token"
    - "Draft status can be updated through lifecycle"
  artifacts:
    - path: "backend/app/routers/drafts_v2.py"
      provides: "v2.0 draft CRUD endpoints"
      exports: ["router"]
    - path: "backend/app/schemas/draft_v2.py"
      provides: "Pydantic schemas for draft API"
      exports: ["DraftCreate", "DraftResponse", "DraftCreateResponse"]
  key_links:
    - from: "backend/app/routers/drafts_v2.py"
      to: "backend/app/models/v2/draft.py"
      via: "Draft, DraftStatus imports"
      pattern: "from app.models.v2 import Draft"
    - from: "backend/app/routers/__init__.py"
      to: "backend/app/routers/drafts_v2.py"
      via: "router registration"
      pattern: "router.include_router.*drafts_v2"
---

<objective>
Create v2.0 draft CRUD API endpoints using existing Draft model from Phase 8.

Purpose: Enable draft creation with capability URL security, binding to base_commit_sha for rebase tracking. This fulfills DRF-01 (draft binds to base_commit_sha) and DRF-05 (status lifecycle).

Output: `/api/v2/drafts` endpoints for create, read, and status update operations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-draft-system/11-CONTEXT.md
@.planning/phases/11-draft-system/11-RESEARCH.md

# Existing code to integrate with
@backend/app/models/v2/draft.py
@backend/app/dependencies/capability.py
@backend/app/routers/drafts.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create v2 draft schemas</name>
  <files>backend/app/schemas/draft_v2.py</files>
  <action>
Create Pydantic schemas for v2.0 draft API:

1. `DraftCreate` - Request body for creating drafts:
   - source: DraftSource (required)
   - title: str | None (optional, auto-generated if not provided)
   - description: str | None (optional)
   - No base_commit_sha in request - server sets from current OntologyVersion

2. `DraftResponse` - Public draft response:
   - id: UUID
   - status: DraftStatus
   - source: DraftSource
   - title: str | None
   - description: str | None
   - user_comment: str | None
   - base_commit_sha: str
   - rebase_status: str | None
   - rebase_commit_sha: str | None
   - created_at: datetime
   - modified_at: datetime
   - expires_at: datetime
   - change_count: int (computed from draft_changes)

3. `DraftCreateResponse` - Response after creation:
   - capability_url: str (shown ONCE)
   - draft: DraftResponse
   - expires_at: datetime

4. `DraftStatusUpdate` - For status transitions:
   - status: DraftStatus
   - user_comment: str | None (optional)

Import from app.models.v2 for DraftStatus, DraftSource enums.
  </action>
  <verify>python -c "from app.schemas.draft_v2 import DraftCreate, DraftResponse, DraftCreateResponse, DraftStatusUpdate; print('OK')"</verify>
  <done>Schemas importable and type-safe for v2 draft API</done>
</task>

<task type="auto">
  <name>Task 2: Create v2 draft router with CRUD endpoints</name>
  <files>backend/app/routers/drafts_v2.py, backend/app/routers/__init__.py</files>
  <action>
Create v2.0 draft router with capability URL pattern:

1. `POST /api/v2/drafts` - Create draft:
   - Generate capability token using existing `generate_capability_token()` from dependencies/capability.py
   - Hash token and store in draft.capability_hash
   - Set base_commit_sha from current OntologyVersion (query latest)
   - Set expires_at to 7 days from now (match v1.0 pattern)
   - Return capability_url ONCE (will not be stored/recoverable)
   - Rate limit: 20/hour per IP (reuse RATE_LIMITS from v1.0)

2. `GET /api/v2/drafts/{token}` - Get draft by capability token:
   - Hash incoming token, query by capability_hash
   - Return 404 for invalid/expired (no information leakage)
   - Include change_count by querying DraftChange count
   - Rate limit: 100/minute per IP

3. `PATCH /api/v2/drafts/{token}` - Update draft status/comment:
   - Only allow status transitions: DRAFT -> VALIDATED, VALIDATED -> SUBMITTED, etc.
   - Update user_comment if provided
   - Update modified_at timestamp
   - Rate limit: 100/minute per IP

Use existing patterns from drafts.py (v1.0):
- `hash_token()` for capability hash
- `build_capability_url()` for URL construction
- Rate limiting with slowapi

Register router in __init__.py with prefix="/api/v2/drafts".
  </action>
  <verify>cd /home/daharoni/dev/ontology-hub/backend && python -c "from app.routers.drafts_v2 import router; print(f'Routes: {len(router.routes)}')"</verify>
  <done>v2 draft router with 3 endpoints registered and importable</done>
</task>

</tasks>

<verification>
1. Schemas validate correctly:
   ```bash
   cd backend && python -c "
   from app.schemas.draft_v2 import DraftCreate, DraftResponse
   from app.models.v2 import DraftSource
   d = DraftCreate(source=DraftSource.HUB_UI)
   print(f'DraftCreate: {d}')
   "
   ```

2. Router registered:
   ```bash
   cd backend && python -c "
   from app.routers import router
   routes = [r.path for r in router.routes if '/drafts' in r.path]
   print(f'Draft routes: {routes}')
   "
   ```
</verification>

<success_criteria>
- DraftCreate schema accepts source (required), title and description (optional)
- DraftCreateResponse includes capability_url field
- POST /api/v2/drafts creates draft with base_commit_sha from current OntologyVersion
- GET /api/v2/drafts/{token} returns draft with change_count
- PATCH /api/v2/drafts/{token} updates status and user_comment
- Rate limiting applied to all endpoints
</success_criteria>

<output>
After completion, create `.planning/phases/11-draft-system/11-01-SUMMARY.md`
</output>
