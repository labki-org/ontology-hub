---
phase: 11-draft-system
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/routers/draft_changes.py
  - backend/app/routers/__init__.py
  - backend/app/schemas/draft_change.py
autonomous: true

must_haves:
  truths:
    - "Draft changes can be added to a draft"
    - "UPDATE changes store JSON Patch operations"
    - "CREATE changes store full replacement JSON"
    - "DELETE changes store neither patch nor replacement"
    - "Invalid JSON Patch format rejected with 422"
  artifacts:
    - path: "backend/app/routers/draft_changes.py"
      provides: "Draft change CRUD endpoints"
      exports: ["router"]
    - path: "backend/app/schemas/draft_change.py"
      provides: "Pydantic schemas with JSON Patch validation"
      exports: ["DraftChangeCreate", "DraftChangeResponse"]
  key_links:
    - from: "backend/app/routers/draft_changes.py"
      to: "backend/app/models/v2/draft.py"
      via: "DraftChange, ChangeType imports"
      pattern: "from app.models.v2 import DraftChange"
    - from: "backend/app/schemas/draft_change.py"
      to: "jsonpatch"
      via: "validation with JsonPatch constructor"
      pattern: "jsonpatch.JsonPatch"
---

<objective>
Create draft change management endpoints for adding, updating, and removing changes within a draft.

Purpose: Enable granular change tracking with RFC 6902 JSON Patch for updates and full replacement JSON for creates. This fulfills DRF-02 (hybrid patch storage format).

Output: `/api/v2/drafts/{token}/changes` endpoints for change CRUD operations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-draft-system/11-CONTEXT.md
@.planning/phases/11-draft-system/11-RESEARCH.md

# Existing code to integrate with
@backend/app/models/v2/draft.py
@backend/app/services/draft_overlay.py
@backend/app/dependencies/capability.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create draft change schemas with JSON Patch validation</name>
  <files>backend/app/schemas/draft_change.py</files>
  <action>
Create Pydantic schemas for draft change management with validation:

1. `DraftChangeCreate` - Request for adding a change:
   - change_type: ChangeType (required)
   - entity_type: str (required) - "category", "property", "subobject", "module", "bundle", "template"
   - entity_key: str (required)
   - patch: list[dict] | None - JSON Patch for UPDATE
   - replacement_json: dict | None - Full entity for CREATE

   Add field validators:
   a) `validate_patch` - For patch field:
      - If not None, must be a list
      - Each operation must have 'op' and 'path' keys
      - 'op' must be one of: add, remove, replace, move, copy, test
      - Construct jsonpatch.JsonPatch(v) to validate - raises InvalidJsonPatch on error
      - Return the validated patch

   b) `model_post_init` - Cross-field validation:
      - UPDATE requires patch, must not have replacement_json
      - CREATE requires replacement_json, must not have patch
      - DELETE must not have patch or replacement_json
      - entity_type must be valid (category, property, subobject, module, bundle, template)

2. `DraftChangeResponse` - Public change response:
   - id: UUID
   - change_type: ChangeType
   - entity_type: str
   - entity_key: str
   - patch: list[dict] | None
   - replacement_json: dict | None
   - created_at: datetime

3. `DraftChangesListResponse` - List of changes:
   - changes: list[DraftChangeResponse]
   - total: int

Import jsonpatch for validation, ChangeType from app.models.v2.
  </action>
  <verify>cd /home/daharoni/dev/ontology-hub/backend && python -c "
from app.schemas.draft_change import DraftChangeCreate
from app.models.v2 import ChangeType

# Valid UPDATE
c1 = DraftChangeCreate(
    change_type=ChangeType.UPDATE,
    entity_type='category',
    entity_key='Person',
    patch=[{'op': 'replace', 'path': '/description', 'value': 'Updated'}]
)
print(f'Valid UPDATE: {c1.change_type}')

# Valid CREATE
c2 = DraftChangeCreate(
    change_type=ChangeType.CREATE,
    entity_type='property',
    entity_key='newProp',
    replacement_json={'entity_key': 'newProp', 'label': 'New'}
)
print(f'Valid CREATE: {c2.change_type}')

# Invalid should raise
try:
    DraftChangeCreate(
        change_type=ChangeType.UPDATE,
        entity_type='category',
        entity_key='Person',
        patch=[{'invalid': 'patch'}]
    )
except ValueError as e:
    print(f'Invalid rejected: {e}')
"</verify>
  <done>Schemas validate JSON Patch format and enforce change_type constraints</done>
</task>

<task type="auto">
  <name>Task 2: Create draft changes router</name>
  <files>backend/app/routers/draft_changes.py, backend/app/routers/__init__.py</files>
  <action>
Create router for managing changes within a draft:

1. `GET /api/v2/drafts/{token}/changes` - List all changes:
   - Validate capability token (hash and lookup)
   - Query DraftChange by draft_id
   - Return DraftChangesListResponse

2. `POST /api/v2/drafts/{token}/changes` - Add a change:
   - Validate capability token
   - Check draft.status == DRAFT (can only add changes to draft status)
   - Validate change using DraftChangeCreate schema
   - For UPDATE/DELETE: verify entity exists in canonical (query entity table)
   - For CREATE: verify entity does NOT exist in canonical
   - Create DraftChange row
   - Update draft.modified_at
   - Return DraftChangeResponse

3. `DELETE /api/v2/drafts/{token}/changes/{change_id}` - Remove a change:
   - Validate capability token
   - Check draft.status == DRAFT
   - Verify change belongs to this draft
   - Delete DraftChange row
   - Update draft.modified_at
   - Return 204 No Content

Helper function for entity existence check:
```python
async def entity_exists(session: AsyncSession, entity_type: str, entity_key: str) -> bool:
    """Check if entity exists in canonical tables."""
    model_map = {
        "category": Category,
        "property": Property,
        "subobject": Subobject,
        "module": Module,
        "bundle": Bundle,
        "template": Template,
    }
    model = model_map.get(entity_type)
    if not model:
        return False
    result = await session.execute(
        select(model).where(model.entity_key == entity_key)
    )
    return result.scalars().first() is not None
```

Rate limit all endpoints: 100/minute per IP.
Register router in __init__.py with prefix="/api/v2/drafts/{token}/changes".
  </action>
  <verify>cd /home/daharoni/dev/ontology-hub/backend && python -c "from app.routers.draft_changes import router; print(f'Routes: {len(router.routes)}')"</verify>
  <done>Draft changes router with list, add, and remove endpoints</done>
</task>

</tasks>

<verification>
1. Schema validation works:
   ```bash
   cd backend && python -c "
   from app.schemas.draft_change import DraftChangeCreate
   from app.models.v2 import ChangeType

   # Test invalid op rejected
   try:
       DraftChangeCreate(
           change_type=ChangeType.UPDATE,
           entity_type='category',
           entity_key='X',
           patch=[{'op': 'invalid_op', 'path': '/x'}]
       )
       print('FAIL: Should have rejected')
   except ValueError:
       print('PASS: Invalid op rejected')
   "
   ```

2. Router endpoints registered:
   ```bash
   cd backend && python -c "
   from app.routers import router
   routes = [r.path for r in router.routes if 'changes' in r.path]
   print(f'Change routes: {routes}')
   "
   ```
</verification>

<success_criteria>
- DraftChangeCreate validates JSON Patch format using jsonpatch library
- UPDATE requires patch field, CREATE requires replacement_json field
- Invalid JSON Patch operations (bad op, missing path) rejected with 422
- POST endpoint verifies entity existence before accepting change
- DELETE endpoint removes change and updates draft.modified_at
- All endpoints rate-limited
</success_criteria>

<output>
After completion, create `.planning/phases/11-draft-system/11-02-SUMMARY.md`
</output>
