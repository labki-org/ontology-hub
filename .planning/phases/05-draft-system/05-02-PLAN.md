---
phase: 05-draft-system
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - frontend/src/api/drafts.ts
  - frontend/src/api/types.ts
  - frontend/src/stores/draftStore.ts
  - frontend/src/pages/DraftPage.tsx
  - frontend/src/components/draft/DraftHeader.tsx
  - frontend/src/components/draft/DraftDiffViewer.tsx
  - frontend/src/components/draft/EditableField.tsx
  - frontend/src/App.tsx
  - frontend/package.json
autonomous: true

must_haves:
  truths:
    - "User navigating to /drafts#{token} sees draft review page"
    - "Draft review shows wiki info, expiration, and diff by entity type"
    - "User can click to expand field-level changes for modified entities"
    - "User can click pencil icon to edit field values inline"
    - "Unsaved changes indicator appears when edits are made"
    - "User can discard changes to reset to original state"
  artifacts:
    - path: "frontend/src/stores/draftStore.ts"
      provides: "Zustand store for draft editing state"
      exports: ["useDraftStore"]
    - path: "frontend/src/pages/DraftPage.tsx"
      provides: "Draft review page"
      min_lines: 50
    - path: "frontend/src/components/draft/EditableField.tsx"
      provides: "Inline editable field component"
      exports: ["EditableField"]
    - path: "frontend/src/api/drafts.ts"
      provides: "Draft API hooks"
      exports: ["useDraft", "useDraftDiff"]
  key_links:
    - from: "frontend/src/pages/DraftPage.tsx"
      to: "frontend/src/stores/draftStore.ts"
      via: "useDraftStore hook"
      pattern: "useDraftStore"
    - from: "frontend/src/App.tsx"
      to: "frontend/src/pages/DraftPage.tsx"
      via: "route definition"
      pattern: "draft/:token"
    - from: "frontend/src/components/draft/DraftDiffViewer.tsx"
      to: "frontend/src/components/draft/EditableField.tsx"
      via: "EditableField component"
      pattern: "<EditableField"
---

<objective>
Build draft review UI with capability URL routing, diff display using existing DiffViewer components, and inline field editing with Zustand state management.

Purpose: Enable wiki admins to review and edit their draft proposals with clear diff feedback before submission.
Output: Draft review page accessible via capability URL with editable diff viewer and state management.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-draft-system/05-CONTEXT.md
@.planning/phases/05-draft-system/05-RESEARCH.md
@.planning/phases/05-draft-system/05-01-SUMMARY.md

Relevant codebase files:
@frontend/src/App.tsx - Current router configuration
@frontend/src/components/version/DiffViewer.tsx - Existing diff display component
@frontend/src/components/version/ChangeGroup.tsx - Collapsible change groups
@frontend/src/api/types.ts - Existing type definitions including VersionDiffResponse
@frontend/src/lib/diff.ts - jsondiffpatch wrapper
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and add draft types and API hooks</name>
  <files>
    frontend/package.json
    frontend/src/api/drafts.ts
    frontend/src/api/types.ts
  </files>
  <action>
1. Install new dependencies in frontend/:
   npm install zustand react-hook-form @hookform/resolvers zod

2. Add draft types to frontend/src/api/types.ts:

   // Draft types
   interface DraftPayload {
     wiki_url: string
     base_version: string
     entities: {
       categories: EntityDefinition[]
       properties: EntityDefinition[]
       subobjects: EntityDefinition[]
     }
     modules?: ModuleDefinition[]
     profiles?: ProfileDefinition[]
   }

   interface EntityDefinition {
     entity_id: string
     label: string
     description?: string
     schema_definition: Record<string, unknown>
   }

   interface DraftPublic {
     id: string
     status: 'pending' | 'validated' | 'submitted' | 'expired'
     payload: DraftPayload
     source_wiki: string | null
     base_commit_sha: string | null
     expires_at: string
     created_at: string
   }

   interface DraftCreateResponse {
     capability_url: string
     expires_at: string
     diff_preview: VersionDiffResponse | null
     validation_warnings: ValidationError[]
   }

   interface ValidationError {
     field: string
     message: string
     severity: 'error' | 'warning'
   }

3. Create frontend/src/api/drafts.ts with TanStack Query hooks:

   a. useDraft(token: string | undefined) - GET /drafts/{token}
      - Returns DraftPublic
      - staleTime: 5 minutes
      - enabled: !!token

   b. useDraftDiff(token: string | undefined) - GET /drafts/{token}/diff
      - Returns VersionDiffResponse
      - staleTime: 5 minutes
      - enabled: !!token

   c. useCreateDraft() - POST /drafts/
      - Mutation returning DraftCreateResponse
      - Invalidates draft queries on success

   d. useUpdateDraft(token: string) - PATCH /drafts/{token}
      - For saving edits (will be used in Plan 03)

Follow existing pattern from api/entities.ts and api/versions.ts.
  </action>
  <verify>
cd /home/daharoni/dev/ontology-hub/frontend && npm run build 2>&1 | grep -E "(error|Error)" | head -5 || echo "Build OK"
  </verify>
  <done>
zustand, react-hook-form, zod installed. Draft types defined. useDraft and useDraftDiff hooks created following established patterns.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Zustand draft store and editable field component</name>
  <files>
    frontend/src/stores/draftStore.ts
    frontend/src/components/draft/EditableField.tsx
  </files>
  <action>
1. Create frontend/src/stores/draftStore.ts:

   Use Zustand with immer middleware for immutable updates:

   interface DraftState {
     // Draft data
     draft: DraftPublic | null
     originalDiff: VersionDiffResponse | null

     // Editing state
     editedEntities: Map<string, Partial<EntityDefinition>>
     editingFields: Set<string>  // "category:Person:label" format
     hasUnsavedChanges: boolean

     // Actions
     setDraft: (draft: DraftPublic, diff: VersionDiffResponse) => void
     startEditingField: (fieldKey: string) => void
     stopEditingField: (fieldKey: string) => void
     updateEntityField: (entityType: string, entityId: string, field: string, value: unknown) => void
     discardChanges: () => void
     getEditedValue: (entityType: string, entityId: string, field: string) => unknown | undefined
   }

   Implementation notes:
   - Map keys use "entityType:entityId" format
   - Set keys use "entityType:entityId:field" format
   - updateEntityField sets hasUnsavedChanges = true
   - discardChanges clears editedEntities, editingFields, sets hasUnsavedChanges = false

2. Create frontend/src/components/draft/EditableField.tsx:

   Props:
   - entityType: string
   - entityId: string
   - fieldName: string
   - value: unknown (current/edited value)
   - originalValue?: unknown (for showing if changed)
   - fieldType?: 'text' | 'textarea' | 'number' (default 'text')

   Behavior:
   - Click to enter edit mode (pencil icon visible on hover)
   - Show input/textarea based on fieldType
   - Check and X buttons to save/cancel
   - Enter key saves (except textarea), Escape cancels
   - Visual indication when value differs from original (yellow text)

   Use useDraftStore for:
   - editingFields.has(fieldKey) to check if editing
   - startEditingField/stopEditingField to toggle
   - updateEntityField to save changes

   Use lucide-react icons: Pencil, Check, X
  </action>
  <verify>
cd /home/daharoni/dev/ontology-hub/frontend && npm run build 2>&1 | grep -E "(error|Error)" | head -5 || echo "Build OK"
  </verify>
  <done>
Zustand store manages draft editing state with immutable updates. EditableField component provides click-to-edit with keyboard shortcuts and visual change indication.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create draft page with diff viewer and routing</name>
  <files>
    frontend/src/components/draft/DraftHeader.tsx
    frontend/src/components/draft/DraftDiffViewer.tsx
    frontend/src/pages/DraftPage.tsx
    frontend/src/App.tsx
  </files>
  <action>
1. Create frontend/src/components/draft/DraftHeader.tsx:

   Props: draft: DraftPublic

   Display:
   - Wiki URL (external link icon)
   - Base version (tag/commit)
   - Created date
   - Expiration date with countdown/badge if expiring soon (< 24h = yellow, < 1h = red)
   - Status badge (pending/validated/submitted)

   Use Card component for layout. Use formatDistanceToNow from date-fns or simple relative time.

2. Create frontend/src/components/draft/DraftDiffViewer.tsx:

   Props:
   - diff: VersionDiffResponse
   - editable?: boolean (default false)

   Extend existing DiffViewer pattern but:
   - When editable=true, wrap field values in EditableField
   - Only "new" values in modified entities are editable (old is read-only diff reference)
   - Added entities are fully editable
   - Deleted entities are not editable

   Use existing ChangeGroup but pass editable prop down.
   If not editable, render exactly like existing DiffViewer.

3. Create frontend/src/pages/DraftPage.tsx:

   Route: /draft/:token

   Implementation:
   a. Extract token from useParams
   b. Use useDraft(token) and useDraftDiff(token)
   c. Initialize store with setDraft on data load (useEffect)
   d. Handle error state: Show "Draft not found or expired" alert
   e. Handle loading state: Show skeleton

   Layout:
   - DraftHeader at top
   - DraftDiffViewer with editable={true}
   - Floating "Unsaved changes" indicator (bottom-right) when hasUnsavedChanges
     - "Save Changes" button (disabled for now, wired in Plan 03)
     - "Discard" button calls discardChanges()

   Add beforeunload warning when hasUnsavedChanges.

4. Update frontend/src/App.tsx:

   Add routes for draft:
   a. /drafts route that handles fragment-based capability URL:
      - Create DraftCapabilityHandler component
      - useEffect extracts token from location.hash
      - Redirects to /draft/{token} with replace: true

   b. /draft/:token route renders DraftPage

   Pattern: Fragment (#) is not sent to server, so capture client-side and redirect.
  </action>
  <verify>
cd /home/daharoni/dev/ontology-hub/frontend && npm run build 2>&1 | grep -E "(error|Error)" | head -5 || echo "Build OK"
  </verify>
  <done>
DraftPage accessible via /drafts#{token} or direct /draft/{token}. Shows header with wiki info and expiration. DiffViewer displays changes with inline editing. Unsaved changes indicator with discard option.
  </done>
</task>

</tasks>

<verification>
1. Navigate to /drafts#testtoken123 redirects to /draft/testtoken123
2. With valid token, page shows draft header and diff viewer
3. With invalid/expired token, shows "Draft not found" error
4. Clicking pencil on modified field enters edit mode
5. Typing and pressing Enter saves change, shows "Unsaved changes" indicator
6. Clicking Discard resets all edits
7. Leaving page with unsaved changes shows browser warning
</verification>

<success_criteria>
- /drafts#{token} redirects to /draft/{token}
- Draft review page displays wiki info, expiration, status
- Diff viewer shows changes grouped by entity type
- Inline editing works with click-to-edit pattern
- Unsaved changes tracked and discardable
- No build errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-draft-system/05-02-SUMMARY.md`
</output>
