---
phase: 05-draft-system
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - frontend/src/stores/draftStore.ts
  - frontend/src/components/draft/ModuleAssignment.tsx
  - frontend/src/components/draft/BulkModuleAssignment.tsx
  - frontend/src/components/draft/DependencyFeedback.tsx
  - frontend/src/components/draft/ProfileEditor.tsx
  - frontend/src/components/draft/DraftDiffViewer.tsx
  - frontend/src/pages/DraftPage.tsx
  - backend/app/routers/drafts.py
  - backend/app/models/draft.py
autonomous: true

must_haves:
  truths:
    - "User can assign new categories to modules via dropdown"
    - "User can bulk-assign multiple categories to a module"
    - "Properties and subobjects show auto-included module membership (grayed, via category)"
    - "Module assignment shows missing dependency warnings"
    - "Module assignment shows redundancy warnings for overlapping assignments"
    - "User can edit profile module lists"
    - "User can create new modules as part of draft"
    - "User can save all draft edits via PATCH endpoint"
  artifacts:
    - path: "frontend/src/components/draft/ModuleAssignment.tsx"
      provides: "Module dropdown with auto-dependency display"
      exports: ["ModuleAssignment"]
    - path: "frontend/src/components/draft/BulkModuleAssignment.tsx"
      provides: "Bulk assignment for new categories"
      exports: ["BulkModuleAssignment"]
    - path: "frontend/src/components/draft/DependencyFeedback.tsx"
      provides: "Missing deps and redundancy warnings"
      exports: ["DependencyFeedback"]
    - path: "frontend/src/components/draft/ProfileEditor.tsx"
      provides: "Profile module list editing"
      exports: ["ProfileEditor"]
    - path: "backend/app/routers/drafts.py"
      provides: "PATCH endpoint for draft updates"
      exports: ["router"]
  key_links:
    - from: "frontend/src/pages/DraftPage.tsx"
      to: "frontend/src/components/draft/BulkModuleAssignment.tsx"
      via: "BulkModuleAssignment component"
      pattern: "<BulkModuleAssignment"
    - from: "frontend/src/components/draft/ModuleAssignment.tsx"
      to: "frontend/src/components/draft/DependencyFeedback.tsx"
      via: "DependencyFeedback component"
      pattern: "<DependencyFeedback"
    - from: "frontend/src/stores/draftStore.ts"
      to: "frontend/src/api/modules.ts"
      via: "useModules for dependency resolution"
      pattern: "useModules"
---

<objective>
Implement module assignment with auto-dependency visualization and profile editing capabilities. Enable users to assign categories to modules with dependency feedback, and edit profile module lists as part of draft review.

Purpose: Complete the draft editing workflow with module organization features that show auto-included dependencies and prevent inconsistent assignments.
Output: Module assignment UI with dependency feedback, profile editor, and backend PATCH endpoint for saving edits.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-draft-system/05-CONTEXT.md
@.planning/phases/05-draft-system/05-RESEARCH.md
@.planning/phases/05-draft-system/05-01-SUMMARY.md
@.planning/phases/05-draft-system/05-02-SUMMARY.md

Relevant codebase files:
@frontend/src/stores/draftStore.ts - Zustand store from Plan 02
@frontend/src/api/modules.ts - Module API hooks
@frontend/src/api/types.ts - Module and Profile types
@backend/app/routers/drafts.py - Draft router
@backend/app/models/draft.py - Draft schemas
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend draft store with module and profile editing state</name>
  <files>
    frontend/src/stores/draftStore.ts
    frontend/src/api/types.ts
  </files>
  <action>
1. Add types to frontend/src/api/types.ts:

   interface ModuleAssignmentState {
     explicit: string[]      // Explicitly assigned module IDs
     autoIncluded: string[]  // Auto-included via dependencies
   }

   interface NewModule {
     module_id: string
     label: string
     description?: string
     category_ids: string[]
     dependencies: string[]
   }

2. Extend frontend/src/stores/draftStore.ts:

   Add to state:
   - moduleAssignments: Map<string, ModuleAssignmentState>  // entity_id -> assignments
   - profileEdits: Map<string, string[]>  // profile_id -> module_ids
   - newModules: NewModule[]  // Modules created as part of draft
   - newProfiles: ProfileDefinition[]  // Profiles created as part of draft

   Add actions:
   - assignToModule(entityId: string, moduleId: string): void
     - Only for categories (properties/subobjects auto-include)
     - Adds to explicit array

   - removeFromModule(entityId: string, moduleId: string): void
     - Removes from explicit array
     - Per CONTEXT: if has children depending on it, converts to autoIncluded instead
     - Shows warning about children

   - bulkAssignToModule(entityIds: string[], moduleId: string): void
     - Assigns multiple categories at once

   - updateProfileModules(profileId: string, moduleIds: string[]): void
     - Updates profile's module list

   - addNewModule(module: NewModule): void
     - Adds module created during draft review

   - computeAutoIncludes(): void
     - Recalculates autoIncluded for all assignments
     - Uses module.dependencies to find parent requirements
     - Properties/subobjects inherit from their categories

   - getEffectiveModules(entityId: string): string[]
     - Returns combined explicit + autoIncluded
     - For properties/subobjects, looks up via parent categories

   Modify hasUnsavedChanges to also check:
   - moduleAssignments.size > 0
   - profileEdits.size > 0
   - newModules.length > 0

   Modify discardChanges to also clear:
   - moduleAssignments
   - profileEdits
   - newModules
   - newProfiles
  </action>
  <verify>
cd /home/daharoni/dev/ontology-hub/frontend && npm run build 2>&1 | grep -E "(error|Error)" | head -5 || echo "Build OK"
  </verify>
  <done>
Draft store extended with module assignments, profile edits, and new module state. Auto-include computation handles category dependencies. All editing state tracked for unsaved changes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create module assignment and dependency feedback components</name>
  <files>
    frontend/src/components/draft/ModuleAssignment.tsx
    frontend/src/components/draft/DependencyFeedback.tsx
    frontend/src/components/draft/BulkModuleAssignment.tsx
  </files>
  <action>
1. Create frontend/src/components/draft/ModuleAssignment.tsx:

   Props:
   - entityId: string
   - entityType: 'category' | 'property' | 'subobject'
   - parentCategories?: string[]  // For props/subobjects

   Implementation:
   a. Use useModules() for available modules
   b. Use useDraftStore for moduleAssignments and actions

   For categories:
   - Show explicitly assigned modules as Badge with X to remove
   - Show auto-included modules as grayed Badge with link icon + "(via dependency)"
   - Popover with Command/ComboBox to add modules
   - DependencyFeedback component below

   For properties/subobjects:
   - Show message: "Module membership inherited from categories"
   - Show inherited modules as grayed italic badges
   - If no parent categories assigned, show: "Assign parent category to module first"

   Use shadcn Popover, Command, Badge components.

2. Create frontend/src/components/draft/DependencyFeedback.tsx:

   Props:
   - entityId: string
   - assignedModules: string[]

   Implementation:
   a. Use useModules() to get module dependency information
   b. Check for missing dependencies:
      - For each assigned module, check if its dependencies are also assigned
      - Missing deps = module.dependencies.filter(d => !assignedModules.includes(d))
   c. Check for redundancy:
      - Module A depends on B, both are assigned -> A is redundant
      - Redundant = assigned where any dependency is also assigned

   Display:
   - Missing deps: Red Alert with AlertTriangle icon
     "Missing Dependencies: Module requires: X, Y"
   - Redundancy: Yellow Alert with Info icon
     "Redundant Assignment: X already included via Y"

   Only show if issues exist.

3. Create frontend/src/components/draft/BulkModuleAssignment.tsx:

   Props:
   - diff: VersionDiffResponse

   Implementation:
   - Extract all new categories (diff.categories.added)
   - Show section only if new categories exist
   - Checkbox list of new categories
   - Module dropdown to assign all selected
   - "Assign Selected" button

   Card layout with header "Assign New Categories to Modules"
   Show count: "3 new categories need module assignment"

   Use useDraftStore bulkAssignToModule action.
  </action>
  <verify>
cd /home/daharoni/dev/ontology-hub/frontend && npm run build 2>&1 | grep -E "(error|Error)" | head -5 || echo "Build OK"
  </verify>
  <done>
ModuleAssignment shows explicit and auto-included modules with visual distinction. DependencyFeedback warns about missing deps and redundancy. BulkModuleAssignment enables batch assignment for new categories.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create profile editor and wire save functionality</name>
  <files>
    frontend/src/components/draft/ProfileEditor.tsx
    frontend/src/components/draft/DraftDiffViewer.tsx
    frontend/src/pages/DraftPage.tsx
    backend/app/routers/drafts.py
    backend/app/models/draft.py
  </files>
  <action>
1. Create frontend/src/components/draft/ProfileEditor.tsx:

   Props:
   - profiles: ProfileChange[]  // From diff (added/modified profiles)
   - existingProfiles: ProfilePublic[]  // From useProfiles()

   Implementation:
   a. List existing profiles with their module lists
   b. For each profile, show multi-select of modules
   c. Changes tracked via useDraftStore updateProfileModules
   d. "Create New Profile" button that adds to newProfiles state:
      - Modal/dialog with profile_id, label, description, module_ids
   e. Show which modules are in which profile
   f. DependencyFeedback: warn if profile includes module but not its dependencies

   Use Card for each profile. Checkbox/toggle list for modules.

2. Update frontend/src/components/draft/DraftDiffViewer.tsx:

   Add ModuleAssignment to each entity item when editable:
   - For each entity in added/modified sections
   - Pass entityType and parentCategories (for props/subobjects)

   Add section for profiles if editable:
   - ProfileEditor component after entity diff sections

3. Update frontend/src/pages/DraftPage.tsx:

   Wire "Save Changes" button:
   a. Use useUpdateDraft(token) mutation
   b. Build update payload from store:
      - Collect editedEntities into payload.entities
      - Collect moduleAssignments into payload.modules
      - Collect profileEdits into payload.profiles
      - Include newModules and newProfiles
   c. On success: invalidate queries, show toast, reset hasUnsavedChanges
   d. On error: show error toast

   Add useProfiles() to fetch existing profiles for ProfileEditor.

4. Backend: Add PATCH /drafts/{token} endpoint:

   In backend/app/routers/drafts.py:
   - Add DraftUpdate schema with optional fields
   - PATCH endpoint accepts partial updates
   - Merge with existing payload
   - Recompute diff_preview after update
   - Rate limit same as draft_read

   In backend/app/models/draft.py:
   - Ensure DraftUpdate schema supports:
     - entities: optional partial updates
     - modules: optional module changes
     - profiles: optional profile changes
  </action>
  <verify>
# Test PATCH endpoint
TOKEN="..." # Use actual token from created draft
curl -X PATCH "http://localhost:8080/api/v1/drafts/${TOKEN}" \
  -H "Content-Type: application/json" \
  -d '{"entities": {"categories": [{"entity_id": "Test", "label": "Updated Label"}]}}' \
  -w "\n%{http_code}\n" | tail -1
# Should return 200

cd /home/daharoni/dev/ontology-hub/frontend && npm run build 2>&1 | grep -E "(error|Error)" | head -5 || echo "Build OK"
  </verify>
  <done>
ProfileEditor allows editing profile module lists and creating new profiles. DraftDiffViewer integrates ModuleAssignment for each entity. Save button persists all edits via PATCH endpoint. Backend accepts partial updates and recomputes diff.
  </done>
</task>

</tasks>

<verification>
1. New categories show ModuleAssignment dropdown
2. Assigning category to module shows it as badge, remove works
3. Properties/subobjects show inherited modules from categories
4. Missing dependency warning appears when assigning module without its deps
5. Redundancy warning appears when both module and its dep are assigned
6. Bulk assignment works for multiple new categories
7. Profile editor shows existing profiles and allows module list editing
8. Creating new profile adds it to draft state
9. Save Changes button persists all edits to backend
10. After save, changes reflected when page reloads
</verification>

<success_criteria>
- Categories can be assigned to modules with visual feedback
- Properties/subobjects show auto-included module membership
- Dependency warnings prevent inconsistent assignments
- Bulk assignment improves efficiency for many new categories
- Profile editing works with module list management
- New modules and profiles can be created in draft
- All edits persist via PATCH endpoint
- No build errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-draft-system/05-03-SUMMARY.md`
</output>
