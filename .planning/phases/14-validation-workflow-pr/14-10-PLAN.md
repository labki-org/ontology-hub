---
phase: 14-validation-workflow-pr
plan: 10
type: execute
wave: 6
depends_on: ["14-07", "14-08", "14-09"]
files_modified:
  - frontend/src/components/BrowsePage.tsx
  - frontend/src/components/draft/DraftSelector.tsx
autonomous: true

must_haves:
  truths:
    - "BrowsePage renders DraftBannerV2 when draft context is active"
    - "BrowsePage renders FloatingActionBar when draft context is active"
    - "Validate button triggers validation and shows results"
    - "Submit PR button opens PRWizard"
    - "Diff view accessible from draft context"
  artifacts:
    - path: "frontend/src/components/BrowsePage.tsx"
      provides: "Integrated browse page with v2 draft workflow"
      contains: "DraftBannerV2"
  key_links:
    - from: "frontend/src/components/BrowsePage.tsx"
      to: "frontend/src/components/draft/DraftBannerV2.tsx"
      via: "import and render"
      pattern: "DraftBannerV2"
    - from: "frontend/src/components/BrowsePage.tsx"
      to: "frontend/src/components/draft/PRWizard.tsx"
      via: "import and render"
      pattern: "PRWizard"
    - from: "frontend/src/components/BrowsePage.tsx"
      to: "frontend/src/api/draftApiV2.ts"
      via: "useValidateDraft, useDraftV2"
      pattern: "useValidateDraft"
---

<objective>
Integrate all v2 draft workflow components into BrowsePage.

Purpose: Wire DraftBannerV2, FloatingActionBar, ValidationSummaryV2, DraftDiffViewerV2, and PRWizard into the existing BrowsePage so users can validate and submit drafts from the main browse interface.

Output: Updated BrowsePage.tsx with full v2 draft workflow integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-validation-workflow-pr/14-CONTEXT.md
@.planning/phases/14-validation-workflow-pr/14-RESEARCH.md

# Prior plan summaries
@.planning/phases/14-validation-workflow-pr/14-07-SUMMARY.md
@.planning/phases/14-validation-workflow-pr/14-08-SUMMARY.md
@.planning/phases/14-validation-workflow-pr/14-09-SUMMARY.md

# Existing BrowsePage
@frontend/src/components/BrowsePage.tsx

# All draft components
# frontend/src/components/draft/DraftBannerV2.tsx
# frontend/src/components/draft/FloatingActionBar.tsx
# frontend/src/components/draft/ValidationSummaryV2.tsx
# frontend/src/components/draft/DraftDiffViewerV2.tsx
# frontend/src/components/draft/PRWizard.tsx

# API and state
# frontend/src/api/draftApiV2.ts
# frontend/src/stores/draftStoreV2.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate draft workflow into BrowsePage</name>
  <files>frontend/src/components/BrowsePage.tsx</files>
  <action>
Update BrowsePage to integrate all v2 draft workflow components:

1. Add imports for new components and hooks:
   ```typescript
   import { DraftBannerV2 } from '@/components/draft/DraftBannerV2'
   import { FloatingActionBar } from '@/components/draft/FloatingActionBar'
   import { DraftDiffViewerV2 } from '@/components/draft/DraftDiffViewerV2'
   import { PRWizard } from '@/components/draft/PRWizard'
   import { useDraftV2, useDraftChanges, useValidateDraft } from '@/api/draftApiV2'
   import { useDraftStoreV2 } from '@/stores/draftStoreV2'
   ```

2. Extract draftId from URL params (existing pattern uses ?draft_id= or draftId from DraftSelector).

3. Add state and hooks for v2 workflow:
   ```typescript
   // Use draftToken from URL or DraftSelector
   const draftToken = searchParams.get('draft_token') || null
   const { data: draftV2 } = useDraftV2(draftToken)
   const { data: changesData } = useDraftChanges(draftToken)
   const validateMutation = useValidateDraft(draftToken || '')

   // Store state
   const { validationReport, setValidationReport, prWizardOpen, setPrWizardOpen } = useDraftStoreV2()
   ```

4. Wire up handlers:
   ```typescript
   const handleValidate = async () => {
     if (!draftToken) return
     try {
       const report = await validateMutation.mutateAsync()
       setValidationReport(report)
     } catch (error) {
       // Handle error
     }
   }

   const handleSubmitPR = () => {
     setPrWizardOpen(true)
   }

   const handleExitDraft = () => {
     // Clear draft context from URL and store
     searchParams.delete('draft_token')
     searchParams.delete('draft_id')
     setSearchParams(searchParams)
     useDraftStoreV2.getState().reset()
   }
   ```

5. Render components conditionally:
   - When draftV2 exists:
     - Replace existing DraftBanner with DraftBannerV2 at top of page
     - Add FloatingActionBar at bottom
     - Add PRWizard (rendered but hidden until opened)
   - When no draft context: existing browse behavior unchanged

6. Add a "View Changes" button/tab in the draft banner or sidebar that shows DraftDiffViewerV2 in the detail panel or as a modal.

Integration pattern:
```tsx
return (
  <div>
    {/* Draft banner at top */}
    {draftV2 && (
      <DraftBannerV2
        draft={draftV2}
        onValidate={handleValidate}
        onSubmitPR={handleSubmitPR}
        onExit={handleExitDraft}
        isValidating={validateMutation.isPending}
        validationReport={validationReport}
      />
    )}

    {/* Existing browse content */}
    {/* ... existing layout ... */}

    {/* Floating action bar */}
    {draftV2 && (
      <FloatingActionBar
        draft={draftV2}
        onValidate={handleValidate}
        onSubmitPR={handleSubmitPR}
        isValidating={validateMutation.isPending}
      />
    )}

    {/* PR Wizard modal */}
    {draftV2 && draftToken && changesData && validationReport && (
      <PRWizard
        open={prWizardOpen}
        onOpenChange={setPrWizardOpen}
        draftToken={draftToken}
        changes={changesData.changes}
        validationReport={validationReport}
      />
    )}
  </div>
)
```

IMPORTANT: Preserve all existing BrowsePage functionality. Only ADD new draft workflow components. Do not remove existing draft banner integration (DraftBanner from v1) - replace it conditionally when draftV2 data is available, otherwise fall back to existing behavior.
  </action>
  <verify>cd /home/daharoni/dev/ontology-hub/frontend && npx tsc --noEmit --skipLibCheck src/components/BrowsePage.tsx 2>&1 | head -30</verify>
  <done>BrowsePage renders DraftBannerV2, FloatingActionBar, and PRWizard when draft context is active</done>
</task>

<task type="auto">
  <name>Task 2: Update DraftSelector for v2 token support</name>
  <files>frontend/src/components/draft/DraftSelector.tsx</files>
  <action>
Update the DraftSelector component to support both v1 and v2 draft modes:

1. When selecting a draft, check if it's a v2 draft (has capability token)
2. Set URL parameter appropriately:
   - v2 drafts: set ?draft_token={token} (for v2 workflow)
   - v1 drafts: set ?draft_id={id} (existing pattern)

If DraftSelector already supports v2 drafts via token, this task is a verification that the existing component works correctly with the new workflow. Ensure:
- Draft status is displayed correctly (using v2 status values)
- Selected draft updates URL params that BrowsePage reads
- DraftSelector shows v2 workflow status badges

If DraftSelector needs minimal updates, make them. If it's already compatible, document in summary.
  </action>
  <verify>cd /home/daharoni/dev/ontology-hub/frontend && npx tsc --noEmit --skipLibCheck src/components/draft/DraftSelector.tsx 2>&1 | head -20</verify>
  <done>DraftSelector supports v2 draft token in URL parameters</done>
</task>

</tasks>

<verification>
- BrowsePage renders DraftBannerV2 when draft context active
- FloatingActionBar visible at bottom when scrolling
- Validate button triggers validation mutation
- Submit PR button opens PRWizard modal
- All components compile without TypeScript errors
- npm run build succeeds
</verification>

<success_criteria>
- Full workflow testable: select draft -> validate -> see results -> submit PR
- DraftBannerV2 replaces v1 banner when v2 draft is active
- FloatingActionBar provides persistent access to actions
- PRWizard opens from Submit PR button
- Existing browse functionality unaffected when no draft context
</success_criteria>

<output>
After completion, create `.planning/phases/14-validation-workflow-pr/14-10-SUMMARY.md`
</output>
