---
phase: 14-validation-workflow-pr
plan: 08
type: execute
wave: 4
depends_on: ["14-06"]
files_modified:
  - frontend/src/components/draft/DraftDiffViewerV2.tsx
autonomous: true

must_haves:
  truths:
    - "Diff view shows per-entity changes grouped by entity type"
    - "Each change shows entity_key, change type badge, and change details"
    - "Change types have distinct visual indicators (green add, amber modify, red delete)"
    - "Entity changes are expandable to show field-level details"
  artifacts:
    - path: "frontend/src/components/draft/DraftDiffViewerV2.tsx"
      provides: "Diff viewer for v2 draft changes"
      exports: ["DraftDiffViewerV2"]
  key_links:
    - from: "frontend/src/components/draft/DraftDiffViewerV2.tsx"
      to: "frontend/src/api/draftApiV2.ts"
      via: "useDraftChanges hook for change data"
      pattern: "useDraftChanges"
---

<objective>
Create v2 diff viewer component showing per-entity changes grouped by type.

Purpose: Users need to review all changes in their draft before validation and submission. The diff viewer shows each change with its type (add/modify/delete) and entity details.

Output: DraftDiffViewerV2.tsx component.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-validation-workflow-pr/14-CONTEXT.md
@.planning/phases/14-validation-workflow-pr/14-RESEARCH.md

# Prior plan summaries
@.planning/phases/14-validation-workflow-pr/14-06-SUMMARY.md

# Existing diff viewer (v1 patterns)
@frontend/src/components/draft/DraftDiffViewer.tsx

# API hooks
# frontend/src/api/draftApiV2.ts (from 14-06)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DraftDiffViewerV2 component</name>
  <files>frontend/src/components/draft/DraftDiffViewerV2.tsx</files>
  <action>
Create a diff viewer component for v2 draft changes:

Props:
- changes: DraftChangeV2[] (from useDraftChanges hook)
- onEntityClick?: (entityType: string, entityKey: string) => void

Layout (grouped by entity type):

1. Summary bar at top:
   - Total changes count
   - Breakdown: "+{N} added, ~{M} modified, -{K} deleted" with colored text

2. Entity type sections (one per type with changes):
   - Header: "Categories ({count})" / "Properties ({count})" etc.
   - Collapsible via AccordionSection pattern

3. Within each section, each change rendered as a card:
   - Left: Change type badge
     - "create" -> green Badge with "+" label
     - "update" -> amber Badge with "~" label
     - "delete" -> red Badge with "-" label
   - Center: entity_key as clickable text (calls onEntityClick)
   - Right: entity_type label

4. Expandable detail panel for each change (click to expand):
   - For CREATE: Show replacement_json fields as key-value pairs (all green/highlighted)
   - For UPDATE: Show patch operations
     - Each patch op: "op: {op}, path: {path}, value: {value}" formatted
     - Use monospace font for paths
   - For DELETE: Show "Entity will be deleted" message

5. Empty state: "No changes in this draft" with gray text

Use:
- shadcn Card for change cards
- shadcn Badge for change type indicators
- Change type color scheme matching Phase 12 conventions:
  - Added: green (bg-green-100 text-green-800)
  - Modified: amber (bg-amber-100 text-amber-800)
  - Deleted: red (bg-red-100 text-red-800)
- lucide-react icons: Plus, Pencil, Trash2 for change types
- React useState for expansion tracking

Group changes by entity_type and sort by:
1. Entity type alphabetically
2. Change type order: create, update, delete
3. Entity key alphabetically within each group
  </action>
  <verify>cd /home/daharoni/dev/ontology-hub/frontend && npx tsc --noEmit --skipLibCheck src/components/draft/DraftDiffViewerV2.tsx 2>&1 | head -20</verify>
  <done>DraftDiffViewerV2 component displays changes grouped by entity type with expansion</done>
</task>

</tasks>

<verification>
- DraftDiffViewerV2 compiles without TypeScript errors
- Changes grouped by entity type
- Change type badges use correct colors (green/amber/red)
- Expandable details show patch operations for updates
</verification>

<success_criteria>
- Diff view groups changes by entity type (categories, properties, etc.)
- Each change shows change type badge (add/modify/delete) with color coding
- CREATE changes show full entity data
- UPDATE changes show JSON Patch operations
- DELETE changes clearly marked
- Entity keys are clickable for navigation
</success_criteria>

<output>
After completion, create `.planning/phases/14-validation-workflow-pr/14-08-SUMMARY.md`
</output>
