---
phase: 14-validation-workflow-pr
plan: 06
type: execute
wave: 3
depends_on: ["14-03"]
files_modified:
  - frontend/src/api/draftApiV2.ts
  - frontend/src/stores/draftStoreV2.ts
autonomous: true

must_haves:
  truths:
    - "Frontend can call validate and submit API endpoints"
    - "Validation results stored in state and accessible to UI components"
    - "Draft status changes reflected in UI state"
    - "Validation cache invalidated when draft changes are made"
  artifacts:
    - path: "frontend/src/api/draftApiV2.ts"
      provides: "API client functions for v2 draft validation and submission"
      exports: ["useValidateDraft", "useSubmitDraft", "useDraftChanges", "useDraftV2"]
    - path: "frontend/src/stores/draftStoreV2.ts"
      provides: "Zustand store for v2 draft workflow state"
      exports: ["useDraftStoreV2"]
  key_links:
    - from: "frontend/src/api/draftApiV2.ts"
      to: "/api/v2/drafts/{token}/validate"
      via: "fetch POST"
      pattern: "validate"
    - from: "frontend/src/api/draftApiV2.ts"
      to: "/api/v2/drafts/{token}/submit"
      via: "fetch POST"
      pattern: "submit"
---

<objective>
Create frontend API hooks and state management for v2 draft workflow.

Purpose: The frontend needs TanStack Query hooks to call the new validate and submit endpoints, plus a Zustand store to manage workflow state (current draft, validation results, submission status).

Output: draftApiV2.ts with query/mutation hooks, draftStoreV2.ts with workflow state.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-validation-workflow-pr/14-CONTEXT.md
@.planning/phases/14-validation-workflow-pr/14-RESEARCH.md

# Existing patterns
@frontend/src/api/entitiesV2.ts
@frontend/src/api/client.ts
@frontend/src/stores/draftStore.ts
@frontend/src/api/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create draftApiV2.ts with query and mutation hooks</name>
  <files>frontend/src/api/draftApiV2.ts</files>
  <action>
Create API client module with TanStack Query hooks for v2 draft operations:

```typescript
import { useMutation, useQuery, useQueryClient } from '@tanstack/react-query'
import { apiFetch } from './client'

// Types for v2 draft API
export interface DraftV2 {
  id: string
  status: 'draft' | 'validated' | 'submitted' | 'merged' | 'rejected'
  source: string
  title: string | null
  description: string | null
  user_comment: string | null
  base_commit_sha: string
  rebase_status: string | null
  rebase_commit_sha: string | null
  created_at: string
  modified_at: string
  expires_at: string
  change_count: number
  pr_url?: string | null
}

export interface DraftChangeV2 {
  id: string
  change_type: 'create' | 'update' | 'delete'
  entity_type: string
  entity_key: string
  patch: Record<string, unknown>[] | null
  replacement_json: Record<string, unknown> | null
  created_at: string
}

export interface ValidationResultV2 {
  entity_type: string
  entity_key: string
  field_path: string | null
  code: string
  message: string
  severity: 'error' | 'warning' | 'info'
  suggested_semver: 'major' | 'minor' | 'patch' | null
  old_value: string | null
  new_value: string | null
}

export interface ValidationReportV2 {
  is_valid: boolean
  errors: ValidationResultV2[]
  warnings: ValidationResultV2[]
  info: ValidationResultV2[]
  suggested_semver: 'major' | 'minor' | 'patch'
  semver_reasons: string[]
  module_suggestions: Record<string, string>
  bundle_suggestions: Record<string, string>
}

export interface SubmitResponse {
  pr_url: string
  draft_status: string
}

// Fetch functions

async function fetchDraftV2(token: string): Promise<DraftV2> {
  return apiFetch(`/drafts/${token}`, { v2: true })
}

async function fetchDraftChanges(token: string): Promise<{
  changes: DraftChangeV2[]
  total: number
}> {
  return apiFetch(`/drafts/${token}/changes`, { v2: true })
}

async function validateDraft(token: string): Promise<ValidationReportV2> {
  return apiFetch(`/drafts/${token}/validate`, {
    v2: true,
    method: 'POST',
  })
}

async function submitDraft(
  token: string,
  params: {
    github_token: string
    pr_title?: string
    user_comment?: string
  }
): Promise<SubmitResponse> {
  return apiFetch(`/drafts/${token}/submit`, {
    v2: true,
    method: 'POST',
    body: JSON.stringify(params),
  })
}

// Query hooks

export function useDraftV2(token: string | null) {
  return useQuery({
    queryKey: ['v2', 'draft', token],
    queryFn: () => fetchDraftV2(token!),
    enabled: !!token,
  })
}

export function useDraftChanges(token: string | null) {
  return useQuery({
    queryKey: ['v2', 'draft-changes', token],
    queryFn: () => fetchDraftChanges(token!),
    enabled: !!token,
  })
}

// Mutation hooks

export function useValidateDraft(token: string) {
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: () => validateDraft(token),
    onSuccess: () => {
      // Invalidate draft query to refresh status
      queryClient.invalidateQueries({ queryKey: ['v2', 'draft', token] })
    },
  })
}

export function useSubmitDraft(token: string) {
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: (params: {
      github_token: string
      pr_title?: string
      user_comment?: string
    }) => submitDraft(token, params),
    onSuccess: () => {
      // Invalidate draft query to refresh status
      queryClient.invalidateQueries({ queryKey: ['v2', 'draft', token] })
    },
  })
}
```

Note: Check if apiFetch supports method and body params. If not, add a helper that uses fetch directly with the correct base URL. The pattern should match how other API calls are made in the project.
  </action>
  <verify>cd /home/daharoni/dev/ontology-hub/frontend && npx tsc --noEmit --skipLibCheck src/api/draftApiV2.ts 2>&1 | head -20</verify>
  <done>draftApiV2.ts exports all query/mutation hooks for draft validation and submission</done>
</task>

<task type="auto">
  <name>Task 2: Create draftStoreV2.ts for workflow state</name>
  <files>frontend/src/stores/draftStoreV2.ts</files>
  <action>
Create a Zustand store for v2 draft workflow state:

```typescript
import { create } from 'zustand'
import type { DraftV2, ValidationReportV2 } from '@/api/draftApiV2'

interface DraftWorkflowState {
  // Current draft token (from URL)
  draftToken: string | null

  // Latest validation results (from validate mutation)
  validationReport: ValidationReportV2 | null

  // UI state
  isValidating: boolean
  isSubmitting: boolean
  prWizardOpen: boolean

  // After successful submission
  submittedPrUrl: string | null

  // Actions
  setDraftToken: (token: string | null) => void
  setValidationReport: (report: ValidationReportV2 | null) => void
  setIsValidating: (isValidating: boolean) => void
  setIsSubmitting: (isSubmitting: boolean) => void
  setPrWizardOpen: (open: boolean) => void
  setSubmittedPrUrl: (url: string | null) => void
  clearValidation: () => void
  reset: () => void
}

const initialState = {
  draftToken: null as string | null,
  validationReport: null as ValidationReportV2 | null,
  isValidating: false,
  isSubmitting: false,
  prWizardOpen: false,
  submittedPrUrl: null as string | null,
}

export const useDraftStoreV2 = create<DraftWorkflowState>()((set) => ({
  ...initialState,

  setDraftToken: (token) => set({ draftToken: token }),

  setValidationReport: (report) => set({ validationReport: report }),

  setIsValidating: (isValidating) => set({ isValidating }),

  setIsSubmitting: (isSubmitting) => set({ isSubmitting }),

  setPrWizardOpen: (open) => set({ prWizardOpen: open }),

  setSubmittedPrUrl: (url) => set({ submittedPrUrl: url }),

  clearValidation: () => set({ validationReport: null }),

  reset: () => set(initialState),
}))
```

This store is intentionally simple. Complex state like the draft object itself is managed by TanStack Query (useDraftV2 hook). This store only holds ephemeral UI state.
  </action>
  <verify>cd /home/daharoni/dev/ontology-hub/frontend && npx tsc --noEmit --skipLibCheck src/stores/draftStoreV2.ts 2>&1 | head -20</verify>
  <done>draftStoreV2.ts exports useDraftStoreV2 with workflow state management</done>
</task>

</tasks>

<verification>
- draftApiV2.ts compiles without TypeScript errors
- draftStoreV2.ts compiles without TypeScript errors
- All hooks use correct API endpoints
- Query invalidation wired for state refresh after mutations
</verification>

<success_criteria>
- useValidateDraft mutation calls POST /api/v2/drafts/{token}/validate
- useSubmitDraft mutation calls POST /api/v2/drafts/{token}/submit
- useDraftV2 query fetches draft status
- useDraftStoreV2 manages UI state for validation and submission
- Query cache invalidated after validation/submission mutations
</success_criteria>

<output>
After completion, create `.planning/phases/14-validation-workflow-pr/14-06-SUMMARY.md`
</output>
