---
phase: 14-validation-workflow-pr
plan: 05
type: execute
wave: 3
depends_on: ["14-03", "14-04"]
files_modified:
  - backend/app/routers/drafts_v2.py
autonomous: true

must_haves:
  truths:
    - "POST /drafts/{token}/submit creates GitHub PR using OAuth token"
    - "Submit endpoint re-validates before creating PR"
    - "Submit transitions draft to SUBMITTED and stores pr_url"
    - "Submit fails if draft is not VALIDATED"
  artifacts:
    - path: "backend/app/routers/drafts_v2.py"
      provides: "Submit endpoint for PR creation"
      contains: "submit_draft"
  key_links:
    - from: "backend/app/routers/drafts_v2.py"
      to: "backend/app/services/pr_builder_v2.py"
      via: "import and call build_files_from_draft_v2"
      pattern: "build_files_from_draft_v2"
    - from: "backend/app/routers/drafts_v2.py"
      to: "backend/app/services/github.py"
      via: "GitHubClient.create_pr_with_token"
      pattern: "create_pr_with_token"
---

<objective>
Add PR submission endpoint to drafts_v2.py router.

Purpose: After validation passes, users can submit their draft as a GitHub PR. The endpoint uses OAuth token (provided in request) to create branch, commit, and PR. Draft transitions to SUBMITTED status.

Output: POST /api/v2/drafts/{token}/submit endpoint that creates GitHub PR.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-validation-workflow-pr/14-CONTEXT.md
@.planning/phases/14-validation-workflow-pr/14-RESEARCH.md

# Prior plan summaries
@.planning/phases/14-validation-workflow-pr/14-03-SUMMARY.md
@.planning/phases/14-validation-workflow-pr/14-04-SUMMARY.md

# Existing drafts router
@backend/app/routers/drafts_v2.py

# v1 OAuth flow (reuse patterns)
@backend/app/routers/oauth.py
@backend/app/services/github.py

# v2 PR builder (from 14-04)
# backend/app/services/pr_builder_v2.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create submit request schema</name>
  <files>backend/app/schemas/draft_v2.py</files>
  <action>
Add a new Pydantic schema for the submit request:

```python
class DraftSubmitRequest(BaseModel):
    """Request body for submitting a draft as PR."""
    github_token: str = Field(..., description="GitHub OAuth access token")
    pr_title: str | None = Field(None, description="Optional custom PR title")
    user_comment: str | None = Field(None, description="Optional comment to include in PR body")


class DraftSubmitResponse(BaseModel):
    """Response from successful PR submission."""
    pr_url: str = Field(..., description="URL of the created pull request")
    draft_status: str = Field(..., description="New draft status (submitted)")
```

Add these to the existing schemas/draft_v2.py file.
  </action>
  <verify>cd /home/daharoni/dev/ontology-hub && python -c "from app.schemas.draft_v2 import DraftSubmitRequest, DraftSubmitResponse; print('OK')"</verify>
  <done>DraftSubmitRequest and DraftSubmitResponse schemas exist</done>
</task>

<task type="auto">
  <name>Task 2: Add submit endpoint to drafts_v2.py</name>
  <files>backend/app/routers/drafts_v2.py</files>
  <action>
Add a POST endpoint for submitting a draft as GitHub PR:

1. Add imports:
   ```python
   import logging
   from app.config import settings
   from app.schemas.draft_v2 import DraftSubmitRequest, DraftSubmitResponse
   from app.services.pr_builder_v2 import (
       build_files_from_draft_v2,
       generate_branch_name,
       generate_commit_message_v2,
       generate_pr_body_v2,
   )
   from app.services.validation.validator_v2 import validate_draft_v2
   from app.services.draft_workflow import transition_to_submitted
   from app.services.github import GitHubClient

   logger = logging.getLogger(__name__)
   ```

2. Add endpoint:

```python
@router.post("/{token}/submit", response_model=DraftSubmitResponse)
@limiter.limit(RATE_LIMITS["draft_create"])  # More restrictive for PR creation
async def submit_draft(
    request: Request,
    token: str,
    submit_req: DraftSubmitRequest,
    session: SessionDep,
) -> DraftSubmitResponse:
    """Submit draft as GitHub pull request.

    Creates a GitHub PR with all draft changes. Requires:
    1. Draft must be in VALIDATED status
    2. Valid GitHub OAuth token with public_repo scope

    The endpoint will:
    1. Re-validate to ensure no stale validation
    2. Generate files from draft changes
    3. Create branch, commit, and PR via GitHub API
    4. Transition draft to SUBMITTED status
    5. Store PR URL in draft

    Rate limited to 20/hour per IP (same as draft creation).

    Args:
        request: HTTP request (required for rate limiting)
        token: Capability token from URL
        submit_req: Submit request with GitHub token and optional PR details
        session: Database session

    Returns:
        DraftSubmitResponse with pr_url

    Raises:
        HTTPException: 404 for invalid or expired tokens
        HTTPException: 400 if draft not in VALIDATED status
        HTTPException: 400 if validation fails on re-check
        HTTPException: 500 if GitHub PR creation fails
    """
    draft = await get_draft_by_token(token, session)

    # Check draft is in VALIDATED status
    if draft.status != DraftStatus.VALIDATED:
        raise HTTPException(
            status_code=400,
            detail=f"Draft must be validated before submitting. "
            f"Current status: {draft.status.value}. "
            f"Run validation first via POST /drafts/{'{token}'}/validate",
        )

    # Re-validate to catch any stale validation (especially if rebased)
    validation = await validate_draft_v2(draft.id, session)
    if not validation.is_valid:
        raise HTTPException(
            status_code=400,
            detail="Draft validation failed on re-check. "
            f"Errors: {[e.message for e in validation.errors]}",
        )

    # Load draft changes for file generation
    changes_query = select(DraftChange).where(DraftChange.draft_id == draft.id)
    changes_result = await session.execute(changes_query)
    changes = list(changes_result.scalars().all())

    if not changes:
        raise HTTPException(
            status_code=400,
            detail="Draft has no changes to submit.",
        )

    # Generate files from draft changes
    files = await build_files_from_draft_v2(draft.id, session)
    if not files:
        raise HTTPException(
            status_code=400,
            detail="No files to commit. Draft changes could not be converted to files.",
        )

    # Generate PR metadata
    branch_name = generate_branch_name(str(draft.id))
    commit_message = generate_commit_message_v2(changes)
    pr_title = submit_req.pr_title or f"Schema update: {draft.title or str(draft.id)[:8]}"
    pr_body = generate_pr_body_v2(
        changes=changes,
        validation=validation,
        draft_title=draft.title,
        user_comment=submit_req.user_comment or draft.user_comment,
    )

    # Create PR via GitHub API
    try:
        pr_url = await GitHubClient(None).create_pr_with_token(  # type: ignore
            token=submit_req.github_token,
            owner=settings.GITHUB_REPO_OWNER,
            repo=settings.GITHUB_REPO_NAME,
            branch_name=branch_name,
            files=files,
            commit_message=commit_message,
            pr_title=pr_title,
            pr_body=pr_body,
        )
    except Exception as e:
        logger.error(f"Failed to create PR: {e}")
        raise HTTPException(
            status_code=500,
            detail=f"Failed to create GitHub PR: {str(e)}",
        )

    # Transition to SUBMITTED and store PR URL
    await transition_to_submitted(draft.id, pr_url, session)
    await session.commit()

    return DraftSubmitResponse(
        pr_url=pr_url,
        draft_status=DraftStatus.SUBMITTED.value,
    )
```
  </action>
  <verify>cd /home/daharoni/dev/ontology-hub && python -c "from app.routers.drafts_v2 import submit_draft; print('OK')"</verify>
  <done>POST /api/v2/drafts/{token}/submit endpoint exists and creates GitHub PR</done>
</task>

</tasks>

<verification>
- POST /api/v2/drafts/{token}/submit endpoint exists
- Endpoint requires draft to be VALIDATED
- Re-validates before creating PR
- Creates branch, commit, and PR via GitHub API
- Transitions draft to SUBMITTED and stores pr_url
- Returns DraftSubmitResponse with pr_url
</verification>

<success_criteria>
- Submit endpoint only works on VALIDATED drafts
- Re-validation catches stale validation results
- GitHub PR created with correct files and metadata
- Draft status transitions to SUBMITTED with pr_url stored
</success_criteria>

<output>
After completion, create `.planning/phases/14-validation-workflow-pr/14-05-SUMMARY.md`
</output>
