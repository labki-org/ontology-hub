---
phase: 14-validation-workflow-pr
plan: 03
type: execute
wave: 2
depends_on: ["14-01", "14-02"]
files_modified:
  - backend/app/routers/drafts_v2.py
autonomous: true

must_haves:
  truths:
    - "POST /drafts/{token}/validate runs validation and transitions to VALIDATED on success"
    - "POST /drafts/{token}/validate returns validation report with all findings"
    - "Validation endpoint only succeeds if no errors (warnings allowed)"
    - "Validation endpoint re-validates if rebase_status indicates changes"
  artifacts:
    - path: "backend/app/routers/drafts_v2.py"
      provides: "Validate endpoint for v2 drafts"
      contains: "validate_draft"
  key_links:
    - from: "backend/app/routers/drafts_v2.py"
      to: "backend/app/services/validation/validator_v2.py"
      via: "import and call validate_draft_v2"
      pattern: "validate_draft_v2"
    - from: "backend/app/routers/drafts_v2.py"
      to: "backend/app/services/draft_workflow.py"
      via: "import and call transition_to_validated"
      pattern: "transition_to_validated"
---

<objective>
Add validation endpoint to drafts_v2.py router.

Purpose: Users need a way to trigger validation and get structured feedback. The endpoint validates the draft against all rules and, if successful (no errors), transitions status to VALIDATED.

Output: POST /api/v2/drafts/{token}/validate endpoint that returns DraftValidationReportV2.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-validation-workflow-pr/14-CONTEXT.md
@.planning/phases/14-validation-workflow-pr/14-RESEARCH.md

# Prior plan summaries
@.planning/phases/14-validation-workflow-pr/14-01-SUMMARY.md
@.planning/phases/14-validation-workflow-pr/14-02-SUMMARY.md

# Existing drafts router
@backend/app/routers/drafts_v2.py

# v2 validation service (from 14-01)
# backend/app/services/validation/validator_v2.py

# Draft workflow (from 14-02)
# backend/app/services/draft_workflow.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add validate endpoint to drafts_v2.py</name>
  <files>backend/app/routers/drafts_v2.py</files>
  <action>
Add a POST endpoint for validating a draft:

1. Add imports at top:
   ```python
   from app.schemas.validation_v2 import DraftValidationReportV2
   from app.services.validation.validator_v2 import validate_draft_v2
   from app.services.draft_workflow import transition_to_validated
   ```

2. Add new endpoint after update_draft_status:

```python
@router.post("/{token}/validate", response_model=DraftValidationReportV2)
@limiter.limit(RATE_LIMITS["draft_read"])
async def validate_draft(
    request: Request,
    token: str,
    session: SessionDep,
) -> DraftValidationReportV2:
    """Validate draft and transition to VALIDATED status if no errors.

    Runs all validation checks:
    - Reference existence (parents, properties, modules exist)
    - Circular inheritance detection
    - Breaking change detection
    - JSON Schema validation against _schema.json definitions
    - Semver classification

    If validation passes (no errors), transitions draft status to VALIDATED.
    Warnings and info messages do NOT prevent validation from passing.

    If draft has rebase_status="conflict", validation will include a warning
    about potential conflicts that should be reviewed.

    Rate limited to 100/minute per IP.

    Args:
        request: HTTP request (required for rate limiting)
        token: Capability token from URL
        session: Database session

    Returns:
        DraftValidationReportV2 with validation results and semver suggestions

    Raises:
        HTTPException: 404 for invalid or expired tokens
        HTTPException: 400 if draft is in terminal status (SUBMITTED/MERGED/REJECTED)
    """
    draft = await get_draft_by_token(token, session)

    # Check draft is in validatable status
    if draft.status in (DraftStatus.SUBMITTED, DraftStatus.MERGED, DraftStatus.REJECTED):
        raise HTTPException(
            status_code=400,
            detail=f"Cannot validate draft in '{draft.status.value}' status. "
            "Draft has already been submitted.",
        )

    # Run validation
    report = await validate_draft_v2(draft.id, session)

    # Add warning if rebase status indicates potential conflicts
    if draft.rebase_status == "conflict":
        from app.schemas.validation_v2 import ValidationResultV2
        report.warnings.append(
            ValidationResultV2(
                entity_type="category",  # Generic
                entity_key="*",
                field_path=None,
                code="REBASE_CONFLICT",
                message="Draft may have conflicts with recent canonical changes. Review before submitting.",
                severity="warning",
            )
        )

    # If no errors, transition to VALIDATED
    if report.is_valid:
        await transition_to_validated(draft.id, session)
        await session.commit()

    return report
```

3. Update imports in __init__ or ensure the endpoint is registered correctly.
  </action>
  <verify>cd /home/daharoni/dev/ontology-hub && python -c "from app.routers.drafts_v2 import validate_draft; print('OK')"</verify>
  <done>POST /api/v2/drafts/{token}/validate endpoint exists and returns DraftValidationReportV2</done>
</task>

</tasks>

<verification>
- POST /api/v2/drafts/{token}/validate endpoint exists
- Endpoint returns DraftValidationReportV2
- Validation success (is_valid=True) transitions draft to VALIDATED status
- Validation with errors returns report but does NOT change status
- Rebase conflicts add warning to report
</verification>

<success_criteria>
- validate_draft endpoint callable with capability token
- Returns structured validation report with entity_key references
- Auto-transitions to VALIDATED when no errors
- Handles rebase_status="conflict" with warning
</success_criteria>

<output>
After completion, create `.planning/phases/14-validation-workflow-pr/14-03-SUMMARY.md`
</output>
