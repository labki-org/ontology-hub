---
phase: 14-validation-workflow-pr
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/routers/draft_changes.py
  - backend/app/services/draft_workflow.py
autonomous: true

must_haves:
  truths:
    - "Adding a change to a VALIDATED draft auto-reverts status to DRAFT"
    - "Auto-revert clears validated_at timestamp"
    - "Status transitions are validated with SELECT FOR UPDATE to prevent races"
  artifacts:
    - path: "backend/app/services/draft_workflow.py"
      provides: "Draft workflow state machine logic"
      exports: ["auto_revert_if_validated", "validate_status_transition"]
    - path: "backend/app/routers/draft_changes.py"
      provides: "Draft change endpoints with auto-revert behavior"
      contains: "auto_revert_if_validated"
  key_links:
    - from: "backend/app/routers/draft_changes.py"
      to: "backend/app/services/draft_workflow.py"
      via: "import and call"
      pattern: "auto_revert_if_validated"
---

<objective>
Implement auto-revert workflow behavior and draft status management.

Purpose: Per CONTEXT.md, if a user edits anything after validation, status auto-reverts to DRAFT. This ensures validation results are always current. Also implement proper locking for status transitions to prevent race conditions.

Output: draft_workflow.py service and updated draft_changes.py with auto-revert behavior.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-validation-workflow-pr/14-CONTEXT.md
@.planning/phases/14-validation-workflow-pr/14-RESEARCH.md

# Existing draft change endpoints
@backend/app/routers/draft_changes.py

# v2 draft model with status
@backend/app/models/v2/draft.py
@backend/app/routers/drafts_v2.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create draft_workflow.py service</name>
  <files>backend/app/services/draft_workflow.py</files>
  <action>
Create a new service module for draft workflow state management:

```python
"""Draft workflow state machine and transition logic."""

from datetime import datetime
from uuid import UUID

from sqlmodel import select
from sqlmodel.ext.asyncio.session import AsyncSession

from app.models.v2 import Draft, DraftStatus


# Valid status transitions (same as drafts_v2.py but centralized)
VALID_TRANSITIONS: dict[DraftStatus, set[DraftStatus]] = {
    DraftStatus.DRAFT: {DraftStatus.VALIDATED},
    DraftStatus.VALIDATED: {DraftStatus.SUBMITTED, DraftStatus.DRAFT},
    DraftStatus.SUBMITTED: {DraftStatus.MERGED, DraftStatus.REJECTED},
    DraftStatus.MERGED: set(),  # Terminal
    DraftStatus.REJECTED: set(),  # Terminal
}


async def get_draft_for_update(
    draft_id: UUID,
    session: AsyncSession,
) -> Draft | None:
    """Get draft with row-level lock for status updates.

    Uses SELECT ... FOR UPDATE to prevent race conditions when
    multiple requests try to modify draft status concurrently.
    """
    from sqlalchemy import text

    # Use raw SQL for FOR UPDATE clause (SQLModel doesn't support it directly)
    result = await session.execute(
        select(Draft).where(Draft.id == draft_id).with_for_update()
    )
    return result.scalar_one_or_none()


async def auto_revert_if_validated(
    draft: Draft,
    session: AsyncSession,
) -> bool:
    """Auto-revert draft status to DRAFT if currently VALIDATED.

    Called when any change is added to a draft. If the draft was
    already validated, this invalidates that validation.

    Returns:
        True if status was reverted, False if no change needed
    """
    if draft.status == DraftStatus.VALIDATED:
        draft.status = DraftStatus.DRAFT
        draft.validated_at = None
        draft.modified_at = datetime.utcnow()
        session.add(draft)
        return True
    return False


def validate_status_transition(
    current_status: DraftStatus,
    new_status: DraftStatus,
) -> tuple[bool, str]:
    """Validate a status transition is allowed.

    Returns:
        Tuple of (is_valid, error_message)
    """
    if new_status == current_status:
        return True, ""

    allowed = VALID_TRANSITIONS.get(current_status, set())
    if new_status not in allowed:
        allowed_str = ", ".join(s.value for s in allowed) if allowed else "none"
        return False, (
            f"Invalid status transition: {current_status.value} -> {new_status.value}. "
            f"Allowed transitions: {allowed_str}"
        )

    return True, ""


async def transition_to_validated(
    draft_id: UUID,
    session: AsyncSession,
) -> Draft:
    """Transition draft to VALIDATED status.

    Called after validation passes. Uses row lock to prevent races.

    Raises:
        ValueError: If transition not allowed
    """
    draft = await get_draft_for_update(draft_id, session)
    if not draft:
        raise ValueError(f"Draft {draft_id} not found")

    is_valid, error = validate_status_transition(draft.status, DraftStatus.VALIDATED)
    if not is_valid:
        raise ValueError(error)

    draft.status = DraftStatus.VALIDATED
    draft.validated_at = datetime.utcnow()
    draft.modified_at = datetime.utcnow()
    session.add(draft)

    return draft


async def transition_to_submitted(
    draft_id: UUID,
    pr_url: str,
    session: AsyncSession,
) -> Draft:
    """Transition draft to SUBMITTED status after PR creation.

    Raises:
        ValueError: If transition not allowed
    """
    draft = await get_draft_for_update(draft_id, session)
    if not draft:
        raise ValueError(f"Draft {draft_id} not found")

    is_valid, error = validate_status_transition(draft.status, DraftStatus.SUBMITTED)
    if not is_valid:
        raise ValueError(error)

    draft.status = DraftStatus.SUBMITTED
    draft.submitted_at = datetime.utcnow()
    draft.modified_at = datetime.utcnow()
    draft.pr_url = pr_url
    session.add(draft)

    return draft
```
  </action>
  <verify>python -c "from app.services.draft_workflow import auto_revert_if_validated, validate_status_transition, transition_to_validated; print('OK')"</verify>
  <done>draft_workflow.py exists with auto_revert_if_validated and status transition functions</done>
</task>

<task type="auto">
  <name>Task 2: Update draft_changes.py with auto-revert</name>
  <files>backend/app/routers/draft_changes.py</files>
  <action>
Modify the add_draft_change endpoint to call auto_revert_if_validated:

1. Add import at top:
   ```python
   from app.services.draft_workflow import auto_revert_if_validated
   ```

2. In add_draft_change function, after validating the draft is in DRAFT status but BEFORE creating the change, update the logic:

   Replace the existing status check:
   ```python
   # Check draft status - can only add changes to DRAFT status
   if draft.status != DraftStatus.DRAFT:
       raise HTTPException(...)
   ```

   With:
   ```python
   # Check draft status - can only add changes to DRAFT or VALIDATED status
   # If VALIDATED, auto-revert to DRAFT (per CONTEXT.md workflow)
   if draft.status == DraftStatus.VALIDATED:
       await auto_revert_if_validated(draft, session)
   elif draft.status != DraftStatus.DRAFT:
       raise HTTPException(
           status_code=400,
           detail=f"Cannot add changes to draft in '{draft.status.value}' status. "
           "Changes can only be added when status is 'draft' or 'validated'.",
       )
   ```

3. Same pattern for remove_draft_change - allow removing changes from VALIDATED (which reverts it):
   ```python
   if draft.status == DraftStatus.VALIDATED:
       await auto_revert_if_validated(draft, session)
   elif draft.status != DraftStatus.DRAFT:
       raise HTTPException(...)
   ```

This ensures:
- Adding change to DRAFT draft: no status change
- Adding change to VALIDATED draft: reverts to DRAFT
- Adding change to SUBMITTED/MERGED/REJECTED: error (immutable)
  </action>
  <verify>cd /home/daharoni/dev/ontology-hub && python -c "from app.routers.draft_changes import add_draft_change; print('OK')"</verify>
  <done>draft_changes.py imports and uses auto_revert_if_validated for both add and remove operations</done>
</task>

</tasks>

<verification>
- draft_workflow.py exists with all workflow functions
- draft_changes.py imports auto_revert_if_validated
- Adding a change to a VALIDATED draft will revert status to DRAFT
- Status transitions use VALID_TRANSITIONS map
</verification>

<success_criteria>
- auto_revert_if_validated clears validated_at and sets status to DRAFT
- draft_changes endpoints allow changes to VALIDATED drafts (auto-reverting)
- Status transitions validated before applying
- Row-level locking prevents race conditions
</success_criteria>

<output>
After completion, create `.planning/phases/14-validation-workflow-pr/14-02-SUMMARY.md`
</output>
