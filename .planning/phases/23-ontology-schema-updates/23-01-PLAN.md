---
phase: 23-ontology-schema-updates
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - /home/daharoni/dev/labki-ontology/scripts/lib/entity-index.js
  - /home/daharoni/dev/labki-ontology/dashboards/_schema.json
  - /home/daharoni/dev/labki-ontology/properties/_schema.json
autonomous: true

must_haves:
  truths:
    - "Dashboard schema validates pages array with main page requirement"
    - "Page names follow category ID pattern when not empty"
    - "Resource schema accepts dynamic fields via additionalProperties"
    - "Properties schema supports Allows_value_from_category field"
    - "Validation script runs without errors on all entity types"
    - "Example entities pass schema validation"
  artifacts:
    - path: "/home/daharoni/dev/labki-ontology/scripts/lib/entity-index.js"
      provides: "Entity indexing for dashboards and resources"
      contains: "dashboards: new Map()"
    - path: "/home/daharoni/dev/labki-ontology/dashboards/_schema.json"
      provides: "Dashboard schema with page name validation"
      contains: "pattern"
    - path: "/home/daharoni/dev/labki-ontology/properties/_schema.json"
      provides: "Property schema with Allows_value_from_category"
      contains: "Allows_value_from_category"
  key_links:
    - from: "/home/daharoni/dev/labki-ontology/scripts/validate.js"
      to: "entity-index.js"
      via: "buildEntityIndex import"
      pattern: "import.*buildEntityIndex"
---

<objective>
Complete ontology schema updates for Dashboard and Resource entity support in labki-ontology.

Purpose: Enable the validation pipeline to handle the new Dashboard and Resource entity types, and ensure schemas match the decisions from Phase 23 CONTEXT.md.

Output: Working validation that passes for all existing and new entity types.
</objective>

<execution_context>
@/home/daharoni/.claude/get-shit-done/workflows/execute-plan.md
@/home/daharoni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/daharoni/dev/ontology-hub/.planning/PROJECT.md
@/home/daharoni/dev/ontology-hub/.planning/ROADMAP.md
@/home/daharoni/dev/ontology-hub/.planning/phases/23-ontology-schema-updates/23-CONTEXT.md

Working directory: /home/daharoni/dev/labki-ontology (NOT ontology-hub)

Existing schemas to reference:
@/home/daharoni/dev/labki-ontology/categories/_schema.json
@/home/daharoni/dev/labki-ontology/dashboards/_schema.json
@/home/daharoni/dev/labki-ontology/resources/_schema.json
@/home/daharoni/dev/labki-ontology/properties/_schema.json
@/home/daharoni/dev/labki-ontology/modules/_schema.json
@/home/daharoni/dev/labki-ontology/bundles/_schema.json
@/home/daharoni/dev/labki-ontology/scripts/lib/entity-index.js
@/home/daharoni/dev/labki-ontology/scripts/lib/constants.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix entity-index.js to support dashboards and resources</name>
  <files>/home/daharoni/dev/labki-ontology/scripts/lib/entity-index.js</files>
  <action>
Add `dashboards: new Map()` and `resources: new Map()` to the index initialization object in buildEntityIndex().

The current index object only initializes 6 entity types but constants.js has 8. This causes a crash when processing dashboard/resource files because `index[firstSegment]` is undefined.

After fix, the index object should be:
```javascript
const index = {
  categories: new Map(),
  properties: new Map(),
  subobjects: new Map(),
  templates: new Map(),
  modules: new Map(),
  bundles: new Map(),
  dashboards: new Map(),
  resources: new Map()
}
```
  </action>
  <verify>Run `cd /home/daharoni/dev/labki-ontology && npm run validate` - should not crash with "Cannot read properties of undefined"</verify>
  <done>Validation script processes all 8 entity types without crashing</done>
</task>

<task type="auto">
  <name>Task 2: Update dashboard schema with page name pattern</name>
  <files>/home/daharoni/dev/labki-ontology/dashboards/_schema.json</files>
  <action>
Update the page name validation in dashboards/_schema.json:

1. The `name` field in pages items currently has no pattern constraint
2. Per CONTEXT.md: "Page names follow category ID pattern: `^[A-Z][a-z]*(_[a-z]+)*$`"
3. BUT the root page must be empty string `""`
4. Also, pages should be displayed alphabetically (informational, no schema change needed)

The name field needs to allow EITHER:
- Empty string (for root page)
- OR match the category ID pattern

Update the `name` property in the pages items to:
```json
"name": {
  "type": "string",
  "description": "Page name. Empty string for root page, otherwise follows pattern: Capital_word format.",
  "pattern": "^$|^[A-Z][a-z]*(_[a-z]+)*$"
}
```

Note: The pattern `^$|^[A-Z][a-z]*(_[a-z]+)*$` uses alternation to allow empty string OR the category pattern.
  </action>
  <verify>
1. Run `cd /home/daharoni/dev/labki-ontology && npm run validate` - dashboard examples should pass
2. Check that Core_overview.json still validates (has pages with name "" and "setup")
  </verify>
  <done>Dashboard schema enforces page name pattern while allowing empty string for root page</done>
</task>

<task type="auto">
  <name>Task 3: Add Allows_value_from_category field to properties schema</name>
  <files>/home/daharoni/dev/labki-ontology/properties/_schema.json</files>
  <action>
Per CONTEXT.md decisions:
- New property field: `Allows_value_from_category` (follows property naming convention)
- References a category by ID (e.g., `"Allows_value_from_category": "SOP"`)
- Mutually exclusive with `allowed_values` array

The current schema already has `allowed_values` which can be either:
- An array of strings (enumeration)
- An object with `from_category` key

CONTEXT.md specifies a DIFFERENT approach: a separate top-level field `Allows_value_from_category`.

Add the new field to properties schema:
```json
"Allows_value_from_category": {
  "type": "string",
  "description": "Category ID to source allowed values from. Mutually exclusive with allowed_values.",
  "pattern": "^[A-Z][a-z]*(_[a-z]+)*$"
}
```

For mutual exclusivity, we need to prevent both `allowed_values` AND `Allows_value_from_category` from being present. Add a `not` constraint at the schema level:

At the top level of the schema, add:
```json
"not": {
  "required": ["allowed_values", "Allows_value_from_category"]
}
```

This ensures that if both fields are present, validation fails.

Keep the existing `allowed_values` definition (for backwards compatibility with the array format and the object format).
  </action>
  <verify>
1. Run `cd /home/daharoni/dev/labki-ontology && npm run validate` - existing properties should pass
2. Create a test: a property with both `allowed_values` AND `Allows_value_from_category` should fail validation
  </verify>
  <done>Properties schema has Allows_value_from_category field that is mutually exclusive with allowed_values</done>
</task>

<task type="auto">
  <name>Task 4: Verify all schemas and run full validation</name>
  <files>
/home/daharoni/dev/labki-ontology/dashboards/Core_overview.json
/home/daharoni/dev/labki-ontology/resources/Person/John_doe.json
  </files>
  <action>
1. Run full validation: `cd /home/daharoni/dev/labki-ontology && npm run validate`

2. If Core_overview.json fails due to page name "setup" not matching pattern:
   - The pattern requires Capital_word format
   - "setup" should be "Setup"
   - Update Core_overview.json page name from "setup" to "Setup"

3. Verify the success criteria from ROADMAP.md:
   - dashboards/_schema.json validates dashboard structure with pages array (check)
   - resources/_schema.json validates resources with additionalProperties:true (check - already there)
   - Modules and bundles schema accepts dashboards array field (check - already there)
   - Example entities pass schema validation (verify)

4. All 17+ entities should validate successfully
  </action>
  <verify>
`cd /home/daharoni/dev/labki-ontology && npm run validate` outputs "All X file(s) validated successfully"
  </verify>
  <done>All entity files pass validation, including dashboards and resources</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Schema validation passes:
```bash
cd /home/daharoni/dev/labki-ontology && npm run validate
```
Expected: "All X file(s) validated successfully" (no errors)

2. Dashboard schema requirements met:
- Pages array required with minItems: 1
- Must contain root page (name: "")
- Page names match pattern or empty

3. Resource schema requirements met:
- additionalProperties: true allows dynamic fields
- Required: id, label, description, category
- Category field has pattern constraint

4. Properties schema requirements met:
- Allows_value_from_category field exists
- Mutually exclusive with allowed_values

5. Module/Bundle schemas:
- dashboards array field exists (already present)
- resources array field exists in modules (already present)
</verification>

<success_criteria>
1. `npm run validate` in labki-ontology runs without crashing
2. All existing entity files pass validation (17+ files)
3. Dashboard schema enforces page structure with name patterns
4. Properties schema supports Allows_value_from_category
5. No regressions - existing schemas remain compatible
</success_criteria>

<output>
After completion, create `/home/daharoni/dev/ontology-hub/.planning/phases/23-ontology-schema-updates/23-01-SUMMARY.md`
</output>
