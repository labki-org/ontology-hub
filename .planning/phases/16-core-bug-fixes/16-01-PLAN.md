---
phase: 16-core-bug-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/schemas/entity_v2.py
  - backend/app/routers/entities_v2.py
autonomous: true

must_haves:
  truths:
    - "User can view subobject details without 'Failed to load' error"
    - "User can view template details without 'Failed to load' error"
  artifacts:
    - path: "backend/app/schemas/entity_v2.py"
      provides: "SubobjectDetailResponse and TemplateDetailResponse schemas"
      contains: "class SubobjectDetailResponse"
    - path: "backend/app/routers/entities_v2.py"
      provides: "GET /subobjects/{entity_key} and GET /templates/{entity_key} endpoints"
      contains: "async def get_subobject"
  key_links:
    - from: "frontend useSubobject hook"
      to: "GET /api/v2/subobjects/{entity_key}"
      via: "apiFetch"
      pattern: "fetchEntityV2.*subobjects"
    - from: "frontend useTemplate hook"
      to: "GET /api/v2/templates/{entity_key}"
      via: "apiFetch"
      pattern: "fetchEntityV2.*templates"
---

<objective>
Add missing backend detail endpoints for subobjects and templates.

Purpose: ENTITY-01 and ENTITY-02 require detail endpoints that don't exist. The frontend hooks (`useSubobject`, `useTemplate`) correctly call `/api/v2/subobjects/{entity_key}` and `/api/v2/templates/{entity_key}`, but backend returns 404 because these endpoints are not implemented.

Output: Working detail endpoints that return entity data with draft overlay support.
</objective>

<execution_context>
@/home/daharoni/.claude/get-shit-done/workflows/execute-plan.md
@/home/daharoni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-core-bug-fixes/16-RESEARCH.md

# Existing patterns
@backend/app/schemas/entity_v2.py
@backend/app/routers/entities_v2.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add subobject and template detail response schemas</name>
  <files>backend/app/schemas/entity_v2.py</files>
  <action>
Add two new response schemas to `backend/app/schemas/entity_v2.py`:

1. `SubobjectDetailResponse` - follows PropertyDetailResponse pattern:
   - `entity_key: str`
   - `label: str`
   - `description: Optional[str] = None`
   - `properties: list[str] = Field(default_factory=list)` - property entity keys
   - `change_status: Optional[ChangeStatus]` with validation_alias="_change_status"
   - `deleted: bool` with validation_alias="_deleted"
   - `model_config = ConfigDict(populate_by_name=True)`

2. `TemplateDetailResponse` - similar structure:
   - `entity_key: str`
   - `label: str`
   - `description: Optional[str] = None`
   - `wikitext: Optional[str] = None` - template wikitext content
   - `property_key: Optional[str] = None` - associated property (templates render properties)
   - `change_status: Optional[ChangeStatus]` with validation_alias="_change_status"
   - `deleted: bool` with validation_alias="_deleted"
   - `model_config = ConfigDict(populate_by_name=True)`

Place these after PropertyDetailResponse class definition.
  </action>
  <verify>
`python -c "from app.schemas.entity_v2 import SubobjectDetailResponse, TemplateDetailResponse; print('OK')"` runs without error from backend directory.
  </verify>
  <done>SubobjectDetailResponse and TemplateDetailResponse schemas exist and can be imported.</done>
</task>

<task type="auto">
  <name>Task 2: Add subobject and template detail endpoints</name>
  <files>backend/app/routers/entities_v2.py</files>
  <action>
Add two new endpoints to `backend/app/routers/entities_v2.py`:

1. First, update imports at top of file to include new schemas:
   ```python
   from app.schemas.entity_v2 import (
       ...,
       SubobjectDetailResponse,
       TemplateDetailResponse,
   )
   ```

2. Add `get_subobject` endpoint after the subobjects list endpoint (around line 420):
   ```python
   @router.get("/subobjects/{entity_key}", response_model=SubobjectDetailResponse)
   @limiter.limit(RATE_LIMITS["entity_read"])
   async def get_subobject(
       request: Request,
       entity_key: str,
       session: SessionDep,
       draft_ctx: DraftContextDep,
   ) -> SubobjectDetailResponse:
       """Get subobject detail.

       Returns subobject with full details and draft change status.

       Rate limited to 200/minute per IP.
       """
       # Get canonical subobject
       query = select(Subobject).where(Subobject.entity_key == entity_key)
       result = await session.execute(query)
       subobj = result.scalar_one_or_none()

       effective = await draft_ctx.apply_overlay(subobj, "subobject", entity_key)

       if not effective:
           raise HTTPException(status_code=404, detail="Subobject not found")

       return SubobjectDetailResponse(
           entity_key=effective.get("entity_key", entity_key),
           label=effective.get("label", ""),
           description=effective.get("description"),
           properties=effective.get("properties", []),
           change_status=effective.get("_change_status"),
           deleted=effective.get("_deleted", False),
       )
   ```

3. Add `get_template` endpoint after the templates list endpoint (around line 500):
   ```python
   @router.get("/templates/{entity_key}", response_model=TemplateDetailResponse)
   @limiter.limit(RATE_LIMITS["entity_read"])
   async def get_template(
       request: Request,
       entity_key: str,
       session: SessionDep,
       draft_ctx: DraftContextDep,
   ) -> TemplateDetailResponse:
       """Get template detail.

       Returns template with full details and draft change status.

       Rate limited to 200/minute per IP.
       """
       # Get canonical template
       query = select(Template).where(Template.entity_key == entity_key)
       result = await session.execute(query)
       tmpl = result.scalar_one_or_none()

       effective = await draft_ctx.apply_overlay(tmpl, "template", entity_key)

       if not effective:
           raise HTTPException(status_code=404, detail="Template not found")

       return TemplateDetailResponse(
           entity_key=effective.get("entity_key", entity_key),
           label=effective.get("label", ""),
           description=effective.get("description"),
           wikitext=effective.get("wikitext"),
           property_key=effective.get("property_key"),
           change_status=effective.get("_change_status"),
           deleted=effective.get("_deleted", False),
       )
   ```

Follow the exact pattern from `get_property` (lines 310-342) - same decorator order, same parameter types, same draft overlay application flow.
  </action>
  <verify>
Run from project root:
```bash
cd backend && python -c "
from app.routers.entities_v2 import get_subobject, get_template
print('Endpoints exist')
"
```

Then start the server and verify endpoints respond:
```bash
curl -s http://localhost:8000/api/v2/subobjects/test | head -1  # Should return 404 (not 500)
curl -s http://localhost:8000/api/v2/templates/test | head -1   # Should return 404 (not 500)
```
  </verify>
  <done>
GET /api/v2/subobjects/{entity_key} returns subobject detail (or 404 if not found).
GET /api/v2/templates/{entity_key} returns template detail (or 404 if not found).
  </done>
</task>

</tasks>

<verification>
1. Backend imports work: `cd backend && python -c "from app.schemas.entity_v2 import SubobjectDetailResponse, TemplateDetailResponse"`
2. Endpoints registered: Check FastAPI docs at http://localhost:8000/docs show the new endpoints
3. 404 behavior: `curl http://localhost:8000/api/v2/subobjects/nonexistent` returns `{"detail":"Subobject not found"}`
4. If test data exists: `curl http://localhost:8000/api/v2/subobjects/{known_key}` returns full subobject detail
</verification>

<success_criteria>
1. SubobjectDetailResponse and TemplateDetailResponse schemas defined in entity_v2.py
2. GET /api/v2/subobjects/{entity_key} endpoint returns subobject detail with draft overlay
3. GET /api/v2/templates/{entity_key} endpoint returns template detail with draft overlay
4. Frontend can fetch subobject/template details without "Failed to load" error (assuming data exists)
</success_criteria>

<output>
After completion, create `.planning/phases/16-core-bug-fixes/16-01-SUMMARY.md`
</output>
