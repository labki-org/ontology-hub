---
phase: 16-core-bug-fixes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/hooks/useAutoSave.ts
  - frontend/src/api/draftApiV2.ts
autonomous: true

must_haves:
  truths:
    - "User can click Validate button in draft mode and see validation results"
    - "User can click Submit PR button in draft mode and see PR wizard"
    - "User sees validation state cleared when making draft changes"
  artifacts:
    - path: "frontend/src/hooks/useAutoSave.ts"
      provides: "Auto-save hook that clears validation on change"
      contains: "clearValidation"
    - path: "frontend/src/stores/draftStoreV2.ts"
      provides: "Validation state management"
      contains: "clearValidation"
  key_links:
    - from: "useAutoSave.onSuccess"
      to: "draftStoreV2.clearValidation"
      via: "zustand store action call"
      pattern: "clearValidation"
    - from: "DraftBannerV2 Validate button"
      to: "handleValidate in BrowsePage"
      via: "onValidate prop"
      pattern: "onValidate.*handleValidate"
---

<objective>
Wire auto-validation clearing and verify draft workflow buttons work.

Purpose: DRAFT-01, DRAFT-02, and DRAFT-03 require that the validation workflow functions correctly. Research shows:
- Validate and Submit PR buttons ARE wired correctly in DraftBannerV2 and FloatingActionBar
- PRWizard only renders when validationReport is non-null (by design - must validate first)
- Auto-validation clearing is NOT implemented - useAutoSave doesn't clear stale validation when changes are made

Output: Draft changes automatically clear stale validation state, prompting user to re-validate. Validate and Submit PR buttons work correctly.
</objective>

<execution_context>
@/home/daharoni/.claude/get-shit-done/workflows/execute-plan.md
@/home/daharoni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-core-bug-fixes/16-RESEARCH.md

# Files to modify
@frontend/src/hooks/useAutoSave.ts
@frontend/src/stores/draftStoreV2.ts
@frontend/src/pages/BrowsePage.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add validation clearing to useAutoSave hook</name>
  <files>frontend/src/hooks/useAutoSave.ts</files>
  <action>
Modify `frontend/src/hooks/useAutoSave.ts` to clear validation state when changes are saved:

1. Add import for the draft store at the top:
   ```typescript
   import { useDraftStoreV2 } from '@/stores/draftStoreV2'
   ```

2. In the mutation's `onSuccess` callback (around line 29-32), add clearValidation call:
   ```typescript
   onSuccess: () => {
     // Invalidate entity queries to refresh with new draft overlay
     queryClient.invalidateQueries({ queryKey: ['v2', entityType, entityKey] })
     // Clear stale validation - draft has changed since last validation
     useDraftStoreV2.getState().clearValidation()
     // Also invalidate draft changes list to show updated change count
     queryClient.invalidateQueries({ queryKey: ['v2', 'draft-changes'] })
     onSuccess?.()
   },
   ```

This ensures that:
- When user edits an entity in draft mode, any previous validation results are cleared
- User sees that validation is stale and needs to re-validate
- The change count in the UI updates

Note: We use `useDraftStoreV2.getState()` instead of the hook because we're inside a callback, not a React component.
  </action>
  <verify>
Verify the import compiles:
```bash
cd frontend && npx tsc --noEmit src/hooks/useAutoSave.ts
```
  </verify>
  <done>useAutoSave hook clears validation state after successful change save.</done>
</task>

<task type="auto">
  <name>Task 2: Add draft-changes invalidation to draft API mutations</name>
  <files>frontend/src/api/draftApiV2.ts</files>
  <action>
Update `frontend/src/api/draftApiV2.ts` to also clear validation when validation completes:

1. In `useValidateDraft` mutation (around line 135-145), the `onSuccess` handler already invalidates draft queries. This is correct - validation updates the draft status.

2. Import the draft store:
   ```typescript
   import { useDraftStoreV2 } from '@/stores/draftStoreV2'
   ```

3. Add a new mutation hook for adding draft changes (if one doesn't exist) or verify the existing flow. Looking at the codebase, `addDraftChange` is imported from `@/api/drafts.ts` (v1 API) by useAutoSave.

   For consistency, ensure the v2 draft workflow also clears validation. The main hook already works via useAutoSave, but if there are direct mutation calls, they should also clear validation.

   Actually, after review: The useAutoSave hook is the primary way changes are made in v2, and Task 1 already adds clearValidation there. No additional changes needed to draftApiV2.ts for now.

   Instead, verify the validation flow works:
   - User makes changes -> useAutoSave saves -> clearValidation called -> validationReport is null
   - User clicks Validate -> handleValidate called -> setValidationReport(report)
   - User clicks Submit PR -> PRWizard renders (because validationReport is now non-null)

   This is the correct flow. The only missing piece was clearValidation on change (Task 1).

   **UPDATE**: Skip this task if no draftApiV2.ts changes needed. The validation flow is:
   1. Changes saved via useAutoSave (uses v1 `addDraftChange` endpoint)
   2. Validation via v2 `validateDraft` endpoint
   3. Submission via v2 `submitDraft` endpoint

   The clearValidation in useAutoSave (Task 1) is sufficient.
  </action>
  <verify>
No code changes needed for this task - verification only.

Test the flow manually:
1. Navigate to browse page with draft_token
2. Make a change to an entity
3. Observe that validation state clears (validationReport becomes null)
4. Click Validate button
5. Observe validation results appear
6. Click Submit PR button
7. Observe PR wizard opens

Or verify via console:
```javascript
// In browser devtools while on /browse?draft_token=xxx
console.log(window.__DRAFT_STORE__)  // Check if validation clears after change
```
  </verify>
  <done>Draft workflow buttons (Validate, Submit PR) work correctly. Validation state clears when changes are made.</done>
</task>

<task type="auto">
  <name>Task 3: Verify module and bundle endpoints work</name>
  <files></files>
  <action>
ENTITY-03 and ENTITY-04 research indicates the endpoints exist:
- `GET /api/v2/modules/{entity_key}` exists (line 600 in entities_v2.py)
- `GET /api/v2/bundles/{entity_key}` exists (line 787 in entities_v2.py)

Verify these endpoints work correctly:

1. Test with curl against running backend:
   ```bash
   # Test module endpoint (use a known module key from the database)
   curl -s http://localhost:8000/api/v2/modules/core | jq .

   # Test bundle endpoint (use a known bundle key)
   curl -s http://localhost:8000/api/v2/bundles/minimal | jq .
   ```

2. If endpoints return correct data, ENTITY-03 and ENTITY-04 are already working.

3. If endpoints fail:
   - Check the specific error message
   - Common issues: type mismatch between Pydantic schema and database model
   - Fix by aligning ModuleDetailResponse/BundleDetailResponse with actual model fields

4. Test in frontend:
   - Navigate to /browse
   - Click on a module in the sidebar
   - Verify detail panel shows module info without "Failed to load" error
   - Repeat for bundles

If everything works: No code changes needed. Document in summary that ENTITY-03/ENTITY-04 were already working.

If issues found: Document specific fix needed and apply it.
  </action>
  <verify>
```bash
# Backend health check for module endpoint
curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/api/v2/modules/core
# Should return 200 (if data exists) or 404 (if no data) - NOT 500

# Backend health check for bundle endpoint
curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/api/v2/bundles/minimal
# Should return 200 (if data exists) or 404 (if no data) - NOT 500
```
  </verify>
  <done>Module and bundle detail endpoints return correct data. Frontend can display module/bundle details without error.</done>
</task>

</tasks>

<verification>
1. Auto-save clears validation: Make a change in draft mode, observe validationReport becomes null
2. Validate button works: Click Validate, observe validation results appear
3. Submit PR button works: After validation, click Submit PR, observe PRWizard modal opens
4. Module detail works: Click module in sidebar, see details panel (not "Failed to load")
5. Bundle detail works: Click bundle in sidebar, see details panel (not "Failed to load")
</verification>

<success_criteria>
1. DRAFT-01: User can click Validate button and see validation results
2. DRAFT-02: User can click Submit PR button and PRWizard opens (after validation)
3. DRAFT-03: Validation state clears when user makes draft changes
4. ENTITY-03: User can view module details without error
5. ENTITY-04: User can view bundle details without error
</success_criteria>

<output>
After completion, create `.planning/phases/16-core-bug-fixes/16-02-SUMMARY.md`
</output>
