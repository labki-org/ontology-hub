---
phase: 16-core-bug-fixes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/hooks/useAutoSave.ts
autonomous: true

must_haves:
  truths:
    - "User can click Validate button in draft mode and see validation results"
    - "User can click Submit PR button in draft mode and see PR wizard"
    - "User sees validation state cleared when making draft changes"
    - "User can view module details without error"
    - "User can view bundle details without error"
  artifacts:
    - path: "frontend/src/hooks/useAutoSave.ts"
      provides: "Auto-save hook that clears validation on change"
      contains: "clearValidation"
  key_links:
    - from: "useAutoSave.onSuccess"
      to: "draftStoreV2.clearValidation"
      via: "zustand store action call"
      pattern: "clearValidation"
---

<objective>
Wire auto-validation clearing and verify draft workflow buttons work.

Purpose: DRAFT-01, DRAFT-02, and DRAFT-03 require that the validation workflow functions correctly. Research shows:
- Validate and Submit PR buttons ARE wired correctly in DraftBannerV2 and FloatingActionBar
- PRWizard only renders when validationReport is non-null (by design - must validate first)
- Auto-validation clearing is NOT implemented - useAutoSave doesn't clear stale validation when changes are made

Output: Draft changes automatically clear stale validation state, prompting user to re-validate. Validate and Submit PR buttons work correctly.
</objective>

<execution_context>
@/home/daharoni/.claude/get-shit-done/workflows/execute-plan.md
@/home/daharoni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-core-bug-fixes/16-RESEARCH.md

# Files to modify
@frontend/src/hooks/useAutoSave.ts
@frontend/src/stores/draftStoreV2.ts
@frontend/src/pages/BrowsePage.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add validation clearing to useAutoSave hook</name>
  <files>frontend/src/hooks/useAutoSave.ts</files>
  <action>
Modify `frontend/src/hooks/useAutoSave.ts` to clear validation state when changes are saved:

1. Add import for the draft store at the top:
   ```typescript
   import { useDraftStoreV2 } from '@/stores/draftStoreV2'
   ```

2. In the mutation's `onSuccess` callback (around line 29-32), add clearValidation call:
   ```typescript
   onSuccess: () => {
     // Invalidate entity queries to refresh with new draft overlay
     queryClient.invalidateQueries({ queryKey: ['v2', entityType, entityKey] })
     // Clear stale validation - draft has changed since last validation
     useDraftStoreV2.getState().clearValidation()
     // Also invalidate draft changes list to show updated change count
     queryClient.invalidateQueries({ queryKey: ['v2', 'draft-changes'] })
     onSuccess?.()
   },
   ```

This ensures that:
- When user edits an entity in draft mode, any previous validation results are cleared
- User sees that validation is stale and needs to re-validate
- The change count in the UI updates

Note: We use `useDraftStoreV2.getState()` instead of the hook because we're inside a callback, not a React component.
  </action>
  <verify>
Verify the import compiles:
```bash
cd frontend && npx tsc --noEmit src/hooks/useAutoSave.ts
```
  </verify>
  <done>useAutoSave hook clears validation state after successful change save.</done>
</task>

<task type="auto">
  <name>Task 2: Verify module and bundle endpoints work (ENTITY-03, ENTITY-04)</name>
  <files>backend/app/routers/entities_v2.py</files>
  <action>
Research confirms module and bundle detail endpoints already exist:
- `GET /api/v2/modules/{entity_key}` (line 600 in entities_v2.py)
- `GET /api/v2/bundles/{entity_key}` (line 787 in entities_v2.py)

**Verification steps:**

1. Start the backend if not running:
   ```bash
   cd backend && uvicorn app.main:app --reload
   ```

2. Test endpoints with curl:
   ```bash
   # Test module endpoint - should return 200 or 404, NOT 500
   curl -s -w "\nHTTP %{http_code}\n" http://localhost:8000/api/v2/modules/core

   # Test bundle endpoint - should return 200 or 404, NOT 500
   curl -s -w "\nHTTP %{http_code}\n" http://localhost:8000/api/v2/bundles/minimal
   ```

3. Test in frontend:
   - Navigate to /browse
   - Click on a module in the sidebar
   - Verify detail panel shows module info without "Failed to load" error
   - Click on a bundle in the sidebar
   - Verify detail panel shows bundle info without "Failed to load" error

**If endpoints work:** Document in summary that ENTITY-03/ENTITY-04 were pre-satisfied (no bugs to fix).

**If endpoints fail with 500 error:**
- Check error message in backend logs
- Common fix: align response schema with model fields
- Apply fix to `ModuleDetailResponse` or `BundleDetailResponse` in `schemas/entity_v2.py`
  </action>
  <verify>
```bash
# Verify endpoints don't return 500 (internal error)
MODULE_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/api/v2/modules/core)
BUNDLE_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/api/v2/bundles/minimal)

# 200 = data found, 404 = no data (both OK), 500 = bug (NOT OK)
if [[ "$MODULE_STATUS" != "500" && "$BUNDLE_STATUS" != "500" ]]; then
  echo "PASS: Module status=$MODULE_STATUS, Bundle status=$BUNDLE_STATUS"
else
  echo "FAIL: Module status=$MODULE_STATUS, Bundle status=$BUNDLE_STATUS"
fi
```
  </verify>
  <done>Module and bundle endpoints verified working. ENTITY-03 and ENTITY-04 pre-satisfied (no implementation needed).</done>
</task>

<task type="auto">
  <name>Task 3: Verify draft workflow (DRAFT-01, DRAFT-02)</name>
  <files></files>
  <action>
Research confirms Validate and Submit PR buttons are correctly wired:
- `DraftBannerV2.tsx` shows Validate button when `isDraft` (status === 'DRAFT')
- `FloatingActionBar.tsx` also has Validate button
- Button calls `handleValidate` in `BrowsePage.tsx`
- PRWizard renders when `validationReport` is non-null

**Verification steps:**

1. Start frontend and backend if not running

2. Create or access an existing draft:
   - Navigate to /browse?draft_token={valid_token}
   - Or create a new draft via the UI

3. Test Validate button (DRAFT-01):
   - Verify "Validate" button is visible in draft banner
   - Click Validate button
   - Verify validation results appear (success or errors listed)

4. Test Submit PR button (DRAFT-02):
   - After validation succeeds, verify "Submit PR" button is visible
   - Click Submit PR button
   - Verify PRWizard modal opens

**If buttons don't work:** Check browser console for errors and fix.

**If buttons work:** Document in summary that DRAFT-01/DRAFT-02 were pre-satisfied.
  </action>
  <verify>
Manual verification in browser:
1. Navigate to draft page
2. Validate button visible and clickable → DRAFT-01 passes
3. After validation, Submit PR button visible and clickable → DRAFT-02 passes
  </verify>
  <done>Validate and Submit PR buttons work correctly. DRAFT-01 and DRAFT-02 pre-satisfied.</done>
</task>

</tasks>

<verification>
1. Auto-save clears validation: Make a change in draft mode, observe validationReport becomes null
2. Validate button works: Click Validate, observe validation results appear
3. Submit PR button works: After validation, click Submit PR, observe PRWizard modal opens
4. Module detail works: Click module in sidebar, see details panel (not "Failed to load")
5. Bundle detail works: Click bundle in sidebar, see details panel (not "Failed to load")
</verification>

<success_criteria>
1. DRAFT-01: User can click Validate button and see validation results
2. DRAFT-02: User can click Submit PR button and PRWizard opens (after validation)
3. DRAFT-03: Validation state clears when user makes draft changes
4. ENTITY-03: User can view module details without error
5. ENTITY-04: User can view bundle details without error
</success_criteria>

<output>
After completion, create `.planning/phases/16-core-bug-fixes/16-02-SUMMARY.md`
</output>
