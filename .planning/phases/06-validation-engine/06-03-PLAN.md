---
phase: 06-validation-engine
plan: 03
type: execute
wave: 2
depends_on: ["06-01", "06-02"]
files_modified:
  - frontend/src/api/types.ts
  - frontend/src/components/draft/ValidationSummary.tsx
  - frontend/src/components/draft/ValidationBadge.tsx
  - frontend/src/components/draft/DraftDiffViewer.tsx
  - frontend/src/pages/DraftPage.tsx
autonomous: true

must_haves:
  truths:
    - "User sees validation summary card on draft page"
    - "User sees error count with red indicator"
    - "User sees warning count with yellow indicator"
    - "User sees suggested semver badge (major/minor/patch)"
    - "User sees validation badges inline next to changed entities"
    - "User can expand validation messages to see details"
    - "Validation errors display with clear severity colors"
  artifacts:
    - path: "frontend/src/api/types.ts"
      provides: "ValidationResult and DraftValidationReport TypeScript types"
      contains: "ValidationResult"
    - path: "frontend/src/components/draft/ValidationSummary.tsx"
      provides: "Summary card showing error/warning counts and semver suggestion"
      exports: ["ValidationSummary"]
    - path: "frontend/src/components/draft/ValidationBadge.tsx"
      provides: "Inline badge for individual validation findings"
      exports: ["ValidationBadge"]
    - path: "frontend/src/pages/DraftPage.tsx"
      provides: "Draft page with validation summary integrated"
      contains: "ValidationSummary"
  key_links:
    - from: "frontend/src/pages/DraftPage.tsx"
      to: "frontend/src/components/draft/ValidationSummary.tsx"
      via: "import and render"
      pattern: "import.*ValidationSummary.*from"
    - from: "frontend/src/components/draft/DraftDiffViewer.tsx"
      to: "frontend/src/components/draft/ValidationBadge.tsx"
      via: "import and render per entity"
      pattern: "import.*ValidationBadge.*from"
---

<objective>
Display validation feedback inline in the draft review UI with clear severity indicators.

Purpose: Enable wiki admins to immediately understand validation errors, breaking change warnings, and semver implications when reviewing their draft, without needing to submit to discover issues.

Output: ValidationSummary component showing overall status, ValidationBadge components for inline feedback, integrated into DraftPage with proper data flow from API.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-validation-engine/06-RESEARCH.md

# Prior plan summaries (for backend validation types)
@.planning/phases/06-validation-engine/06-01-SUMMARY.md
@.planning/phases/06-validation-engine/06-02-SUMMARY.md

# Existing frontend patterns
@frontend/src/pages/DraftPage.tsx
@frontend/src/components/draft/DraftDiffViewer.tsx
@frontend/src/api/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add validation types and update DraftPublic</name>
  <files>
    frontend/src/api/types.ts
  </files>
  <action>
Add TypeScript types for validation results and update DraftPublic to include validation_results.

Add to `frontend/src/api/types.ts`:

```typescript
// Validation types (matches backend schemas/validation.py)

export type ValidationSeverity = 'error' | 'warning' | 'info'
export type SemverSuggestion = 'major' | 'minor' | 'patch'

export interface ValidationResult {
  entity_type: 'category' | 'property' | 'subobject' | 'module' | 'profile'
  entity_id: string
  field: string | null
  code: string  // e.g., "MISSING_PARENT", "DATATYPE_CHANGED"
  message: string
  severity: ValidationSeverity
  suggested_semver: SemverSuggestion | null
  old_value: string | null
  new_value: string | null
}

export interface DraftValidationReport {
  is_valid: boolean
  errors: ValidationResult[]
  warnings: ValidationResult[]
  info: ValidationResult[]
  suggested_semver: SemverSuggestion
  semver_reasons: string[]
}
```

Update `DraftPublic` interface to include validation_results:
```typescript
export interface DraftPublic {
  id: string
  status: DraftStatus
  payload: DraftPayload
  source_wiki: string | null
  base_commit_sha: string | null
  diff_preview: VersionDiffResponse | null
  validation_results: DraftValidationReport | null  // NEW
  expires_at: string
  created_at: string
}
```

Update `DraftCreateResponse` to include validation_results:
```typescript
export interface DraftCreateResponse {
  capability_url: string
  expires_at: string
  diff_preview: VersionDiffResponse | null
  validation_results: DraftValidationReport | null  // NEW
  validation_warnings: ValidationError[]  // Keep for backward compat
}
```
  </action>
  <verify>
    cd /home/daharoni/dev/ontology-hub/frontend && npx tsc --noEmit 2>&1 | head -20
  </verify>
  <done>ValidationResult and DraftValidationReport types defined. DraftPublic includes validation_results field. TypeScript compiles without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Create ValidationSummary and ValidationBadge components</name>
  <files>
    frontend/src/components/draft/ValidationSummary.tsx
    frontend/src/components/draft/ValidationBadge.tsx
  </files>
  <action>
Create validation display components following existing shadcn/ui patterns.

1. Create `frontend/src/components/draft/ValidationSummary.tsx`:
```tsx
import { AlertCircle, AlertTriangle, CheckCircle, Info, ChevronDown, ChevronUp } from 'lucide-react'
import { useState } from 'react'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import { Button } from '@/components/ui/button'
import { Collapsible, CollapsibleContent, CollapsibleTrigger } from '@/components/ui/collapsible'
import type { DraftValidationReport, ValidationResult } from '@/api/types'

interface ValidationSummaryProps {
  report: DraftValidationReport
}

const semverColors: Record<string, string> = {
  major: 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200',
  minor: 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200',
  patch: 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200',
}

function ValidationResultItem({ result }: { result: ValidationResult }) {
  return (
    <li className="text-sm">
      <span className="font-mono text-xs bg-muted px-1 rounded">{result.entity_id}</span>
      {result.field && <span className="text-muted-foreground">.{result.field}</span>}
      <span className="ml-2">{result.message}</span>
      {result.old_value && result.new_value && (
        <span className="ml-2 text-xs text-muted-foreground">
          ({result.old_value} -&gt; {result.new_value})
        </span>
      )}
    </li>
  )
}

function ValidationSection({
  title,
  icon: Icon,
  iconClassName,
  items,
  defaultOpen = false,
}: {
  title: string
  icon: typeof AlertCircle
  iconClassName: string
  items: ValidationResult[]
  defaultOpen?: boolean
}) {
  const [isOpen, setIsOpen] = useState(defaultOpen)

  if (items.length === 0) return null

  return (
    <Collapsible open={isOpen} onOpenChange={setIsOpen}>
      <CollapsibleTrigger asChild>
        <Button variant="ghost" className="w-full justify-between p-2 h-auto">
          <div className="flex items-center gap-2">
            <Icon className={`h-4 w-4 ${iconClassName}`} />
            <span className="font-medium">{title}</span>
            <Badge variant="secondary" className="ml-1">
              {items.length}
            </Badge>
          </div>
          {isOpen ? (
            <ChevronUp className="h-4 w-4" />
          ) : (
            <ChevronDown className="h-4 w-4" />
          )}
        </Button>
      </CollapsibleTrigger>
      <CollapsibleContent className="px-2 pb-2">
        <ul className="space-y-1 ml-6 list-disc">
          {items.map((item, i) => (
            <ValidationResultItem key={`${item.entity_id}-${item.code}-${i}`} result={item} />
          ))}
        </ul>
      </CollapsibleContent>
    </Collapsible>
  )
}

export function ValidationSummary({ report }: ValidationSummaryProps) {
  const StatusIcon = report.is_valid ? CheckCircle : AlertCircle
  const statusColor = report.is_valid ? 'text-green-600' : 'text-red-600'
  const statusText = report.is_valid ? 'Valid' : 'Has Errors'

  return (
    <Card>
      <CardHeader className="pb-2">
        <CardTitle className="flex items-center justify-between text-lg">
          <div className="flex items-center gap-2">
            <StatusIcon className={`h-5 w-5 ${statusColor}`} />
            <span>Validation: {statusText}</span>
          </div>
          <Badge className={semverColors[report.suggested_semver]}>
            Suggested: {report.suggested_semver.toUpperCase()}
          </Badge>
        </CardTitle>
      </CardHeader>
      <CardContent className="space-y-2">
        <ValidationSection
          title="Errors"
          icon={AlertCircle}
          iconClassName="text-red-600"
          items={report.errors}
          defaultOpen={report.errors.length > 0}
        />

        <ValidationSection
          title="Warnings"
          icon={AlertTriangle}
          iconClassName="text-yellow-600"
          items={report.warnings}
          defaultOpen={report.warnings.length > 0 && report.errors.length === 0}
        />

        <ValidationSection
          title="Info"
          icon={Info}
          iconClassName="text-blue-600"
          items={report.info}
        />

        {report.semver_reasons.length > 0 && (
          <div className="text-sm text-muted-foreground border-t pt-3 mt-3">
            <span className="font-medium">Semver reasoning:</span>
            <ul className="ml-4 mt-1 list-disc">
              {report.semver_reasons.map((reason, i) => (
                <li key={i}>{reason}</li>
              ))}
            </ul>
          </div>
        )}
      </CardContent>
    </Card>
  )
}
```

2. Create `frontend/src/components/draft/ValidationBadge.tsx`:
```tsx
import { AlertTriangle, AlertCircle, Info } from 'lucide-react'
import { Badge } from '@/components/ui/badge'
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from '@/components/ui/tooltip'
import type { ValidationResult } from '@/api/types'

interface ValidationBadgeProps {
  result: ValidationResult
  compact?: boolean
}

const severityConfig = {
  error: {
    icon: AlertCircle,
    className: 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200 border-red-200 dark:border-red-800',
  },
  warning: {
    icon: AlertTriangle,
    className: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200 border-yellow-200 dark:border-yellow-800',
  },
  info: {
    icon: Info,
    className: 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 border-blue-200 dark:border-blue-800',
  },
}

export function ValidationBadge({ result, compact = false }: ValidationBadgeProps) {
  const config = severityConfig[result.severity]
  const Icon = config.icon

  return (
    <TooltipProvider>
      <Tooltip>
        <TooltipTrigger asChild>
          <Badge
            variant="outline"
            className={`${config.className} gap-1 cursor-help text-xs`}
          >
            <Icon className="h-3 w-3" />
            {!compact && (
              <>
                {result.code}
                {result.suggested_semver && (
                  <span className="opacity-75">({result.suggested_semver})</span>
                )}
              </>
            )}
          </Badge>
        </TooltipTrigger>
        <TooltipContent side="top" className="max-w-xs">
          <p className="font-medium">{result.code}</p>
          <p className="text-sm">{result.message}</p>
          {result.old_value && result.new_value && (
            <p className="text-xs mt-1 opacity-75">
              {result.old_value} -&gt; {result.new_value}
            </p>
          )}
          {result.suggested_semver && (
            <p className="text-xs mt-1">
              Semver impact: <span className="font-medium">{result.suggested_semver}</span>
            </p>
          )}
        </TooltipContent>
      </Tooltip>
    </TooltipProvider>
  )
}

interface ValidationBadgesProps {
  results: ValidationResult[]
  compact?: boolean
}

export function ValidationBadges({ results, compact = false }: ValidationBadgesProps) {
  if (results.length === 0) return null

  return (
    <div className="flex flex-wrap gap-1">
      {results.map((result, i) => (
        <ValidationBadge
          key={`${result.entity_id}-${result.code}-${i}`}
          result={result}
          compact={compact}
        />
      ))}
    </div>
  )
}
```
  </action>
  <verify>
    cd /home/daharoni/dev/ontology-hub/frontend && npx tsc --noEmit 2>&1 | head -20
  </verify>
  <done>ValidationSummary shows error/warning/info counts with collapsible sections and semver badge. ValidationBadge shows individual findings with tooltips. Components follow shadcn/ui patterns.</done>
</task>

<task type="auto">
  <name>Task 3: Integrate validation display into DraftPage</name>
  <files>
    frontend/src/components/draft/DraftDiffViewer.tsx
    frontend/src/pages/DraftPage.tsx
  </files>
  <action>
Integrate ValidationSummary into DraftPage and add inline ValidationBadges to DraftDiffViewer.

1. Update `frontend/src/pages/DraftPage.tsx`:
- Import ValidationSummary
- Add validation_results to the draft data flow
- Render ValidationSummary after DraftHeader

```tsx
import { ValidationSummary } from '@/components/draft/ValidationSummary'

// In the DraftPage component, after DraftHeader:

{/* Validation summary - show when draft has validation results */}
{draft.validation_results && (
  <ValidationSummary report={draft.validation_results} />
)}
```

2. Update `frontend/src/components/draft/DraftDiffViewer.tsx`:
- Import ValidationBadges
- Add validation_results as an optional prop
- Create a helper to get validation results for a specific entity
- Render ValidationBadges next to each changed entity

Add prop to DraftDiffViewer:
```tsx
import { ValidationBadges } from '@/components/draft/ValidationBadge'
import type { DraftValidationReport, ValidationResult } from '@/api/types'

interface DraftDiffViewerProps {
  diff: VersionDiffResponse
  editable?: boolean
  validationResults?: DraftValidationReport | null
}
```

Add helper function:
```tsx
function getEntityValidationResults(
  validationResults: DraftValidationReport | null | undefined,
  entityType: string,
  entityId: string
): ValidationResult[] {
  if (!validationResults) return []

  const allResults = [
    ...validationResults.errors,
    ...validationResults.warnings,
    ...validationResults.info,
  ]

  return allResults.filter(
    (r) => r.entity_type === entityType && r.entity_id === entityId
  )
}
```

In the entity rendering section (where ChangeGroup maps over changes), add ValidationBadges:
```tsx
// After entity header/label, before the diff content
<ValidationBadges
  results={getEntityValidationResults(validationResults, entityType, change.entity_id)}
  compact
/>
```

3. Update DraftPage to pass validation_results to DraftDiffViewer:
```tsx
<DraftDiffViewer
  diff={diff}
  editable={isEditable}
  validationResults={draft.validation_results}
/>
```
  </action>
  <verify>
    cd /home/daharoni/dev/ontology-hub/frontend && npx tsc --noEmit 2>&1 | head -20
  </verify>
  <done>ValidationSummary renders on DraftPage showing overall validation status. ValidationBadges appear inline next to each entity in DraftDiffViewer. Data flows from draft.validation_results through to components.</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `cd frontend && npx tsc --noEmit`
2. Create draft with validation errors - should see red error section in ValidationSummary
3. Create draft with breaking changes - should see yellow warning section with semver reasoning
4. View entity in diff viewer with validation issue - should see inline badge
5. Hover over validation badge - should see tooltip with full message
6. Expand/collapse validation sections in summary
</verification>

<success_criteria>
- ValidationResult/DraftValidationReport types match backend schemas
- DraftPublic includes validation_results field
- ValidationSummary shows is_valid status with appropriate icon (check/alert)
- ValidationSummary shows error/warning/info counts with correct colors
- ValidationSummary shows suggested semver badge (major=red, minor=blue, patch=green)
- ValidationBadge shows severity icon and code with tooltip for details
- DraftDiffViewer shows inline badges next to entities with validation findings
- Collapsible sections allow focusing on relevant validation issues
- Semver reasoning displayed to explain classification
</success_criteria>

<output>
After completion, create `.planning/phases/06-validation-engine/06-03-SUMMARY.md`
</output>
