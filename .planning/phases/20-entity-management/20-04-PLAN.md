---
phase: 20-entity-management
plan: 04
type: execute
wave: 2
depends_on: ["20-01", "20-02"]
files_modified:
  - frontend/src/components/layout/SidebarV2.tsx
  - frontend/src/stores/draftStoreV2.ts
  - frontend/src/api/draftApiV2.ts
autonomous: true

must_haves:
  truths:
    - "User sees + New button next to each entity section header in draft mode"
    - "User does not see + New button when not in draft mode"
    - "Clicking + New opens the create modal for that entity type"
    - "After creation, new entity appears in sidebar"
  artifacts:
    - path: "frontend/src/components/layout/SidebarV2.tsx"
      provides: "Sidebar with + New buttons per entity section"
      contains: "+ New"
    - path: "frontend/src/stores/draftStoreV2.ts"
      provides: "Create modal state management"
      contains: "createModalOpen"
  key_links:
    - from: "frontend/src/components/layout/SidebarV2.tsx"
      to: "frontend/src/stores/draftStoreV2.ts"
      via: "useDraftStoreV2 hook"
      pattern: "useDraftStoreV2"
    - from: "frontend/src/components/layout/SidebarV2.tsx"
      to: "frontend/src/components/entity/modals/CreateEntityModal.tsx"
      via: "CreateEntityModal component"
      pattern: "CreateEntityModal"
---

<objective>
Integrate "+ New" buttons into the sidebar entity sections that appear only in draft mode. Wire up to open CreateEntityModal for the appropriate entity type. Add create modal state to draftStoreV2.

Purpose: Users can initiate entity creation from the sidebar where they browse entities.
Output: Updated SidebarV2.tsx with "+ New" buttons, draftStoreV2 with modal state
</objective>

<execution_context>
@/home/daharoni/.claude/get-shit-done/workflows/execute-plan.md
@/home/daharoni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/20-entity-management/20-CONTEXT.md
@frontend/src/components/layout/SidebarV2.tsx
@frontend/src/stores/draftStoreV2.ts
@frontend/src/components/entity/modals/CreateEntityModal.tsx
@frontend/src/components/entity/forms/CategoryForm.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add create modal state to draftStoreV2</name>
  <files>
    frontend/src/stores/draftStoreV2.ts
  </files>
  <action>
Extend draftStoreV2.ts with create modal state:

1. Add to state interface:
   ```typescript
   // Create modal state
   createModalOpen: boolean
   createModalEntityType: 'category' | 'property' | 'subobject' | 'template' | 'module' | 'bundle' | null
   ```

2. Add to initialState:
   ```typescript
   createModalOpen: false,
   createModalEntityType: null,
   ```

3. Add actions:
   ```typescript
   openCreateModal: (entityType: 'category' | 'property' | 'subobject' | 'template' | 'module' | 'bundle') => void
   closeCreateModal: () => void
   ```

4. Implement actions:
   ```typescript
   openCreateModal: (entityType) => {
     set((state) => {
       state.createModalOpen = true
       state.createModalEntityType = entityType
     })
   },

   closeCreateModal: () => {
     set((state) => {
       state.createModalOpen = false
       state.createModalEntityType = null
     })
   },
   ```

5. Update reset action to include new state
  </action>
  <verify>
    - draftStoreV2.ts has createModalOpen and createModalEntityType in state
    - openCreateModal and closeCreateModal actions exported
    - reset() clears modal state
  </verify>
  <done>
    - Create modal state managed in Zustand store
    - Actions available for opening/closing modal
    - State persists throughout draft session
  </done>
</task>

<task type="auto">
  <name>Task 2: Add "+ New" buttons to EntitySection in SidebarV2</name>
  <files>
    frontend/src/components/layout/SidebarV2.tsx
  </files>
  <action>
Update SidebarV2.tsx to add "+ New" buttons:

1. Import Plus icon and store actions:
   ```tsx
   import { Plus } from 'lucide-react'
   import { useDraftStoreV2 } from '@/stores/draftStoreV2'
   ```

2. Update EntitySectionProps to include:
   ```tsx
   isDraftMode: boolean
   onAddNew?: () => void
   ```

3. Update CollapsibleTrigger to include "+ New" button (only in draft mode):
   ```tsx
   <CollapsibleTrigger className="flex items-center w-full px-2 py-1.5 rounded hover:bg-sidebar-accent text-sm group">
     <ChevronRight className="h-4 w-4 transition-transform group-data-[state=open]:rotate-90" />
     <Icon className="h-4 w-4 ml-1 mr-2" />
     <span className="font-medium">{title}</span>
     <Badge variant="secondary" className="ml-auto">
       {filteredEntities.length}
     </Badge>
     {isDraftMode && onAddNew && (
       <button
         onClick={(e) => {
           e.stopPropagation() // Don't trigger collapsible
           onAddNew()
         }}
         className="ml-2 p-1 rounded hover:bg-sidebar-accent-foreground/10"
         aria-label={`Add new ${title.toLowerCase().slice(0, -1)}`}
       >
         <Plus className="h-4 w-4" />
       </button>
     )}
   </CollapsibleTrigger>
   ```

4. In SidebarV2 component, get modal actions and pass to EntitySection:
   ```tsx
   const openCreateModal = useDraftStoreV2((s) => s.openCreateModal)
   const isDraftMode = !!draftToken

   // Then for each EntitySection:
   <EntitySection
     title="Categories"
     icon={Boxes}
     entities={categories}
     isLoading={categoriesLoading}
     searchTerm={debouncedSearchTerm}
     entityType="category"
     isDraftMode={isDraftMode}
     onAddNew={() => openCreateModal('category')}
   />
   ```

5. Repeat for all 6 entity sections
  </action>
  <verify>
    - EntitySection receives isDraftMode and onAddNew props
    - "+ New" button only visible when isDraftMode is true
    - Button has e.stopPropagation() to not toggle collapsible
    - All 6 entity sections have onAddNew wired
  </verify>
  <done>
    - "+ New" buttons appear in sidebar header next to count badge
    - Only visible in draft mode
    - Each button opens create modal for its entity type
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire CreateEntityModal into SidebarV2 with form switching</name>
  <files>
    frontend/src/components/layout/SidebarV2.tsx
  </files>
  <action>
Add CreateEntityModal to SidebarV2 with dynamic form rendering:

1. Import modal and forms:
   ```tsx
   import { CreateEntityModal } from '@/components/entity/modals/CreateEntityModal'
   import { CategoryForm } from '@/components/entity/forms/CategoryForm'
   import { PropertyForm } from '@/components/entity/forms/PropertyForm'
   import { SubobjectForm } from '@/components/entity/forms/SubobjectForm'
   import { TemplateForm } from '@/components/entity/forms/TemplateForm'
   import { ModuleForm } from '@/components/entity/forms/ModuleForm'
   import { BundleForm } from '@/components/entity/forms/BundleForm'
   import { useCreateEntityChange } from '@/api/draftApiV2'
   ```

2. Get modal state:
   ```tsx
   const createModalOpen = useDraftStoreV2((s) => s.createModalOpen)
   const createModalEntityType = useDraftStoreV2((s) => s.createModalEntityType)
   const closeCreateModal = useDraftStoreV2((s) => s.closeCreateModal)
   ```

3. Setup mutation:
   ```tsx
   const createEntity = useCreateEntityChange(draftToken)
   ```

4. Create submit handler:
   ```tsx
   const handleCreateSubmit = async (data: Record<string, unknown>) => {
     if (!createModalEntityType) return

     try {
       await createEntity.mutateAsync({
         entityType: createModalEntityType,
         entityKey: data.id as string,
         data,
       })
       closeCreateModal()
       // Optionally select the new entity in graph
       setSelectedEntity(data.id as string, createModalEntityType)
     } catch (error) {
       // Error handling - form should show error
       console.error('Failed to create entity:', error)
     }
   }
   ```

5. Render modal at end of component:
   ```tsx
   <CreateEntityModal
     isOpen={createModalOpen}
     onClose={closeCreateModal}
     title={createModalEntityType ? `Create ${createModalEntityType.charAt(0).toUpperCase() + createModalEntityType.slice(1)}` : ''}
   >
     {createModalEntityType === 'category' && (
       <CategoryForm
         onSubmit={handleCreateSubmit}
         onCancel={closeCreateModal}
         isSubmitting={createEntity.isPending}
       />
     )}
     {createModalEntityType === 'property' && (
       <PropertyForm
         onSubmit={handleCreateSubmit}
         onCancel={closeCreateModal}
         isSubmitting={createEntity.isPending}
       />
     )}
     {/* ... repeat for all 6 types */}
   </CreateEntityModal>
   ```

6. After successful creation, new entity appears in sidebar via query invalidation (handled in mutation)
  </action>
  <verify>
    - CreateEntityModal rendered in SidebarV2
    - Form switches based on createModalEntityType
    - Submit calls useCreateEntityChange mutation
    - Modal closes and entity appears in sidebar after creation
  </verify>
  <done>
    - CreateEntityModal integrated with dynamic form switching
    - Entity creation flow complete: click "+ New" -> fill form -> submit -> entity in sidebar
    - New entity selected after creation
  </done>
</task>

</tasks>

<verification>
1. Run `cd /home/daharoni/dev/ontology-hub/frontend && npm run build` - should pass
2. Start dev server and verify in draft mode:
   - "+ New" buttons visible next to each entity section
   - Clicking opens appropriate form
   - Form validates on blur
   - Create button disabled until valid
3. Verify buttons NOT visible when not in draft mode
</verification>

<success_criteria>
- "+ New" buttons visible only in draft mode
- Each button opens CreateEntityModal with correct form
- Form submission creates entity via API
- New entity appears in sidebar after creation
- Modal closes after successful creation
</success_criteria>

<output>
After completion, create `.planning/phases/20-entity-management/20-04-SUMMARY.md`
</output>
