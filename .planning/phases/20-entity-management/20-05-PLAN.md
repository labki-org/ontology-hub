---
phase: 20-entity-management
plan: 05
type: execute
wave: 2
depends_on: ["20-01"]
files_modified:
  - frontend/src/components/entity/forms/EntityCombobox.tsx
  - frontend/src/components/entity/forms/RelationshipChips.tsx
  - frontend/src/components/entity/forms/CategoryForm.tsx
  - frontend/src/components/entity/forms/ModuleForm.tsx
  - frontend/src/components/entity/forms/BundleForm.tsx
autonomous: true

must_haves:
  truths:
    - "User can search for entities in autocomplete dropdown"
    - "User sees Create option when typing non-existent ID"
    - "User can remove relationships via X button on chips"
    - "Duplicate relationships are prevented"
  artifacts:
    - path: "frontend/src/components/entity/forms/EntityCombobox.tsx"
      provides: "Autocomplete combobox with create-if-not-exists"
      min_lines: 80
    - path: "frontend/src/components/entity/forms/RelationshipChips.tsx"
      provides: "Display selected relationships as removable chips"
      min_lines: 40
  key_links:
    - from: "frontend/src/components/entity/forms/EntityCombobox.tsx"
      to: "cmdk"
      via: "Command primitive for autocomplete"
      pattern: "Command"
    - from: "frontend/src/components/entity/forms/RelationshipChips.tsx"
      to: "@/components/ui/badge"
      via: "Badge for chip styling"
      pattern: "Badge"
---

<objective>
Create the EntityCombobox component for relationship management (parent categories, properties in subobjects, modules in bundles, etc.) with type-ahead search and "create if not exists" functionality. Add RelationshipChips for displaying selected relationships.

Purpose: Enable adding/removing relationships between entities with autocomplete and cascading create flow.
Output: EntityCombobox.tsx, RelationshipChips.tsx, updated forms
</objective>

<execution_context>
@/home/daharoni/.claude/get-shit-done/workflows/execute-plan.md
@/home/daharoni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/20-entity-management/20-CONTEXT.md
@.planning/phases/20-entity-management/20-RESEARCH.md
@frontend/src/components/ui/popover.tsx
@frontend/src/components/ui/badge.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RelationshipChips component</name>
  <files>
    frontend/src/components/entity/forms/RelationshipChips.tsx
  </files>
  <action>
Create RelationshipChips.tsx for displaying selected relationships:

1. Props:
   ```tsx
   interface RelationshipChipsProps {
     values: string[]
     onRemove: (value: string) => void
     disabled?: boolean
     getLabel?: (key: string) => string // Optional label resolver
   }
   ```

2. Render chips with X button:
   ```tsx
   export function RelationshipChips({
     values,
     onRemove,
     disabled,
     getLabel,
   }: RelationshipChipsProps) {
     if (values.length === 0) return null

     return (
       <div className="flex flex-wrap gap-2">
         {values.map((value) => (
           <Badge
             key={value}
             variant="secondary"
             className="flex items-center gap-1 pr-1"
           >
             <span>{getLabel ? getLabel(value) : value}</span>
             {!disabled && (
               <button
                 type="button"
                 onClick={() => onRemove(value)}
                 className="ml-1 h-4 w-4 rounded-full hover:bg-muted flex items-center justify-center"
                 aria-label={`Remove ${value}`}
               >
                 <X className="h-3 w-3" />
               </button>
             )}
           </Badge>
         ))}
       </div>
     )
   }
   ```

3. Import X from lucide-react
  </action>
  <verify>
    - RelationshipChips.tsx exports RelationshipChips component
    - X button removes relationship via onRemove callback
    - Disabled state hides remove buttons
    - Uses Badge component for chip styling
  </verify>
  <done>
    - Chips display selected relationships
    - X button removes relationship (per CONTEXT: not hover trash icon)
    - Clean visual consistent with existing UI
  </done>
</task>

<task type="auto">
  <name>Task 2: Create EntityCombobox with cmdk</name>
  <files>
    frontend/src/components/entity/forms/EntityCombobox.tsx
  </files>
  <action>
Create EntityCombobox.tsx using cmdk for autocomplete:

1. Install check: cmdk should already be installed from Plan 01

2. Props:
   ```tsx
   interface EntityComboboxProps {
     entityType: 'category' | 'property' | 'subobject' | 'template' | 'module' | 'bundle'
     availableEntities: Array<{ key: string; label: string }>
     selectedKeys: string[]
     onChange: (keys: string[]) => void
     onCreateNew?: (id: string) => void // Callback for cascading create
     placeholder?: string
     disabled?: boolean
   }
   ```

3. Implementation using cmdk Command primitive with Radix Popover:
   ```tsx
   import { Command, CommandInput, CommandList, CommandItem, CommandEmpty, CommandGroup } from 'cmdk'
   import { Popover, PopoverTrigger, PopoverContent } from '@/components/ui/popover'
   import { Button } from '@/components/ui/button'
   import { Plus, Check, ChevronsUpDown } from 'lucide-react'

   export function EntityCombobox({
     entityType,
     availableEntities,
     selectedKeys,
     onChange,
     onCreateNew,
     placeholder = 'Search...',
     disabled,
   }: EntityComboboxProps) {
     const [open, setOpen] = useState(false)
     const [inputValue, setInputValue] = useState('')

     // Filter out already selected
     const unselectedEntities = availableEntities.filter(
       (e) => !selectedKeys.includes(e.key)
     )

     // Filter by search
     const filteredEntities = unselectedEntities.filter(
       (e) =>
         e.key.toLowerCase().includes(inputValue.toLowerCase()) ||
         e.label.toLowerCase().includes(inputValue.toLowerCase())
     )

     // Check if exact match exists
     const exactMatch = availableEntities.find(
       (e) => e.key.toLowerCase() === inputValue.toLowerCase()
     )

     const handleSelect = (key: string) => {
       onChange([...selectedKeys, key])
       setInputValue('')
       setOpen(false)
     }

     const handleCreate = () => {
       if (onCreateNew && inputValue.trim()) {
         onCreateNew(inputValue.trim())
         setInputValue('')
         setOpen(false)
       }
     }

     return (
       <Popover open={open} onOpenChange={setOpen}>
         <PopoverTrigger asChild>
           <Button
             variant="outline"
             role="combobox"
             aria-expanded={open}
             className="w-full justify-between"
             disabled={disabled}
           >
             {placeholder}
             <ChevronsUpDown className="ml-2 h-4 w-4 shrink-0 opacity-50" />
           </Button>
         </PopoverTrigger>
         <PopoverContent className="w-full p-0">
           <Command>
             <CommandInput
               placeholder={`Search ${entityType}...`}
               value={inputValue}
               onValueChange={setInputValue}
             />
             <CommandList>
               <CommandEmpty>
                 {inputValue && !exactMatch ? (
                   <button
                     className="flex items-center gap-2 w-full px-2 py-1.5 text-sm hover:bg-accent"
                     onClick={handleCreate}
                   >
                     <Plus className="h-4 w-4" />
                     Create "{inputValue}"
                   </button>
                 ) : (
                   <span className="text-muted-foreground">No results found.</span>
                 )}
               </CommandEmpty>
               <CommandGroup>
                 {filteredEntities.map((entity) => (
                   <CommandItem
                     key={entity.key}
                     value={entity.key}
                     onSelect={handleSelect}
                   >
                     <Check
                       className={cn(
                         'mr-2 h-4 w-4',
                         selectedKeys.includes(entity.key)
                           ? 'opacity-100'
                           : 'opacity-0'
                       )}
                     />
                     {entity.label}
                     <span className="ml-2 text-muted-foreground text-xs">
                       ({entity.key})
                     </span>
                   </CommandItem>
                 ))}
               </CommandGroup>
             </CommandList>
           </Command>
         </PopoverContent>
       </Popover>
     )
   }
   ```

4. Key behaviors per CONTEXT/RESEARCH:
   - Filters by both key (ID) and label
   - Shows "Create" option only when input doesn't match existing
   - Prevents duplicate selection
   - Keyboard navigation via cmdk
  </action>
  <verify>
    - EntityCombobox.tsx uses cmdk Command primitives
    - Filters out already-selected entities
    - Shows "Create" option for non-existent input
    - onCreateNew callback invoked when Create clicked
  </verify>
  <done>
    - Autocomplete with keyboard navigation
    - Create-if-not-exists flow ready
    - Duplicate prevention via filtering
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate EntityCombobox into forms</name>
  <files>
    frontend/src/components/entity/forms/CategoryForm.tsx
    frontend/src/components/entity/forms/ModuleForm.tsx
    frontend/src/components/entity/forms/BundleForm.tsx
  </files>
  <action>
Update forms to use EntityCombobox and RelationshipChips:

**CategoryForm.tsx:**
1. Add imports and props:
   ```tsx
   import { EntityCombobox } from './EntityCombobox'
   import { RelationshipChips } from './RelationshipChips'
   import { useCategories } from '@/api/entitiesV2'

   interface CategoryFormProps {
     onSubmit: (data: CategoryFormData) => void
     onCancel: () => void
     onCreateRelatedEntity?: (type: string, id: string) => void
     isSubmitting?: boolean
     draftId?: string
   }
   ```

2. Fetch available categories for parent selection:
   ```tsx
   const { data: categoriesData } = useCategories(undefined, undefined, draftId)
   const availableCategories = (categoriesData?.items || []).map(c => ({
     key: c.entity_key,
     label: c.label,
   }))
   ```

3. Replace parents placeholder with:
   ```tsx
   <div className="space-y-2">
     <Label>Parent Categories</Label>
     <EntityCombobox
       entityType="category"
       availableEntities={availableCategories}
       selectedKeys={form.watch('parents') || []}
       onChange={(keys) => form.setValue('parents', keys)}
       onCreateNew={(id) => onCreateRelatedEntity?.('category', id)}
       placeholder="Add parent category..."
     />
     <RelationshipChips
       values={form.watch('parents') || []}
       onRemove={(key) => {
         const current = form.getValues('parents') || []
         form.setValue('parents', current.filter(k => k !== key))
       }}
     />
   </div>
   ```

**ModuleForm.tsx:**
- Add combobox for categories, properties, subobjects, templates
- Use tabs or sections to organize different entity types
- Each with its own EntityCombobox

**BundleForm.tsx:**
- Add combobox for modules selection
- Modules is required so show validation error if empty on submit
  </action>
  <verify>
    - CategoryForm has parent categories combobox with chips
    - ModuleForm has entity selection for all 4 types
    - BundleForm has modules selection with requirement indicator
    - All forms pass onCreateRelatedEntity for cascading create
  </verify>
  <done>
    - Relationship management integrated into forms
    - Chips display selected relationships with X to remove
    - Combobox enables adding new relationships
  </done>
</task>

</tasks>

<verification>
1. Run `cd /home/daharoni/dev/ontology-hub/frontend && npm run build` - should pass
2. Test EntityCombobox filtering and selection
3. Test RelationshipChips removal
4. Verify "Create" option appears for non-existent IDs
</verification>

<success_criteria>
- EntityCombobox provides type-ahead search with keyboard navigation
- "Create" option appears when typing non-existent entity ID
- RelationshipChips display selected relationships with X remove button
- Forms integrate combobox for relationship management
- Duplicate selection prevented
</success_criteria>

<output>
After completion, create `.planning/phases/20-entity-management/20-05-SUMMARY.md`
</output>
