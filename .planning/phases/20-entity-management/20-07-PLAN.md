---
phase: 20-entity-management
plan: 07
type: execute
wave: 4
depends_on: ["20-04", "20-05", "20-06"]
files_modified:
  - frontend/src/components/entity/modals/NestedModalStack.tsx
  - frontend/src/stores/draftStoreV2.ts
  - frontend/src/components/layout/SidebarV2.tsx
autonomous: true

must_haves:
  truths:
    - "User can create non-existent entity from relationship autocomplete"
    - "Nested modal shows which entity is being created for context"
    - "After nested create, new entity appears in parent form's selection"
    - "User can cancel nested create without losing parent form state"
  artifacts:
    - path: "frontend/src/components/entity/modals/NestedModalStack.tsx"
      provides: "Handles cascading create flow with modal stacking"
      min_lines: 80
    - path: "frontend/src/stores/draftStoreV2.ts"
      provides: "Nested modal state management"
      contains: "nestedCreateModal"
  key_links:
    - from: "frontend/src/components/entity/modals/NestedModalStack.tsx"
      to: "frontend/src/components/entity/modals/CreateEntityModal.tsx"
      via: "Reuses CreateEntityModal for nested creation"
      pattern: "CreateEntityModal"
---

<objective>
Implement cascading create flow: when user types a non-existent entity ID in a relationship combobox and clicks "Create", open a nested modal for that entity, then return to the original form with the new entity selected.

Purpose: Users can create dependent entities inline without leaving their current form context.
Output: NestedModalStack.tsx, updated draftStoreV2 with nested state, integration in forms
</objective>

<execution_context>
@/home/daharoni/.claude/get-shit-done/workflows/execute-plan.md
@/home/daharoni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/20-entity-management/20-CONTEXT.md
@.planning/phases/20-entity-management/20-RESEARCH.md
@frontend/src/components/entity/modals/CreateEntityModal.tsx
@frontend/src/stores/draftStoreV2.ts
@frontend/src/components/entity/forms/EntityCombobox.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add nested modal state to draftStoreV2</name>
  <files>
    frontend/src/stores/draftStoreV2.ts
  </files>
  <action>
Extend draftStoreV2.ts with nested modal state:

1. Add to state interface:
   ```typescript
   // Nested create modal state (for cascading create flow)
   nestedCreateModal: {
     isOpen: boolean
     entityType: 'category' | 'property' | 'subobject' | 'template' | 'module' | 'bundle' | null
     prefilledId: string
     parentContext: {
       entityType: string
       fieldName: string
     } | null
   }
   ```

2. Add to initialState:
   ```typescript
   nestedCreateModal: {
     isOpen: false,
     entityType: null,
     prefilledId: '',
     parentContext: null,
   },
   ```

3. Add actions:
   ```typescript
   openNestedCreateModal: (params: {
     entityType: 'category' | 'property' | 'subobject' | 'template' | 'module' | 'bundle'
     prefilledId: string
     parentContext: { entityType: string; fieldName: string }
   }) => void

   closeNestedCreateModal: () => void

   // Callback for when nested entity is created
   onNestedEntityCreated: ((entityKey: string) => void) | null
   setOnNestedEntityCreated: (callback: ((entityKey: string) => void) | null) => void
   ```

4. Implement:
   ```typescript
   openNestedCreateModal: (params) => {
     set((state) => {
       state.nestedCreateModal.isOpen = true
       state.nestedCreateModal.entityType = params.entityType
       state.nestedCreateModal.prefilledId = params.prefilledId
       state.nestedCreateModal.parentContext = params.parentContext
     })
   },

   closeNestedCreateModal: () => {
     set((state) => {
       state.nestedCreateModal.isOpen = false
       state.nestedCreateModal.entityType = null
       state.nestedCreateModal.prefilledId = ''
       state.nestedCreateModal.parentContext = null
     })
   },

   onNestedEntityCreated: null,
   setOnNestedEntityCreated: (callback) => {
     set((state) => {
       state.onNestedEntityCreated = callback
     })
   },
   ```

5. Update reset() to clear nested state
  </action>
  <verify>
    - nestedCreateModal state includes isOpen, entityType, prefilledId, parentContext
    - Actions for open/close and callback management
    - reset() clears nested modal state
  </verify>
  <done>
    - Nested modal state managed in Zustand
    - Parent context preserved for breadcrumb display
    - Callback mechanism for notifying parent form
  </done>
</task>

<task type="auto">
  <name>Task 2: Create NestedModalStack component</name>
  <files>
    frontend/src/components/entity/modals/NestedModalStack.tsx
  </files>
  <action>
Create NestedModalStack.tsx to handle cascading create:

```tsx
import { useEffect } from 'react'
import { useDraftStoreV2 } from '@/stores/draftStoreV2'
import { useCreateEntityChange } from '@/api/draftApiV2'
import { CreateEntityModal } from './CreateEntityModal'
import { CategoryForm } from '../forms/CategoryForm'
import { PropertyForm } from '../forms/PropertyForm'
import { SubobjectForm } from '../forms/SubobjectForm'
import { TemplateForm } from '../forms/TemplateForm'
import { ModuleForm } from '../forms/ModuleForm'
import { BundleForm } from '../forms/BundleForm'

interface NestedModalStackProps {
  draftToken: string
}

/**
 * Handles the nested create modal for cascading entity creation.
 * When user clicks "Create [entity]" from a relationship combobox,
 * this modal opens on top of the primary create modal.
 *
 * After creation, the new entity key is passed back to the parent
 * form via the onNestedEntityCreated callback.
 */
export function NestedModalStack({ draftToken }: NestedModalStackProps) {
  const {
    nestedCreateModal,
    closeNestedCreateModal,
    onNestedEntityCreated,
    setOnNestedEntityCreated,
  } = useDraftStoreV2()

  const createEntity = useCreateEntityChange(draftToken)

  // Clean up callback on unmount
  useEffect(() => {
    return () => setOnNestedEntityCreated(null)
  }, [setOnNestedEntityCreated])

  const handleSubmit = async (data: Record<string, unknown>) => {
    if (!nestedCreateModal.entityType) return

    try {
      await createEntity.mutateAsync({
        entityType: nestedCreateModal.entityType,
        entityKey: data.id as string,
        data,
      })

      // Notify parent form about new entity
      if (onNestedEntityCreated) {
        onNestedEntityCreated(data.id as string)
      }

      closeNestedCreateModal()
    } catch (error) {
      console.error('Failed to create nested entity:', error)
    }
  }

  const { entityType, prefilledId, parentContext } = nestedCreateModal

  // Build title with context
  const title = entityType
    ? `Create ${entityType.charAt(0).toUpperCase() + entityType.slice(1)}`
    : ''

  const contextHint = parentContext
    ? `Creating ${entityType} for ${parentContext.entityType}'s ${parentContext.fieldName}`
    : ''

  // Initial data with prefilled ID
  const initialData = prefilledId ? { id: prefilledId } : undefined

  return (
    <CreateEntityModal
      isOpen={nestedCreateModal.isOpen}
      onClose={closeNestedCreateModal}
      title={title}
    >
      {/* Context breadcrumb */}
      {contextHint && (
        <p className="text-sm text-muted-foreground mb-4 italic">
          {contextHint}
        </p>
      )}

      {entityType === 'category' && (
        <CategoryForm
          onSubmit={handleSubmit}
          onCancel={closeNestedCreateModal}
          isSubmitting={createEntity.isPending}
          initialData={initialData}
          draftId={draftToken}
          // Don't allow nested-nested create (limit to 1 level)
        />
      )}
      {entityType === 'property' && (
        <PropertyForm
          onSubmit={handleSubmit}
          onCancel={closeNestedCreateModal}
          isSubmitting={createEntity.isPending}
          initialData={initialData}
        />
      )}
      {entityType === 'subobject' && (
        <SubobjectForm
          onSubmit={handleSubmit}
          onCancel={closeNestedCreateModal}
          isSubmitting={createEntity.isPending}
          initialData={initialData}
        />
      )}
      {entityType === 'template' && (
        <TemplateForm
          onSubmit={handleSubmit}
          onCancel={closeNestedCreateModal}
          isSubmitting={createEntity.isPending}
          initialData={initialData}
        />
      )}
      {entityType === 'module' && (
        <ModuleForm
          onSubmit={handleSubmit}
          onCancel={closeNestedCreateModal}
          isSubmitting={createEntity.isPending}
          initialData={initialData}
        />
      )}
      {entityType === 'bundle' && (
        <BundleForm
          onSubmit={handleSubmit}
          onCancel={closeNestedCreateModal}
          isSubmitting={createEntity.isPending}
          initialData={initialData}
        />
      )}
    </CreateEntityModal>
  )
}
```

Key points:
- Uses existing CreateEntityModal for consistent styling
- Shows context hint about what entity triggered the nested create
- Passes prefilledId to form's initialData
- Notifies parent form via callback when entity created
- Limits to 1 level of nesting (per RESEARCH anti-pattern)
  </action>
  <verify>
    - NestedModalStack uses nestedCreateModal state from store
    - Shows context hint about parent entity
    - Calls onNestedEntityCreated callback after creation
    - Prefills ID from autocomplete input
  </verify>
  <done>
    - Nested modal reuses CreateEntityModal
    - Context preserved and displayed
    - New entity key passed back to parent
    - Limited to 1 level of nesting
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire nested create into forms and SidebarV2</name>
  <files>
    frontend/src/components/layout/SidebarV2.tsx
    frontend/src/components/entity/forms/CategoryForm.tsx
  </files>
  <action>
**SidebarV2.tsx:**

1. Add NestedModalStack to render tree:
   ```tsx
   import { NestedModalStack } from '@/components/entity/modals/NestedModalStack'

   // In component, after CreateEntityModal:
   {draftToken && (
     <NestedModalStack draftToken={draftToken} />
   )}
   ```

**CategoryForm.tsx (and other forms with relationships):**

1. Update onCreateNew handler in EntityCombobox to use nested modal:
   ```tsx
   const openNestedCreateModal = useDraftStoreV2((s) => s.openNestedCreateModal)
   const setOnNestedEntityCreated = useDraftStoreV2((s) => s.setOnNestedEntityCreated)

   const handleCreateRelated = (entityType: string, id: string) => {
     // Set callback to add created entity to this form's selection
     setOnNestedEntityCreated((newKey: string) => {
       const current = form.getValues('parents') || []
       form.setValue('parents', [...current, newKey])
     })

     // Open nested modal
     openNestedCreateModal({
       entityType: entityType as any,
       prefilledId: id,
       parentContext: {
         entityType: 'category',
         fieldName: 'Parent Categories',
       },
     })
   }

   // Pass to EntityCombobox:
   <EntityCombobox
     entityType="category"
     availableEntities={availableCategories}
     selectedKeys={form.watch('parents') || []}
     onChange={(keys) => form.setValue('parents', keys)}
     onCreateNew={(id) => handleCreateRelated('category', id)}
     placeholder="Add parent category..."
   />
   ```

2. Apply same pattern to ModuleForm (for entity relationships) and BundleForm (for module relationships)

3. Forms created from nested modal should NOT allow further nesting (remove onCreateNew prop when in nested context)
  </action>
  <verify>
    - NestedModalStack rendered in SidebarV2
    - CategoryForm's EntityCombobox opens nested modal on "Create"
    - After nested create, new entity appears in parent form's chips
    - Nested forms don't allow further nesting
  </verify>
  <done>
    - Full cascading create flow working
    - User can create parent category from category form
    - New entity automatically selected in parent form
    - Single level nesting enforced
  </done>
</task>

</tasks>

<verification>
1. Run `cd /home/daharoni/dev/ontology-hub/frontend && npm run build` - should pass
2. Test cascading flow:
   - Open create category modal
   - In parents combobox, type non-existent ID
   - Click "Create" - nested modal opens with ID prefilled
   - Fill and submit - nested modal closes
   - Verify new category appears in parent form's chips
3. Cancel nested without losing parent state
</verification>

<success_criteria>
- Clicking "Create" in combobox opens nested modal
- Nested modal shows context hint (creating for which form/field)
- ID is prefilled from autocomplete input
- After creation, parent form has new entity selected
- Cancel doesn't affect parent form state
- Only 1 level of nesting allowed
</success_criteria>

<output>
After completion, create `.planning/phases/20-entity-management/20-07-SUMMARY.md`
</output>
