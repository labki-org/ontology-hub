---
phase: 20-entity-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/package.json
  - frontend/src/components/entity/forms/FormField.tsx
  - frontend/src/components/entity/forms/schemas.ts
  - frontend/src/api/draftApiV2.ts
autonomous: true

must_haves:
  truths:
    - "Form fields show required asterisk indicator"
    - "Validation errors appear below invalid fields"
    - "Save button disabled until form is valid"
  artifacts:
    - path: "frontend/src/components/entity/forms/FormField.tsx"
      provides: "Reusable form field wrapper with label, required indicator, error display"
      min_lines: 40
    - path: "frontend/src/components/entity/forms/schemas.ts"
      provides: "Zod schemas for all 6 entity types"
      exports: ["categorySchema", "propertySchema", "subobjectSchema", "templateSchema", "moduleSchema", "bundleSchema"]
    - path: "frontend/src/api/draftApiV2.ts"
      provides: "useCreateEntityChange mutation hook"
      contains: "useCreateEntityChange"
  key_links:
    - from: "frontend/src/components/entity/forms/FormField.tsx"
      to: "react-hook-form"
      via: "Controller component"
      pattern: "Controller"
    - from: "frontend/src/components/entity/forms/schemas.ts"
      to: "zod"
      via: "z.object schema definitions"
      pattern: "z\\.object"
---

<objective>
Create the foundational form infrastructure for entity creation: shared FormField component, Zod validation schemas for all 6 entity types, and API mutation hook for creating entity changes.

Purpose: All entity creation forms will share this foundation - consistent validation, error display, and API integration.
Output: FormField.tsx, schemas.ts, extended draftApiV2.ts
</objective>

<execution_context>
@/home/daharoni/.claude/get-shit-done/workflows/execute-plan.md
@/home/daharoni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/20-entity-management/20-CONTEXT.md
@.planning/phases/20-entity-management/20-RESEARCH.md
@frontend/src/components/entity/form/InlineEditField.tsx
@frontend/src/api/draftApiV2.ts
@backend/app/schemas/draft_change.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install cmdk and create FormField component</name>
  <files>
    frontend/package.json
    frontend/src/components/entity/forms/FormField.tsx
  </files>
  <action>
1. Install cmdk library:
   ```bash
   cd frontend && npm install cmdk
   ```

2. Create FormField.tsx - a reusable form field wrapper with:
   - Props: name, label, required?, control (from react-hook-form), render function
   - Uses Controller from react-hook-form
   - Shows label with red asterisk (*) for required fields (use aria-label="required" on asterisk)
   - Shows error message below field with role="alert" when fieldState.error exists
   - Passes data-invalid attribute to child for TailwindCSS styling
   - Example pattern from RESEARCH.md Pattern 2

3. Export as named export from the file
  </action>
  <verify>
    - `cd /home/daharoni/dev/ontology-hub/frontend && npm ls cmdk` shows cmdk installed
    - FormField.tsx exists and exports FormField component
    - FormField uses Controller from react-hook-form
    - Error display has role="alert"
  </verify>
  <done>
    - cmdk installed in package.json
    - FormField component renders label, required indicator, and error messages
    - Accessibility attributes (aria-label, role="alert") present
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Zod validation schemas for all entity types</name>
  <files>
    frontend/src/components/entity/forms/schemas.ts
  </files>
  <action>
Create schemas.ts with Zod schemas for all 6 entity types based on CONTEXT.md required fields:

1. **ID validation** (shared across all):
   - Required, non-empty
   - Regex: `/^[a-z0-9-]+$/` with message "ID must be lowercase letters, numbers, and hyphens"
   - NO async validation for uniqueness (handled at submit time by backend)

2. **categorySchema**:
   - id: z.string().min(1, "ID is required").regex(...)
   - label: z.string().min(1, "Label is required")
   - description: z.string().min(1, "Description is required")
   - parents: z.array(z.string()).optional() (relationship, added via combobox)

3. **propertySchema**:
   - id, label, description (same as category)
   - datatype: z.string().min(1, "Datatype is required")
   - cardinality: z.string().min(1, "Cardinality is required")

4. **subobjectSchema**:
   - id, label, description (same as category)
   - properties: z.array(z.string()).optional()

5. **templateSchema**:
   - id, label, description (same as category)
   - wikitext: z.string().min(1, "Wikitext is required")

6. **moduleSchema**:
   - id: required
   - version: z.string().min(1, "Version is required")
   - label, description: required
   - categories: z.array(z.string()).optional()
   - properties: z.array(z.string()).optional()
   - subobjects: z.array(z.string()).optional()
   - templates: z.array(z.string()).optional()
   - Use superRefine to validate "at least one of categories/properties/subobjects/templates"

7. **bundleSchema**:
   - id, version, label, description: required
   - modules: z.array(z.string()).min(1, "At least one module is required")

Export type aliases using z.infer<typeof schema> for each.
  </action>
  <verify>
    - schemas.ts exports all 6 schemas
    - Each schema has TypeScript type alias exported
    - `grep -q "z.object" frontend/src/components/entity/forms/schemas.ts`
    - Module schema has superRefine for at-least-one validation
  </verify>
  <done>
    - All 6 entity type schemas defined with appropriate validation rules
    - ID fields use kebab-case regex validation
    - TypeScript types inferred and exported
  </done>
</task>

<task type="auto">
  <name>Task 3: Add useCreateEntityChange mutation hook to draftApiV2</name>
  <files>
    frontend/src/api/draftApiV2.ts
  </files>
  <action>
Extend draftApiV2.ts with:

1. Add createEntityChange function:
   ```typescript
   interface CreateEntityParams {
     entityType: 'category' | 'property' | 'subobject' | 'template' | 'module' | 'bundle'
     entityKey: string
     data: Record<string, unknown>
   }

   async function createEntityChange(
     token: string,
     params: CreateEntityParams
   ): Promise<DraftChangeV2> {
     return apiFetch(`/drafts/${token}/changes`, {
       v2: true,
       method: 'POST',
       body: JSON.stringify({
         change_type: 'CREATE',
         entity_type: params.entityType,
         entity_key: params.entityKey,
         replacement_json: params.data,
       }),
     })
   }
   ```

2. Add useCreateEntityChange mutation hook:
   ```typescript
   export function useCreateEntityChange(token: string | undefined) {
     const queryClient = useQueryClient()

     return useMutation({
       mutationFn: (params: CreateEntityParams) => createEntityChange(token!, params),
       onSuccess: () => {
         // Invalidate draft changes and entity lists to refresh sidebar
         queryClient.invalidateQueries({ queryKey: ['v2', 'draft-changes', token] })
         queryClient.invalidateQueries({ queryKey: ['v2', 'categories'] })
         queryClient.invalidateQueries({ queryKey: ['v2', 'properties'] })
         queryClient.invalidateQueries({ queryKey: ['v2', 'subobjects'] })
         queryClient.invalidateQueries({ queryKey: ['v2', 'templates'] })
         queryClient.invalidateQueries({ queryKey: ['v2', 'modules'] })
         queryClient.invalidateQueries({ queryKey: ['v2', 'bundles'] })
       },
     })
   }
   ```

3. Export CreateEntityParams type for use in forms.
  </action>
  <verify>
    - `grep -q "useCreateEntityChange" frontend/src/api/draftApiV2.ts`
    - Function sends POST to /drafts/{token}/changes with change_type: 'CREATE'
    - Query invalidation includes all entity types
  </verify>
  <done>
    - useCreateEntityChange hook exported from draftApiV2.ts
    - Creates entity via POST /drafts/{token}/changes
    - Invalidates relevant query caches on success
  </done>
</task>

</tasks>

<verification>
1. Run `cd /home/daharoni/dev/ontology-hub/frontend && npm run build` - should pass
2. Verify cmdk is in package.json dependencies
3. Verify schemas.ts exports all 6 schemas with type inference
4. Verify draftApiV2.ts exports useCreateEntityChange
</verification>

<success_criteria>
- cmdk library installed
- FormField component provides consistent label/error/required UX
- All 6 entity schemas defined with proper validation
- useCreateEntityChange mutation ready for form submission
</success_criteria>

<output>
After completion, create `.planning/phases/20-entity-management/20-01-SUMMARY.md`
</output>
