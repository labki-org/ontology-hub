---
phase: 13-entity-detail-pages
plan: 08
type: execute
wave: 4
depends_on: ["13-03", "13-04", "13-05", "13-06", "13-07"]
files_modified:
  - frontend/src/components/entity/EntityDetailPanel.tsx
  - frontend/src/pages/BrowsePage.tsx
autonomous: true

must_haves:
  truths:
    - "Double-clicking entity in sidebar or graph opens detail modal"
    - "Single-clicking entity still shows quick preview in bottom panel"
    - "Modal can be opened via keyboard shortcut or button"
    - "All 6 entity types render correctly in modal"
    - "Edit mode toggle works correctly in draft context"
  artifacts:
    - path: "frontend/src/pages/BrowsePage.tsx"
      provides: "Integrated browse page with modal support"
  key_links:
    - from: "frontend/src/pages/BrowsePage.tsx"
      to: "frontend/src/components/entity/EntityDetailModal.tsx"
      via: "renders modal"
      pattern: "EntityDetailModal"
    - from: "frontend/src/components/entity/EntityDetailPanel.tsx"
      to: "frontend/src/stores/detailStore.ts"
      via: "opens modal on double-click"
      pattern: "openDetail"
---

<objective>
Integrate the entity detail modal into BrowsePage with double-click-to-open interaction and ensure all entity types work correctly.

Purpose: Connect all the detail components built in previous plans to the main browse experience, enabling users to view full entity details in a modal overlay.

Output: BrowsePage with integrated EntityDetailModal, EntityDetailPanel with double-click handling.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/13-entity-detail-pages/13-CONTEXT.md
@.planning/phases/13-entity-detail-pages/13-03-SUMMARY.md
@.planning/phases/13-entity-detail-pages/13-04-SUMMARY.md
@.planning/phases/13-entity-detail-pages/13-05-SUMMARY.md
@.planning/phases/13-entity-detail-pages/13-06-SUMMARY.md
@.planning/phases/13-entity-detail-pages/13-07-SUMMARY.md
@frontend/src/pages/BrowsePage.tsx
@frontend/src/components/entity/EntityDetailPanel.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update EntityDetailPanel with double-click to open modal</name>
  <files>frontend/src/components/entity/EntityDetailPanel.tsx</files>
  <action>
Update `frontend/src/components/entity/EntityDetailPanel.tsx` to include:
1. Double-click handler to open full detail modal
2. "View Full Details" button as alternative to double-click
3. Keep existing quick preview functionality for single-click

Key changes:
- Import useDetailStore
- Add button to open modal
- Add double-click handler on clickable elements

```typescript
import { useCategory, useProperty, useSubobject, useModule, useBundle, useTemplate } from '@/api/entitiesV2'
import {
  Card,
  CardHeader,
  CardTitle,
  CardDescription,
  CardContent,
} from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import { Button } from '@/components/ui/button'
import { Skeleton } from '@/components/ui/skeleton'
import { useGraphStore } from '@/stores/graphStore'
import { useDetailStore } from '@/stores/detailStore'
import { Maximize2 } from 'lucide-react'
import type { CategoryDetailV2 } from '@/api/types'

interface EntityDetailPanelProps {
  entityKey: string | null
  entityType?: string
  draftId?: string
}

/**
 * Hook to fetch entity by type. Returns the appropriate hook result.
 */
function useEntityByType(entityKey: string, entityType: string, draftId?: string) {
  const categoryQuery = useCategory(entityType === 'category' ? entityKey : '', draftId)
  const propertyQuery = useProperty(entityType === 'property' ? entityKey : '', draftId)
  const subobjectQuery = useSubobject(entityType === 'subobject' ? entityKey : '', draftId)
  const moduleQuery = useModule(entityType === 'module' ? entityKey : '', draftId)
  const bundleQuery = useBundle(entityType === 'bundle' ? entityKey : '', draftId)
  const templateQuery = useTemplate(entityType === 'template' ? entityKey : '', draftId)

  switch (entityType) {
    case 'category':
      return categoryQuery
    case 'property':
      return propertyQuery
    case 'subobject':
      return subobjectQuery
    case 'module':
      return moduleQuery
    case 'bundle':
      return bundleQuery
    case 'template':
      return templateQuery
    default:
      return categoryQuery
  }
}

/**
 * Detail panel component that shows the selected entity's quick preview.
 *
 * - Single click: Shows quick preview in this panel
 * - Double click / "View Details" button: Opens full detail modal
 */
export function EntityDetailPanel({
  entityKey,
  entityType = 'category',
  draftId,
}: EntityDetailPanelProps) {
  const setSelectedEntity = useGraphStore((s) => s.setSelectedEntity)
  const openDetail = useDetailStore((s) => s.openDetail)

  // Fetch entity data based on type
  const { data, isLoading, error } = useEntityByType(entityKey || '', entityType, draftId)

  const handleOpenModal = () => {
    if (entityKey && entityType) {
      openDetail(entityKey, entityType)
    }
  }

  if (!entityKey) {
    return (
      <div className="h-full flex items-center justify-center p-6">
        <div className="text-center text-muted-foreground">
          <p className="text-lg font-medium mb-2">Select an entity to view details</p>
          <p className="text-sm">Click an entity in the sidebar or graph to see its information</p>
        </div>
      </div>
    )
  }

  if (isLoading) {
    return (
      <div className="h-full overflow-auto p-6">
        <Skeleton className="h-8 w-64 mb-4" />
        <Skeleton className="h-4 w-full mb-2" />
        <Skeleton className="h-4 w-full mb-2" />
        <Skeleton className="h-4 w-3/4" />
      </div>
    )
  }

  if (error) {
    return (
      <div className="h-full flex items-center justify-center p-6">
        <div className="text-center text-destructive">
          <p className="font-medium">Failed to load entity details</p>
          <p className="text-sm text-muted-foreground mt-1">Please try again</p>
        </div>
      </div>
    )
  }

  if (!data) {
    return (
      <div className="h-full flex items-center justify-center p-6">
        <div className="text-center text-muted-foreground">
          <p className="font-medium">Entity not found</p>
        </div>
      </div>
    )
  }

  // Type guard to check if data is CategoryDetailV2
  const categoryData = data as CategoryDetailV2

  return (
    <div className="h-full overflow-auto p-6">
      <Card onDoubleClick={handleOpenModal} className="cursor-pointer">
        <CardHeader>
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-2">
              <Badge variant="outline" className="capitalize">
                {entityType}
              </Badge>
              <CardTitle className="text-xl">{categoryData.label}</CardTitle>
              {categoryData.change_status && categoryData.change_status !== 'unchanged' && (
                <Badge
                  variant={
                    categoryData.change_status === 'added'
                      ? 'default'
                      : categoryData.change_status === 'modified'
                      ? 'secondary'
                      : 'destructive'
                  }
                  className={
                    categoryData.change_status === 'added'
                      ? 'bg-green-500 hover:bg-green-600'
                      : categoryData.change_status === 'modified'
                      ? 'bg-yellow-500 hover:bg-yellow-600'
                      : ''
                  }
                >
                  {categoryData.change_status === 'added'
                    ? '+ Added'
                    : categoryData.change_status === 'modified'
                    ? '~ Modified'
                    : '- Deleted'}
                </Badge>
              )}
            </div>
            <Button
              variant="ghost"
              size="icon"
              onClick={(e) => {
                e.stopPropagation()
                handleOpenModal()
              }}
              title="View full details"
            >
              <Maximize2 className="h-4 w-4" />
            </Button>
          </div>
          {categoryData.description && (
            <CardDescription>{categoryData.description}</CardDescription>
          )}
          {categoryData.patch_error && (
            <div className="mt-2 text-sm text-destructive bg-destructive/10 p-2 rounded">
              <strong>Patch Error:</strong> {categoryData.patch_error}
            </div>
          )}
        </CardHeader>

        <CardContent className="space-y-4">
          {/* Quick preview - parents (for categories) */}
          {'parents' in categoryData && categoryData.parents && categoryData.parents.length > 0 && (
            <div>
              <h3 className="text-sm font-semibold text-muted-foreground uppercase tracking-wide mb-2">
                Parent Categories
              </h3>
              <div className="flex flex-wrap gap-2">
                {categoryData.parents.map((parent) => (
                  <Badge
                    key={parent}
                    variant="secondary"
                    className="cursor-pointer hover:bg-secondary/80"
                    onClick={(e) => {
                      e.stopPropagation()
                      setSelectedEntity(parent, 'category')
                    }}
                    onDoubleClick={(e) => {
                      e.stopPropagation()
                      openDetail(parent, 'category')
                    }}
                  >
                    {parent}
                  </Badge>
                ))}
              </div>
            </div>
          )}

          {/* Quick preview - properties count (for categories) */}
          {'properties' in categoryData && categoryData.properties && (
            <div>
              <h3 className="text-sm font-semibold text-muted-foreground uppercase tracking-wide mb-2">
                Properties
              </h3>
              <p className="text-sm text-muted-foreground">
                {categoryData.properties.length} properties ({categoryData.properties.filter(p => p.is_direct).length} direct, {categoryData.properties.filter(p => !p.is_direct).length} inherited)
              </p>
            </div>
          )}

          <div className="pt-2 text-xs text-muted-foreground text-center">
            Double-click or click <Maximize2 className="inline h-3 w-3" /> for full details
          </div>
        </CardContent>
      </Card>
    </div>
  )
}
```
  </action>
  <verify>
EntityDetailPanel updated with modal integration:
```bash
grep -n "useDetailStore" frontend/src/components/entity/EntityDetailPanel.tsx
grep -n "openDetail" frontend/src/components/entity/EntityDetailPanel.tsx
```
  </verify>
  <done>EntityDetailPanel updated with double-click and button to open full detail modal</done>
</task>

<task type="auto">
  <name>Task 2: Integrate EntityDetailModal into BrowsePage</name>
  <files>frontend/src/pages/BrowsePage.tsx</files>
  <action>
Update `frontend/src/pages/BrowsePage.tsx` to render the EntityDetailModal:

```typescript
import { useEffect, useRef } from 'react'
import { useSearchParams } from 'react-router-dom'
import { ReactFlowProvider } from '@xyflow/react'
import { SplitLayout } from '@/components/layout/SplitLayout'
import { GraphCanvas } from '@/components/graph/GraphCanvas'
import { EntityDetailPanel } from '@/components/entity/EntityDetailPanel'
import { EntityDetailModal } from '@/components/entity/EntityDetailModal'
import { useGraphStore } from '@/stores/graphStore'

/**
 * Main browse/draft page with unified UI for both modes.
 *
 * Features:
 * - Split layout with graph (top) and quick preview (bottom) panels
 * - Same UI serves both canonical browse and draft mode
 * - URL draft_id parameter activates draft context
 * - Entity selection syncs between sidebar, graph, and detail panel
 * - Double-click opens full detail modal overlay
 *
 * URL structure:
 * - /browse - canonical browse, no entity selected
 * - /browse?entity=Person - canonical browse with Person selected
 * - /browse?draft_id=abc123 - draft mode
 * - /browse?draft_id=abc123&entity=Person - draft mode with entity selected
 */
export function BrowsePage() {
  const [searchParams, setSearchParams] = useSearchParams()
  const selectedEntityKey = useGraphStore((s) => s.selectedEntityKey)
  const selectedEntityType = useGraphStore((s) => s.selectedEntityType)
  const setSelectedEntity = useGraphStore((s) => s.setSelectedEntity)

  // Track if we've done initial sync from URL
  const initialSyncDone = useRef(false)

  // Extract URL parameters
  const draftId = searchParams.get('draft_id') || undefined
  const entityFromUrl = searchParams.get('entity')

  // Sync URL entity param to graphStore ONLY on initial mount
  useEffect(() => {
    if (!initialSyncDone.current && entityFromUrl) {
      setSelectedEntity(entityFromUrl, 'category') // URL doesn't store type, default to category
      initialSyncDone.current = true
    }
  }, [entityFromUrl, setSelectedEntity])

  // Sync graphStore selection to URL when it changes (one-way: store -> URL)
  useEffect(() => {
    // Skip during initial sync
    if (!initialSyncDone.current && entityFromUrl) {
      initialSyncDone.current = true
      return
    }

    const currentEntity = searchParams.get('entity')
    if (selectedEntityKey !== currentEntity) {
      setSearchParams(
        (prev) => {
          if (selectedEntityKey) {
            prev.set('entity', selectedEntityKey)
          } else {
            prev.delete('entity')
          }
          return prev
        },
        { replace: true }
      )
    }
  }, [selectedEntityKey, searchParams, setSearchParams, entityFromUrl])

  return (
    <ReactFlowProvider>
      <SplitLayout className="h-full">
        {/* Top panel: Graph visualization */}
        <GraphCanvas entityKey={selectedEntityKey ?? undefined} draftId={draftId} />

        {/* Bottom panel: Entity quick preview */}
        <EntityDetailPanel
          entityKey={selectedEntityKey}
          entityType={selectedEntityType}
          draftId={draftId}
        />
      </SplitLayout>

      {/* Full detail modal - renders on top when open */}
      <EntityDetailModal draftId={draftId} />
    </ReactFlowProvider>
  )
}
```

The key change is adding `<EntityDetailModal draftId={draftId} />` at the end of the component. The modal manages its own open/close state via detailStore.
  </action>
  <verify>
BrowsePage includes EntityDetailModal:
```bash
grep -n "EntityDetailModal" frontend/src/pages/BrowsePage.tsx
cd frontend && npm run build 2>&1 | head -30
```
  </verify>
  <done>BrowsePage updated with EntityDetailModal integration</done>
</task>

<task type="auto">
  <name>Task 3: Install any missing shadcn/ui components and verify build</name>
  <files>frontend/src/components/ui/switch.tsx</files>
  <action>
The EntityDetailModal uses Switch component for the edit toggle. Install if missing:

```bash
cd frontend
npx shadcn@latest add switch --yes
```

Also verify all imports work by running a build:

```bash
cd frontend && npm run build
```

If any imports fail, identify and install the missing components.

Common ones that might be needed:
- switch (for edit toggle)
- select (for datatype/cardinality dropdowns)

If build passes, this task is complete.
  </action>
  <verify>
Build succeeds:
```bash
cd frontend && npm run build 2>&1 | tail -10
```
  </verify>
  <done>All shadcn/ui components installed, build succeeds</done>
</task>

</tasks>

<verification>
1. EntityDetailPanel has double-click handler: `grep "onDoubleClick" frontend/src/components/entity/EntityDetailPanel.tsx`
2. BrowsePage renders EntityDetailModal: `grep "EntityDetailModal" frontend/src/pages/BrowsePage.tsx`
3. Build passes: `cd frontend && npm run build`
4. Switch component exists: `ls frontend/src/components/ui/switch.tsx`
</verification>

<success_criteria>
- Double-clicking entity card opens full detail modal
- "View Full Details" button (expand icon) opens modal
- Modal renders correct detail component based on entity type
- Edit mode toggle appears in modal when draft_id is present
- All 6 entity types can be viewed in modal without errors
- Quick preview still works in bottom panel (single click)
- Build passes with all components integrated
</success_criteria>

<output>
After completion, create `.planning/phases/13-entity-detail-pages/13-08-SUMMARY.md`
</output>
