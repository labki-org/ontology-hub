---
phase: 13-entity-detail-pages
plan: 03
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - frontend/src/components/entity/EntityDetailModal.tsx
  - frontend/src/components/entity/sections/MembershipSection.tsx
  - frontend/src/components/entity/sections/WhereUsedSection.tsx
  - frontend/src/stores/detailStore.ts
autonomous: true

must_haves:
  truths:
    - "Entity detail modal opens as full overlay hiding graph behind"
    - "Modal has global edit toggle at top that switches entire page to edit mode"
    - "Edit mode toggle only appears when draft context is active"
    - "MembershipSection shows which modules/bundles contain this entity"
    - "WhereUsedSection shows entities that reference this entity"
  artifacts:
    - path: "frontend/src/components/entity/EntityDetailModal.tsx"
      provides: "Full detail view modal with edit toggle"
      exports: ["EntityDetailModal"]
    - path: "frontend/src/stores/detailStore.ts"
      provides: "Detail modal state (open, editing, selected entity)"
      exports: ["useDetailStore"]
  key_links:
    - from: "frontend/src/components/entity/EntityDetailModal.tsx"
      to: "frontend/src/stores/detailStore.ts"
      via: "zustand store"
      pattern: "useDetailStore"
---

<objective>
Create the modal overlay container for full entity detail view with edit mode toggle, plus shared sections for module membership and where-used lists.

Purpose: The EntityDetailModal provides the container that entity-specific detail components will render into. It handles the modal state, edit toggle, and breadcrumb navigation.

Output: EntityDetailModal component with edit mode toggle, MembershipSection and WhereUsedSection components, detailStore for state management.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/13-entity-detail-pages/13-CONTEXT.md
@.planning/phases/13-entity-detail-pages/13-RESEARCH.md
@.planning/phases/13-entity-detail-pages/13-01-SUMMARY.md
@frontend/src/components/ui/dialog.tsx
@frontend/src/components/ui/breadcrumb.tsx
@frontend/src/stores/graphStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create detailStore for modal state</name>
  <files>frontend/src/stores/detailStore.ts</files>
  <action>
Create `frontend/src/stores/detailStore.ts` - Zustand store for detail modal state:

```typescript
import { create } from 'zustand'

interface DetailState {
  // Modal open state
  isOpen: boolean

  // Edit mode toggle
  isEditing: boolean

  // Currently viewed entity (may differ from selected in graph)
  entityKey: string | null
  entityType: string | null

  // Navigation breadcrumb trail
  breadcrumbs: Array<{ key: string; type: string; label: string }>

  // Actions
  openDetail: (entityKey: string, entityType: string) => void
  closeDetail: () => void
  setEditing: (editing: boolean) => void
  pushBreadcrumb: (key: string, type: string, label: string) => void
  navigateToBreadcrumb: (index: number) => void
  clearBreadcrumbs: () => void
}

export const useDetailStore = create<DetailState>((set, get) => ({
  isOpen: false,
  isEditing: false,
  entityKey: null,
  entityType: null,
  breadcrumbs: [],

  openDetail: (entityKey, entityType) => {
    const { breadcrumbs, entityKey: currentKey } = get()

    // If opening from closed state, start fresh breadcrumbs
    if (!get().isOpen) {
      set({
        isOpen: true,
        entityKey,
        entityType,
        breadcrumbs: [], // Will be populated when entity loads
        isEditing: false, // Reset edit mode on new modal
      })
    } else if (currentKey !== entityKey) {
      // Navigating to different entity while modal open - add to breadcrumbs
      set({
        entityKey,
        entityType,
        // Breadcrumb added by component after label loads
      })
    }
  },

  closeDetail: () =>
    set({
      isOpen: false,
      entityKey: null,
      entityType: null,
      breadcrumbs: [],
      isEditing: false,
    }),

  setEditing: (editing) => set({ isEditing: editing }),

  pushBreadcrumb: (key, type, label) =>
    set((state) => ({
      breadcrumbs: [
        ...state.breadcrumbs.filter((b) => b.key !== key), // Avoid duplicates
        { key, type, label },
      ],
    })),

  navigateToBreadcrumb: (index) => {
    const { breadcrumbs } = get()
    if (index < breadcrumbs.length) {
      const target = breadcrumbs[index]
      set({
        entityKey: target.key,
        entityType: target.type,
        breadcrumbs: breadcrumbs.slice(0, index + 1),
      })
    }
  },

  clearBreadcrumbs: () => set({ breadcrumbs: [] }),
}))
```

This store manages:
- Modal open/close state
- Edit mode toggle (only in draft context)
- Current entity being viewed
- Breadcrumb navigation trail
  </action>
  <verify>
File exists and exports useDetailStore:
```bash
grep -n "export const useDetailStore" frontend/src/stores/detailStore.ts
```
  </verify>
  <done>detailStore created with modal state, edit toggle, and breadcrumb navigation</done>
</task>

<task type="auto">
  <name>Task 2: Create EntityDetailModal component</name>
  <files>frontend/src/components/entity/EntityDetailModal.tsx</files>
  <action>
Create `frontend/src/components/entity/EntityDetailModal.tsx` - modal container for entity details:

```typescript
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog'
import {
  Breadcrumb,
  BreadcrumbItem,
  BreadcrumbLink,
  BreadcrumbList,
  BreadcrumbPage,
  BreadcrumbSeparator,
} from '@/components/ui/breadcrumb'
import { Button } from '@/components/ui/button'
import { Switch } from '@/components/ui/switch'
import { Label } from '@/components/ui/label'
import { useDetailStore } from '@/stores/detailStore'
import { Fragment } from 'react'

// Entity detail components will be lazy-loaded
import { CategoryDetail } from './detail/CategoryDetail'
import { PropertyDetail } from './detail/PropertyDetail'
import { SubobjectDetail } from './detail/SubobjectDetail'
import { ModuleDetail } from './detail/ModuleDetail'
import { BundleDetail } from './detail/BundleDetail'
import { TemplateDetail } from './detail/TemplateDetail'

interface EntityDetailModalProps {
  draftId?: string
}

/**
 * Full detail view modal overlay.
 * Per CONTEXT.md: modal overlay hides graph behind, global edit toggle at top.
 */
export function EntityDetailModal({ draftId }: EntityDetailModalProps) {
  const {
    isOpen,
    isEditing,
    entityKey,
    entityType,
    breadcrumbs,
    closeDetail,
    setEditing,
    navigateToBreadcrumb,
  } = useDetailStore()

  // Only show edit toggle when draft context is active
  const canEdit = !!draftId

  // Render the appropriate detail component based on entity type
  const renderDetail = () => {
    if (!entityKey || !entityType) return null

    const props = {
      entityKey,
      draftId,
      isEditing: canEdit && isEditing,
    }

    switch (entityType) {
      case 'category':
        return <CategoryDetail {...props} />
      case 'property':
        return <PropertyDetail {...props} />
      case 'subobject':
        return <SubobjectDetail {...props} />
      case 'module':
        return <ModuleDetail {...props} />
      case 'bundle':
        return <BundleDetail {...props} />
      case 'template':
        return <TemplateDetail {...props} />
      default:
        return <div>Unknown entity type: {entityType}</div>
    }
  }

  return (
    <Dialog open={isOpen} onOpenChange={(open) => !open && closeDetail()}>
      <DialogContent className="max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
        <DialogHeader className="flex-shrink-0">
          <div className="flex items-center justify-between">
            {/* Breadcrumb navigation */}
            <Breadcrumb>
              <BreadcrumbList>
                {breadcrumbs.map((crumb, index) => (
                  <Fragment key={crumb.key}>
                    {index > 0 && <BreadcrumbSeparator />}
                    <BreadcrumbItem>
                      {index === breadcrumbs.length - 1 ? (
                        <BreadcrumbPage>{crumb.label}</BreadcrumbPage>
                      ) : (
                        <BreadcrumbLink
                          href="#"
                          onClick={(e) => {
                            e.preventDefault()
                            navigateToBreadcrumb(index)
                          }}
                        >
                          {crumb.label}
                        </BreadcrumbLink>
                      )}
                    </BreadcrumbItem>
                  </Fragment>
                ))}
              </BreadcrumbList>
            </Breadcrumb>

            {/* Edit mode toggle - only shown in draft context */}
            {canEdit && (
              <div className="flex items-center gap-2">
                <Switch
                  id="edit-mode"
                  checked={isEditing}
                  onCheckedChange={setEditing}
                />
                <Label htmlFor="edit-mode" className="text-sm">
                  Edit Mode
                </Label>
              </div>
            )}
          </div>
        </DialogHeader>

        <div className="flex-1 overflow-auto">
          {renderDetail()}
        </div>
      </DialogContent>
    </Dialog>
  )
}
```

Note: This component imports detail components that will be created in subsequent plans. For now, create placeholder files so TypeScript doesn't error.

Create placeholder files for each detail component:

```bash
mkdir -p frontend/src/components/entity/detail
```

Create `frontend/src/components/entity/detail/CategoryDetail.tsx`:
```typescript
export function CategoryDetail({ entityKey, draftId, isEditing }: { entityKey: string; draftId?: string; isEditing: boolean }) {
  return <div>Category detail for {entityKey} (placeholder)</div>
}
```

Create similar placeholders for PropertyDetail, SubobjectDetail, ModuleDetail, BundleDetail, TemplateDetail with same signature.
  </action>
  <verify>
Modal component exists and imports work:
```bash
grep -n "export function EntityDetailModal" frontend/src/components/entity/EntityDetailModal.tsx
ls frontend/src/components/entity/detail/
```
  </verify>
  <done>EntityDetailModal created with breadcrumb navigation and edit mode toggle; placeholder detail components in place</done>
</task>

<task type="auto">
  <name>Task 3: Create MembershipSection and WhereUsedSection</name>
  <files>
    frontend/src/components/entity/sections/MembershipSection.tsx
    frontend/src/components/entity/sections/WhereUsedSection.tsx
  </files>
  <action>
Create `frontend/src/components/entity/sections/MembershipSection.tsx`:

```typescript
import { Badge } from '@/components/ui/badge'
import { useDetailStore } from '@/stores/detailStore'
import { AccordionSection } from './AccordionSection'

interface MembershipSectionProps {
  modules?: string[]
  bundles?: string[]
}

/**
 * Shows which modules/bundles contain this entity.
 * Clicking a module/bundle navigates to its detail view.
 */
export function MembershipSection({ modules = [], bundles = [] }: MembershipSectionProps) {
  const openDetail = useDetailStore((s) => s.openDetail)

  const hasContent = modules.length > 0 || bundles.length > 0

  if (!hasContent) {
    return (
      <AccordionSection id="membership" title="Membership" count={0} defaultOpen={false}>
        <p className="text-sm text-muted-foreground italic">
          Not assigned to any modules or bundles
        </p>
      </AccordionSection>
    )
  }

  return (
    <AccordionSection
      id="membership"
      title="Membership"
      count={modules.length + bundles.length}
      defaultOpen={false}
    >
      <div className="space-y-4">
        {modules.length > 0 && (
          <div>
            <h4 className="text-sm font-medium mb-2">Modules</h4>
            <div className="flex flex-wrap gap-2">
              {modules.map((moduleKey) => (
                <Badge
                  key={moduleKey}
                  variant="secondary"
                  className="cursor-pointer hover:bg-secondary/80"
                  onClick={() => openDetail(moduleKey, 'module')}
                >
                  {moduleKey}
                </Badge>
              ))}
            </div>
          </div>
        )}

        {bundles.length > 0 && (
          <div>
            <h4 className="text-sm font-medium mb-2">Bundles</h4>
            <div className="flex flex-wrap gap-2">
              {bundles.map((bundleKey) => (
                <Badge
                  key={bundleKey}
                  variant="outline"
                  className="cursor-pointer hover:bg-muted"
                  onClick={() => openDetail(bundleKey, 'bundle')}
                >
                  {bundleKey}
                </Badge>
              ))}
            </div>
          </div>
        )}
      </div>
    </AccordionSection>
  )
}
```

Create `frontend/src/components/entity/sections/WhereUsedSection.tsx`:

```typescript
import { Badge } from '@/components/ui/badge'
import { useDetailStore } from '@/stores/detailStore'
import { AccordionSection } from './AccordionSection'

interface WhereUsedItem {
  entityKey: string
  entityType: string
  label?: string
}

interface WhereUsedSectionProps {
  items: WhereUsedItem[]
  title?: string
}

/**
 * Shows entities that reference this entity.
 * E.g., for a property: which categories use it.
 * E.g., for a subobject: which categories/properties reference it.
 */
export function WhereUsedSection({
  items,
  title = 'Used By',
}: WhereUsedSectionProps) {
  const openDetail = useDetailStore((s) => s.openDetail)

  if (items.length === 0) {
    return (
      <AccordionSection id="where-used" title={title} count={0} defaultOpen={false}>
        <p className="text-sm text-muted-foreground italic">Not used by any entities</p>
      </AccordionSection>
    )
  }

  // Group items by entity type
  const grouped = items.reduce(
    (acc, item) => {
      const type = item.entityType
      if (!acc[type]) acc[type] = []
      acc[type].push(item)
      return acc
    },
    {} as Record<string, WhereUsedItem[]>
  )

  const typeLabels: Record<string, string> = {
    category: 'Categories',
    property: 'Properties',
    subobject: 'Subobjects',
    module: 'Modules',
    bundle: 'Bundles',
    template: 'Templates',
  }

  return (
    <AccordionSection id="where-used" title={title} count={items.length}>
      <div className="space-y-4">
        {Object.entries(grouped).map(([type, typeItems]) => (
          <div key={type}>
            <h4 className="text-sm font-medium mb-2">{typeLabels[type] || type}</h4>
            <div className="flex flex-wrap gap-2">
              {typeItems.map((item) => (
                <Badge
                  key={item.entityKey}
                  variant="secondary"
                  className="cursor-pointer hover:bg-secondary/80"
                  onClick={() => openDetail(item.entityKey, item.entityType)}
                >
                  {item.label || item.entityKey}
                </Badge>
              ))}
            </div>
          </div>
        ))}
      </div>
    </AccordionSection>
  )
}
```
  </action>
  <verify>
Both section components exist:
```bash
grep -n "export function MembershipSection" frontend/src/components/entity/sections/MembershipSection.tsx
grep -n "export function WhereUsedSection" frontend/src/components/entity/sections/WhereUsedSection.tsx
```
  </verify>
  <done>MembershipSection and WhereUsedSection components created with clickable navigation to related entities</done>
</task>

</tasks>

<verification>
1. Store exists: `ls frontend/src/stores/detailStore.ts`
2. Modal exists: `ls frontend/src/components/entity/EntityDetailModal.tsx`
3. Section components exist: `ls frontend/src/components/entity/sections/`
4. Placeholder detail components exist: `ls frontend/src/components/entity/detail/`
5. TypeScript compiles: `cd frontend && npm run build`
</verification>

<success_criteria>
- detailStore manages modal open/close, edit toggle, breadcrumbs
- EntityDetailModal renders as Dialog with edit mode switch (only in draft context)
- Breadcrumb navigation allows clicking back through entity chain
- MembershipSection shows modules/bundles with click-to-navigate
- WhereUsedSection shows referencing entities grouped by type
- Placeholder detail components exist for all 6 entity types
</success_criteria>

<output>
After completion, create `.planning/phases/13-entity-detail-pages/13-03-SUMMARY.md`
</output>
