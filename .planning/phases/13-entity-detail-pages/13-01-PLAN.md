---
phase: 13-entity-detail-pages
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/components/ui/dialog.tsx
  - frontend/src/components/ui/accordion.tsx
  - frontend/src/components/ui/input.tsx
  - frontend/src/components/ui/textarea.tsx
  - frontend/src/components/ui/breadcrumb.tsx
  - frontend/src/api/types.ts
  - frontend/src/api/entitiesV2.ts
  - frontend/src/api/drafts.ts
  - frontend/src/hooks/useAutoSave.ts
autonomous: true

must_haves:
  truths:
    - "shadcn/ui dialog, accordion, input, textarea, breadcrumb components are installed and available"
    - "Frontend TypeScript types match backend entity detail response shapes"
    - "Auto-save hook exists with debounce and race condition handling"
    - "API client can submit draft changes via POST /drafts/{token}/changes"
  artifacts:
    - path: "frontend/src/components/ui/dialog.tsx"
      provides: "Modal overlay component"
    - path: "frontend/src/components/ui/accordion.tsx"
      provides: "Collapsible sections component"
    - path: "frontend/src/hooks/useAutoSave.ts"
      provides: "Auto-save with debounce hook"
    - path: "frontend/src/api/types.ts"
      provides: "TypeScript types for all entity detail responses"
  key_links:
    - from: "frontend/src/hooks/useAutoSave.ts"
      to: "frontend/src/api/drafts.ts"
      via: "mutation function"
      pattern: "useMutation|addDraftChange"
---

<objective>
Install missing shadcn/ui components, add TypeScript types for entity details, and create the auto-save hook foundation.

Purpose: Establish shared infrastructure that all entity detail pages will use - UI components for modal/accordion display, types for data shapes, and auto-save mechanism for edit mode.

Output: shadcn/ui components installed, TypeScript types extended, useAutoSave hook ready for use.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-entity-detail-pages/13-CONTEXT.md
@.planning/phases/13-entity-detail-pages/13-RESEARCH.md
@frontend/src/api/types.ts
@frontend/src/api/entitiesV2.ts
@backend/app/schemas/entity_v2.py
@backend/app/schemas/draft_change.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install missing shadcn/ui components</name>
  <files>
    frontend/src/components/ui/dialog.tsx
    frontend/src/components/ui/accordion.tsx
    frontend/src/components/ui/input.tsx
    frontend/src/components/ui/textarea.tsx
    frontend/src/components/ui/breadcrumb.tsx
  </files>
  <action>
Run shadcn CLI to install missing components needed for entity detail pages:

```bash
cd frontend
npx shadcn@latest add dialog accordion input textarea breadcrumb --yes
```

These components provide:
- dialog: Modal overlay for full entity detail view (uses Radix Dialog for accessibility)
- accordion: Collapsible sections for organizing entity details
- input: Text input for editing fields
- textarea: Multi-line input for descriptions and wikitext
- breadcrumb: Navigation trail showing entity path

Verify each component file is created in `src/components/ui/`.
  </action>
  <verify>
All 5 component files exist:
- `ls frontend/src/components/ui/dialog.tsx`
- `ls frontend/src/components/ui/accordion.tsx`
- `ls frontend/src/components/ui/input.tsx`
- `ls frontend/src/components/ui/textarea.tsx`
- `ls frontend/src/components/ui/breadcrumb.tsx`
  </verify>
  <done>All shadcn/ui components installed and available for import</done>
</task>

<task type="auto">
  <name>Task 2: Extend TypeScript types for entity details</name>
  <files>frontend/src/api/types.ts</files>
  <action>
Add TypeScript interfaces matching backend entity detail response schemas. Add these types to `frontend/src/api/types.ts`:

```typescript
// Property detail (matches PropertyDetailResponse)
export interface PropertyDetailV2 {
  entity_key: string
  label: string
  description?: string | null
  datatype: string
  cardinality: string
  change_status?: 'added' | 'modified' | 'deleted' | 'unchanged'
  deleted?: boolean
}

// Subobject detail (similar structure to basic entity)
export interface SubobjectDetailV2 {
  entity_key: string
  label: string
  description?: string | null
  properties?: string[]  // Property keys
  change_status?: 'added' | 'modified' | 'deleted' | 'unchanged'
  deleted?: boolean
}

// Module detail (matches ModuleDetailResponse)
export interface ModuleDetailV2 {
  entity_key: string
  label: string
  version?: string | null
  entities: Record<string, string[]>  // { category: [...], property: [...] }
  closure: string[]  // Transitive dependencies
  change_status?: 'added' | 'modified' | 'deleted' | 'unchanged'
  deleted?: boolean
}

// Bundle detail (matches BundleDetailResponse)
export interface BundleDetailV2 {
  entity_key: string
  label: string
  version?: string | null
  modules: string[]
  closure: string[]  // Transitive module dependencies
  change_status?: 'added' | 'modified' | 'deleted' | 'unchanged'
  deleted?: boolean
}

// Template detail
export interface TemplateDetailV2 {
  entity_key: string
  label: string
  description?: string | null
  wikitext?: string  // Template content
  change_status?: 'added' | 'modified' | 'deleted' | 'unchanged'
  deleted?: boolean
}

// Draft change types for edit mode
export type ChangeType = 'CREATE' | 'UPDATE' | 'DELETE'

export interface DraftChangeCreate {
  change_type: ChangeType
  entity_type: string
  entity_key: string
  patch?: Array<{ op: string; path: string; value?: unknown }>
  replacement_json?: Record<string, unknown>
}

export interface DraftChangeResponse {
  id: string
  change_type: ChangeType
  entity_type: string
  entity_key: string
  patch?: Array<{ op: string; path: string; value?: unknown }>
  replacement_json?: Record<string, unknown>
  created_at: string
}

// Union type for any entity detail
export type EntityDetailV2 =
  | CategoryDetailV2
  | PropertyDetailV2
  | SubobjectDetailV2
  | ModuleDetailV2
  | BundleDetailV2
  | TemplateDetailV2
```

Note: CategoryDetailV2 already exists in types.ts, keep it as-is.
  </action>
  <verify>
TypeScript compiles without errors:
```bash
cd frontend && npm run build 2>&1 | head -20
```
  </verify>
  <done>All entity detail TypeScript types defined and compatible with backend schemas</done>
</task>

<task type="auto">
  <name>Task 3: Create useAutoSave hook and draft change API</name>
  <files>
    frontend/src/hooks/useAutoSave.ts
    frontend/src/api/drafts.ts
  </files>
  <action>
Create `frontend/src/hooks/useAutoSave.ts` - auto-save hook with debounce and race condition handling:

```typescript
import { useCallback, useRef, useEffect } from 'react'
import { useMutation, useQueryClient } from '@tanstack/react-query'
import { addDraftChange } from '@/api/drafts'
import type { DraftChangeCreate } from '@/api/types'

interface UseAutoSaveOptions {
  draftToken: string
  entityType: string
  entityKey: string
  debounceMs?: number
  onSuccess?: () => void
  onError?: (error: Error) => void
}

export function useAutoSave({
  draftToken,
  entityType,
  entityKey,
  debounceMs = 500,
  onSuccess,
  onError,
}: UseAutoSaveOptions) {
  const queryClient = useQueryClient()
  const timeoutRef = useRef<NodeJS.Timeout | null>(null)
  const requestIdRef = useRef(0)

  const mutation = useMutation({
    mutationFn: (change: DraftChangeCreate) => addDraftChange(draftToken, change),
    onSuccess: () => {
      // Invalidate entity queries to refresh with new draft overlay
      queryClient.invalidateQueries({ queryKey: ['v2', entityType, entityKey] })
      onSuccess?.()
    },
    onError: (error: Error) => {
      onError?.(error)
    },
  })

  const saveChange = useCallback(
    (patch: Array<{ op: string; path: string; value?: unknown }>) => {
      // Cancel pending timeout
      if (timeoutRef.current) {
        clearTimeout(timeoutRef.current)
      }

      // Increment request ID for race condition handling
      const currentRequestId = ++requestIdRef.current

      timeoutRef.current = setTimeout(() => {
        // Check if this is still the latest request
        if (currentRequestId !== requestIdRef.current) {
          return // Stale request, skip
        }

        mutation.mutate({
          change_type: 'UPDATE',
          entity_type: entityType,
          entity_key: entityKey,
          patch,
        })
      }, debounceMs)
    },
    [mutation, entityType, entityKey, debounceMs]
  )

  // Cleanup on unmount
  useEffect(() => {
    return () => {
      if (timeoutRef.current) {
        clearTimeout(timeoutRef.current)
      }
    }
  }, [])

  return {
    saveChange,
    isSaving: mutation.isPending,
    error: mutation.error,
  }
}
```

Update `frontend/src/api/drafts.ts` - add addDraftChange function:

```typescript
import { apiFetch } from './client'
import type { DraftChangeCreate, DraftChangeResponse } from './types'

// ... existing exports ...

export async function addDraftChange(
  token: string,
  change: DraftChangeCreate
): Promise<DraftChangeResponse> {
  return apiFetch(`/drafts/${token}/changes`, {
    method: 'POST',
    body: JSON.stringify(change),
    v2: true,
  })
}
```

Ensure the apiFetch in client.ts handles POST with JSON body (should already work based on existing code patterns).
  </action>
  <verify>
TypeScript compiles and hooks directory exists:
```bash
cd frontend && npm run build 2>&1 | head -20
ls frontend/src/hooks/useAutoSave.ts
```
  </verify>
  <done>useAutoSave hook created with debounced saves and race condition handling; addDraftChange API function available</done>
</task>

</tasks>

<verification>
1. All shadcn/ui components installed: `ls frontend/src/components/ui/{dialog,accordion,input,textarea,breadcrumb}.tsx`
2. TypeScript types compile: `cd frontend && npm run build`
3. Hooks directory exists with useAutoSave: `ls frontend/src/hooks/useAutoSave.ts`
4. API client has addDraftChange: `grep -n "addDraftChange" frontend/src/api/drafts.ts`
</verification>

<success_criteria>
- 5 new shadcn/ui components available in frontend/src/components/ui/
- TypeScript types for all 6 entity detail shapes defined
- useAutoSave hook created with debounce (500ms default) and request ID tracking
- addDraftChange API function available for draft mutations
- `npm run build` passes without type errors
</success_criteria>

<output>
After completion, create `.planning/phases/13-entity-detail-pages/13-01-SUMMARY.md`
</output>
