---
phase: 10-query-layer
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - backend/app/routers/entities_v2.py
  - backend/app/main.py
autonomous: true

must_haves:
  truths:
    - "Category detail returns parents, direct properties, and inherited properties with provenance"
    - "Property where-used endpoint returns categories using the property"
    - "Module detail returns direct entities and computed closure"
    - "Bundle detail returns modules and computed closure"
    - "All entity queries accept optional draft_id and return effective view with change_status"
  artifacts:
    - path: "backend/app/routers/entities_v2.py"
      provides: "v2 entity endpoints"
      exports: ["router"]
    - path: "backend/app/main.py"
      provides: "Router registration"
      contains: "entities_v2"
  key_links:
    - from: "backend/app/routers/entities_v2.py"
      to: "app.services.draft_overlay.DraftContextDep"
      via: "FastAPI dependency"
      pattern: "DraftContextDep"
    - from: "backend/app/routers/entities_v2.py"
      to: "category_property_effective"
      via: "SQLAlchemy text query"
      pattern: "category_property_effective"
---

<objective>
Implement v2.0 entity query endpoints with draft overlay support

Purpose: Provide read endpoints for all entity types that return canonical data with optional draft overlay, supporting QRY-01 through QRY-07 requirements including category detail with inheritance provenance, property where-used, and module/bundle closure computation.

Output: FastAPI router with entity endpoints that integrate DraftOverlayService for effective view computation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-query-layer/10-CONTEXT.md
@.planning/phases/10-query-layer/10-RESEARCH.md
@.planning/phases/10-query-layer/10-01-SUMMARY.md

# v2.0 models
@backend/app/models/v2/__init__.py
@backend/app/models/v2/relationships.py
@backend/app/models/v2/category_property_effective.py

# v1.0 patterns to follow
@backend/app/routers/entities.py

# Dependencies from 10-01
@backend/app/services/draft_overlay.py
@backend/app/schemas/entity_v2.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create v2 entity router with category and property endpoints</name>
  <files>backend/app/routers/entities_v2.py</files>
  <action>
Create entities_v2.py router with /api/v2 prefix.

**Endpoints to implement:**

1. **GET /categories** - List categories with pagination and draft overlay
   - Query params: cursor (optional str), limit (int, default 20), draft_id (optional UUID)
   - Query Category table ordered by entity_key
   - Apply draft overlay to each category
   - Include draft-created categories (from DraftOverlayService.get_draft_creates)
   - Re-sort merged results by entity_key
   - Return EntityListResponse with change_status on each item

2. **GET /categories/{entity_key}** - Category detail with parents and properties
   - Query params: draft_id (optional UUID)
   - Get canonical category by entity_key
   - Apply draft overlay
   - Query CategoryParent to get parent category keys
   - Query category_property_effective materialized view joined with properties table:
     - Select property entity_key, label, depth, is_required, source category entity_key
     - Order by depth (direct first), then label
     - Build property list with is_direct (depth=0), is_inherited (depth>0), source_category, inheritance_depth
   - Return CategoryDetailResponse

3. **GET /properties** - List properties with pagination and draft overlay
   - Same pattern as categories list

4. **GET /properties/{entity_key}** - Property detail
   - Query params: draft_id (optional UUID)
   - Get canonical property, apply overlay
   - Return PropertyDetailResponse

5. **GET /properties/{entity_key}/used-by** - Where-used (QRY-05)
   - Query params: draft_id (optional UUID)
   - Query CategoryProperty joined with Category where property matches
   - Get list of category entity_keys using this property
   - Apply draft overlay to each category
   - Return list of category objects with change_status

**Implementation notes:**
- Use DraftContextDep dependency for all endpoints
- Use raw SQL (sqlalchemy text()) for category_property_effective queries since it's a view
- Follow v1.0 cursor pagination pattern (limit+1 to detect has_next)
- Handle 404 for missing entities
- Include rate limiting decorators like v1.0 (optional but follow pattern)
  </action>
  <verify>python -c "from app.routers.entities_v2 import router; print(f'Routes: {len(router.routes)}')" from backend dir</verify>
  <done>Category and property endpoints implemented with draft overlay support and category detail includes inherited properties with provenance</done>
</task>

<task type="auto">
  <name>Task 2: Add module/bundle endpoints and register router</name>
  <files>backend/app/routers/entities_v2.py, backend/app/main.py</files>
  <action>
Add module and bundle endpoints to entities_v2.py:

1. **GET /modules/{entity_key}** - Module detail with closure (QRY-06)
   - Query params: draft_id (optional UUID)
   - Get canonical module, apply overlay
   - Query ModuleEntity to get direct entity membership (grouped by entity_type)
   - Compute closure: For each category in module, find categories that depend on it (used as parent)
     - Use recursive CTE to find all descendants that would need this module's categories
     - Closure = direct entities + auto-included dependencies
   - Return ModuleDetailResponse with entities and closure

2. **GET /bundles/{entity_key}** - Bundle detail with closure (QRY-07)
   - Query params: draft_id (optional UUID)
   - Get canonical bundle, apply overlay
   - Query BundleModule to get direct module membership
   - Compute closure: For each module, include modules they depend on
     - Module A depends on Module B if A has category that inherits from B's category
   - Return BundleDetailResponse with modules and closure

3. **GET /subobjects** and **GET /templates** - List endpoints (basic pagination, draft overlay)
   - Follow same pattern as categories/properties list

**Register router in main.py:**
- Import router from app.routers.entities_v2
- Add: `app.include_router(entities_v2.router, prefix="/api/v2")`

**Closure computation approach:**
- For modules: Find all categories that are parents of module's categories (transitive closure of category_parent)
- For bundles: Find modules containing those parent categories
- Use recursive CTE for efficiency
  </action>
  <verify>curl http://localhost:8000/api/v2/categories -s | head -c 200 (or use python import test if server not running)</verify>
  <done>Module and bundle endpoints with closure computation; router registered at /api/v2</done>
</task>

</tasks>

<verification>
- [ ] GET /api/v2/categories returns paginated list with change_status
- [ ] GET /api/v2/categories/{key} returns detail with parents and properties
- [ ] GET /api/v2/properties returns paginated list
- [ ] GET /api/v2/properties/{key}/used-by returns categories using property
- [ ] GET /api/v2/modules/{key} returns module with entities and closure
- [ ] GET /api/v2/bundles/{key} returns bundle with modules and closure
- [ ] All endpoints accept draft_id query parameter
- [ ] Router registered in main.py at /api/v2 prefix
</verification>

<success_criteria>
All v2.0 entity query endpoints operational with draft context support; category detail includes inheritance provenance from materialized view; module/bundle detail includes computed closure.
</success_criteria>

<output>
After completion, create `.planning/phases/10-query-layer/10-02-SUMMARY.md`
</output>
