---
phase: 29-frontend-graph-visualization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/services/graph_query.py
  - backend/app/models/v2/__init__.py
autonomous: true

must_haves:
  truths:
    - "Dashboard nodes appear in full ontology graph"
    - "Resource nodes appear in full ontology graph"
    - "Dashboard neighborhood query returns connected modules"
    - "Resource neighborhood query returns parent category"
  artifacts:
    - path: "backend/app/services/graph_query.py"
      provides: "Dashboard and Resource graph query methods"
      contains: "_get_dashboard_neighborhood"
    - path: "backend/app/services/graph_query.py"
      provides: "Full ontology includes dashboards and resources"
      contains: "entity_type=\"dashboard\""
  key_links:
    - from: "graph_query.py"
      to: "Dashboard model"
      via: "import and query"
      pattern: "from app.models.v2 import.*Dashboard"
    - from: "graph_query.py"
      to: "Resource model"
      via: "import and query"
      pattern: "from app.models.v2 import.*Resource"
---

<objective>
Extend backend graph query service to include Dashboard and Resource entities.

Purpose: Enable graph visualization to display the new entity types with their relationships to modules and categories.
Output: Updated graph_query.py with neighborhood methods for dashboard and resource entities, plus inclusion in full ontology graph.
</objective>

<execution_context>
@/home/daharoni/.claude/get-shit-done/workflows/execute-plan.md
@/home/daharoni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/29-frontend-graph-visualization/29-RESEARCH.md
@backend/app/services/graph_query.py
@backend/app/models/v2/dashboard.py
@backend/app/models/v2/resource.py
@backend/app/models/v2/relationships.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Dashboard and Resource imports and neighborhood methods</name>
  <files>backend/app/services/graph_query.py</files>
  <action>
1. Add Dashboard, Resource, ModuleDashboard imports from app.models.v2

2. Update get_neighborhood_graph dispatch to handle "dashboard" and "resource" entity_type:
   - elif entity_type == "dashboard": return await self._get_dashboard_neighborhood(entity_key, depth)
   - elif entity_type == "resource": return await self._get_resource_neighborhood(entity_key, depth)

3. Add _get_dashboard_neighborhood method:
   - Verify dashboard exists (query Dashboard table)
   - Check draft creates if not found
   - Get modules that reference this dashboard via ModuleDashboard join
   - Build dashboard node with entity_type="dashboard"
   - Build module nodes for connected modules
   - Build edges: module -> dashboard with edge_type="module_dashboard"
   - Return GraphResponse with nodes and edges

4. Add _get_resource_neighborhood method:
   - Verify resource exists (query Resource table)
   - Check draft creates if not found
   - Get parent category via resource.category_key lookup
   - Build resource node with entity_type="resource"
   - Build category node for parent category
   - Build edge: category -> resource with edge_type="category_resource"
   - Return GraphResponse with nodes and edges

Follow existing patterns from _get_template_neighborhood and _get_property_neighborhood for structure.
  </action>
  <verify>
Run: cd /home/daharoni/dev/ontology-hub && python -c "from backend.app.services.graph_query import GraphQueryService; print('Import OK')"
  </verify>
  <done>
GraphQueryService can handle dashboard and resource entity types in get_neighborhood_graph. Methods _get_dashboard_neighborhood and _get_resource_neighborhood exist.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Dashboard and Resource to full ontology graph</name>
  <files>backend/app/services/graph_query.py</files>
  <action>
Update get_full_ontology_graph method to include Dashboard and Resource entities:

1. After templates section, add dashboards section:
   - Query all dashboards: select(Dashboard)
   - Get dashboard_keys list
   - For each dashboard, apply draft overlay and create GraphNode with entity_type="dashboard"
   - Get module->dashboard edges via ModuleDashboard join query
   - Add edges with edge_type="module_dashboard"

2. After dashboards section, add resources section:
   - Query all resources: select(Resource)
   - Get resource_keys list
   - For each resource, apply draft overlay and create GraphNode with entity_type="resource"
   - Add edges: category -> resource with edge_type="category_resource" (using resource.category_key)

3. Add draft-created dashboards and resources:
   - Check draft_overlay.get_draft_creates("dashboard") and add nodes
   - Check draft_overlay.get_draft_creates("resource") and add nodes

Module membership for dashboards: Use ModuleDashboard table to find which modules contain each dashboard.
Module membership for resources: Resources don't have direct module membership - they belong to categories which may be in modules.
  </action>
  <verify>
Run backend tests to verify no regressions:
cd /home/daharoni/dev/ontology-hub/backend && python -m pytest tests/test_graph_query.py -v --tb=short 2>/dev/null || echo "No existing graph tests or tests passed"
  </verify>
  <done>
get_full_ontology_graph returns GraphResponse that includes dashboard and resource nodes with their edges.
  </done>
</task>

</tasks>

<verification>
1. Python syntax check: cd /home/daharoni/dev/ontology-hub/backend && python -m py_compile app/services/graph_query.py
2. Import check: python -c "from app.services.graph_query import GraphQueryService"
3. Backend startup check: uvicorn app.main:app --host 0.0.0.0 --port 8080 & sleep 3 && curl -s http://localhost:8080/health | grep -q ok && kill %1
</verification>

<success_criteria>
- GraphQueryService imports Dashboard, Resource, ModuleDashboard from app.models.v2
- get_neighborhood_graph handles entity_type "dashboard" and "resource"
- _get_dashboard_neighborhood returns dashboard node + connected module nodes + module_dashboard edges
- _get_resource_neighborhood returns resource node + parent category node + category_resource edge
- get_full_ontology_graph includes all dashboards and resources with their edges
- No regressions in existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/29-frontend-graph-visualization/29-01-SUMMARY.md`
</output>
