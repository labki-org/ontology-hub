---
phase: 15-v2-frontend-wiring-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/pages/BrowsePage.tsx
  - frontend/src/components/layout/SidebarV2.tsx
  - frontend/src/components/layout/MainLayoutV2.tsx
  - frontend/src/components/draft/PRWizardSteps/ConfirmSubmit.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Entity queries and graph queries receive correct draft_id when only draft_token is in URL"
    - "Sidebar entity lists show change badges when only draft_token is in URL"
    - "No duplicate or conflicting v1 draft banner appears in v2 flow"
    - "OAuth redirect during PR submission hits /api/v1/oauth/github/login (not 404)"
  artifacts:
    - path: "frontend/src/pages/BrowsePage.tsx"
      provides: "Draft ID derivation from draftV2.data?.id"
      contains: "draftV2.data?.id"
    - path: "frontend/src/components/layout/SidebarV2.tsx"
      provides: "Draft ID derivation from draftV2.data?.id"
      contains: "draftV2.data?.id"
    - path: "frontend/src/components/layout/MainLayoutV2.tsx"
      provides: "Clean v2-only layout without v1 draft components"
    - path: "frontend/src/components/draft/PRWizardSteps/ConfirmSubmit.tsx"
      provides: "Correct OAuth redirect URL"
      contains: "/api/v1/oauth/github/login"
  key_links:
    - from: "BrowsePage.tsx"
      to: "useCategory/useProperty/etc hooks"
      via: "draftId derived from draftV2.data?.id"
      pattern: "draftV2\\.data\\??\\.id"
    - from: "BrowsePage.tsx"
      to: "GraphCanvas"
      via: "draftId prop"
      pattern: "draftId=\\{draftId\\}"
    - from: "SidebarV2.tsx"
      to: "useCategories/useProperties/etc hooks"
      via: "draftId derived from draftV2.data?.id"
      pattern: "draftV2\\.data\\??\\.id"
    - from: "ConfirmSubmit.tsx"
      to: "backend OAuth endpoint"
      via: "window.location.href"
      pattern: "/api/v1/oauth/github/login"
---

<objective>
Fix 3 frontend integration gaps from the v2.0 milestone audit: draft_id derivation from async draft data, v1/v2 component conflicts in MainLayoutV2, and OAuth redirect URL.

Purpose: These 3 gaps break the Draft Editing and PR Submission E2E flows. Without these fixes, draft overlay is invisible (entity/graph queries get undefined draft_id) and PR submission 404s on OAuth redirect.

Output: All 4 files patched, both E2E flows unblocked.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/v2.0-MILESTONE-AUDIT.md
@.planning/phases/15-v2-frontend-wiring-fixes/15-RESEARCH.md

Key files to modify:
@frontend/src/pages/BrowsePage.tsx
@frontend/src/components/layout/SidebarV2.tsx
@frontend/src/components/layout/MainLayoutV2.tsx
@frontend/src/components/draft/PRWizardSteps/ConfirmSubmit.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Derive draftId from fetched draft in BrowsePage and SidebarV2</name>
  <files>
    frontend/src/pages/BrowsePage.tsx
    frontend/src/components/layout/SidebarV2.tsx
  </files>
  <action>
**BrowsePage.tsx** (3 changes):

1. Change line 52 to derive draftId from the fetched draft object instead of only URL params:
   - BEFORE: `const draftId = searchParams.get('draft_id') || undefined`
   - AFTER: Move draftId assignment BELOW the `useDraftV2(draftToken)` call (line 57) and change to:
     `const draftId = draftV2.data?.id?.toString() || searchParams.get('draft_id') || undefined`
   - The draft.id is a number (database UUID integer), so `.toString()` converts it for the string-typed draftId parameter.
   - The fallback to `searchParams.get('draft_id')` preserves backward compatibility with v1 workflow.

2. Verify that the derived `draftId` is now passed to:
   - All entity query hooks (lines 66-71): `useCategory(..., draftId)`, `useProperty(..., draftId)`, etc.
   - `<GraphCanvas draftId={draftId} ...>` (line ~172)
   - `<EntityDetailPanel draftId={draftId} ...>` (line ~199)
   - `<EntityDetailModal draftId={draftId} />` (line ~207)
   These already reference the `draftId` variable, so the fix propagates automatically once the variable is correctly derived.

3. No other changes to BrowsePage.tsx. The draftV2/draftToken logic for DraftBannerV2, FloatingActionBar, and PRWizard remains unchanged (they use draftToken/draftV2.data, not draftId).

**SidebarV2.tsx** (3 changes):

1. Add import for `useDraftV2` from `@/api/draftApiV2`:
   `import { useDraftV2 } from '@/api/draftApiV2'`

2. After the existing `searchParams` line (line 111-112), add draft_token extraction and useDraftV2 hook:
   ```typescript
   const draftToken = searchParams.get('draft_token') || undefined
   const draftV2 = useDraftV2(draftToken)
   ```

3. Change line 112 from:
   `const draftId = searchParams.get('draft_id') || undefined`
   To (AFTER the useDraftV2 call):
   `const draftId = draftV2.data?.id?.toString() || searchParams.get('draft_id') || undefined`

This ensures the sidebar entity list queries (`useCategories(undefined, undefined, draftId)` etc.) receive the correct draft_id, enabling change badges (added/modified/deleted) to appear in the sidebar during the v2 draft_token workflow.
  </action>
  <verify>
1. `cd frontend && npx tsc --noEmit` -- TypeScript compiles without errors
2. Grep for the fix pattern: `grep -n "draftV2.data?.id" src/pages/BrowsePage.tsx src/components/layout/SidebarV2.tsx` -- both files should show the derived draftId
3. Grep that old bare `searchParams.get('draft_id')` assignment is gone from both files (replaced by the derived version that falls back to draft_id URL param)
  </verify>
  <done>
- BrowsePage.tsx derives draftId from `draftV2.data?.id` with fallback to `draft_id` URL param
- SidebarV2.tsx derives draftId from `draftV2.data?.id` with fallback to `draft_id` URL param
- All entity queries, graph queries, EntityDetailPanel, and EntityDetailModal receive correct draftId in v2 flow
- Sidebar change badges render when using draft_token workflow
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove v1 draft components from MainLayoutV2 and fix OAuth URL</name>
  <files>
    frontend/src/components/layout/MainLayoutV2.tsx
    frontend/src/components/draft/PRWizardSteps/ConfirmSubmit.tsx
  </files>
  <action>
**MainLayoutV2.tsx** (remove v1 DraftBanner entirely):

BrowsePage already renders DraftBannerV2 conditionally when `draftV2.data` exists. MainLayoutV2 renders a SECOND v1 DraftBanner using the v1 `useDraft` hook. This creates duplicate banners and the v1 banner reads from the wrong API.

1. Remove the v1 imports (lines 3-5):
   - Remove: `import { DraftBanner } from '@/components/draft/DraftBanner'`
   - Remove: `import { useDraft } from '@/api/drafts'`
   - Keep: `import { DraftSelector } from '@/components/draft/DraftSelector'` (DraftSelector supports both v1 and v2 per decision [14-10])

2. Remove the `useSearchParams` extraction for `draftId` (lines 18-19):
   - Remove: `const [searchParams] = useSearchParams()`
   - Remove: `const draftId = searchParams.get('draft_id') || undefined`

3. Remove the `useDraft` hook call (line 22):
   - Remove: `const { data: draft } = useDraft(draftId)`

4. Remove the entire conditional DraftBanner rendering block (lines 38-45):
   - Remove: `{draft && (<DraftBanner ... />)}`

5. Also remove `useSearchParams` from the react-router-dom import if no longer needed. Check if `Link` is still used (yes, line 31) -- keep `Link` import.
   - BEFORE: `import { Outlet, Link, useSearchParams } from 'react-router-dom'`
   - AFTER: `import { Outlet, Link } from 'react-router-dom'`

The result: MainLayoutV2 becomes a simple shell with sidebar, header (with DraftSelector), and Outlet. All draft UI rendering is handled by BrowsePage.

**ConfirmSubmit.tsx** (1-line fix):

1. Change line 28 from:
   `window.location.href = \`/api/oauth/github/login?${params.toString()}\``
   To:
   `window.location.href = \`/api/v1/oauth/github/login?${params.toString()}\``

This matches the backend route registration at `/api/v1/oauth/github/login` (confirmed in the milestone audit).
  </action>
  <verify>
1. `cd frontend && npx tsc --noEmit` -- TypeScript compiles without errors
2. `grep -n "DraftBanner\|useDraft" src/components/layout/MainLayoutV2.tsx` -- should return NO matches (all v1 draft references removed)
3. `grep -n "useSearchParams" src/components/layout/MainLayoutV2.tsx` -- should return NO matches
4. `grep -n "/api/v1/oauth/github/login" src/components/draft/PRWizardSteps/ConfirmSubmit.tsx` -- should return 1 match with the corrected URL
5. `grep -rn "/api/oauth/github/login" src/` -- should return NO matches for the broken URL (only /api/v1/ version should exist)
  </verify>
  <done>
- MainLayoutV2 no longer imports or renders v1 DraftBanner or useDraft
- No duplicate draft banners in v2 flow
- ConfirmSubmit.tsx redirects to /api/v1/oauth/github/login
- PR submission OAuth flow will not 404
  </done>
</task>

</tasks>

<verification>
After both tasks complete, verify the full integration:

1. **TypeScript build:** `cd frontend && npx tsc --noEmit` passes with zero errors
2. **Draft ID derivation chain:**
   - BrowsePage: `draftV2.data?.id?.toString()` feeds into entity hooks, GraphCanvas, EntityDetailPanel, EntityDetailModal
   - SidebarV2: `draftV2.data?.id?.toString()` feeds into useCategories, useProperties, etc.
3. **No v1 remnants in v2 layout:** `grep -rn "import.*DraftBanner[^V]" src/components/layout/` returns nothing
4. **OAuth URL correctness:** `grep -rn "/api/oauth/" src/ | grep -v "/api/v1/"` returns nothing
5. **Backward compatibility:** `grep -n "searchParams.get('draft_id')" src/pages/BrowsePage.tsx src/components/layout/SidebarV2.tsx` still shows fallback reads (the derived draftId includes `|| searchParams.get('draft_id')`)
</verification>

<success_criteria>
1. When navigating to `/browse?draft_token=abc123`, entity queries receive a valid draftId (from fetched draft.id), showing draft overlay data
2. When navigating to `/browse?draft_token=abc123`, sidebar entity lists receive draftId, showing change badges
3. When navigating to `/browse?draft_token=abc123`, graph queries receive draftId, showing change status colors on nodes
4. MainLayoutV2 renders zero DraftBanner components (only BrowsePage renders DraftBannerV2)
5. Clicking "Submit Pull Request" in the PR wizard redirects to `/api/v1/oauth/github/login` (not 404)
6. Legacy `/browse?draft_id=123` still works (fallback path preserved)
</success_criteria>

<output>
After completion, create `.planning/phases/15-v2-frontend-wiring-fixes/15-01-SUMMARY.md`
</output>
