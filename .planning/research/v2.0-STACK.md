# Stack Additions for v2.0

**Project:** Ontology Hub v2.0 Platform Rebuild
**Researched:** 2026-01-23
**Domain:** Graph visualization, JSON Patch, precomputed relationship tables, draft-as-deltas
**Confidence:** HIGH

---

## Executive Summary

v2.0 adds graph visualization, canonical versioning, precomputed relationship tables, and draft-as-deltas. The existing stack handles most requirements well. This research identifies specific additions needed for NEW capabilities only.

**Key findings:**

1. **Graph visualization:** React Flow v12 is already installed and is the RIGHT choice. No change needed. For module hull overlays, use ViewportPortal with d3-polygon for convex hull computation.

2. **JSON Patch (Python):** Add `jsonpatch ^1.33` for RFC 6902 compliance. It supports both `make_patch()` (generate from two objects) and `apply_patch()` (apply patch to document).

3. **PostgreSQL patterns:** Native recursive CTEs with SEARCH/CYCLE clauses (PostgreSQL 14+) handle inheritance traversal. No extension needed. Materialized views with REFRESH CONCURRENTLY for relationship tables; consider pg_ivm extension only if incremental refresh becomes critical.

4. **Frontend diff:** jsondiffpatch ^0.7.3 (already installed) includes RFC 6902 formatter via `jsondiffpatch.formatters.jsonpatch.format()`. No additional library needed.

---

## Validated Existing Stack (DO NOT ADD)

The following are already installed and validated for v2.0 requirements:

| Package | Version | Purpose | v2.0 Use |
|---------|---------|---------|----------|
| @xyflow/react | ^12.10.0 | Graph visualization | Inheritance graphs, module dependencies |
| @dagrejs/dagre | ^1.1.8 | Graph layout | Hierarchical layout for entity graphs |
| jsondiffpatch | ^0.7.3 | JSON diff/patch | Draft diff computation, RFC 6902 output |
| zustand | ^5.0.10 | Client state | Draft editing state |
| immer | ^11.1.3 | Immutable updates | Draft state mutations |

These packages are sufficient. Do NOT add alternatives.

---

## New Stack Additions

### Backend: JSON Patch (RFC 6902)

**Add:** `jsonpatch ^1.33`

**Purpose:** Apply and generate RFC 6902 patches for draft-as-deltas model.

**Why this library:**
- Most widely used Python RFC 6902 implementation (2M+ downloads/month)
- Supports both directions: `make_patch(src, dst)` and `apply_patch(doc, patch)`
- Compatible with Python 3.7+ (v1.0 uses Python 3.12)
- Maintained since 2012, stable API

**API verified (official docs):**
```python
import jsonpatch

# Generate patch from two objects
src = {'label': 'Person', 'parent': None}
dst = {'label': 'Person', 'parent': 'Thing'}
patch = jsonpatch.make_patch(src, dst)
# Result: [{'op': 'add', 'path': '/parent', 'value': 'Thing'}]

# Apply patch to document
result = patch.apply(src)
# Result: {'label': 'Person', 'parent': 'Thing'}

# Validate patch without applying
jsonpatch.apply_patch(src, patch, in_place=False)
```

**Installation:**
```bash
# Add to backend/requirements.txt
jsonpatch>=1.33
```

**Sources:**
- [python-json-patch PyPI](https://pypi.org/project/jsonpatch/) - v1.33 released June 2023
- [python-json-patch Tutorial](https://python-json-patch.readthedocs.io/en/stable/tutorial.html)
- Confidence: HIGH (verified with official documentation)

---

### Frontend: Convex Hull for Module Overlays

**Add:** `d3-polygon ^3.0.1`

**Purpose:** Compute convex hulls for multi-module visual grouping overlays.

**Why this library:**
- Tiny (4KB minified), zero dependencies
- Standard D3 module, extremely well-tested
- `d3.polygonHull(points)` returns vertices in counterclockwise order
- Works seamlessly with React Flow's ViewportPortal

**NOT adding d3 full bundle** - only the polygon submodule is needed.

**API:**
```typescript
import { polygonHull } from 'd3-polygon';

// Given node positions for a module's entities
const points: [number, number][] = nodes.map(n => [n.position.x, n.position.y]);

// Compute hull vertices
const hull = polygonHull(points);
// Result: [[x1,y1], [x2,y2], ...] or null if < 3 points

// Draw as SVG path
const pathData = hull ? `M ${hull.map(p => p.join(',')).join(' L ')} Z` : '';
```

**Integration with React Flow:**
```typescript
import { ViewportPortal } from '@xyflow/react';
import { polygonHull } from 'd3-polygon';

function ModuleHullOverlay({ moduleId, nodes }) {
  const points = nodes.map(n => [n.position.x + n.width/2, n.position.y + n.height/2]);
  const hull = polygonHull(points);

  if (!hull || hull.length < 3) return null;

  // Expand hull slightly for visual padding
  const padding = 20;
  const centroid = [
    hull.reduce((s, p) => s + p[0], 0) / hull.length,
    hull.reduce((s, p) => s + p[1], 0) / hull.length,
  ];
  const expandedHull = hull.map(([x, y]) => {
    const dx = x - centroid[0];
    const dy = y - centroid[1];
    const len = Math.sqrt(dx*dx + dy*dy);
    return [x + (dx/len) * padding, y + (dy/len) * padding];
  });

  const pathData = `M ${expandedHull.map(p => p.join(',')).join(' L ')} Z`;

  return (
    <ViewportPortal>
      <svg style={{ position: 'absolute', overflow: 'visible', pointerEvents: 'none' }}>
        <path
          d={pathData}
          fill={moduleColors[moduleId]}
          fillOpacity={0.1}
          stroke={moduleColors[moduleId]}
          strokeWidth={2}
          strokeDasharray="5,5"
        />
      </svg>
    </ViewportPortal>
  );
}
```

**Installation:**
```bash
npm install d3-polygon
npm install -D @types/d3-polygon
```

**Sources:**
- [D3 Polygon Documentation](https://d3js.org/d3-polygon)
- [Observable: d3.polygonHull](https://observablehq.com/@d3/d3-polygonhull)
- Confidence: HIGH (d3 standard library)

---

### PostgreSQL: No Extensions Required

**Do NOT add:** pg_ivm, ltree, or other extensions for v2.0 initial build.

**Why:**
- PostgreSQL 17 native recursive CTEs with SEARCH/CYCLE clauses handle inheritance traversal
- Materialized views with REFRESH CONCURRENTLY are sufficient for relationship tables
- pg_ivm (incremental view maintenance) adds complexity; evaluate only if refresh becomes a bottleneck

**Recursive CTE for Inheritance Traversal:**
```sql
-- Get all ancestors of a category (PostgreSQL 14+ syntax)
WITH RECURSIVE ancestors AS (
  -- Base case: the category itself
  SELECT entity_id, parent_category_id, 0 as depth
  FROM category
  WHERE entity_id = 'Person'

  UNION ALL

  -- Recursive case: parent of current
  SELECT c.entity_id, c.parent_category_id, a.depth + 1
  FROM category c
  JOIN ancestors a ON c.entity_id = a.parent_category_id
)
SEARCH DEPTH FIRST BY entity_id SET search_order
CYCLE entity_id SET is_cycle USING cycle_path
SELECT * FROM ancestors WHERE NOT is_cycle;
```

**Materialized View Pattern:**
```sql
-- category_parent: all ancestor relationships (not just direct parent)
CREATE MATERIALIZED VIEW category_ancestor AS
WITH RECURSIVE tree AS (
  SELECT entity_id, parent_category_id as ancestor_id, 1 as depth
  FROM category WHERE parent_category_id IS NOT NULL
  UNION ALL
  SELECT t.entity_id, c.parent_category_id, t.depth + 1
  FROM tree t
  JOIN category c ON t.ancestor_id = c.entity_id
  WHERE c.parent_category_id IS NOT NULL
)
SELECT DISTINCT entity_id, ancestor_id, depth FROM tree;

CREATE UNIQUE INDEX ON category_ancestor (entity_id, ancestor_id);

-- Refresh pattern (concurrent for no-lock refresh)
REFRESH MATERIALIZED VIEW CONCURRENTLY category_ancestor;
```

**When to Reconsider pg_ivm:**
- If `REFRESH MATERIALIZED VIEW` takes > 5 seconds
- If relationship tables change frequently (multiple times per minute)
- Neither expected for Ontology Hub use case

**Sources:**
- [PostgreSQL 18 WITH Documentation](https://www.postgresql.org/docs/current/queries-with.html)
- [pg_ivm Extension](https://github.com/sraoss/pg_ivm)
- Confidence: HIGH (PostgreSQL official documentation)

---

## What NOT to Add

### Graph Visualization

| Considered | Decision | Reason |
|------------|----------|--------|
| Cytoscape.js | REJECT | React integration is awkward; React Flow already installed and working |
| Sigma.js/Graphology | REJECT | Better for large graphs (10k+ nodes), overkill for 200 nodes |
| vis-network | REJECT | Older library, less active development |
| D3.js (full) | REJECT | Too low-level; React Flow abstracts this well |

**React Flow is the right choice** for Ontology Hub because:
- Already installed and working (v1.0 uses it for inheritance graphs)
- Handles 450+ nodes smoothly (verified stress test)
- Native React integration with hooks
- Compound nodes via `parentId` for basic grouping
- ViewportPortal for custom overlays (module hulls)
- Custom node types already implemented (CategoryNode, ModuleNode)

### JSON Diff/Patch Libraries

| Considered | Decision | Reason |
|------------|----------|--------|
| rfc6902 (npm) | REJECT | jsondiffpatch already does this |
| fast-json-patch | REJECT | jsondiffpatch has better array handling |
| diff-match-patch | REJECT | Text diff, not JSON structure diff |

**jsondiffpatch is sufficient** because:
- Already installed in v1.0
- Supports RFC 6902 output via `formatters.jsonpatch.format(delta)`
- Better array diff (detects moves, not just add/remove)
- Used in existing DiffViewer, ChangeGroup components

### Backend JSON Diff

| Considered | Decision | Reason |
|------------|----------|--------|
| deepdiff | REJECT | Different output format, not RFC 6902 |
| dictdiffer | REJECT | Simpler than needed, no RFC 6902 |
| pyjsonpatch | REJECT | Less mature than jsonpatch |

**jsonpatch is the right choice** because:
- Direct RFC 6902 compliance
- Both make_patch and apply_patch
- Most downloads, longest maintenance history

---

## Integration Patterns

### Draft-as-Deltas Flow

```
Frontend (jsondiffpatch)          Backend (jsonpatch)
         |                                |
         v                                v
User edits entity          POST /drafts with full payload
         |                                |
         v                                v
jsondiffpatch.diff()       make_patch(canonical, draft)
         |                                |
         v                                v
Show visual diff           Store: {entity_id, patch: [...]}
         |                                |
         v                                v
formatters.jsonpatch.format()   apply_patch() on save
         |                                |
         v                                v
Send to backend            Write to canonical
```

**Frontend computes visual diff; backend stores and applies RFC 6902 patches.**

### Module Hull Overlay Architecture

```
EntityGraph component
    |
    +-- ReactFlow (nodes, edges)
    |       |
    |       +-- CategoryNode (custom)
    |       +-- ModuleNode (custom)
    |
    +-- ViewportPortal
            |
            +-- ModuleHullOverlay (for each visible module)
                    |
                    +-- d3.polygonHull(module's node positions)
                    +-- SVG path with fill/stroke
```

**Overlays render in ViewportPortal so they transform with pan/zoom.**

---

## Performance Considerations

### React Flow with 200+ Nodes

React Flow handles 450 nodes in stress test. For 200 nodes:

1. **Memoize custom nodes:**
   ```typescript
   const CategoryNode = memo(({ data }) => { ... });
   ```

2. **Use dagre layout once, not on every render:**
   ```typescript
   const { nodes, edges } = useMemo(() =>
     getLayoutedElements(rawNodes, rawEdges),
     [rawNodes, rawEdges]
   );
   ```

3. **Simplify CSS on nodes:** Avoid shadows, gradients, animations on node elements.

4. **Lazy render hull overlays:** Only compute hulls for visible/expanded modules.

### Materialized View Refresh

For relationship tables with ~500 entities:

1. **REFRESH CONCURRENTLY** - Requires unique index but allows reads during refresh
2. **Refresh on webhook** - After GitHub push, before returning to caller
3. **Incremental refresh not needed** - Full refresh of 500-row view takes < 100ms

---

## Installation Summary

### Backend (requirements.txt additions)

```txt
# RFC 6902 JSON Patch
jsonpatch>=1.33
```

### Frontend (npm additions)

```bash
npm install d3-polygon
npm install -D @types/d3-polygon
```

### PostgreSQL (no changes)

No extensions required. Use native recursive CTEs and materialized views.

---

## Verification Checklist

- [x] React Flow v12 handles 200+ nodes (verified: stress test shows 450)
- [x] React Flow supports compound nodes (verified: parentId, extent: 'parent')
- [x] ViewportPortal renders custom SVG in viewport coordinates (verified: official docs)
- [x] jsondiffpatch outputs RFC 6902 (verified: formatters.jsonpatch.format)
- [x] python-json-patch supports make_patch (verified: official tutorial)
- [x] PostgreSQL 17 supports SEARCH/CYCLE in recursive CTEs (verified: PostgreSQL docs)
- [x] d3-polygon is standalone (verified: 4KB, zero deps)

---

## Sources

### Primary (HIGH confidence)
- [React Flow Performance](https://reactflow.dev/learn/advanced-use/performance)
- [React Flow Stress Test](https://reactflow.dev/examples/nodes/stress) - 450 nodes
- [React Flow ViewportPortal](https://reactflow.dev/api-reference/components/viewport-portal)
- [React Flow Sub Flows](https://reactflow.dev/examples/grouping/sub-flows)
- [python-json-patch Tutorial](https://python-json-patch.readthedocs.io/en/stable/tutorial.html)
- [python-json-patch PyPI](https://pypi.org/project/jsonpatch/)
- [D3 Polygon Documentation](https://d3js.org/d3-polygon)
- [PostgreSQL WITH Queries](https://www.postgresql.org/docs/current/queries-with.html)
- [jsondiffpatch Formatters](https://github.com/benjamine/jsondiffpatch/blob/master/docs/formatters.md)

### Secondary (MEDIUM confidence)
- [pg_ivm Extension](https://github.com/sraoss/pg_ivm)
- [React Flow GitHub Discussions](https://github.com/xyflow/xyflow/discussions) - grouping, performance

---

## Confidence Assessment

| Area | Confidence | Notes |
|------|------------|-------|
| React Flow for graphs | HIGH | Already working in v1.0, stress tested |
| d3-polygon for hulls | HIGH | Standard D3 module, simple API |
| jsonpatch (Python) | HIGH | Most used RFC 6902 lib, verified API |
| jsondiffpatch RFC 6902 | HIGH | Formatter exists, verified in docs |
| PostgreSQL recursive CTE | HIGH | Native feature, no extension needed |
| Materialized views | HIGH | Standard PostgreSQL, no extension needed |
| ViewportPortal integration | MEDIUM | Documented but needs integration testing |

**Overall confidence:** HIGH

---

*Research completed: 2026-01-23*
*Ready for roadmap: yes*
